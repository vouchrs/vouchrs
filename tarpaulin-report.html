<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","workspaces","vouchrs","src","handlers","auth.rs"],"content":"// Authentication handlers: sign-in and sign-out\nuse crate::oauth::{OAuthConfig, OAuthState};\nuse crate::session::SessionManager;\nuse crate::settings::VouchrsSettings;\nuse crate::utils::crypto::generate_csrf_token;\nuse crate::utils::response_builder::ResponseBuilder;\nuse actix_web::{web, HttpRequest, HttpResponse, Result};\nuse log::{debug, error, info};\n\nuse super::static_files::get_sign_in_page;\nuse serde::Deserialize;\n#[derive(Deserialize)]\npub struct SignInQuery {\n    pub provider: Option\u003cString\u003e,\n    pub rd: Option\u003cString\u003e,\n}\n\n/// OAuth sign in handler\n/// \n/// # Errors\n/// Returns an error if provider is not found, authentication fails,\n/// or redirect URL generation fails\npub async fn oauth_sign_in(\n    query: web::Query\u003cSignInQuery\u003e,\n    _req: HttpRequest,\n    oauth_config: web::Data\u003cOAuthConfig\u003e,\n    settings: web::Data\u003cVouchrsSettings\u003e,\n    session_manager: web::Data\u003cSessionManager\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    // Clear any existing session by setting an expired cookie\n    let clear_cookie = session_manager.create_expired_cookie();\n\n    match \u0026query.provider {\n        Some(provider) if oauth_config.get_client_configured(provider) =\u003e {\n            // Generate state for CSRF protection using high-entropy crypto-secure token\n            let csrf_state = generate_csrf_token();\n\n            // Create OAuth state object\n            let oauth_state = OAuthState {\n                state: csrf_state,\n                provider: provider.clone(),\n                redirect_url: query.rd.clone(),\n            };\n\n            // ðŸ”’ SECURITY: Use encrypted state parameter to prevent tampering\n            // This prevents attackers from modifying the provider name or redirect URL\n            let actual_state = match session_manager.encrypt_data(\u0026oauth_state) {\n                Ok(encrypted_state) =\u003e {\n                    info!(\"Using encrypted state parameter for {provider} OAuth (tamper-proof)\");\n                    encrypted_state\n                }\n                Err(e) =\u003e {\n                    error!(\"Failed to encrypt OAuth state: {e}\");\n                    let clear_cookie = session_manager.create_expired_cookie();\n                    return Ok(HttpResponse::Found()\n                        .cookie(clear_cookie)\n                        .append_header((\"Location\", \"/oauth2/sign_in?error=state_encryption_failed\"))\n                        .finish());\n                }\n            };\n            let mut response_builder = HttpResponse::Found();\n            response_builder.cookie(clear_cookie);\n\n            debug!(\n                \"Generated encrypted OAuth state for provider {provider}: length = {} chars\",\n                actual_state.len()\n            );\n            debug!(\n                \"Stored OAuth state for provider: {provider}, using encrypted state parameter (tamper-proof)\"\n            );\n\n            // Get authorization URL\n            match oauth_config.get_auth_url(provider, \u0026actual_state) {\n                Ok(auth_url) =\u003e {\n                    info!(\"Redirecting to {provider} OAuth: {auth_url}\");\n                    Ok(response_builder\n                        .append_header((\"Location\", auth_url))\n                        .finish())\n                }\n                Err(e) =\u003e {\n                    error!(\"Failed to get auth URL for {provider}: {e}\");\n                    let error_clear_cookie = session_manager.create_expired_cookie();\n                    Ok(ResponseBuilder::redirect_with_cookie(\n                        \"/oauth2/sign_in?error=oauth_config\",\n                        Some(error_clear_cookie),\n                    ))\n                }\n            }\n        }\n        Some(provider) =\u003e {\n            let clear_cookie = session_manager.create_expired_cookie();\n            let error_url = format!(\n                \"/oauth2/sign_in?error=unsupported_provider\u0026provider={provider}\"\n            );\n            Ok(ResponseBuilder::redirect_with_cookie(\n                \u0026error_url,\n                Some(clear_cookie),\n            ))\n        }\n        None =\u003e {\n            // Return login page HTML\n            let clear_cookie = session_manager.create_expired_cookie();\n            Ok(HttpResponse::Ok()\n                .cookie(clear_cookie)\n                .content_type(\"text/html\")\n                .body(get_sign_in_page(\u0026settings)))\n        }\n    }\n}\n\n/// OAuth sign out handler\n/// \n/// # Errors\n/// Returns an error if session validation fails or cookie clearing fails\npub async fn oauth_sign_out(\n    req: HttpRequest,\n    oauth_config: web::Data\u003cOAuthConfig\u003e,\n    session_manager: web::Data\u003cSessionManager\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    // Get the user's provider before clearing the session\n    let provider = match session_manager.get_session_from_request(\u0026req) {\n        Ok(Some(session)) =\u003e Some(session.provider),\n        _ =\u003e None,\n    };\n\n    // Create expired cookies to clear both session and user data\n    let clear_session_cookie = session_manager.create_expired_cookie();\n    let clear_user_cookie = session_manager.create_expired_user_cookie();\n    info!(\"User signed out and both session and user data cleared\");\n\n    // If we have a provider, check if it supports sign-out URL\n    if let Some(provider_name) = provider {\n        if let Some(signout_url) = oauth_config.get_signout_url(\u0026provider_name) {\n            info!(\"Redirecting to {provider_name} sign-out: {signout_url}\");\n            return Ok(ResponseBuilder::success_redirect_with_cookies(\n                \u0026signout_url,\n                vec![clear_session_cookie, clear_user_cookie],\n            ));\n        }\n        debug!(\n            \"Provider {provider_name} does not support automatic sign-out\"\n        );\n    }\n\n    // Default: redirect to login page\n    Ok(ResponseBuilder::success_redirect_with_cookies(\n        \"/oauth2/sign_in\",\n        vec![clear_session_cookie, clear_user_cookie],\n    ))\n}\n","traces":[{"line":23,"address":[2527312],"length":1,"stats":{"Line":0}},{"line":31,"address":[2718779,2718859],"length":1,"stats":{"Line":0}},{"line":33,"address":[2718977,2718913],"length":1,"stats":{"Line":0}},{"line":34,"address":[2719615,2719017],"length":1,"stats":{"Line":0}},{"line":36,"address":[2719759],"length":1,"stats":{"Line":0}},{"line":41,"address":[2720489],"length":1,"stats":{"Line":0}},{"line":42,"address":[2720635,2720568],"length":1,"stats":{"Line":0}},{"line":47,"address":[3576437,3576358],"length":1,"stats":{"Line":0}},{"line":48,"address":[2720972],"length":1,"stats":{"Line":0}},{"line":49,"address":[3576624,3576780,3576720],"length":1,"stats":{"Line":0}},{"line":50,"address":[2721106],"length":1,"stats":{"Line":0}},{"line":52,"address":[2720908],"length":1,"stats":{"Line":0}},{"line":53,"address":[2720924,2724880,2724909],"length":1,"stats":{"Line":0}},{"line":54,"address":[2724894,2725211],"length":1,"stats":{"Line":0}},{"line":55,"address":[2725251,2725356,2725491],"length":1,"stats":{"Line":0}},{"line":56,"address":[2725308],"length":1,"stats":{"Line":0}},{"line":57,"address":[2725429],"length":1,"stats":{"Line":0}},{"line":58,"address":[2725380,2725633],"length":1,"stats":{"Line":0}},{"line":61,"address":[2721138],"length":1,"stats":{"Line":0}},{"line":62,"address":[2721491],"length":1,"stats":{"Line":0}},{"line":64,"address":[2721714,2721608,2721839],"length":1,"stats":{"Line":0}},{"line":68,"address":[2721666,2722119,2722151],"length":1,"stats":{"Line":0}},{"line":73,"address":[2722732,2722487,2722617,2722133],"length":1,"stats":{"Line":0}},{"line":74,"address":[2722833],"length":1,"stats":{"Line":0}},{"line":75,"address":[2722873,2723109,2722966],"length":1,"stats":{"Line":0}},{"line":76,"address":[2723091,2723443],"length":1,"stats":{"Line":0}},{"line":77,"address":[2722976],"length":1,"stats":{"Line":0}},{"line":80,"address":[2722753],"length":1,"stats":{"Line":0}},{"line":81,"address":[2722785,2723605,2723634],"length":1,"stats":{"Line":0}},{"line":82,"address":[2723948,2723619],"length":1,"stats":{"Line":0}},{"line":83,"address":[2724020],"length":1,"stats":{"Line":0}},{"line":85,"address":[2724013],"length":1,"stats":{"Line":0}},{"line":90,"address":[2719720],"length":1,"stats":{"Line":0}},{"line":91,"address":[2719736,2719812],"length":1,"stats":{"Line":0}},{"line":92,"address":[2719929,2719858],"length":1,"stats":{"Line":0}},{"line":95,"address":[2720240],"length":1,"stats":{"Line":0}},{"line":96,"address":[2720037],"length":1,"stats":{"Line":0}},{"line":97,"address":[2720104],"length":1,"stats":{"Line":0}},{"line":102,"address":[2719075],"length":1,"stats":{"Line":0}},{"line":103,"address":[3574876,3574688,3574797,3574996],"length":1,"stats":{"Line":0}},{"line":104,"address":[2719235],"length":1,"stats":{"Line":0}},{"line":106,"address":[3574907],"length":1,"stats":{"Line":0}},{"line":115,"address":[3797824],"length":1,"stats":{"Line":0}},{"line":121,"address":[2726101,2726181,2726303],"length":1,"stats":{"Line":0}},{"line":122,"address":[2726535,2726340],"length":1,"stats":{"Line":0}},{"line":123,"address":[2726272],"length":1,"stats":{"Line":0}},{"line":127,"address":[3582558,3582682],"length":1,"stats":{"Line":0}},{"line":128,"address":[2726961,2727033],"length":1,"stats":{"Line":0}},{"line":129,"address":[2727079,2727172,2727224],"length":1,"stats":{"Line":0}},{"line":132,"address":[3582973,3583252],"length":1,"stats":{"Line":0}},{"line":133,"address":[3583292,3583399],"length":1,"stats":{"Line":0}},{"line":134,"address":[2727754,2727909,2727872],"length":1,"stats":{"Line":0}},{"line":135,"address":[2728524],"length":1,"stats":{"Line":0}},{"line":136,"address":[2727886],"length":1,"stats":{"Line":0}},{"line":137,"address":[2728251],"length":1,"stats":{"Line":0}},{"line":140,"address":[2729007,2728933],"length":1,"stats":{"Line":0}},{"line":146,"address":[2729570],"length":1,"stats":{"Line":0}},{"line":148,"address":[2727530,2729314],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":58},{"path":["/","workspaces","vouchrs","src","handlers","callback.rs"],"content":"// OAuth callback handler\nuse crate::oauth::{OAuthCallback, OAuthConfig, OAuthState, get_state_from_callback};\nuse crate::session::SessionManager;\nuse actix_web::{web, HttpRequest, HttpResponse, Result};\nuse chrono::{DateTime, Utc};\nuse log::{debug, error};\n\nuse crate::session_builder::SessionBuilder;\nuse crate::utils::apple::{process_apple_callback, AppleUserInfo};\nuse crate::utils::logging::LoggingHelper;\nuse crate::utils::redirect_validator::validate_post_auth_redirect;\nuse crate::utils::response_builder::ResponseBuilder;\nuse crate::utils::user_agent::extract_user_agent_info;\n\n/// Parameters for session finalization\nstruct SessionFinalizeParams {\n    provider: String,\n    id_token: Option\u003cString\u003e,\n    refresh_token: Option\u003cString\u003e,\n    expires_at: DateTime\u003cUtc\u003e,\n    apple_user_info: Option\u003cAppleUserInfo\u003e,\n    redirect_url: Option\u003cString\u003e,\n}\n\n/// OAuth callback handler\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - OAuth state validation fails\n/// - Authorization code exchange fails\n/// - Session building fails\n/// - Cookie creation fails\npub async fn oauth_callback(\n    query: web::Query\u003cOAuthCallback\u003e,\n    form: Option\u003cweb::Form\u003cOAuthCallback\u003e\u003e,\n    req: HttpRequest,\n    oauth_config: web::Data\u003cOAuthConfig\u003e,\n    session_manager: web::Data\u003cSessionManager\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    // Extract callback data from either query params or form\n    let callback_data = extract_callback_data(query, form);\n    LoggingHelper::log_callback_debug(\u0026req, \u0026callback_data);\n\n    // Validate callback and extract required data\n    let (code, oauth_state) = match validate_callback(\u0026callback_data, \u0026session_manager, \u0026req) {\n        Ok(data) =\u003e data,\n        Err(response) =\u003e return Ok(response),\n    };\n\n    // Exchange code for OAuth tokens\n    let token_result = oauth_config\n        .exchange_code_for_tokens(\u0026oauth_state.provider, \u0026code)\n        .await;\n\n    let (id_token, refresh_token, expires_at, apple_user_info) = match token_result {\n        Ok(result) =\u003e result,\n        Err(e) =\u003e {\n            error!(\"Failed to exchange code for user info: {e}\");\n            let clear_cookie = session_manager.create_expired_cookie();\n            return Ok(HttpResponse::Found()\n                .cookie(clear_cookie)\n                .append_header((\"Location\", \"/oauth2/sign_in?error=auth_failed\"))\n                .finish());\n        }\n    };\n\n    LoggingHelper::log_oauth_token_response(\u0026oauth_state.provider, apple_user_info.as_ref());\n\n    // Process additional Apple user info if available\n    let processed_apple_info = process_apple_callback(\u0026callback_data, apple_user_info);\n\n    // Build and complete the session\n    let result = build_and_finalize_session(\n        \u0026req,\n        \u0026session_manager,\n        SessionFinalizeParams {\n            provider: oauth_state.provider,\n            id_token,\n            refresh_token,\n            expires_at,\n            apple_user_info: processed_apple_info,\n            redirect_url: oauth_state.redirect_url,\n        },\n    );\n\n    Ok(result)\n}\n\n/// Extract callback data from either query parameters or form submission\nfn extract_callback_data(\n    query: web::Query\u003cOAuthCallback\u003e,\n    form: Option\u003cweb::Form\u003cOAuthCallback\u003e\u003e,\n) -\u003e OAuthCallback {\n    form.map_or_else(|| {\n        debug!(\"OAuth callback received via query: {query:?}\");\n        query.into_inner()\n    }, |form_data| {\n        debug!(\"OAuth callback received via form_post: {form_data:?}\");\n        form_data.into_inner()\n    })\n}\n\n/// Validate the callback data and extract the required code and OAuth state\nfn validate_callback(\n    callback_data: \u0026OAuthCallback,\n    session_manager: \u0026SessionManager,\n    req: \u0026HttpRequest,\n) -\u003e Result\u003c(String, OAuthState), HttpResponse\u003e {\n    // Check for OAuth errors\n    if let Some(_error) = \u0026callback_data.error {\n        let clear_cookie = session_manager.create_expired_cookie();\n        return Err(HttpResponse::Found()\n            .cookie(clear_cookie)\n            .append_header((\"Location\", \"/oauth2/sign_in?error=auth_failed\"))\n            .finish());\n    }\n\n    // Get authorization code\n    let code = if let Some(code) = \u0026callback_data.code {\n        code.clone()\n    } else {\n        error!(\"No authorization code received\");\n        let clear_cookie = session_manager.create_expired_cookie();\n        return Err(HttpResponse::Found()\n            .cookie(clear_cookie)\n            .append_header((\"Location\", \"/oauth2/sign_in?error=auth_failed\"))\n            .finish());\n    };\n\n    // Get state parameter\n    let received_state = if let Some(state) = \u0026callback_data.state {\n        state.clone()\n    } else {\n        error!(\"No state parameter received\");\n        let clear_cookie = session_manager.create_expired_cookie();\n        return Err(HttpResponse::Found()\n            .cookie(clear_cookie)\n            .append_header((\"Location\", \"/oauth2/sign_in?error=oauth_state_error\"))\n            .finish());\n    };\n\n    // Parse and validate OAuth state\n    match get_state_from_callback(\u0026received_state, session_manager, req) {\n        Ok(state) =\u003e {\n            debug!(\"OAuth state verified for provider: {}\", state.provider);\n            Ok((code, state))\n        }\n        Err(e) =\u003e {\n            error!(\"Failed to parse OAuth state: {e}\");\n            let clear_cookie = session_manager.create_expired_cookie();\n            Err(HttpResponse::Found()\n                .cookie(clear_cookie)\n                .append_header((\"Location\", \"/oauth2/sign_in?error=oauth_state_error\"))\n                .finish())\n        }\n    }\n}\n\n// Function moved to utils/apple_utils.rs\n\n/// Build session and finalize the authentication process\nfn build_and_finalize_session(\n    req: \u0026HttpRequest,\n    session_manager: \u0026SessionManager,\n    params: SessionFinalizeParams,\n) -\u003e HttpResponse {\n    // Extract client info\n    let client_ip = req\n        .connection_info()\n        .realip_remote_addr()\n        .map(std::string::ToString::to_string);\n    let user_agent_info = extract_user_agent_info(req);\n\n    // Build the session (without access token)\n    let session_result = SessionBuilder::build_session_with_apple_info(\n        params.provider.clone(),\n        params.id_token,\n        params.refresh_token,\n        params.expires_at,\n        params.apple_user_info,\n    );\n\n    match session_result {\n        Ok(complete_session) =\u003e {\n            LoggingHelper::log_session_created(\u0026complete_session.user_email, \u0026params.provider);\n\n            // Split complete session into token data and user data\n            let session = complete_session.to_session();\n            let user_data =\n                complete_session.to_user_data(client_ip.as_deref(), Some(\u0026user_agent_info));\n\n            // Create both session and user cookies\n            let session_cookie = match session_manager.create_session_cookie(\u0026session) {\n                Ok(cookie) =\u003e cookie,\n                Err(e) =\u003e {\n                    error!(\"Failed to create session cookie: {e}\");\n                    let clear_cookie = session_manager.create_expired_cookie();\n                    return HttpResponse::Found()\n                        .cookie(clear_cookie)\n                        .append_header((\"Location\", \"/oauth2/sign_in?error=session_build_error\"))\n                        .finish();\n                }\n            };\n\n            let user_cookie = match session_manager.create_user_cookie(\u0026user_data) {\n                Ok(cookie) =\u003e cookie,\n                Err(e) =\u003e {\n                    error!(\"Failed to create user cookie: {e}\");\n                    let clear_cookie = session_manager.create_expired_cookie();\n                    return HttpResponse::Found()\n                        .cookie(clear_cookie)\n                        .append_header((\"Location\", \"/oauth2/sign_in?error=session_build_error\"))\n                        .finish();\n                }\n            };\n\n            let clear_temp_cookie = session_manager.create_expired_temp_state_cookie();\n            let redirect_to = params.redirect_url.unwrap_or_else(|| \"/\".to_string());\n\n            // Validate the redirect URL to prevent open redirect attacks\n            let validated_redirect = validate_post_auth_redirect(\u0026redirect_to).unwrap_or_else(|_| {\n                error!(\"Invalid post-authentication redirect URL '{redirect_to}': rejecting\");\n                // Fallback to safe default on validation failure\n                \"/\".to_string()\n            });\n\n            // Create response with multiple cookies\n            ResponseBuilder::success_redirect_with_cookies(\n                \u0026validated_redirect,\n                vec![session_cookie, user_cookie, clear_temp_cookie],\n            )\n        }\n        Err(e) =\u003e {\n            error!(\"Failed to build session from ID token: {e}\");\n            let clear_cookie = session_manager.create_expired_cookie();\n            HttpResponse::Found()\n                .cookie(clear_cookie)\n                .append_header((\"Location\", \"/oauth2/sign_in?error=session_build_error\"))\n                .finish()\n        }\n    }\n}\n","traces":[{"line":34,"address":[3861904],"length":1,"stats":{"Line":0}},{"line":42,"address":[3649421],"length":1,"stats":{"Line":0}},{"line":43,"address":[3425413],"length":1,"stats":{"Line":0}},{"line":46,"address":[2521273,2521570],"length":1,"stats":{"Line":0}},{"line":47,"address":[2765006],"length":1,"stats":{"Line":0}},{"line":48,"address":[3425653],"length":1,"stats":{"Line":0}},{"line":52,"address":[3426263,3426582,3426050,3425957,3426217],"length":1,"stats":{"Line":0}},{"line":53,"address":[3650213],"length":1,"stats":{"Line":0}},{"line":54,"address":[2765880,2764645,2765592,2765532,2765681],"length":1,"stats":{"Line":0}},{"line":56,"address":[3650754,3650901],"length":1,"stats":{"Line":0}},{"line":57,"address":[3650899],"length":1,"stats":{"Line":0}},{"line":58,"address":[3650791],"length":1,"stats":{"Line":0}},{"line":59,"address":[2765975,2768023,2768063],"length":1,"stats":{"Line":0}},{"line":60,"address":[3653217,3652877],"length":1,"stats":{"Line":0}},{"line":61,"address":[2768522,2768649,2768417],"length":1,"stats":{"Line":0}},{"line":62,"address":[2524846],"length":1,"stats":{"Line":0}},{"line":63,"address":[3429299],"length":1,"stats":{"Line":0}},{"line":64,"address":[2524918,2525171],"length":1,"stats":{"Line":0}},{"line":68,"address":[2522683,2522784],"length":1,"stats":{"Line":0}},{"line":71,"address":[2766559,2766394],"length":1,"stats":{"Line":0}},{"line":75,"address":[3651415],"length":1,"stats":{"Line":0}},{"line":76,"address":[3427359,3427293],"length":1,"stats":{"Line":0}},{"line":77,"address":[2523367],"length":1,"stats":{"Line":0}},{"line":78,"address":[2523093],"length":1,"stats":{"Line":0}},{"line":79,"address":[2523146],"length":1,"stats":{"Line":0}},{"line":80,"address":[3651622],"length":1,"stats":{"Line":0}},{"line":82,"address":[3427518],"length":1,"stats":{"Line":0}},{"line":83,"address":[3651750],"length":1,"stats":{"Line":0}},{"line":87,"address":[2767220],"length":1,"stats":{"Line":0}},{"line":91,"address":[3141872],"length":1,"stats":{"Line":0}},{"line":95,"address":[3712422],"length":1,"stats":{"Line":0}},{"line":96,"address":[3654232,3654006,3654103],"length":1,"stats":{"Line":0}},{"line":97,"address":[3654119],"length":1,"stats":{"Line":0}},{"line":98,"address":[2526533,2525981,2526558,2526032,2526007,2525562],"length":1,"stats":{"Line":0}},{"line":99,"address":[3430406,3430503,3430632],"length":1,"stats":{"Line":0}},{"line":100,"address":[2526167],"length":1,"stats":{"Line":0}},{"line":105,"address":[3141952,3142624,3142630],"length":1,"stats":{"Line":0}},{"line":111,"address":[3712551],"length":1,"stats":{"Line":0}},{"line":112,"address":[3405007],"length":1,"stats":{"Line":0}},{"line":113,"address":[3862328,3862491,3862624],"length":1,"stats":{"Line":0}},{"line":114,"address":[3142257],"length":1,"stats":{"Line":0}},{"line":115,"address":[3405274],"length":1,"stats":{"Line":0}},{"line":116,"address":[3862518,3862765],"length":1,"stats":{"Line":0}},{"line":120,"address":[3862854,3862355],"length":1,"stats":{"Line":0}},{"line":121,"address":[3142678],"length":1,"stats":{"Line":0}},{"line":123,"address":[3142758,3145510],"length":1,"stats":{"Line":0}},{"line":124,"address":[3408379],"length":1,"stats":{"Line":0}},{"line":125,"address":[3865983,3866110,3865700],"length":1,"stats":{"Line":0}},{"line":126,"address":[3716287],"length":1,"stats":{"Line":0}},{"line":127,"address":[3145844],"length":1,"stats":{"Line":0}},{"line":128,"address":[3866243,3866007],"length":1,"stats":{"Line":0}},{"line":132,"address":[3405596,3405700],"length":1,"stats":{"Line":0}},{"line":133,"address":[3405708],"length":1,"stats":{"Line":0}},{"line":135,"address":[3142839,3144794,3144762],"length":1,"stats":{"Line":0}},{"line":136,"address":[3864976,3865213],"length":1,"stats":{"Line":0}},{"line":137,"address":[3145125,3145017,3145260],"length":1,"stats":{"Line":0}},{"line":138,"address":[3865281],"length":1,"stats":{"Line":0}},{"line":139,"address":[3715754],"length":1,"stats":{"Line":0}},{"line":140,"address":[3145383,3145149],"length":1,"stats":{"Line":0}},{"line":144,"address":[3863123,3863219],"length":1,"stats":{"Line":0}},{"line":145,"address":[3863355],"length":1,"stats":{"Line":0}},{"line":146,"address":[3863435,3863531,3863751],"length":1,"stats":{"Line":0}},{"line":147,"address":[3863541],"length":1,"stats":{"Line":0}},{"line":149,"address":[3405979],"length":1,"stats":{"Line":0}},{"line":150,"address":[3143119,3143964,3143932],"length":1,"stats":{"Line":0}},{"line":151,"address":[3406842],"length":1,"stats":{"Line":0}},{"line":152,"address":[3714881,3715008,3714778],"length":1,"stats":{"Line":0}},{"line":153,"address":[3407226],"length":1,"stats":{"Line":0}},{"line":154,"address":[3714954],"length":1,"stats":{"Line":0}},{"line":163,"address":[3146096,3150561,3148889],"length":1,"stats":{"Line":0}},{"line":169,"address":[3866672,3866393,3866580],"length":1,"stats":{"Line":0}},{"line":172,"address":[3866623,3866730],"length":1,"stats":{"Line":0}},{"line":173,"address":[3146597],"length":1,"stats":{"Line":0}},{"line":177,"address":[3866828],"length":1,"stats":{"Line":0}},{"line":178,"address":[3409600],"length":1,"stats":{"Line":0}},{"line":179,"address":[3717280],"length":1,"stats":{"Line":0}},{"line":180,"address":[3146740],"length":1,"stats":{"Line":0}},{"line":181,"address":[3866988],"length":1,"stats":{"Line":0}},{"line":184,"address":[3717476],"length":1,"stats":{"Line":0}},{"line":185,"address":[3717629],"length":1,"stats":{"Line":0}},{"line":186,"address":[3147166,3147063],"length":1,"stats":{"Line":0}},{"line":189,"address":[3717812],"length":1,"stats":{"Line":0}},{"line":190,"address":[3717942,3717839],"length":1,"stats":{"Line":0}},{"line":194,"address":[3718064,3717993],"length":1,"stats":{"Line":0}},{"line":195,"address":[3718217],"length":1,"stats":{"Line":0}},{"line":196,"address":[3147497],"length":1,"stats":{"Line":0}},{"line":197,"address":[3147513,3149805,3149773],"length":1,"stats":{"Line":0}},{"line":198,"address":[3412803,3413091],"length":1,"stats":{"Line":0}},{"line":199,"address":[3150075,3150183,3150318],"length":1,"stats":{"Line":0}},{"line":200,"address":[3413159],"length":1,"stats":{"Line":0}},{"line":201,"address":[3870576],"length":1,"stats":{"Line":0}},{"line":202,"address":[3413378,3413231],"length":1,"stats":{"Line":0}},{"line":206,"address":[3147729,3147681],"length":1,"stats":{"Line":0}},{"line":207,"address":[3147882],"length":1,"stats":{"Line":0}},{"line":208,"address":[3410726],"length":1,"stats":{"Line":0}},{"line":209,"address":[3148990,3147782,3149022],"length":1,"stats":{"Line":0}},{"line":210,"address":[3869300,3869600],"length":1,"stats":{"Line":0}},{"line":211,"address":[3720068,3720195,3719960],"length":1,"stats":{"Line":0}},{"line":212,"address":[3720020],"length":1,"stats":{"Line":0}},{"line":213,"address":[3149485],"length":1,"stats":{"Line":0}},{"line":214,"address":[3149436,3149579],"length":1,"stats":{"Line":0}},{"line":218,"address":[3718542,3718610],"length":1,"stats":{"Line":0}},{"line":219,"address":[3430940,3430928],"length":1,"stats":{"Line":0}},{"line":222,"address":[3655120,3655532],"length":1,"stats":{"Line":0}},{"line":223,"address":[2770380,2770417,2770299],"length":1,"stats":{"Line":0}},{"line":225,"address":[3655239],"length":1,"stats":{"Line":0}},{"line":230,"address":[3411234],"length":1,"stats":{"Line":0}},{"line":231,"address":[3411343],"length":1,"stats":{"Line":0}},{"line":234,"address":[3717513],"length":1,"stats":{"Line":0}},{"line":235,"address":[3717545,3721335,3721371],"length":1,"stats":{"Line":0}},{"line":236,"address":[3870997],"length":1,"stats":{"Line":0}},{"line":237,"address":[3150945,3151183,3151048],"length":1,"stats":{"Line":0}},{"line":238,"address":[3871381],"length":1,"stats":{"Line":0}},{"line":239,"address":[3871461],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":114},{"path":["/","workspaces","vouchrs","src","handlers","debug.rs"],"content":"// Debug handler for sessions\nuse crate::session::SessionManager;\nuse actix_web::{web, HttpRequest, HttpResponse, Result};\nuse log::{debug, error, info};\n\n/// `OAuth2` userinfo endpoint - returns user data from encrypted user cookie\n/// \n/// # Errors\n/// Returns an error if session extraction fails or user data is invalid\npub async fn oauth_userinfo(\n    req: HttpRequest,\n    session_manager: web::Data\u003cSessionManager\u003e,\n    _settings: web::Data\u003ccrate::settings::VouchrsSettings\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    use crate::utils::cookie::USER_COOKIE_NAME;\n\n    // Get the vouchrs_user cookie directly\n    req.cookie(USER_COOKIE_NAME).map_or_else(|| {\n        debug!(\"Userinfo endpoint: No vouchrs_user cookie found\");\n        Ok(HttpResponse::Unauthorized().json(serde_json::json!({\n            \"error\": \"no_user_data\",\n            \"error_description\": \"No user data cookie found. Please authenticate first.\"\n        })))\n    }, |cookie| match session_manager.decrypt_data::\u003ccrate::models::VouchrsUserData\u003e(cookie.value()) {\n        Ok(user_data) =\u003e {\n            info!(\n                \"Userinfo endpoint: returning raw user data for user: {}\",\n                user_data.email\n            );\n\n            // Return the complete user data as raw JSON\n            Ok(HttpResponse::Ok().json(user_data))\n        }\n        Err(e) =\u003e {\n            error!(\"Userinfo endpoint: Error decrypting user cookie: {e}\");\n            Ok(HttpResponse::Unauthorized().json(serde_json::json!({\n                \"error\": \"invalid_cookie\",\n                \"error_description\": \"Failed to decrypt user cookie data\",\n                \"details\": e.to_string()\n            })))\n        }\n    })\n}\n\n/// Debug endpoint - returns debug information from session\n/// \n/// # Errors\n/// Returns an error if session extraction fails or debug data is invalid\npub async fn oauth_debug(\n    req: HttpRequest,\n    session_manager: web::Data\u003cSessionManager\u003e,\n    _settings: web::Data\u003ccrate::settings::VouchrsSettings\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    // Check if debug mode is enabled via environment variable\n    let debug_enabled = std::env::var(\"OAUTH_DEBUG_ENABLED\")\n        .unwrap_or_else(|_| \"false\".to_string())\n        .to_lowercase()\n        == \"true\";\n\n    if !debug_enabled {\n        error!(\"OAuth debug endpoint accessed but OAUTH_DEBUG_ENABLED is not set to true\");\n        return Ok(HttpResponse::Ok().json(serde_json::json!({\n            \"error\": \"debug_disabled\",\n            \"error_description\": \"Debug endpoint disabled. Set OAUTH_DEBUG_ENABLED=true to enable this endpoint\"\n        })));\n    }\n\n    match session_manager.get_session_from_request(\u0026req) {\n        Ok(Some(session)) =\u003e {\n            // Also try to get user data from user cookie\n            let user_data = session_manager\n                .get_user_data_from_request(\u0026req)\n                .unwrap_or(None);\n\n            let debug_response = serde_json::json!({\n                \"session_data\": {\n                    \"provider\": session.provider,\n                    \"expires_at\": session.expires_at,\n                    \"id_token\": session.id_token,\n                    \"refresh_token\": session.refresh_token,\n                },\n                \"debug_info\": {\n                    \"session_cookie_name\": \"vouchrs_session\",\n                    \"user_cookie_name\": \"vouchrs_user\",\n                    \"user_cookie\": user_data,\n                    \"timestamp\": chrono::Utc::now(),\n                }\n            });\n\n            Ok(HttpResponse::Ok().json(debug_response))\n        }\n        Ok(None) =\u003e {\n            debug!(\"Debug endpoint: No valid session found\");\n            Ok(HttpResponse::Unauthorized().json(create_no_session_response(\u0026req)))\n        }\n        Err(e) =\u003e {\n            error!(\"Debug endpoint: Error retrieving session: {e}\");\n            Ok(HttpResponse::Unauthorized().json(create_session_error_response(\u0026req, \u0026e)))\n        }\n    }\n}\n\nfn create_no_session_response(req: \u0026HttpRequest) -\u003e serde_json::Value {\n    let raw_cookie_data = req.cookie(\"vouchrs_session\").map(|cookie| {\n        let cookie_value = cookie.value();\n        serde_json::json!({\n            \"raw_encrypted_data\": cookie_value,\n            \"cookie_length\": cookie_value.len(),\n            \"cookie_preview\": format!(\"{}...{}\",\n                \u0026cookie_value[..std::cmp::min(50, cookie_value.len())],\n                if cookie_value.len() \u003e 100 {\n                    \u0026cookie_value[cookie_value.len()-20..]\n                } else {\n                    \"\"\n                }\n            ),\n            \"note\": \"Cookie found but session is invalid, expired, or failed to decrypt\"\n        })\n    });\n\n    serde_json::json!({\n        \"error\": \"No session\",\n        \"message\": \"No valid session found\",\n        \"cookie_analysis\": {\n            \"decryption_successful\": false,\n            \"session_cookie_found\": raw_cookie_data.is_some(),\n            \"raw_cookie_data\": raw_cookie_data,\n            \"possible_reasons\": [\n                \"Session expired\",\n                \"Cookie decryption failed (wrong key)\",\n                \"Cookie corrupted or invalid format\",\n                \"No session cookie present\"\n            ]\n        },\n        \"debug_info\": {\n            \"timestamp\": chrono::Utc::now(),\n            \"has_cookies\": req.cookies().map(|cookies| !cookies.is_empty()).unwrap_or(false)\n        }\n    })\n}\n\nfn create_session_error_response(\n    req: \u0026HttpRequest,\n    error: \u0026dyn std::fmt::Display,\n) -\u003e serde_json::Value {\n    let raw_cookie_data = req.cookie(\"vouchrs_session\").map(|cookie| {\n        let cookie_value = cookie.value();\n        serde_json::json!({\n            \"raw_encrypted_data\": cookie_value,\n            \"cookie_length\": cookie_value.len(),\n            \"cookie_preview\": format!(\"{}...{}\",\n                \u0026cookie_value[..std::cmp::min(50, cookie_value.len())],\n                if cookie_value.len() \u003e 100 {\n                    \u0026cookie_value[cookie_value.len()-20..]\n                } else {\n                    \"\"\n                }\n            ),\n            \"note\": \"Cookie found but decryption/validation failed\"\n        })\n    });\n\n    serde_json::json!({\n        \"error\": \"Session error\",\n        \"message\": format!(\"Error retrieving session: {}\", error),\n        \"cookie_analysis\": {\n            \"decryption_successful\": false,\n            \"session_cookie_found\": raw_cookie_data.is_some(),\n            \"raw_cookie_data\": raw_cookie_data,\n            \"error_details\": format!(\"{}\", error)\n        },\n        \"debug_info\": {\n            \"timestamp\": chrono::Utc::now()\n        }\n    })\n}\n","traces":[{"line":10,"address":[3777120],"length":1,"stats":{"Line":0}},{"line":18,"address":[3024691,3024944,3025854,3024584,3025882],"length":1,"stats":{"Line":0}},{"line":19,"address":[3025042,3024960],"length":1,"stats":{"Line":0}},{"line":20,"address":[3025541,3025832,3025222,3025331,3025860,3025007],"length":1,"stats":{"Line":0}},{"line":24,"address":[4086449,4083920,4083178,4084884,4084046,4083825,4083947],"length":1,"stats":{"Line":0}},{"line":25,"address":[3364863],"length":1,"stats":{"Line":0}},{"line":26,"address":[3026304,3026217,3026332],"length":1,"stats":{"Line":0}},{"line":32,"address":[4084750,4084626,4084338],"length":1,"stats":{"Line":0}},{"line":34,"address":[3265170],"length":1,"stats":{"Line":0}},{"line":35,"address":[3365616,3364818,3365644],"length":1,"stats":{"Line":0}},{"line":36,"address":[3027220,3027804,3027271,3026930,3028308],"length":1,"stats":{"Line":0}},{"line":39,"address":[3366493],"length":1,"stats":{"Line":0}},{"line":49,"address":[3777168],"length":1,"stats":{"Line":0}},{"line":55,"address":[3267744,3268059,3267963,3267841],"length":1,"stats":{"Line":0}},{"line":56,"address":[4093920,4093904],"length":1,"stats":{"Line":0}},{"line":58,"address":[3367643,3367538,3367700],"length":1,"stats":{"Line":0}},{"line":60,"address":[4087089],"length":1,"stats":{"Line":0}},{"line":61,"address":[3268119,3268198,3268226],"length":1,"stats":{"Line":0}},{"line":62,"address":[3268538,3269531,3268838,3268204,3268904,3268607,3268500,3269569,3268449],"length":1,"stats":{"Line":0}},{"line":68,"address":[3030639,3029076,3030501],"length":1,"stats":{"Line":0}},{"line":69,"address":[3030676],"length":1,"stats":{"Line":0}},{"line":71,"address":[3031507,3030780,3031431],"length":1,"stats":{"Line":0}},{"line":73,"address":[3370267],"length":1,"stats":{"Line":0}},{"line":75,"address":[3372289,3372546,3370373,3371164,3371418,3372476,3371847,3371094,3370322,3370910,3371923,3370843,3373598,3370545,3370411,3371992,3370615,3372730,3370469,3371348,3372223,3372792,3371792],"length":1,"stats":{"Line":0}},{"line":86,"address":[3273141],"length":1,"stats":{"Line":0}},{"line":90,"address":[3273728,3273554,3273617],"length":1,"stats":{"Line":0}},{"line":93,"address":[3369672,3369571,3369644],"length":1,"stats":{"Line":0}},{"line":94,"address":[4089231,4088994,4089302],"length":1,"stats":{"Line":0}},{"line":96,"address":[3369350],"length":1,"stats":{"Line":0}},{"line":97,"address":[3030594,3035008,3035036],"length":1,"stats":{"Line":0}},{"line":98,"address":[3374190,3373902,3374276],"length":1,"stats":{"Line":0}},{"line":103,"address":[3557504,3561089,3560902],"length":1,"stats":{"Line":0}},{"line":104,"address":[2511838],"length":1,"stats":{"Line":0}},{"line":105,"address":[3275070,3275170],"length":1,"stats":{"Line":0}},{"line":106,"address":[4095885,4094170,4095913,4094777,4094514,4095309,4094568],"length":1,"stats":{"Line":0}},{"line":108,"address":[3375216,3375142],"length":1,"stats":{"Line":0}},{"line":109,"address":[3375699,3375849,3375578],"length":1,"stats":{"Line":0}},{"line":110,"address":[3375405,3375482],"length":1,"stats":{"Line":0}},{"line":111,"address":[3375605,3375669,3375844],"length":1,"stats":{"Line":0}},{"line":112,"address":[3276099,3276039],"length":1,"stats":{"Line":0}},{"line":114,"address":[3375644],"length":1,"stats":{"Line":0}},{"line":121,"address":[2514707,2511964,2515108,2512863,2514593,2514211,2513040,2512121,2513253,2512537,2512331,2514358,2512793,2515080,2512012],"length":1,"stats":{"Line":0}},{"line":126,"address":[3727886,3727821],"length":1,"stats":{"Line":0}},{"line":136,"address":[3729443],"length":1,"stats":{"Line":0}},{"line":137,"address":[3729686,3729746],"length":1,"stats":{"Line":0}},{"line":142,"address":[3780816,3783726,3783886],"length":1,"stats":{"Line":0}},{"line":146,"address":[4096000,4097891,4097963],"length":1,"stats":{"Line":0}},{"line":147,"address":[3037742,3037842],"length":1,"stats":{"Line":0}},{"line":148,"address":[3277576,3277178,3277522,3277785,3278317,3278893,3278921],"length":1,"stats":{"Line":0}},{"line":150,"address":[3277494,3277568],"length":1,"stats":{"Line":0}},{"line":151,"address":[3278051,3277930,3278201],"length":1,"stats":{"Line":0}},{"line":152,"address":[3038429,3038506],"length":1,"stats":{"Line":0}},{"line":153,"address":[4097172,4096933,4096997],"length":1,"stats":{"Line":0}},{"line":154,"address":[3278083,3278023],"length":1,"stats":{"Line":0}},{"line":156,"address":[3377628],"length":1,"stats":{"Line":0}},{"line":163,"address":[2516263,2515830,2516977,2516766,2517703,2515622,2516589,2515513,2518158,2516519,2515990,2517137,2518130,2515997,2517556,2515465,2517144],"length":1,"stats":{"Line":0}},{"line":165,"address":[3781394,3781326],"length":1,"stats":{"Line":0}},{"line":168,"address":[2516508,2516564],"length":1,"stats":{"Line":0}},{"line":170,"address":[3732124,3732192],"length":1,"stats":{"Line":0}},{"line":173,"address":[3732866],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":60},{"path":["/","workspaces","vouchrs","src","handlers","mod.rs"],"content":"// HTTP request handlers for OAuth proxy\npub mod auth;\npub mod callback;\npub mod debug;\npub mod static_files;\npub mod proxy_upstream;\n\n#[cfg(test)]\nmod tests;\n\n// Re-export the main handler functions\npub use auth::{oauth_sign_in, oauth_sign_out};\npub use callback::oauth_callback;\npub use debug::{oauth_debug, oauth_userinfo};\npub use static_files::{health, serve_static};\npub use proxy_upstream::proxy_upstream;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","handlers","proxy_upstream.rs"],"content":"use actix_web::{web, HttpRequest, HttpResponse, Result as ActixResult};\nuse reqwest::Client;\nuse std::collections::HashMap;\n\nuse crate::{\n    models::VouchrsSession,\n    oauth::{check_and_refresh_tokens, OAuthConfig},\n    session::SessionManager,\n    settings::VouchrsSettings,\n    utils::response_builder::{is_hop_by_hop_header, ResponseBuilder},\n    utils::user_agent::is_browser_request,\n};\n\n/// HTTP client for making upstream requests\nstatic CLIENT: std::sync::LazyLock\u003cClient\u003e = std::sync::LazyLock::new(Client::new);\n\n/// Generic catch-all proxy handler that forwards requests as-is to upstream\n/// Proxy requests with authentication\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Authentication fails (missing or invalid session)\n/// - Request building fails\n/// - Upstream server is unreachable\n#[allow(clippy::implicit_hasher)]\npub async fn proxy_upstream(\n    req: HttpRequest,\n    query_params: web::Query\u003cHashMap\u003cString, String\u003e\u003e,\n    body: web::Bytes,\n    session_manager: web::Data\u003cSessionManager\u003e,\n    settings: web::Data\u003cVouchrsSettings\u003e,\n    oauth_config: web::Data\u003cOAuthConfig\u003e,\n) -\u003e ActixResult\u003cHttpResponse\u003e {\n    // Extract and validate session from encrypted cookie\n    let session = match extract_session_from_request(\u0026req, \u0026session_manager) {\n        Ok(session) =\u003e session,\n        Err(response) =\u003e return Ok(response),\n    };\n\n    // Check and refresh tokens if necessary\n    let _tokens =\n        match check_and_refresh_tokens(session.clone(), \u0026oauth_config, \u0026session.provider).await {\n            Ok(tokens) =\u003e tokens,\n            Err(response) =\u003e return Ok(response),\n        };\n\n    // Build and execute upstream request\n    let upstream_url =\n        match ResponseBuilder::build_upstream_url(\u0026settings.proxy.upstream_url, req.path()) {\n            Ok(url) =\u003e url,\n            Err(response) =\u003e return Ok(response),\n        };\n\n    let upstream_response =\n        match execute_upstream_request(\u0026req, \u0026query_params, \u0026body, \u0026upstream_url).await {\n            Ok(response) =\u003e response,\n            Err(response) =\u003e return Ok(response),\n        };\n\n    // Forward upstream response back to client\n    forward_upstream_response(upstream_response, \u0026req, \u0026settings).await\n}\n\n/// Execute the upstream request with proper headers and body\n/// \n/// # Errors\n/// \n/// Returns an `HttpResponse` error if:\n/// - HTTP method conversion fails\n/// - Upstream request fails\nasync fn execute_upstream_request(\n    req: \u0026HttpRequest,\n    query_params: \u0026web::Query\u003cHashMap\u003cString, String\u003e\u003e,\n    body: \u0026web::Bytes,\n    upstream_url: \u0026str,\n) -\u003e Result\u003creqwest::Response, HttpResponse\u003e {\n    let reqwest_method = ResponseBuilder::convert_http_method(req.method())?;\n\n    let mut request_builder = CLIENT\n        .request(reqwest_method, upstream_url)\n        .header(\"User-Agent\", \"Vouchrs-Proxy/1.0\");\n\n    // Forward headers, query params, and body\n    request_builder = ResponseBuilder::forward_request_headers(request_builder, req);\n    request_builder = ResponseBuilder::forward_query_parameters(request_builder, query_params);\n    request_builder = ResponseBuilder::forward_request_body(request_builder, body);\n\n    // Execute the request\n    request_builder.send().await.map_err(|err| {\n        // Return a simple error response\n        HttpResponse::BadGateway().json(serde_json::json!({\n            \"error\": \"upstream_error\",\n            \"message\": format!(\"Failed to reach upstream service: {err}\")\n        }))\n    })\n}\n\n// Functions have been moved to ResponseBuilder\n\n/// Forward upstream response back to client, handling 401/403 redirects for browsers\n/// \n/// # Errors\n/// \n/// Returns an error if reading the upstream response body fails\nasync fn forward_upstream_response(\n    upstream_response: reqwest::Response,\n    req: \u0026HttpRequest,\n    settings: \u0026VouchrsSettings,\n) -\u003e ActixResult\u003cHttpResponse\u003e {\n    let status_code = upstream_response.status();\n\n    // Check if this is a 401 Unauthorized response\n    if status_code == reqwest::StatusCode::UNAUTHORIZED {\n        // Determine if this is a browser request \n        if is_browser_request(req) {\n            // Redirect browser requests to sign-in page\n            let sign_in_url = format!(\"{}/oauth2/sign_in\", settings.application.redirect_base_url);\n            return Ok(HttpResponse::Found()\n                .insert_header((\"Location\", sign_in_url.clone()))\n                .json(serde_json::json!({\n                    \"error\": \"authentication_required\",\n                    \"message\": \"Authentication required. Redirecting to sign-in page.\",\n                    \"redirect_url\": sign_in_url\n                })));\n        }\n        // For non-browser requests, return 401 with JSON error\n        return Ok(HttpResponse::Unauthorized().json(serde_json::json!({\n            \"error\": \"unauthorized\",\n            \"message\": \"Authentication required. Please obtain a valid session cookie or bearer token.\"\n        })));\n    }\n\n    // For all other status codes, forward the response as-is\n    let actix_status = actix_web::http::StatusCode::from_u16(status_code.as_u16())\n        .unwrap_or(actix_web::http::StatusCode::INTERNAL_SERVER_ERROR);\n\n    let mut response_builder = HttpResponse::build(actix_status);\n\n    // Forward relevant headers (excluding hop-by-hop headers)\n    for (name, value) in upstream_response.headers() {\n        let name_str = name.as_str().to_lowercase();\n        if !is_hop_by_hop_header(\u0026name_str) {\n            if let Ok(value_str) = value.to_str() {\n                response_builder.insert_header((name.as_str(), value_str));\n            }\n        }\n    }\n\n    // Get response body\n    let response_body = upstream_response.bytes().await.map_err(|err| {\n        actix_web::error::ErrorBadGateway(format!(\"Failed to read upstream response: {err}\"))\n    })?;\n\n    Ok(response_builder.body(response_body))\n}\n\n/// Extract and validate session from encrypted cookie\n/// \n/// # Errors\n/// \n/// Returns an `HttpResponse` error if:\n/// - No session cookie is found\n/// - Session is invalid or expired\nfn extract_session_from_request(\n    req: \u0026HttpRequest,\n    session_manager: \u0026SessionManager,\n) -\u003e Result\u003cVouchrsSession, HttpResponse\u003e {\n    // Helper function to handle authentication errors\n    let handle_auth_error = |message: \u0026str| {\n        if is_browser_request(req) {\n            // For browser requests, redirect to sign-in page\n            let sign_in_url = \"/oauth2/sign_in\";\n            HttpResponse::Found()\n                .insert_header((\"Location\", sign_in_url))\n                .finish()\n        } else {\n            // For non-browser requests, return JSON error\n            HttpResponse::Unauthorized().json(serde_json::json!({\n                \"error\": \"unauthorized\",\n                \"message\": message\n            }))\n        }\n    };\n\n    // Extract session cookie\n    let cookie = req\n        .cookie(\"vouchrs_session\")\n        .ok_or_else(|| handle_auth_error(\"No session cookie found. Please authenticate first.\"))?;\n\n    // Decrypt and validate session\n    session_manager.decrypt_and_validate_session(cookie.value()).map_or_else(|_| Err(handle_auth_error(\n        \"Session is invalid or expired. Please authenticate again.\",\n    )), Ok)\n}\n\n// is_hop_by_hop_header function has been moved to utils::response_builder\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::test_helpers::create_test_settings;\n    use crate::utils::test_request_builder::TestRequestBuilder;\n    use crate::utils::user_agent::{derive_platform_from_user_agent, extract_user_agent_info};\n\n    #[test]\n    fn test_hop_by_hop_headers() {\n        use crate::utils::response_builder::is_hop_by_hop_header;\n        assert!(is_hop_by_hop_header(\"connection\"));\n        assert!(is_hop_by_hop_header(\"transfer-encoding\"));\n        assert!(!is_hop_by_hop_header(\"content-type\"));\n        assert!(!is_hop_by_hop_header(\"authorization\"));\n    }\n\n    #[test]\n    fn test_user_agent_extraction() {\n        // Test with modern client hints headers\n        let req = TestRequestBuilder::client_hints_request();\n\n        let user_agent_info = extract_user_agent_info(\u0026req);\n\n        assert_eq!(\n            user_agent_info.user_agent,\n            Some(\"\\\"Google Chrome\\\";v=\\\"91\\\", \\\"Chromium\\\";v=\\\"91\\\"\".to_string())\n        );\n        assert_eq!(user_agent_info.platform, Some(\"Windows\".to_string()));\n        assert_eq!(user_agent_info.lang, Some(\"en-US\".to_string()));\n        assert_eq!(user_agent_info.mobile, 0);\n\n        // Test with fallback to User-Agent header\n        let req = TestRequestBuilder::macos_french_request();\n\n        let user_agent_info = extract_user_agent_info(\u0026req);\n\n        assert_eq!(\n            user_agent_info.user_agent,\n            Some(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\".to_string())\n        );\n        assert_eq!(user_agent_info.platform, Some(\"macOS\".to_string())); // Derived from User-Agent\n        assert_eq!(user_agent_info.lang, Some(\"fr-FR\".to_string()));\n        assert_eq!(user_agent_info.mobile, 0); // Default when not specified\n    }\n\n    #[test]\n    fn test_platform_derivation_from_user_agent() {\n        // Test Windows detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Windows NT 10.0; Win64; x64)\"),\n            \"Windows\".to_string()\n        );\n\n        // Test macOS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)\"),\n            \"macOS\".to_string()\n        );\n\n        // Test Linux detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (X11; Linux x86_64)\"),\n            \"Linux\".to_string()\n        );\n\n        // Test Android detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Linux; Android 11; SM-G991B)\"),\n            \"Android\".to_string()\n        );\n\n        // Test iOS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\n                \"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)\"\n            ),\n            \"iOS\".to_string()\n        );\n\n        // Test Chrome OS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (X11; CrOS x86_64 14541.0.0)\"),\n            \"Chrome OS\".to_string()\n        );\n\n        // Test unknown platform - now returns \"Unknown\" instead of None\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Unknown Platform)\"),\n            \"Unknown\".to_string()\n        );\n    }\n\n    #[tokio::test]\n    async fn test_401_redirect_for_browser_requests() {\n        // Test browser request (Accept: text/html)\n        let browser_req = TestRequestBuilder::browser_request();\n\n        let settings = create_test_settings();\n\n        // Test that browser requests are properly detected\n        assert!(\n            is_browser_request(\u0026browser_req),\n            \"Should detect browser request\"\n        );\n\n        // Test API request (Accept: application/json)\n        let api_req = TestRequestBuilder::api_request();\n\n        assert!(!is_browser_request(\u0026api_req), \"Should detect API request\");\n\n        // Test that the redirect URL is properly constructed\n        let expected_redirect_url =\n            format!(\"{}/oauth2/sign_in\", settings.application.redirect_base_url);\n        assert_eq!(\n            expected_redirect_url,\n            \"http://localhost:8080/oauth2/sign_in\"\n        );\n    }\n\n    #[test]\n    fn test_browser_detection() {\n        // Test browser detection with Accept: text/html\n        let browser_req = TestRequestBuilder::browser_request();\n        assert!(is_browser_request(\u0026browser_req));\n\n        // Test API client detection with Accept: application/json\n        let api_req = TestRequestBuilder::api_request();\n        assert!(!is_browser_request(\u0026api_req));\n\n        // Test browser detection via User-Agent fallback\n        let browser_ua_req = TestRequestBuilder::user_agent_request(\n            \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n        );\n        assert!(is_browser_request(\u0026browser_ua_req));\n\n        // Test API client via User-Agent\n        let api_ua_req = TestRequestBuilder::user_agent_request(\"curl/7.68.0\");\n        assert!(!is_browser_request(\u0026api_ua_req));\n\n        // Test unknown client (no Accept or User-Agent)\n        let unknown_req = TestRequestBuilder::empty_request();\n        assert!(!is_browser_request(\u0026unknown_req));\n    }\n\n    #[test]\n    fn test_sign_in_url_generation() {\n        let settings = create_test_settings();\n        let expected_url = format!(\"{}/oauth2/sign_in\", settings.application.redirect_base_url);\n        assert_eq!(expected_url, \"http://localhost:8080/oauth2/sign_in\");\n    }\n\n    #[tokio::test]\n    async fn test_cookie_filtering() {\n        // Create a mock HTTP request with cookies\n        let cookies =\n            \"vouchrs_session=test_session_value; another_cookie=value; third_cookie=value3\";\n        let req = TestRequestBuilder::with_cookies(cookies);\n\n        // Create a reqwest RequestBuilder\n        let client = Client::new();\n        let request_builder = client.get(\"http://example.com\");\n\n        // Apply header forwarding\n        let modified_builder = ResponseBuilder::forward_request_headers(request_builder, \u0026req);\n\n        // Since we can't inspect the actual headers directly in the builder,\n        // we need to convert it to a request and check the headers\n        let request = modified_builder.build().expect(\"Failed to build request\");\n        let headers = request.headers();\n\n        // Check that the Cookie header exists but doesn't contain vouchrs_session\n        if let Some(cookie_header) = headers.get(reqwest::header::COOKIE) {\n            let cookie_str = cookie_header\n                .to_str()\n                .expect(\"Failed to convert cookie header to string\");\n            assert!(\n                !cookie_str.contains(\"vouchrs_session=\"),\n                \"Cookie header should not contain vouchrs_session\"\n            );\n            assert!(\n                cookie_str.contains(\"another_cookie=value\"),\n                \"Cookie header should contain other cookies\"\n            );\n            assert!(\n                cookie_str.contains(\"third_cookie=value3\"),\n                \"Cookie header should contain other cookies\"\n            );\n        } else {\n            panic!(\"Cookie header is missing\");\n        }\n    }\n}\n","traces":[{"line":27,"address":[3842464],"length":1,"stats":{"Line":0}},{"line":36,"address":[3240702,3240506],"length":1,"stats":{"Line":0}},{"line":37,"address":[3240841],"length":1,"stats":{"Line":0}},{"line":38,"address":[3335040],"length":1,"stats":{"Line":0}},{"line":42,"address":[3241437,3241065,3241035,3241251,3241613,3241545,3240588],"length":1,"stats":{"Line":0}},{"line":44,"address":[3336252],"length":1,"stats":{"Line":0}},{"line":45,"address":[3070800],"length":1,"stats":{"Line":0}},{"line":49,"address":[4047006,4047099],"length":1,"stats":{"Line":0}},{"line":51,"address":[3336784],"length":1,"stats":{"Line":0}},{"line":52,"address":[3242471],"length":1,"stats":{"Line":0}},{"line":55,"address":[3337165,3334865,3336854,3337000],"length":1,"stats":{"Line":0}},{"line":57,"address":[4048266],"length":1,"stats":{"Line":0}},{"line":58,"address":[3337410],"length":1,"stats":{"Line":0}},{"line":62,"address":[3338590,3337723,3334886,3337784,3337974],"length":1,"stats":{"Line":0}},{"line":72,"address":[3892528],"length":1,"stats":{"Line":0}},{"line":78,"address":[3074103,3074212],"length":1,"stats":{"Line":0}},{"line":80,"address":[4050724,4050599],"length":1,"stats":{"Line":0}},{"line":81,"address":[3340124],"length":1,"stats":{"Line":0}},{"line":85,"address":[3246020],"length":1,"stats":{"Line":0}},{"line":86,"address":[3340380],"length":1,"stats":{"Line":0}},{"line":87,"address":[4051047],"length":1,"stats":{"Line":0}},{"line":90,"address":[3340652,3342191,3340594,3342219,3341168,3339684,3341127,3340886],"length":1,"stats":{"Line":0}},{"line":92,"address":[3247941,3247533,3247060,3246934,3247389,3247015,3247560,3247913,3247173],"length":1,"stats":{"Line":0}},{"line":94,"address":[3247365,3247433],"length":1,"stats":{"Line":0}},{"line":106,"address":[3824960],"length":1,"stats":{"Line":0}},{"line":111,"address":[3077062,3076908],"length":1,"stats":{"Line":0}},{"line":114,"address":[3342681],"length":1,"stats":{"Line":0}},{"line":116,"address":[3248512,3249604],"length":1,"stats":{"Line":0}},{"line":118,"address":[3249637,3250603],"length":1,"stats":{"Line":0}},{"line":119,"address":[3079513,3080416,3079307],"length":1,"stats":{"Line":0}},{"line":120,"address":[4055650,4055582],"length":1,"stats":{"Line":0}},{"line":121,"address":[3345189,3345303,3345600,3345234,3345857,3346260,3345787,3345534],"length":1,"stats":{"Line":0}},{"line":128,"address":[3249829,3249760,3249610,3250539,3250126,3250060,3249722,3249671],"length":1,"stats":{"Line":0}},{"line":135,"address":[3248541,3248474],"length":1,"stats":{"Line":0}},{"line":138,"address":[3077242],"length":1,"stats":{"Line":0}},{"line":141,"address":[3077356,3077267],"length":1,"stats":{"Line":0}},{"line":142,"address":[3343203,3343455],"length":1,"stats":{"Line":0}},{"line":143,"address":[4054113,4054042],"length":1,"stats":{"Line":0}},{"line":144,"address":[3077955,3078008],"length":1,"stats":{"Line":0}},{"line":145,"address":[3343730],"length":1,"stats":{"Line":0}},{"line":151,"address":[3249089,3248345,3252116,3248973,3253298,3252434,3253292,3253072],"length":1,"stats":{"Line":0}},{"line":152,"address":[3081657,3081705],"length":1,"stats":{"Line":0}},{"line":155,"address":[3252535,3252658],"length":1,"stats":{"Line":0}},{"line":165,"address":[3825497,3825491,3825056],"length":1,"stats":{"Line":0}},{"line":170,"address":[3842838],"length":1,"stats":{"Line":0}},{"line":171,"address":[3081934],"length":1,"stats":{"Line":0}},{"line":173,"address":[3347603],"length":1,"stats":{"Line":0}},{"line":174,"address":[3082840,3082081,3081997],"length":1,"stats":{"Line":0}},{"line":175,"address":[3253460],"length":1,"stats":{"Line":0}},{"line":179,"address":[3347659,3348170,3347954,3348450,3348478,3347841],"length":1,"stats":{"Line":0}},{"line":187,"address":[3825099,3825246],"length":1,"stats":{"Line":0}},{"line":189,"address":[3348592,3348609],"length":1,"stats":{"Line":0}},{"line":192,"address":[3348753,3348656,3348682,3348792,3348798],"length":1,"stats":{"Line":0}},{"line":194,"address":[3254455,3254512],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":54},{"path":["/","workspaces","vouchrs","src","handlers","static_files.rs"],"content":"use crate::models::HealthResponse;\nuse crate::settings::VouchrsSettings;\nuse actix_web::{web, HttpResponse, Result};\nuse log::debug;\nuse std::fs;\n\n/// Health check endpoint\n/// \n/// # Errors\n/// Returns an error if health status cannot be determined\npub async fn health() -\u003e Result\u003cHttpResponse\u003e {\n    let response = HealthResponse {\n        status: \"ok\".to_string(),\n        message: \"Vouchrs OIDC Reverse Proxy is running\".to_string(),\n    };\n    Ok(HttpResponse::Ok().json(response))\n}\n\n/// Serve static files from the configured static directory\n///\n/// # Errors\n///\n/// Returns an error if:\n/// - The requested file cannot be read\n/// - The file path is invalid\npub async fn serve_static(\n    path: web::Path\u003cString\u003e,\n    settings: web::Data\u003cVouchrsSettings\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    let filename = path.into_inner();\n    let file_path = format!(\"{}/{}\", settings.static_files.assets_folder, filename);\n\n    debug!(\"Attempting to serve static file: {file_path}\");\n\n    fs::read(\u0026file_path).map_or_else(|_| {\n        debug!(\"Static file not found: {file_path}\");\n        Ok(HttpResponse::NotFound().json(serde_json::json!({\n            \"error\": \"not_found\",\n            \"message\": \"File not found\"\n        })))\n    }, |contents| {\n        let content_type = match file_path.split('.').next_back() {\n            Some(\"html\") =\u003e \"text/html\",\n            Some(\"css\") =\u003e \"text/css\",\n            Some(\"js\") =\u003e \"application/javascript\",\n            Some(\"png\") =\u003e \"image/png\",\n            Some(\"jpg\" | \"jpeg\") =\u003e \"image/jpeg\",\n            Some(\"gif\") =\u003e \"image/gif\",\n            Some(\"svg\") =\u003e \"image/svg+xml\",\n            Some(\"ico\") =\u003e \"image/x-icon\",\n            _ =\u003e \"text/plain\",\n        };\n\n        Ok(HttpResponse::Ok().content_type(content_type).body(contents))\n    })\n}\n\n// Helper function to get sign-in page HTML (reused from original handlers)\n#[must_use]\npub fn get_sign_in_page(settings: \u0026VouchrsSettings) -\u003e String {\n    let html_path = format!(\"{}/sign-in.html\", settings.static_files.assets_folder);\n    std::fs::read_to_string(\u0026html_path).unwrap_or_else(|_| generate_dynamic_sign_in_page(settings))\n}\n\n// Generate dynamic sign-in page with providers from configuration\n#[must_use]\npub fn generate_dynamic_sign_in_page(settings: \u0026VouchrsSettings) -\u003e String {\n    let provider_buttons = generate_provider_buttons(settings);\n    let brand_name = settings.application.redirect_base_url.clone();\n    \n    format!(\n        r#\"\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"UTF-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e\n    \u003ctitle\u003eSign In - {brand_name}\u003c/title\u003e\n    \u003cstyle\u003e{}\u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"login-box\"\u003e\n            \u003ch1\u003eSign In\u003c/h1\u003e\n            \u003cp\u003eChoose your authentication provider\u003c/p\u003e\n            \u003cdiv class=\"button-container\"\u003e\n                {provider_buttons}\n            \u003c/div\u003e\n            \u003cdiv class=\"footer\"\u003e\n                \u003cp\u003eProtected by \u003ca href=\"https://github.com/vouchrs/vouchrs\" target=\"_blank\"\u003eVouchrs\u003c/a\u003e\u003c/p\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\"#,\n        get_sign_in_styles(),\n        brand_name = brand_name,\n        provider_buttons = provider_buttons\n    )\n}\n\nfn generate_provider_buttons(settings: \u0026VouchrsSettings) -\u003e String {\n    settings\n        .get_enabled_providers()\n        .iter()\n        .map(|provider| {\n            let display_name = provider.display_name.as_ref()\n                .unwrap_or(\u0026provider.name)\n                .clone();\n            let provider_class = format!(\"provider-{}\", provider.name.to_lowercase());\n            format!(\n                r#\"\u003ca href=\"/oauth2/sign_in?provider={}\" class=\"provider-button {}\"\u003e\n                    \u003cspan\u003eContinue with {}\u003c/span\u003e\n                \u003c/a\u003e\"#,\n                provider.name, provider_class, display_name\n            )\n        })\n        .collect::\u003cVec\u003c_\u003e\u003e()\n        .join(\"\\n                \")\n}\n\n#[allow(clippy::too_many_lines)]\nconst fn get_sign_in_styles() -\u003e \u0026'static str {\n    r\"\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        \n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n            min-height: 100vh;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n        }\n        \n        .container {\n            width: 100%;\n            max-width: 400px;\n        }\n        \n        .login-box {\n            background: white;\n            border-radius: 10px;\n            box-shadow: 0 14px 28px rgba(0,0,0,0.12), 0 10px 10px rgba(0,0,0,0.08);\n            padding: 40px;\n        }\n        \n        h1 {\n            color: #333;\n            font-size: 28px;\n            font-weight: 600;\n            text-align: center;\n            margin-bottom: 10px;\n        }\n        \n        p {\n            color: #666;\n            text-align: center;\n            margin-bottom: 30px;\n        }\n        \n        .button-container {\n            display: flex;\n            flex-direction: column;\n            gap: 15px;\n            margin-bottom: 30px;\n        }\n        \n        .provider-button {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 12px 20px;\n            border-radius: 6px;\n            text-decoration: none;\n            font-weight: 500;\n            font-size: 16px;\n            transition: all 0.3s ease;\n            border: 2px solid transparent;\n        }\n        \n        .provider-button:hover {\n            transform: translateY(-1px);\n            box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n        }\n        \n        /* Provider-specific colors */\n        .provider-google {\n            background: #4285f4;\n            color: white;\n        }\n        \n        .provider-google:hover {\n            background: #3367d6;\n        }\n        \n        .provider-github {\n            background: #24292e;\n            color: white;\n        }\n        \n        .provider-github:hover {\n            background: #1a1e22;\n        }\n        \n        .provider-microsoft {\n            background: #0078d4;\n            color: white;\n        }\n        \n        .provider-microsoft:hover {\n            background: #0063b1;\n        }\n        \n        .provider-apple {\n            background: #000;\n            color: white;\n        }\n        \n        .provider-apple:hover {\n            background: #333;\n        }\n        \n        /* Generic provider style */\n        .provider-button:not(.provider-google):not(.provider-github):not(.provider-microsoft):not(.provider-apple) {\n            background: #6366f1;\n            color: white;\n        }\n        \n        .provider-button:not(.provider-google):not(.provider-github):not(.provider-microsoft):not(.provider-apple):hover {\n            background: #5558e3;\n        }\n        \n        .footer {\n            text-align: center;\n            padding-top: 20px;\n            border-top: 1px solid #e9ecef;\n        }\n        \n        .footer p {\n            color: #999;\n            font-size: 14px;\n            margin: 0;\n        }\n        \n        .footer a {\n            color: #6366f1;\n            text-decoration: none;\n        }\n        \n        .footer a:hover {\n            text-decoration: underline;\n        }\n        \n        @media (max-width: 480px) {\n            .login-box {\n                padding: 30px 20px;\n            }\n            \n            h1 {\n                font-size: 24px;\n            }\n        }\n    \"\n}\n","traces":[{"line":11,"address":[3135776,3135866,3136392,3135888,3135805],"length":1,"stats":{"Line":0}},{"line":13,"address":[3055118],"length":1,"stats":{"Line":0}},{"line":14,"address":[3055211],"length":1,"stats":{"Line":0}},{"line":16,"address":[3136218,3136100,3136040],"length":1,"stats":{"Line":0}},{"line":26,"address":[3325648],"length":1,"stats":{"Line":0}},{"line":30,"address":[3055812],"length":1,"stats":{"Line":0}},{"line":31,"address":[3836136,3836200],"length":1,"stats":{"Line":0}},{"line":33,"address":[3136864,3136954,3136990],"length":1,"stats":{"Line":0}},{"line":35,"address":[3836774,3838214,3836992,3838186,3836480],"length":1,"stats":{"Line":0}},{"line":36,"address":[3837116,3837144,3837019],"length":1,"stats":{"Line":0}},{"line":37,"address":[3838164,3838192,3837122,3837446,3837395,3837559,3837777],"length":1,"stats":{"Line":0}},{"line":41,"address":[3138720,3138601,3137551,3137882,3139835],"length":1,"stats":{"Line":0}},{"line":42,"address":[3058116,3058027],"length":1,"stats":{"Line":0}},{"line":43,"address":[3058217,3058280,3058319],"length":1,"stats":{"Line":0}},{"line":44,"address":[3139006,3139069,3139108],"length":1,"stats":{"Line":0}},{"line":45,"address":[3838658,3838697,3838595],"length":1,"stats":{"Line":0}},{"line":46,"address":[3458948,3459011,3459050],"length":1,"stats":{"Line":0}},{"line":47,"address":[3058493,3058556],"length":1,"stats":{"Line":0}},{"line":48,"address":[3058631,3058707],"length":1,"stats":{"Line":0}},{"line":49,"address":[3139493,3139454,3139394],"length":1,"stats":{"Line":0}},{"line":50,"address":[3839040,3838980],"length":1,"stats":{"Line":0}},{"line":51,"address":[3138970],"length":1,"stats":{"Line":0}},{"line":54,"address":[3459354,3459457],"length":1,"stats":{"Line":0}},{"line":60,"address":[3232249,3231984,3232255],"length":1,"stats":{"Line":0}},{"line":61,"address":[3232013],"length":1,"stats":{"Line":0}},{"line":62,"address":[3232133,3232199],"length":1,"stats":{"Line":0}},{"line":67,"address":[3326449,3326455,3325984],"length":1,"stats":{"Line":0}},{"line":68,"address":[3326019],"length":1,"stats":{"Line":0}},{"line":69,"address":[3326029],"length":1,"stats":{"Line":0}},{"line":71,"address":[4036241],"length":1,"stats":{"Line":0}},{"line":95,"address":[3232378,3232441],"length":1,"stats":{"Line":0}},{"line":101,"address":[3233113,3232768,3233119],"length":1,"stats":{"Line":0}},{"line":102,"address":[2589101,2589027,2589249],"length":1,"stats":{"Line":0}},{"line":105,"address":[3059977,3059983,3059264],"length":1,"stats":{"Line":0}},{"line":106,"address":[3459830,3459857],"length":1,"stats":{"Line":0}},{"line":107,"address":[3140046],"length":1,"stats":{"Line":0}},{"line":109,"address":[3059360,3059431],"length":1,"stats":{"Line":0}},{"line":110,"address":[3059697,3059760],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":38},{"path":["/","workspaces","vouchrs","src","handlers","tests.rs"],"content":"// Tests for handlers \nuse crate::session_builder::SessionBuilder;\nuse crate::utils::apple::{AppleUserInfo, AppleUserName};\nuse chrono::Utc;\n\n#[test]\nfn test_session_builder_with_apple_user_info_fallback() {\n    // Test SessionBuilder using Apple user info when ID token lacks name\n    let apple_user_info = AppleUserInfo {\n        name: AppleUserName {\n            first_name: Some(\"John\".to_string()),\n            last_name: Some(\"Doe\".to_string()),\n        },\n        email: Some(\"john.doe@example.com\".to_string()),\n    };\n    let id_token = Some(\"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiZW1haWwiOiJmYWxsYmFja0BleGFtcGxlLmNvbSJ9.invalid\".to_string());\n    let refresh_token = None;\n    let expires_at = Utc::now();\n    let result = SessionBuilder::build_session_with_apple_info(\n        \"apple\".to_string(),\n        id_token,\n        refresh_token,\n        expires_at,\n        Some(apple_user_info),\n    );\n\n    assert!(result.is_ok());\n    let session = result.unwrap();\n    assert_eq!(session.user_email, \"fallback@example.com\"); // From ID token\n    assert_eq!(session.user_name, Some(\"John Doe\".to_string())); // From Apple user info fallback\n    assert_eq!(session.provider_id, \"1234567890\");\n}\n\n#[test]\nfn test_session_builder_with_google_tokens() {\n    // Test SessionBuilder with Google-style ID tokens (name in 'name' field)\n    let id_token = Some(\"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiZW1haWwiOiJnb29nbGVAZXhhbXBsZS5jb20iLCJuYW1lIjoiR29vZ2xlIFVzZXIifQ.invalid\".to_string());\n    let refresh_token = None;\n    let expires_at = Utc::now();\n    let result =\n        SessionBuilder::build_session(\"google\".to_string(), id_token, refresh_token, expires_at);\n\n    assert!(result.is_ok());\n    let session = result.unwrap();\n    assert_eq!(session.user_email, \"google@example.com\");\n    assert_eq!(session.user_name, Some(\"Google User\".to_string()));\n    assert_eq!(session.provider_id, \"1234567890\");\n}\n\n#[test]\nfn test_session_builder_with_invalid_token() {\n    // Test SessionBuilder with actually invalid JWT token\n    let id_token = Some(\"completely.invalid.token\".to_string());\n    let refresh_token = None;\n    let expires_at = Utc::now();\n    let result =\n        SessionBuilder::build_session(\"test\".to_string(), id_token, refresh_token, expires_at);\n\n    // This should fail because the token format is invalid\n    assert!(result.is_err());\n    assert!(result.unwrap_err().contains(\"Base64 decode failed\"));\n}\n\n#[test]\nfn test_session_builder_without_id_token() {\n    // Test SessionBuilder when no ID token is provided\n    let id_token = None;\n    let refresh_token = None;\n    let expires_at = Utc::now();\n    let result =\n        SessionBuilder::build_session(\"test\".to_string(), id_token, refresh_token, expires_at);\n\n    // This should fail because no ID token is available\n    assert!(result.is_err());\n    assert!(result.unwrap_err().contains(\"No ID token available\"));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","lib.rs"],"content":"\n#![warn(clippy::pedantic)]\n#![warn(clippy::cargo)]\n#![deny(warnings)]\n#![allow(clippy::multiple_crate_versions)]\n\npub mod handlers;\npub mod models;\npub mod oauth;\npub mod session;\npub mod session_builder;\npub mod settings;\npub mod utils;\n\n// Re-export commonly used items\npub use handlers::{\n    health, oauth_callback, oauth_debug, oauth_sign_in, oauth_sign_out,\n    oauth_userinfo,\n};\npub use models::VouchrsSession;\npub use oauth::OAuthConfig;\npub use session::SessionManager;\npub use settings::VouchrsSettings;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","main.rs"],"content":"#![warn(clippy::pedantic)]\n#![warn(clippy::cargo)]\n#![deny(warnings)]\n#![allow(clippy::multiple_crate_versions)]\n\n\nuse actix_cors::Cors;\nuse actix_web::{middleware::Logger, web, App, HttpServer};\nuse vouchrs::{\n    handlers::{\n        health, oauth_callback, oauth_debug, oauth_sign_in, oauth_sign_out,\n        oauth_userinfo, serve_static, proxy_upstream\n    },\n    oauth::OAuthConfig,\n    session::SessionManager,\n    settings::VouchrsSettings,\n};\n\n#[actix_web::main]\nasync fn main() -\u003e std::io::Result\u003c()\u003e {\n    // Load configuration from Settings.toml and environment variables\n    // This also loads .env file and initializes the logger\n    let settings = VouchrsSettings::load()\n        .map_err(|e| std::io::Error::other(format!(\"Failed to load settings: {e}\")))?;\n\n    // Initialize OAuth configuration with config-driven providers\n    let mut oauth_config = OAuthConfig::new();\n    oauth_config\n        .initialize_from_settings(\u0026settings)\n        .await\n        .map_err(|e| {\n            std::io::Error::other(format!(\"Failed to initialize OAuth providers: {e}\"))\n        })?;\n\n    println!(\"âœ“ Using stateless sessions with encrypted cookies\");\n    start_server(oauth_config, settings).await\n}\n\n/// Start the server with stateless sessions\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Server binding fails\n/// - Server fails to start\nasync fn start_server(\n    oauth_config: OAuthConfig,\n    settings: VouchrsSettings,\n) -\u003e std::io::Result\u003c()\u003e {\n    let bind_address = settings.get_bind_address();\n    print_startup_info(\u0026bind_address, \"Stateless\", \u0026settings);\n\n    // Initialize session manager with encryption key from settings\n    let session_manager = SessionManager::new(\n        settings.session.session_secret.as_bytes(),\n        settings.cookies.secure,\n        settings.session.session_duration_hours,\n    );\n\n    // Configure CORS for SPAs\n    let cors_origins = settings.get_cors_origins();\n\n    HttpServer::new(move || {\n        let cors_origins = cors_origins.clone();\n        let cors = Cors::default()\n            .allowed_origin_fn(move |origin, _| {\n                cors_origins\n                    .iter()\n                    .any(|allowed| allowed == origin.to_str().unwrap_or(\"\"))\n            })\n            .allowed_methods(vec![\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"])\n            .allowed_headers(vec![\"Authorization\", \"Content-Type\", \"Accept\"])\n            .supports_credentials()\n            .max_age(3600);\n\n        App::new()\n            .app_data(web::Data::new(oauth_config.clone()))\n            .app_data(web::Data::new(settings.clone()))\n            .app_data(web::Data::new(session_manager.clone()))\n            .wrap(cors)\n            .wrap(Logger::default())\n            .configure(configure_services)\n    })\n    .bind(\u0026bind_address)?\n    .run()\n    .await\n}\n\nfn configure_services(cfg: \u0026mut web::ServiceConfig) {\n    cfg\n        // OAuth2 endpoints \n        .route(\"/oauth2/sign_in\", web::get().to(oauth_sign_in))\n        .route(\"/oauth2/sign_out\", web::get().to(oauth_sign_out))\n        .route(\"/oauth2/sign_out\", web::post().to(oauth_sign_out))\n        .route(\"/oauth2/callback\", web::get().to(oauth_callback))\n        .route(\"/oauth2/callback\", web::post().to(oauth_callback))\n        .route(\"/oauth2/debug\", web::get().to(oauth_debug))\n        .route(\"/oauth2/userinfo\", web::get().to(oauth_userinfo))\n        // Static files endpoint\n        .route(\"/oauth2/static/{filename:.*}\", web::get().to(serve_static))\n        // Health endpoint\n        .route(\"/ping\", web::get().to(health))\n        // Catch-all proxy for any other path - provider determined from session\n        .default_service(\n            web::route()\n                .guard(actix_web::guard::fn_guard(|req| {\n                    let path = req.head().uri.path();\n                    !path.starts_with(\"/oauth2\") \u0026\u0026 !path.starts_with(\"/ping\")\n                }))\n                .to(proxy_upstream),\n        );\n}\n\nfn print_startup_info(bind_address: \u0026str, session_backend: \u0026str, settings: \u0026VouchrsSettings) {\n    println!(\n        \"Starting Vouchrs OIDC Reverse Proxy on http://{bind_address}\"\n    );\n    println!(\"Session Backend: {session_backend}\");\n    println!();\n    println!(\"OAuth2 endpoints:\");\n    println!(\"  GET  /oauth2/sign_in  - Login/logout page\");\n    println!(\"  GET|POST /oauth2/sign_out - Clear session\");\n    println!(\"  GET|POST /oauth2/callback - OAuth callback (POST for Apple form_post)\");\n    println!();\n    println!(\"OAuth callback URL for identity providers:\");\n    println!(\n        \"  {}/oauth2/callback\",\n        settings.application.redirect_base_url\n    );\n    println!();\n    if session_backend == \"Stateless\" {\n        println!(\"Sidecar Proxy endpoints (with automatic OAuth token injection):\");\n        println!(\"  ALL {{any path}}                   - Proxy to upstream service as-is\");\n        println!(\"                                    (except /oauth2/* and /health)\");\n        println!(\n            \"                                    Upstream URL: {}\",\n            settings.proxy.upstream_url\n        );\n        println!();\n    }\n    println!(\"System endpoints:\");\n    println!(\"  GET  /ping            - Health check\");\n    println!(\"  GET  /oauth2/static/* - Static files (HTML, CSS, JS, images)\");\n    println!(\n        \"  Static files folder: {}\",\n        settings.static_files.assets_folder\n    );\n}\n","traces":[{"line":23,"address":[2631660,2631256,2631339,2631116],"length":1,"stats":{"Line":0}},{"line":24,"address":[2631323,2632640,2632670],"length":1,"stats":{"Line":0}},{"line":27,"address":[2631432],"length":1,"stats":{"Line":0}},{"line":28,"address":[2632364,2631496,2631978,2632071,2631598,2631919],"length":1,"stats":{"Line":0}},{"line":30,"address":[2631628,2631758,2631162,2631591,2631951],"length":1,"stats":{"Line":0}},{"line":31,"address":[2632880,2633077],"length":1,"stats":{"Line":0}},{"line":32,"address":[2632895,2632955],"length":1,"stats":{"Line":0}},{"line":35,"address":[2632097],"length":1,"stats":{"Line":0}},{"line":36,"address":[2792039],"length":1,"stats":{"Line":0}},{"line":46,"address":[2392896],"length":1,"stats":{"Line":0}},{"line":50,"address":[2627197],"length":1,"stats":{"Line":0}},{"line":51,"address":[2627321,2627411],"length":1,"stats":{"Line":0}},{"line":55,"address":[2627445],"length":1,"stats":{"Line":0}},{"line":56,"address":[2627487],"length":1,"stats":{"Line":0}},{"line":57,"address":[2627502],"length":1,"stats":{"Line":0}},{"line":61,"address":[2627528],"length":1,"stats":{"Line":0}},{"line":63,"address":[2628323,2627562,2627929,2630647,2628235,2628944,2628033,2628658,2630524],"length":1,"stats":{"Line":0}},{"line":64,"address":[2628974],"length":1,"stats":{"Line":0}},{"line":65,"address":[2629185,2629067,2629458,2629730,2629777],"length":1,"stats":{"Line":0}},{"line":66,"address":[2629127,2630688],"length":1,"stats":{"Line":0}},{"line":67,"address":[2630712],"length":1,"stats":{"Line":0}},{"line":69,"address":[2630768,2630782],"length":1,"stats":{"Line":0}},{"line":71,"address":[2629497,2629210,2629222,2630625],"length":1,"stats":{"Line":0}},{"line":72,"address":[2629535,2629769,2630603,2629523],"length":1,"stats":{"Line":0}},{"line":74,"address":[2629823],"length":1,"stats":{"Line":0}},{"line":76,"address":[2630123,2630263,2629831,2630347,2629986,2630418,2630470],"length":1,"stats":{"Line":0}},{"line":77,"address":[2630022,2630574,2629896,2629923],"length":1,"stats":{"Line":0}},{"line":78,"address":[2630038,2630556,2630159,2630057],"length":1,"stats":{"Line":0}},{"line":79,"address":[2630197,2630538,2630175,2630294],"length":1,"stats":{"Line":0}},{"line":80,"address":[2630354,2630302],"length":1,"stats":{"Line":0}},{"line":81,"address":[2630377,2630454,2630362,2630514],"length":1,"stats":{"Line":0}},{"line":84,"address":[2628010,2627898],"length":1,"stats":{"Line":0}},{"line":86,"address":[2628486,2627260,2628228,2628288,2628682],"length":1,"stats":{"Line":0}},{"line":89,"address":[2392976,2394053,2394085],"length":1,"stats":{"Line":0}},{"line":90,"address":[2393469,2393279,2393876,2393561,2392996,2393166,2393772,2393673,2394032,2393065,2393361],"length":1,"stats":{"Line":0}},{"line":92,"address":[2393004],"length":1,"stats":{"Line":0}},{"line":93,"address":[2393123],"length":1,"stats":{"Line":0}},{"line":94,"address":[2393198],"length":1,"stats":{"Line":0}},{"line":95,"address":[2393310],"length":1,"stats":{"Line":0}},{"line":96,"address":[2393404],"length":1,"stats":{"Line":0}},{"line":97,"address":[2393506],"length":1,"stats":{"Line":0}},{"line":98,"address":[2393610],"length":1,"stats":{"Line":0}},{"line":100,"address":[2393717],"length":1,"stats":{"Line":0}},{"line":102,"address":[2393821],"length":1,"stats":{"Line":0}},{"line":105,"address":[2394003,2393964,2393898],"length":1,"stats":{"Line":0}},{"line":106,"address":[2393923],"length":1,"stats":{"Line":0}},{"line":107,"address":[2630875],"length":1,"stats":{"Line":0}},{"line":108,"address":[2630918],"length":1,"stats":{"Line":0}},{"line":114,"address":[2394096],"length":1,"stats":{"Line":0}},{"line":115,"address":[2394136],"length":1,"stats":{"Line":0}},{"line":118,"address":[2394206],"length":1,"stats":{"Line":0}},{"line":119,"address":[2394300],"length":1,"stats":{"Line":0}},{"line":120,"address":[2394335],"length":1,"stats":{"Line":0}},{"line":121,"address":[2394370],"length":1,"stats":{"Line":0}},{"line":122,"address":[2394405],"length":1,"stats":{"Line":0}},{"line":123,"address":[2394440],"length":1,"stats":{"Line":0}},{"line":124,"address":[2394475],"length":1,"stats":{"Line":0}},{"line":125,"address":[2394510],"length":1,"stats":{"Line":0}},{"line":126,"address":[2394550],"length":1,"stats":{"Line":0}},{"line":130,"address":[2394643],"length":1,"stats":{"Line":0}},{"line":131,"address":[2394678],"length":1,"stats":{"Line":0}},{"line":132,"address":[2394915],"length":1,"stats":{"Line":0}},{"line":133,"address":[2394950],"length":1,"stats":{"Line":0}},{"line":134,"address":[2394985],"length":1,"stats":{"Line":0}},{"line":135,"address":[2395025],"length":1,"stats":{"Line":0}},{"line":139,"address":[2395118],"length":1,"stats":{"Line":0}},{"line":141,"address":[2394704],"length":1,"stats":{"Line":0}},{"line":142,"address":[2394739],"length":1,"stats":{"Line":0}},{"line":143,"address":[2394774],"length":1,"stats":{"Line":0}},{"line":144,"address":[2394814],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":70},{"path":["/","workspaces","vouchrs","src","models.rs"],"content":"use chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\n\n#[derive(Serialize, Deserialize)]\npub struct HealthResponse {\n    pub status: String,\n    pub message: String,\n}\n\n/// User data structure for the `vouchrs_user` cookie\n/// Contains only essential user information (not JWT metadata)\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct VouchrsUserData {\n    pub email: String,\n    pub name: Option\u003cString\u003e,\n    pub provider: String,\n    pub provider_id: String,\n    pub client_ip: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub platform: Option\u003cString\u003e,\n    pub lang: Option\u003cString\u003e,\n    pub mobile: i32,\n    pub session_start: Option\u003ci64\u003e,\n}\n\n/// Session structure containing only essential token data for cookies\n/// User data is now stored separately in the `vouchrs_user` cookie\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct VouchrsSession {\n    pub id_token: Option\u003cString\u003e,\n    pub refresh_token: Option\u003cString\u003e,\n    pub provider: String,\n    pub expires_at: DateTime\u003cUtc\u003e,\n}\n\nimpl VouchrsSession {\n    /// Check if tokens need refresh (within 5 minutes of expiry)\n    #[must_use]\n    pub fn needs_refresh(\u0026self) -\u003e bool {\n        let now = chrono::Utc::now();\n        let buffer_minutes = chrono::Duration::minutes(5);\n        self.expires_at \u003c= now + buffer_minutes\n    }\n}\n\n/// Complete session data structure used during OAuth flow\n/// Contains both user data and token data before splitting into separate cookies\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct CompleteSessionData {\n    pub user_email: String,\n    pub user_name: Option\u003cString\u003e,\n    pub provider: String,\n    pub provider_id: String,\n    pub id_token: Option\u003cString\u003e,\n    pub refresh_token: Option\u003cString\u003e,\n    pub expires_at: DateTime\u003cUtc\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl CompleteSessionData {\n    /// Extract token data as `VouchrsSession`\n    #[must_use]\n    pub fn to_session(\u0026self) -\u003e VouchrsSession {\n        VouchrsSession {\n            id_token: self.id_token.clone(),\n            refresh_token: self.refresh_token.clone(),\n            provider: self.provider.clone(),\n            expires_at: self.expires_at,\n        }\n    }\n\n    /// Extract user data as `VouchrsUserData` with additional context\n    #[must_use]\n    pub fn to_user_data(\n        \u0026self,\n        client_ip: Option\u003c\u0026str\u003e,\n        user_agent_info: Option\u003c\u0026crate::utils::user_agent::UserAgentInfo\u003e,\n    ) -\u003e VouchrsUserData {\n        VouchrsUserData {\n            email: self.user_email.clone(),\n            name: self.user_name.clone(),\n            provider: self.provider.clone(),\n            provider_id: self.provider_id.clone(),\n            client_ip: client_ip.map(std::string::ToString::to_string),\n            user_agent: user_agent_info.and_then(|ua| ua.user_agent.clone()),\n            platform: user_agent_info.and_then(|ua| ua.platform.clone()),\n            lang: user_agent_info.and_then(|ua| ua.lang.clone()),\n            mobile: user_agent_info.map_or(0, |ua| i32::from(ua.mobile)),\n            session_start: Some(self.created_at.timestamp()), // Convert created_at to Unix timestamp\n        }\n    }\n}\n","traces":[{"line":39,"address":[3058272],"length":1,"stats":{"Line":0}},{"line":40,"address":[3593069],"length":1,"stats":{"Line":0}},{"line":41,"address":[4389112],"length":1,"stats":{"Line":0}},{"line":42,"address":[3669803],"length":1,"stats":{"Line":0}},{"line":63,"address":[3670199,3669872,3670193],"length":1,"stats":{"Line":0}},{"line":65,"address":[3669902],"length":1,"stats":{"Line":0}},{"line":66,"address":[4389279],"length":1,"stats":{"Line":0}},{"line":67,"address":[4389338],"length":1,"stats":{"Line":0}},{"line":68,"address":[3058595],"length":1,"stats":{"Line":0}},{"line":74,"address":[3059739,3059745,3058752],"length":1,"stats":{"Line":0}},{"line":80,"address":[3058821],"length":1,"stats":{"Line":0}},{"line":81,"address":[3670312],"length":1,"stats":{"Line":0}},{"line":82,"address":[3670378],"length":1,"stats":{"Line":0}},{"line":83,"address":[3670441],"length":1,"stats":{"Line":0}},{"line":84,"address":[3670512],"length":1,"stats":{"Line":0}},{"line":85,"address":[2872672,2872688],"length":1,"stats":{"Line":0}},{"line":86,"address":[3251456,3251440],"length":1,"stats":{"Line":0}},{"line":87,"address":[3650896,3650912],"length":1,"stats":{"Line":0}},{"line":88,"address":[2872800,2872809],"length":1,"stats":{"Line":0}},{"line":89,"address":[3594147],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","workspaces","vouchrs","src","oauth.rs"],"content":"// Config-driven OAuth implementation using provider configurations from settings\n// Supports dynamic discovery endpoints and customizable provider configurations\n\n// Standard library imports\nuse std::collections::HashMap;\nuse std::env;\n\n// Third-party imports\nuse actix_web::HttpResponse;\nuse base64::Engine as _;\nuse chrono::Utc;\nuse log::debug;\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\n\n// Local imports\nuse crate::models::VouchrsSession;\nuse crate::settings::{ProviderSettings, VouchrsSettings};\nuse crate::utils::apple;\nuse crate::utils::logging::LoggingHelper;\n\n// ============================================================================\n// Error Types\n// ============================================================================\n\n/// Error types for OAuth operations\n#[derive(Debug)]\npub enum OAuthError {\n    Configuration(String),\n    Network(String),\n    InvalidResponse(String),\n}\n\nimpl std::fmt::Display for OAuthError {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            Self::Configuration(msg) =\u003e write!(f, \"Configuration error: {msg}\"),\n            Self::Network(msg) =\u003e write!(f, \"Network error: {msg}\"),\n            Self::InvalidResponse(msg) =\u003e write!(f, \"Invalid response: {msg}\"),\n        }\n    }\n}\n\nimpl std::error::Error for OAuthError {}\n\n// ============================================================================\n// Core Data Structures\n// ============================================================================\n\n/// OAuth callback structure for handling responses from OAuth providers\n#[derive(Deserialize, Debug)]\npub struct OAuthCallback {\n    pub code: Option\u003cString\u003e,\n    pub state: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n    pub user: Option\u003cserde_json::Value\u003e, // Apple sends user info in form POST on first login\n}\n\n/// OAuth state structure for CSRF protection and flow tracking\n#[derive(Serialize, Deserialize, Debug)]\npub struct OAuthState {\n    pub state: String,\n    pub provider: String,\n    pub redirect_url: Option\u003cString\u003e,\n}\n\n/// OAuth tokens structure for session management\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct OAuthTokens {\n    pub token_type: String,\n    pub scope: Option\u003cString\u003e,\n}\n\n// ============================================================================\n// Internal Structures\n// ============================================================================\n\n/// Apple JWT claims structure for client secret generation\n#[derive(Debug, Serialize, Deserialize)]\nstruct AppleJwtClaims {\n    iss: String, // Team ID\n    iat: i64,    // Issued at time\n    exp: i64,    // Expiration time\n    aud: String, // Audience (always \"https://appleid.apple.com\")\n    sub: String, // Client ID\n}\n\n/// Token response structure from OAuth providers\n#[derive(Debug, Deserialize)]\nstruct TokenResponse {\n    refresh_token: Option\u003cString\u003e,\n    id_token: Option\u003cString\u003e,\n    token_type: String,\n    expires_in: Option\u003cu64\u003e,\n    user: Option\u003capple::AppleUserInfo\u003e, // Apple-specific user info field\n}\n\n// ============================================================================\n// Provider Configuration\n// ============================================================================\n\n/// Runtime provider configuration with resolved endpoints\n#[derive(Debug, Clone)]\npub struct RuntimeProvider {\n    pub settings: ProviderSettings,\n    pub auth_url: String,\n    pub token_url: String,\n    pub client_id: Option\u003cString\u003e,\n    pub client_secret: Option\u003cString\u003e,\n}\n\nimpl RuntimeProvider {\n    /// Creates a `RuntimeProvider` from settings\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - Discovery URL cannot be resolved\n    /// - Required configuration is missing\n    /// - Network errors occur during discovery\n    pub async fn from_settings(settings: ProviderSettings) -\u003e Result\u003cSelf, String\u003e {\n        // Use the new getter methods instead of direct environment variable access\n        let client_id = settings.get_client_id();\n        let client_secret = settings.get_client_secret();\n\n        // Resolve endpoints from discovery URL or use direct URLs\n        let (auth_url, token_url) = if let Some(ref discovery_url) = settings.discovery_url {\n            Self::resolve_from_discovery(discovery_url).await?\n        } else {\n            let auth_url = settings.authorization_endpoint.clone().ok_or_else(|| {\n                format!(\"Provider {} missing authorization_endpoint\", settings.name)\n            })?;\n            let token_url = settings\n                .token_endpoint\n                .clone()\n                .ok_or_else(|| format!(\"Provider {} missing token_endpoint\", settings.name))?;\n            (auth_url, token_url)\n        };\n\n        Ok(Self {\n            settings,\n            auth_url,\n            token_url,\n            client_id,\n            client_secret,\n        })\n    }\n\n    /// Resolve authorization and token endpoints from discovery URL\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Network request to discovery URL fails\n    /// - Response cannot be parsed as JSON\n    /// - Required endpoints are missing from discovery document\n    async fn resolve_from_discovery(discovery_url: \u0026str) -\u003e Result\u003c(String, String), String\u003e {\n        let resp = reqwest::get(discovery_url)\n            .await\n            .map_err(|e| e.to_string())?;\n        let doc: serde_json::Value = resp.json().await.map_err(|e| e.to_string())?;\n        let auth_url = doc[\"authorization_endpoint\"]\n            .as_str()\n            .ok_or_else(|| \"Missing authorization_endpoint in discovery document\".to_string())?\n            .to_string();\n        let token_url = doc[\"token_endpoint\"]\n            .as_str()\n            .ok_or_else(|| \"Missing token_endpoint in discovery document\".to_string())?\n            .to_string();\n        Ok((auth_url, token_url))\n    }\n\n    /// Check if the provider is properly configured\n    #[must_use]\n    pub const fn is_configured(\u0026self) -\u003e bool {\n        self.client_id.is_some()\n            \u0026\u0026 (self.client_secret.is_some() || self.settings.jwt_signing.is_some())\n    }\n}\n\n// ============================================================================\n// Type Aliases\n// ============================================================================\n\n/// Result type for token exchange operations\n/// Returns (`id_token`, `refresh_token`, `expires_at`, `apple_user_info_fallback`)\ntype TokenExchangeResult = Result\u003c\n    (\n        Option\u003cString\u003e,\n        Option\u003cString\u003e,\n        chrono::DateTime\u003cUtc\u003e,\n        Option\u003capple::AppleUserInfo\u003e,\n    ),\n    String,\n\u003e;\n\n// ============================================================================\n// OAuth Configuration\n// ============================================================================\n\n/// Config-driven OAuth configuration with multiple provider support\n#[derive(Clone)]\npub struct OAuthConfig {\n    pub providers: HashMap\u003cString, RuntimeProvider\u003e,\n    pub redirect_base_url: String,\n    http_client: reqwest::Client,\n}\n\nimpl Default for OAuthConfig {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl OAuthConfig {\n    /// Create a new OAuth configuration\n    #[must_use]\n    pub fn new() -\u003e Self {\n        let redirect_base_url =\n            env::var(\"REDIRECT_BASE_URL\").unwrap_or_else(|_| \"http://localhost:8080\".to_string());\n\n        Self {\n            providers: HashMap::new(),\n            redirect_base_url,\n            http_client: reqwest::Client::new(),\n        }\n    }\n\n    /// Initialize providers from settings\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - Provider validation fails for any enabled provider\n    /// - Required environment variables are missing for enabled providers\n    /// - Provider configuration is invalid or incomplete\n    /// - No providers are successfully configured\n    pub async fn initialize_from_settings(\n        \u0026mut self,\n        settings: \u0026VouchrsSettings,\n    ) -\u003e Result\u003c(), String\u003e {\n        LoggingHelper::log_oauth_provider_initialization();\n\n        for provider_settings in \u0026settings.providers {\n            if !provider_settings.enabled {\n                LoggingHelper::log_oauth_provider_disabled(\u0026provider_settings.name);\n                continue;\n            }\n\n            match RuntimeProvider::from_settings(provider_settings.clone()).await {\n                Ok(runtime_provider) =\u003e {\n                    if runtime_provider.is_configured() {\n                        LoggingHelper::log_oauth_provider_configured(\n                            provider_settings\n                                .display_name\n                                .as_deref()\n                                .unwrap_or(\u0026provider_settings.name),\n                            \u0026provider_settings.name,\n                        );\n                        self.providers\n                            .insert(provider_settings.name.clone(), runtime_provider);\n                    } else {\n                        LoggingHelper::log_oauth_provider_not_configured(\n                            provider_settings\n                                .display_name\n                                .as_deref()\n                                .unwrap_or(\u0026provider_settings.name),\n                        );\n                    }\n                }\n                Err(e) =\u003e {\n                    log::error!(\n                        \"âŒ Failed to initialize provider {}: {e}\",\n                        provider_settings.name\n                    );\n                }\n            }\n        }\n        if self.providers.is_empty() {\n            return Err(\"No OAuth providers are configured. Please configure at least one provider in Settings.toml and set the required environment variables.\".to_string());\n        }\n        let provider_names: Vec\u003c_\u003e = self.providers.keys().collect();\n        LoggingHelper::log_oauth_providers_summary(\u0026provider_names);\n\n        Ok(())\n    }\n\n    /// Check if a provider's client is configured\n    #[must_use]\n    pub fn get_client_configured(\u0026self, provider: \u0026str) -\u003e bool {\n        self.providers\n            .get(provider)\n            .is_some_and(RuntimeProvider::is_configured)\n    }\n\n    /// Get the authorization URL for a provider\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - The specified provider is not configured\n    /// - The client ID is not configured for the provider\n    /// - The authorization URL is malformed\n    pub fn get_auth_url(\u0026self, provider: \u0026str, state: \u0026str) -\u003e Result\u003cString, String\u003e {\n        let runtime_provider = self\n            .providers\n            .get(provider)\n            .ok_or_else(|| format!(\"Provider {provider} not configured\"))?;\n\n        // Get client ID using the new getter method\n        let client_id = runtime_provider\n            .settings\n            .get_client_id()\n            .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n\n        // Build authorization URL\n        let redirect_uri = format!(\"{}/oauth2/callback\", self.redirect_base_url);\n        let scopes = runtime_provider.settings.scopes.join(\" \");\n\n        // Start with base parameters\n        let mut url = url::Url::parse(\u0026runtime_provider.auth_url).map_err(|e| e.to_string())?;\n        url.query_pairs_mut()\n            .append_pair(\"client_id\", \u0026client_id)\n            .append_pair(\"redirect_uri\", \u0026redirect_uri)\n            .append_pair(\"response_type\", \"code\")\n            .append_pair(\"scope\", \u0026scopes)\n            .append_pair(\"state\", state);\n\n        // Add provider-specific extra parameters\n        for (key, value) in \u0026runtime_provider.settings.extra_auth_params {\n            url.query_pairs_mut().append_pair(key, value);\n        }\n\n        LoggingHelper::log_oauth_url_built(\n            provider,\n            \u0026scopes,\n            \u0026runtime_provider.settings.extra_auth_params,\n        );\n\n        Ok(url.to_string())\n    }\n\n    /// Exchange OAuth authorization code for OAuth tokens\n    /// This manually handles the token exchange to properly capture ID tokens\n    /// Returns (`id_token`, `refresh_token`, `expires_at`, `Option\u003cAppleUserInfo\u003e`) for Apple user info fallback\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Provider is not configured\n    /// - Client credentials are missing\n    /// - Token exchange request fails\n    /// - Response parsing fails\n    pub async fn exchange_code_for_tokens(\n        \u0026self,\n        provider: \u0026str,\n        code: \u0026str,\n    ) -\u003e TokenExchangeResult {\n        let runtime_provider = self\n            .providers\n            .get(provider)\n            .ok_or_else(|| format!(\"Provider {provider} not configured\"))?;\n\n        // Prepare token exchange parameters\n        let params = self.prepare_token_exchange_params(provider, code, runtime_provider)?;\n\n        // Execute token exchange request\n        let response_text = self.execute_token_exchange(provider, runtime_provider, \u0026params).await?;\n\n        // Parse and process the token response\n        Self::process_token_response(provider, \u0026response_text)\n    }\n\n    /// Prepare parameters for token exchange request\n    fn prepare_token_exchange_params(\n        \u0026self,\n        provider: \u0026str,\n        code: \u0026str,\n        runtime_provider: \u0026RuntimeProvider,\n    ) -\u003e Result\u003cHashMap\u003cString, String\u003e, String\u003e {\n        let redirect_uri = format!(\"{}/oauth2/callback\", self.redirect_base_url);\n        let mut params = HashMap::new();\n        \n        // Basic OAuth parameters\n        params.insert(\"grant_type\".to_string(), \"authorization_code\".to_string());\n        params.insert(\"code\".to_string(), code.to_string());\n        params.insert(\"redirect_uri\".to_string(), redirect_uri);\n\n        // Client credentials\n        let client_id = runtime_provider\n            .settings\n            .get_client_id()\n            .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n\n        params.insert(\"client_id\".to_string(), client_id);\n\n        // Handle client secret or JWT signing\n        if let Some(ref secret) = runtime_provider.client_secret {\n            // Regular OAuth with client secret\n            params.insert(\"client_secret\".to_string(), secret.clone());\n        } else if let Some(ref jwt_config) = runtime_provider.settings.jwt_signing {\n            // JWT signing (Apple)\n            let client_id = runtime_provider\n                .settings\n                .get_client_id()\n                .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n            let client_secret = crate::utils::apple::generate_jwt_client_secret(jwt_config, \u0026client_id)?;\n            params.insert(\"client_secret\".to_string(), client_secret);\n        } else {\n            return Err(\"No client secret or JWT signing configuration for provider\".to_string());\n        }\n\n        Ok(params)\n    }\n\n    /// Execute the token exchange HTTP request\n    async fn execute_token_exchange(\n        \u0026self,\n        provider: \u0026str,\n        runtime_provider: \u0026RuntimeProvider,\n        params: \u0026HashMap\u003cString, String\u003e,\n    ) -\u003e Result\u003cString, String\u003e {\n        LoggingHelper::log_token_exchange_start(provider);\n        \n        let response = self\n            .http_client\n            .post(\u0026runtime_provider.token_url)\n            .form(params)\n            .send()\n            .await\n            .map_err(|e| format!(\"Failed to exchange code for token: {e}\"))?;\n\n        let status = response.status();\n        if !status.is_success() {\n            let error_text = response\n                .text()\n                .await\n                .unwrap_or_else(|_| \"Unknown error\".to_string());\n            return Err(format!(\n                \"Token exchange failed with status {status}: {error_text}\"\n            ));\n        }\n\n        response\n            .text()\n            .await\n            .map_err(|e| format!(\"Failed to read response text: {e}\"))\n    }\n\n    /// Process the token response and extract relevant information\n    fn process_token_response(\n        provider: \u0026str,\n        response_text: \u0026str,\n    ) -\u003e TokenExchangeResult {\n        // Log the raw token response for debugging\n        if provider == \"apple\" {\n            LoggingHelper::log_apple_token_response_raw(response_text);\n        } else {\n            LoggingHelper::log_token_response_raw(provider, response_text);\n        }\n\n        let token_response: TokenResponse = serde_json::from_str(response_text)\n            .map_err(|e| format!(\"Failed to parse token response: {e}\"))?;\n\n        // Calculate token expiration\n        let expires_at = token_response.expires_in.map_or_else(|| {\n            // Default to 1 hour if no expiration provided\n            Utc::now() + chrono::Duration::hours(1)\n        }, |expires_in| {\n            Utc::now() + chrono::Duration::seconds(i64::try_from(expires_in).unwrap_or(3600))\n        });\n\n        // Log detailed information about what we extracted\n        LoggingHelper::log_token_exchange_summary(\n            provider,\n            token_response.refresh_token.as_ref(),\n            token_response.id_token.as_ref(),\n            \u0026token_response.token_type,\n            token_response.expires_in.map(|v| i64::try_from(v).unwrap_or(3600)),\n        );\n\n        Ok((\n            token_response.id_token,\n            token_response.refresh_token,\n            expires_at,\n            token_response.user,\n        ))\n    }\n\n    /// Get the signout URL for a provider\n    #[must_use]\n    pub fn get_signout_url(\u0026self, provider: \u0026str) -\u003e Option\u003cString\u003e {\n        self.providers\n            .get(provider)\n            .and_then(|p| p.settings.signout_url.clone())\n    }\n\n    /// Get list of enabled provider names\n    #[must_use]\n    pub fn get_enabled_providers(\u0026self) -\u003e Vec\u003c\u0026str\u003e {\n        self.providers.keys().map(std::string::String::as_str).collect()\n    }\n\n    /// Get provider display name\n    #[must_use]\n    pub fn get_provider_display_name(\u0026self, provider: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n        self.providers\n            .get(provider)\n            .and_then(|p| p.settings.display_name.as_deref())\n    }\n}\n\n\n\n// ============================================================================\n// Token Management Functions\n// ============================================================================\n\n// Static HTTP client for making token refresh requests\nstatic CLIENT: std::sync::LazyLock\u003creqwest::Client\u003e =\n    std::sync::LazyLock::new(reqwest::Client::new);\n\n/// Check if tokens need refresh and refresh them if necessary\n/// \n/// # Errors\n/// \n/// Returns an `HttpResponse` error if:\n/// - Tokens are expired and no refresh token is available\n/// - Token refresh fails\npub async fn check_and_refresh_tokens(\n    mut session: VouchrsSession,\n    oauth_config: \u0026OAuthConfig,\n    provider: \u0026str,\n) -\u003e Result\u003cVouchrsSession, HttpResponse\u003e {\n    // Check if tokens need refresh (within 5 minutes of expiry)\n    let now = chrono::Utc::now();\n    let buffer_time = chrono::Duration::minutes(5);\n    if session.expires_at \u003e now + buffer_time {\n        return Ok(session);\n    }\n\n    // Attempt to refresh tokens\n    let refresh_token = session.refresh_token.as_ref().ok_or_else(|| {\n        HttpResponse::Unauthorized().json(serde_json::json!({\n            \"error\": \"unauthorized\",\n            \"message\": \"OAuth tokens expired and no refresh token available. Please re-authenticate.\"\n        }))\n    })?;\n\n    // Call refresh_oauth_tokens and update session fields\n    match refresh_tokens(refresh_token, oauth_config, provider).await {\n        Ok((new_id_token, new_refresh_token, new_expires_at)) =\u003e {\n            session.id_token = new_id_token;\n            session.refresh_token = new_refresh_token;\n            session.expires_at = new_expires_at;\n            Ok(session)\n        }\n        Err(err) =\u003e Err(HttpResponse::Unauthorized().json(serde_json::json!({\n            \"error\": \"token_refresh_failed\",\n            \"message\": format!(\"Failed to refresh OAuth tokens: {err}\")\n        }))),\n    }\n}\n\n/// Refresh OAuth tokens using the refresh token\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Provider is not configured\n/// - Client credentials are missing or cannot be generated\n/// - Token refresh request fails\n/// - Response parsing fails\npub async fn refresh_tokens(\n    refresh_token: \u0026str,\n    oauth_config: \u0026OAuthConfig,\n    provider: \u0026str,\n) -\u003e Result\u003c\n    (\n        Option\u003cString\u003e,\n        Option\u003cString\u003e,\n        chrono::DateTime\u003cchrono::Utc\u003e,\n    ),\n    String,\n\u003e {\n    // Get provider configuration\n    let runtime_provider = oauth_config\n        .providers\n        .get(provider)\n        .ok_or_else(|| format!(\"Provider {provider} not configured\"))?;\n\n    let client_id = runtime_provider\n        .client_id\n        .as_ref()\n        .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n\n    // Handle client credentials based on provider configuration\n    let client_secret = if let Some(ref secret) = runtime_provider.client_secret {\n        secret.clone()\n    } else if let Some(ref jwt_config) = runtime_provider.settings.jwt_signing {\n        // Generate JWT client secret for Apple\n        let client_id = runtime_provider\n            .settings\n            .get_client_id()\n            .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n        apple::generate_jwt_client_secret(jwt_config, \u0026client_id)\n            .map_err(|e| format!(\"Failed to generate client secret: {e}\"))?\n    } else {\n        return Err(format!(\n            \"No client secret or JWT signing configuration for provider {provider}\"\n        ));\n    };\n\n    let params = [\n        (\"grant_type\", \"refresh_token\"),\n        (\"refresh_token\", refresh_token),\n        (\"client_id\", client_id.as_str()),\n        (\"client_secret\", client_secret.as_str()),\n    ];\n\n    let response = CLIENT\n        .post(\u0026runtime_provider.token_url)\n        .form(\u0026params)\n        .send()\n        .await\n        .map_err(|e| format!(\"HTTP request failed: {e}\"))?;\n\n    if !response.status().is_success() {\n        let status = response.status();\n        let error_text = response\n            .text()\n            .await\n            .unwrap_or_else(|_| \"Unknown error\".to_string());\n        return Err(format!(\n            \"Token refresh failed with status {status}: {error_text}\"\n        ));\n    }\n\n    // Parse token response extracting id_token, refresh_token, expires_at\n    let token_response: Value = response\n        .json()\n        .await\n        .map_err(|e| format!(\"Failed to parse token response: {e}\"))?;\n\n    let expires_in = token_response[\"expires_in\"].as_u64().unwrap_or(3600); // Default to 1 hour\n\n    let new_refresh_token = token_response[\"refresh_token\"]\n        .as_str()\n        .map(ToString::to_string);\n\n    let new_id_token = token_response[\"id_token\"].as_str().map(ToString::to_string);\n\n    let new_expires_at = chrono::Utc::now() + chrono::Duration::seconds(i64::try_from(expires_in).unwrap_or(3600));\n\n    Ok((new_id_token, new_refresh_token, new_expires_at))\n}\n\n// ============================================================================\n// Utility Functions\n// ============================================================================\n\n// ============================================================================\n// OAuth State Management\n// ============================================================================\n\n/// Parse OAuth state from received state parameter and retrieve stored state from cookie\n/// This eliminates provider-specific branching logic by using the stored OAuth state\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - The received state does not match the stored CSRF token\n/// - No stored state is found and encrypted state decryption fails\n/// - The encrypted state format is invalid\npub fn get_state_from_callback(\n    received_state: \u0026str,\n    session_manager: \u0026crate::session::SessionManager,\n    req: \u0026actix_web::HttpRequest,\n) -\u003e Result\u003ccrate::oauth::OAuthState, String\u003e {\n    debug!(\"Received OAuth state parameter: length = {} characters\", received_state.len());\n\n    // First, try to get the stored OAuth state from temporary cookie (legacy compatibility)\n    match session_manager.get_temporary_state_from_request(req) {\n        Ok(Some(stored_state)) =\u003e {\n            // For legacy cookie-based state, verify the received state matches the stored CSRF token\n            if stored_state.state == received_state {\n                debug!(\n                    \"OAuth state verified: stored state matches received state for provider {}\",\n                    stored_state.provider\n                );\n                Ok(stored_state)\n            } else {\n                Err(\n                    \"OAuth state mismatch: received state does not match stored CSRF token\"\n                        .to_string(),\n                )\n            }\n        }\n        Ok(None) =\u003e {\n            // ðŸ”’ SECURITY: Try to decrypt the received state parameter\n            // This prevents tampering with provider name or redirect URL\n            match session_manager.decrypt_data::\u003ccrate::oauth::OAuthState\u003e(received_state) {\n                Ok(decrypted_state) =\u003e {\n                    debug!(\n                        \"Successfully decrypted OAuth state for provider: {}\",\n                        decrypted_state.provider\n                    );\n                    Ok(decrypted_state)\n                }\n                Err(e) =\u003e {\n                    debug!(\"Failed to decrypt OAuth state: {e}\");\n                    // Fallback: Try parsing as legacy plain-text state (for backwards compatibility)\n                    parse_stateless_oauth_state(received_state)\n                }\n            }\n        }\n        Err(e) =\u003e {\n            debug!(\"Failed to retrieve stored OAuth state: {e}\");\n            // Try decrypting the state parameter directly\n            match session_manager.decrypt_data::\u003ccrate::oauth::OAuthState\u003e(received_state) {\n                Ok(decrypted_state) =\u003e {\n                    debug!(\n                        \"Successfully decrypted OAuth state for provider: {}\",\n                        decrypted_state.provider\n                    );\n                    Ok(decrypted_state)\n                }\n                Err(decrypt_error) =\u003e {\n                    debug!(\"Failed to decrypt OAuth state: {decrypt_error}\");\n                    // Final fallback: Parse as legacy plain-text state\n                    parse_stateless_oauth_state(received_state)\n                }\n            }\n        }\n    }\n}\n\n/// Parse OAuth state when no stored state is available (stateless mode)\n/// \n/// âš ï¸  **DEPRECATED \u0026 VULNERABLE**: This function is kept for backwards compatibility only.\n/// Plain-text state parameters can be tampered with by attackers to modify provider names\n/// or redirect URLs. New implementations should use encrypted state parameters.\n/// \n/// This handles cases where the provider info needs to be extracted from the state parameter itself\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - The state format is invalid (missing provider information)\n/// - Cannot determine provider from simple CSRF token in stateless mode\nfn parse_stateless_oauth_state(received_state: \u0026str) -\u003e Result\u003ccrate::oauth::OAuthState, String\u003e {\n    debug!(\n        \"Attempting to parse stateless OAuth state: '{received_state}'\"\n    );\n    debug!(\"Contains pipe character: {}\", received_state.contains('|'));\n\n    if received_state.contains('|') {\n        // New format: \"csrf_token|provider|optional_redirect\"\n        let parts: Vec\u003c\u0026str\u003e = received_state.split('|').collect();\n\n        if parts.len() \u003c 2 {\n            return Err(\"Stateless OAuth state missing provider information\".to_string());\n        }\n\n        let csrf_state = parts[0].to_string();\n        let provider = parts[1].to_string();\n\n        let redirect_url = if parts.len() \u003e 2 {\n            // Try URL_SAFE_NO_PAD first, then fallback to STANDARD for backwards compatibility\n            base64::engine::general_purpose::URL_SAFE_NO_PAD.decode(parts[2])\n                .or_else(|_| base64::engine::general_purpose::STANDARD.decode(parts[2]))\n                .map_or(None, |decoded_bytes| String::from_utf8(decoded_bytes).ok())\n        } else {\n            None\n        };\n\n        debug!(\n            \"Successfully parsed stateless OAuth state for provider: {provider}\"\n        );\n\n        Ok(crate::oauth::OAuthState {\n            state: csrf_state,\n            provider,\n            redirect_url,\n        })\n    } else {\n        // Simple CSRF token without provider or redirect URL\n        Err(\"Cannot determine provider from simple CSRF token in stateless mode\".to_string())\n    }\n}\n\n// ============================================================================\n// Tests\n// ============================================================================\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_stateless_oauth_state_simple() {\n        let result = parse_stateless_oauth_state(\"simple_csrf_token\");\n\n        // Should fail because we can't determine provider in stateless mode\n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"Cannot determine provider\"));\n    }\n\n    #[test]\n    fn test_parse_stateless_oauth_state_with_provider_and_redirect() {\n        let redirect_url = \"/dashboard\";\n        let encoded_redirect =\n            base64::engine::general_purpose::URL_SAFE_NO_PAD.encode(redirect_url.as_bytes());\n        let state = format!(\"csrf_token|google|{encoded_redirect}\");\n\n        let result = parse_stateless_oauth_state(\u0026state);\n\n        // Should succeed with the new format\n        assert!(result.is_ok());\n        let oauth_state = result.unwrap();\n        assert_eq!(oauth_state.state, \"csrf_token\");\n        assert_eq!(oauth_state.provider, \"google\");\n        assert_eq!(oauth_state.redirect_url, Some(redirect_url.to_string()));\n    }\n\n    #[test]\n    fn test_parse_stateless_oauth_state_with_provider_without_redirect() {\n        let state = \"csrf_token|google\";\n\n        let result = parse_stateless_oauth_state(state);\n\n        // Should succeed with the new format\n        assert!(result.is_ok());\n        let oauth_state = result.unwrap();\n        assert_eq!(oauth_state.state, \"csrf_token\");\n        assert_eq!(oauth_state.provider, \"google\");\n        assert_eq!(oauth_state.redirect_url, None);\n    }\n\n    #[test]\n    fn test_parse_stateless_oauth_state_invalid_base64() {\n        let state = \"csrf_token|google|invalid_base64!@#\";\n\n        let result = parse_stateless_oauth_state(state);\n\n        // Should succeed but ignore invalid base64 redirect URL\n        assert!(result.is_ok());\n        let oauth_state = result.unwrap();\n        assert_eq!(oauth_state.state, \"csrf_token\");\n        assert_eq!(oauth_state.provider, \"google\");\n        assert_eq!(oauth_state.redirect_url, None);\n    }\n\n    #[test]\n    fn test_encrypted_state_security_fix() {\n        use crate::session::SessionManager;\n        \n        // Create a session manager for encryption/decryption\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let session_manager = SessionManager::new(key, false, 24);\n        \n        // Create an OAuth state\n        let original_state = OAuthState {\n            state: \"csrf_token_123\".to_string(),\n            provider: \"google\".to_string(),\n            redirect_url: Some(\"/dashboard\".to_string()),\n        };\n        \n        // Encrypt the state (this is what we now do in auth.rs)\n        let encrypted_state = session_manager.encrypt_data(\u0026original_state).unwrap();\n        \n        // Verify that the encrypted state doesn't contain plain text provider info\n        assert!(!encrypted_state.contains(\"google\"));\n        assert!(!encrypted_state.contains(\"dashboard\"));\n        assert!(!encrypted_state.contains(\"csrf_token_123\"));\n        \n        // Verify that we can decrypt it back correctly\n        let decrypted_state: OAuthState = session_manager.decrypt_data(\u0026encrypted_state).unwrap();\n        assert_eq!(decrypted_state.state, original_state.state);\n        assert_eq!(decrypted_state.provider, original_state.provider);\n        assert_eq!(decrypted_state.redirect_url, original_state.redirect_url);\n    }\n\n    #[test]\n    fn test_tampered_encrypted_state_fails() {\n        use crate::session::SessionManager;\n        \n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let session_manager = SessionManager::new(key, false, 24);\n        \n        let original_state = OAuthState {\n            state: \"csrf_token_123\".to_string(),\n            provider: \"google\".to_string(),\n            redirect_url: Some(\"/dashboard\".to_string()),\n        };\n        \n        let encrypted_state = session_manager.encrypt_data(\u0026original_state).unwrap();\n        \n        // Tamper with the encrypted state by changing one character\n        let mut chars: Vec\u003cchar\u003e = encrypted_state.chars().collect();\n        if let Some(last_char) = chars.last_mut() {\n            *last_char = if *last_char == 'A' { 'B' } else { 'A' };\n        }\n        let tampered_state: String = chars.into_iter().collect();\n        \n        // Attempting to decrypt tampered state should fail\n        let result = session_manager.decrypt_data::\u003cOAuthState\u003e(\u0026tampered_state);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_legacy_plaintext_state_still_works() {\n        // Test that our fallback to legacy parsing still works for backwards compatibility\n        let legacy_state = \"csrf_token|google|L2Rhc2hib2FyZA==\"; // base64(\"/dashboard\")\n        \n        let result = parse_stateless_oauth_state(legacy_state);\n        assert!(result.is_ok());\n        \n        let oauth_state = result.unwrap();\n        assert_eq!(oauth_state.state, \"csrf_token\");\n        assert_eq!(oauth_state.provider, \"google\");\n        assert_eq!(oauth_state.redirect_url, Some(\"/dashboard\".to_string()));\n    }\n}\n","traces":[{"line":35,"address":[3039936],"length":1,"stats":{"Line":0}},{"line":36,"address":[3039968],"length":1,"stats":{"Line":0}},{"line":37,"address":[3309863],"length":1,"stats":{"Line":0}},{"line":38,"address":[3601753],"length":1,"stats":{"Line":0}},{"line":39,"address":[3310080],"length":1,"stats":{"Line":0}},{"line":121,"address":[2617911,2617396,2615728,2615778,2615889,2617388],"length":1,"stats":{"Line":0}},{"line":123,"address":[2615860],"length":1,"stats":{"Line":0}},{"line":124,"address":[3961821],"length":1,"stats":{"Line":0}},{"line":127,"address":[3257531,3258430,3259351],"length":1,"stats":{"Line":0}},{"line":128,"address":[3319297],"length":1,"stats":{"Line":0}},{"line":130,"address":[3963282,3963872,3962287,3962175,3961977],"length":1,"stats":{"Line":0}},{"line":131,"address":[3165814],"length":1,"stats":{"Line":0}},{"line":133,"address":[2616615,2616512,2616691],"length":1,"stats":{"Line":0}},{"line":136,"address":[3164463,3164383,3165942,3165920],"length":1,"stats":{"Line":0}},{"line":137,"address":[3164580],"length":1,"stats":{"Line":0}},{"line":140,"address":[3164920],"length":1,"stats":{"Line":0}},{"line":141,"address":[3164790],"length":1,"stats":{"Line":0}},{"line":144,"address":[2617012],"length":1,"stats":{"Line":0}},{"line":145,"address":[3962950],"length":1,"stats":{"Line":0}},{"line":157,"address":[3040445,3040432],"length":1,"stats":{"Line":0}},{"line":158,"address":[3260486,3260806,3260081,3259918,3260347,3260372],"length":1,"stats":{"Line":0}},{"line":159,"address":[3964533,3964422,3964479,3964332,3964717],"length":1,"stats":{"Line":0}},{"line":160,"address":[3168512,3166742,3168496],"length":1,"stats":{"Line":0}},{"line":161,"address":[3211058],"length":1,"stats":{"Line":0}},{"line":162,"address":[2619871,2619733,2619645,2620532],"length":1,"stats":{"Line":0}},{"line":164,"address":[2619839,2620768,2620780],"length":1,"stats":{"Line":0}},{"line":166,"address":[3965947,3966039,3966185],"length":1,"stats":{"Line":0}},{"line":168,"address":[2620828,2620816,2620149],"length":1,"stats":{"Line":0}},{"line":170,"address":[3168193],"length":1,"stats":{"Line":0}},{"line":175,"address":[3040464],"length":1,"stats":{"Line":0}},{"line":176,"address":[3678813],"length":1,"stats":{"Line":0}},{"line":177,"address":[3602153,3602187],"length":1,"stats":{"Line":0}},{"line":210,"address":[3040576],"length":1,"stats":{"Line":0}},{"line":211,"address":[3040584],"length":1,"stats":{"Line":0}},{"line":218,"address":[3040608,3040932,3040953],"length":1,"stats":{"Line":0}},{"line":219,"address":[2620864,2620880],"length":1,"stats":{"Line":0}},{"line":223,"address":[3040699],"length":1,"stats":{"Line":0}},{"line":225,"address":[3679125],"length":1,"stats":{"Line":0}},{"line":238,"address":[3310864],"length":1,"stats":{"Line":0}},{"line":242,"address":[3169121],"length":1,"stats":{"Line":0}},{"line":244,"address":[3967313,3969039,3967379],"length":1,"stats":{"Line":0}},{"line":245,"address":[3171018],"length":1,"stats":{"Line":0}},{"line":246,"address":[3265152,3265216],"length":1,"stats":{"Line":0}},{"line":250,"address":[3169390,3171468,3171520,3169162,3169359],"length":1,"stats":{"Line":0}},{"line":251,"address":[3967812],"length":1,"stats":{"Line":0}},{"line":252,"address":[2621868,2621806],"length":1,"stats":{"Line":0}},{"line":254,"address":[3169901,3170220],"length":1,"stats":{"Line":0}},{"line":257,"address":[3170153],"length":1,"stats":{"Line":0}},{"line":258,"address":[2622273],"length":1,"stats":{"Line":0}},{"line":260,"address":[3264049,3264033,3264130],"length":1,"stats":{"Line":0}},{"line":261,"address":[2622354,2622341,2622457],"length":1,"stats":{"Line":0}},{"line":264,"address":[3169858,3170046],"length":1,"stats":{"Line":0}},{"line":267,"address":[3968059],"length":1,"stats":{"Line":0}},{"line":271,"address":[3263364],"length":1,"stats":{"Line":0}},{"line":272,"address":[3264350,3264322,3263396],"length":1,"stats":{"Line":0}},{"line":279,"address":[3969128],"length":1,"stats":{"Line":0}},{"line":280,"address":[2623108,2623354],"length":1,"stats":{"Line":0}},{"line":282,"address":[2623158,2623077],"length":1,"stats":{"Line":0}},{"line":283,"address":[3171185,3171268],"length":1,"stats":{"Line":0}},{"line":285,"address":[3171289],"length":1,"stats":{"Line":0}},{"line":290,"address":[3041024],"length":1,"stats":{"Line":0}},{"line":291,"address":[3602706],"length":1,"stats":{"Line":0}},{"line":304,"address":[3041072,3043453,3043390],"length":1,"stats":{"Line":0}},{"line":305,"address":[3603000,3602834],"length":1,"stats":{"Line":0}},{"line":308,"address":[3041285],"length":1,"stats":{"Line":0}},{"line":311,"address":[3041382,3041515],"length":1,"stats":{"Line":0}},{"line":314,"address":[3171766,3171744],"length":1,"stats":{"Line":0}},{"line":317,"address":[3311492,3311555],"length":1,"stats":{"Line":0}},{"line":318,"address":[3680234,3680143],"length":1,"stats":{"Line":0}},{"line":321,"address":[3171891,3171872],"length":1,"stats":{"Line":0}},{"line":322,"address":[3312251,3312630,3312410,3312504],"length":1,"stats":{"Line":0}},{"line":323,"address":[3604122],"length":1,"stats":{"Line":0}},{"line":324,"address":[3604249],"length":1,"stats":{"Line":0}},{"line":326,"address":[3042687],"length":1,"stats":{"Line":0}},{"line":327,"address":[3312702,3312353],"length":1,"stats":{"Line":0}},{"line":330,"address":[3681209],"length":1,"stats":{"Line":0}},{"line":331,"address":[3042981,3043238],"length":1,"stats":{"Line":0}},{"line":336,"address":[3043019],"length":1,"stats":{"Line":0}},{"line":337,"address":[3681462],"length":1,"stats":{"Line":0}},{"line":340,"address":[3043100],"length":1,"stats":{"Line":0}},{"line":354,"address":[3605216],"length":1,"stats":{"Line":0}},{"line":359,"address":[3265818,3266597,3265935,3265801,3266050],"length":1,"stats":{"Line":0}},{"line":361,"address":[3265805],"length":1,"stats":{"Line":0}},{"line":362,"address":[3971616,3971638,3970386,3970294],"length":1,"stats":{"Line":0}},{"line":365,"address":[3172835,3172411],"length":1,"stats":{"Line":0}},{"line":368,"address":[3304407],"length":1,"stats":{"Line":0}},{"line":371,"address":[3173287,3173396],"length":1,"stats":{"Line":0}},{"line":375,"address":[3043536,3045136,3046097],"length":1,"stats":{"Line":0}},{"line":381,"address":[3313562],"length":1,"stats":{"Line":0}},{"line":382,"address":[3313730],"length":1,"stats":{"Line":0}},{"line":385,"address":[3682342,3684587,3682270,3682381],"length":1,"stats":{"Line":0}},{"line":386,"address":[3316085,3314017,3314085],"length":1,"stats":{"Line":0}},{"line":387,"address":[3044236],"length":1,"stats":{"Line":0}},{"line":390,"address":[3044375,3044484,3046038],"length":1,"stats":{"Line":0}},{"line":393,"address":[3267376,3267398],"length":1,"stats":{"Line":0}},{"line":395,"address":[3314569,3314641],"length":1,"stats":{"Line":0}},{"line":398,"address":[3314748],"length":1,"stats":{"Line":0}},{"line":400,"address":[3606686,3606902,3606713,3606600],"length":1,"stats":{"Line":0}},{"line":401,"address":[3044852,3045147],"length":1,"stats":{"Line":0}},{"line":403,"address":[3315165,3315328,3315218,3315996],"length":1,"stats":{"Line":0}},{"line":406,"address":[3267526,3267504],"length":1,"stats":{"Line":0}},{"line":407,"address":[3607297,3607221],"length":1,"stats":{"Line":0}},{"line":408,"address":[3684183,3684255],"length":1,"stats":{"Line":0}},{"line":410,"address":[3606976,3607795],"length":1,"stats":{"Line":0}},{"line":413,"address":[3606832],"length":1,"stats":{"Line":0}},{"line":417,"address":[3046128],"length":1,"stats":{"Line":0}},{"line":423,"address":[3174171],"length":1,"stats":{"Line":0}},{"line":425,"address":[3268185,3269252,3268460,3268030,3268104,3268602,3268041,3268488],"length":1,"stats":{"Line":0}},{"line":427,"address":[3972402],"length":1,"stats":{"Line":0}},{"line":430,"address":[3174446,3174209,3174750,3174506,3174563],"length":1,"stats":{"Line":0}},{"line":431,"address":[3176544,3176565,3174858],"length":1,"stats":{"Line":0}},{"line":433,"address":[3268728,3268824],"length":1,"stats":{"Line":0}},{"line":434,"address":[3175115],"length":1,"stats":{"Line":0}},{"line":435,"address":[3268863,3269504,3269049,3269446],"length":1,"stats":{"Line":0}},{"line":437,"address":[3973648,3973846,3973450,3973390,3972307],"length":1,"stats":{"Line":0}},{"line":438,"address":[2628544,2628560],"length":1,"stats":{"Line":0}},{"line":439,"address":[3175904,3175826],"length":1,"stats":{"Line":0}},{"line":444,"address":[3973553,3974471,3973309,3974571],"length":1,"stats":{"Line":0}},{"line":446,"address":[3270135,3267957,3269218,3269158,3269937],"length":1,"stats":{"Line":0}},{"line":447,"address":[3270576,3270597],"length":1,"stats":{"Line":0}},{"line":451,"address":[3047176,3046192,3047182],"length":1,"stats":{"Line":0}},{"line":456,"address":[3046257],"length":1,"stats":{"Line":0}},{"line":457,"address":[3684838],"length":1,"stats":{"Line":0}},{"line":459,"address":[3684804],"length":1,"stats":{"Line":0}},{"line":462,"address":[3316516,3316374],"length":1,"stats":{"Line":0}},{"line":463,"address":[3316468],"length":1,"stats":{"Line":0}},{"line":466,"address":[3316612],"length":1,"stats":{"Line":0}},{"line":468,"address":[2629085],"length":1,"stats":{"Line":0}},{"line":469,"address":[3271072,3271058],"length":1,"stats":{"Line":0}},{"line":470,"address":[3975463],"length":1,"stats":{"Line":0}},{"line":476,"address":[3608483],"length":1,"stats":{"Line":0}},{"line":477,"address":[3685195],"length":1,"stats":{"Line":0}},{"line":478,"address":[3046693],"length":1,"stats":{"Line":0}},{"line":479,"address":[3975552,3975561],"length":1,"stats":{"Line":0}},{"line":482,"address":[3608806],"length":1,"stats":{"Line":0}},{"line":483,"address":[3608680],"length":1,"stats":{"Line":0}},{"line":484,"address":[3046882],"length":1,"stats":{"Line":0}},{"line":486,"address":[3316984],"length":1,"stats":{"Line":0}},{"line":492,"address":[3047200],"length":1,"stats":{"Line":0}},{"line":493,"address":[3047268],"length":1,"stats":{"Line":0}},{"line":495,"address":[3177520,3177536],"length":1,"stats":{"Line":0}},{"line":500,"address":[3047312],"length":1,"stats":{"Line":0}},{"line":501,"address":[3047330],"length":1,"stats":{"Line":0}},{"line":506,"address":[3317456],"length":1,"stats":{"Line":0}},{"line":507,"address":[3609266],"length":1,"stats":{"Line":0}},{"line":509,"address":[3177568,3177577],"length":1,"stats":{"Line":0}},{"line":530,"address":[3685984],"length":1,"stats":{"Line":0}},{"line":536,"address":[3976051],"length":1,"stats":{"Line":0}},{"line":537,"address":[2629875],"length":1,"stats":{"Line":0}},{"line":538,"address":[3178123],"length":1,"stats":{"Line":0}},{"line":539,"address":[3271980],"length":1,"stats":{"Line":0}},{"line":543,"address":[3182112,3182831,3178237,3178793,3178395,3182859,3178585],"length":1,"stats":{"Line":0}},{"line":544,"address":[2634051,2633942,2634545,2634261,2634517,2633856],"length":1,"stats":{"Line":0}},{"line":551,"address":[2631074,2630410,2629809],"length":1,"stats":{"Line":0}},{"line":552,"address":[3977735],"length":1,"stats":{"Line":0}},{"line":553,"address":[3179757,3179783],"length":1,"stats":{"Line":0}},{"line":554,"address":[3978077,3978011],"length":1,"stats":{"Line":0}},{"line":555,"address":[3273872],"length":1,"stats":{"Line":0}},{"line":556,"address":[2631944],"length":1,"stats":{"Line":0}},{"line":558,"address":[2631349,2632295,2632654,2632814,2632821,2633632,2632209,2632257,2632360,2632587],"length":1,"stats":{"Line":0}},{"line":560,"address":[3274670,3274599],"length":1,"stats":{"Line":0}},{"line":574,"address":[3686096],"length":1,"stats":{"Line":0}},{"line":587,"address":[3183350,3183173,3183147,3183465,3185573],"length":1,"stats":{"Line":0}},{"line":589,"address":[3276863],"length":1,"stats":{"Line":0}},{"line":590,"address":[2635046,2635133,2640112,2640134],"length":1,"stats":{"Line":0}},{"line":592,"address":[3277238,3277399,3277284,3279280],"length":1,"stats":{"Line":0}},{"line":595,"address":[3981640,3986800,3986822,3981735],"length":1,"stats":{"Line":0}},{"line":598,"address":[3183756],"length":1,"stats":{"Line":0}},{"line":599,"address":[3981974,3981895],"length":1,"stats":{"Line":0}},{"line":600,"address":[3981929,3982124],"length":1,"stats":{"Line":0}},{"line":602,"address":[3184069,3184134,3184234,3185395],"length":1,"stats":{"Line":0}},{"line":605,"address":[3184122,3188848,3188870,3184202],"length":1,"stats":{"Line":0}},{"line":606,"address":[3982514,3982633,3982423],"length":1,"stats":{"Line":0}},{"line":607,"address":[3278233,3282688,3282709],"length":1,"stats":{"Line":0}},{"line":609,"address":[3277800,3279109],"length":1,"stats":{"Line":0}},{"line":614,"address":[3982969],"length":1,"stats":{"Line":0}},{"line":615,"address":[3982000],"length":1,"stats":{"Line":0}},{"line":616,"address":[3183974],"length":1,"stats":{"Line":0}},{"line":617,"address":[2635694,2636401],"length":1,"stats":{"Line":0}},{"line":618,"address":[3278504],"length":1,"stats":{"Line":0}},{"line":621,"address":[2636652,2636747,2636778,2637474,2638250,2636835,2637564,2637430],"length":1,"stats":{"Line":0}},{"line":622,"address":[3185084],"length":1,"stats":{"Line":0}},{"line":623,"address":[2636754],"length":1,"stats":{"Line":0}},{"line":625,"address":[3278884,3279316,3279512,3276937,3278944],"length":1,"stats":{"Line":0}},{"line":626,"address":[3983988,3987248,3987269],"length":1,"stats":{"Line":0}},{"line":628,"address":[2637793,2637707],"length":1,"stats":{"Line":0}},{"line":629,"address":[2637985,2637836],"length":1,"stats":{"Line":0}},{"line":630,"address":[3985009,3984452,3984566,3984951],"length":1,"stats":{"Line":0}},{"line":632,"address":[4026856],"length":1,"stats":{"Line":0}},{"line":633,"address":[3283088,3283104],"length":1,"stats":{"Line":0}},{"line":634,"address":[3280753,3280675],"length":1,"stats":{"Line":0}},{"line":640,"address":[3281130,3282257,3279975,3280295,3281188,3281301],"length":1,"stats":{"Line":0}},{"line":642,"address":[3223102],"length":1,"stats":{"Line":0}},{"line":643,"address":[3281269,3283221,3283200],"length":1,"stats":{"Line":0}},{"line":645,"address":[3281494,3281402],"length":1,"stats":{"Line":0}},{"line":647,"address":[3187847],"length":1,"stats":{"Line":0}},{"line":651,"address":[2639581,2639493],"length":1,"stats":{"Line":0}},{"line":653,"address":[3986167,3986235],"length":1,"stats":{"Line":0}},{"line":655,"address":[3188260],"length":1,"stats":{"Line":0}},{"line":675,"address":[3610882,3610876,3609488],"length":1,"stats":{"Line":0}},{"line":680,"address":[3609680,3609559],"length":1,"stats":{"Line":0}},{"line":683,"address":[3610007,3609620],"length":1,"stats":{"Line":0}},{"line":684,"address":[3610044],"length":1,"stats":{"Line":0}},{"line":686,"address":[3049455,3049680,3048291],"length":1,"stats":{"Line":0}},{"line":687,"address":[3688050,3688172,3688240],"length":1,"stats":{"Line":0}},{"line":691,"address":[3688178],"length":1,"stats":{"Line":0}},{"line":694,"address":[3049461],"length":1,"stats":{"Line":0}},{"line":702,"address":[3610173],"length":1,"stats":{"Line":0}},{"line":703,"address":[3610304],"length":1,"stats":{"Line":0}},{"line":704,"address":[3687231,3687168,3687072],"length":1,"stats":{"Line":0}},{"line":708,"address":[3687174],"length":1,"stats":{"Line":0}},{"line":710,"address":[3048382],"length":1,"stats":{"Line":0}},{"line":711,"address":[3610256,3610943,3610983],"length":1,"stats":{"Line":0}},{"line":713,"address":[3049095],"length":1,"stats":{"Line":0}},{"line":717,"address":[3686631],"length":1,"stats":{"Line":0}},{"line":718,"address":[3048102,3050075,3050027],"length":1,"stats":{"Line":0}},{"line":720,"address":[3320424,3320120],"length":1,"stats":{"Line":0}},{"line":721,"address":[3320522],"length":1,"stats":{"Line":0}},{"line":722,"address":[3050664,3050515,3050601],"length":1,"stats":{"Line":0}},{"line":726,"address":[3320698],"length":1,"stats":{"Line":0}},{"line":728,"address":[3050374],"length":1,"stats":{"Line":0}},{"line":729,"address":[3689568,3688957,3689608],"length":1,"stats":{"Line":0}},{"line":731,"address":[3612894],"length":1,"stats":{"Line":0}},{"line":751,"address":[3692049,3689920,3691970],"length":1,"stats":{"Line":5}},{"line":752,"address":[3689947,3690030],"length":1,"stats":{"Line":10}},{"line":755,"address":[3689984,3690295],"length":1,"stats":{"Line":10}},{"line":757,"address":[3322159,3321781],"length":1,"stats":{"Line":6}},{"line":759,"address":[3613953],"length":1,"stats":{"Line":4}},{"line":761,"address":[3052134,3052212],"length":1,"stats":{"Line":8}},{"line":762,"address":[3615293,3614141],"length":1,"stats":{"Line":0}},{"line":765,"address":[3614106,3614180],"length":1,"stats":{"Line":6}},{"line":766,"address":[3322499,3322414],"length":1,"stats":{"Line":8}},{"line":768,"address":[3614387,3614411,3614317],"length":1,"stats":{"Line":9}},{"line":770,"address":[3052713,3052525,3052611],"length":1,"stats":{"Line":7}},{"line":771,"address":[2641216,2641234],"length":1,"stats":{"Line":4}},{"line":772,"address":[3987870,3987856],"length":1,"stats":{"Line":5}},{"line":774,"address":[3322601],"length":1,"stats":{"Line":1}},{"line":777,"address":[3052561,3052773,3053113],"length":1,"stats":{"Line":4}},{"line":781,"address":[3614832],"length":1,"stats":{"Line":4}},{"line":782,"address":[3691376],"length":1,"stats":{"Line":2}},{"line":783,"address":[3052836],"length":1,"stats":{"Line":4}},{"line":784,"address":[3614784],"length":1,"stats":{"Line":4}},{"line":788,"address":[3613871],"length":1,"stats":{"Line":1}}],"covered":19,"coverable":243},{"path":["/","workspaces","vouchrs","src","session.rs"],"content":"use crate::models::{VouchrsSession, VouchrsUserData};\nuse crate::oauth::OAuthState;\nuse crate::utils::cookie::{CookieOptions, ToCookie, COOKIE_NAME, USER_COOKIE_NAME};\nuse crate::utils::crypto::{derive_encryption_key, encrypt_data, decrypt_data};\nuse actix_web::{cookie::Cookie, HttpRequest, HttpResponse, ResponseError};\nuse anyhow::{anyhow, Result};\nuse chrono::Utc;\nuse serde::{de::DeserializeOwned, Serialize};\nuse std::time::{SystemTime, UNIX_EPOCH};\n\n// Custom error wrapper for ResponseError implementation\n#[derive(Debug)]\npub struct SessionError(anyhow::Error);\n\nimpl std::fmt::Display for SessionError {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        self.0.fmt(f)\n    }\n}\n\nimpl From\u003canyhow::Error\u003e for SessionError {\n    fn from(err: anyhow::Error) -\u003e Self {\n        Self(err)\n    }\n}\n\nimpl ResponseError for SessionError {\n    fn error_response(\u0026self) -\u003e HttpResponse {\n        let error_msg = self.0.to_string();\n\n        if error_msg.contains(\"Session expired\") || error_msg.contains(\"Session not found\") {\n            HttpResponse::Unauthorized().json(\"Authentication required\")\n        } else {\n            HttpResponse::InternalServerError().json(\"Internal server error\")\n        }\n    }\n}\n\n/// Session Manager for stateless encrypted session handling\n#[derive(Clone)]\npub struct SessionManager {\n    encryption_key: [u8; 32],\n    cookie_secure: bool,\n    session_duration_hours: u64,\n}\n\nimpl SessionManager {\n    /// Create a new session manager with the provided key and cookie settings\n    #[must_use]\n    pub fn new(key: \u0026[u8], cookie_secure: bool, session_duration_hours: u64) -\u003e Self {\n        let encryption_key = derive_encryption_key(key);\n\n        Self {\n            encryption_key,\n            cookie_secure,\n            session_duration_hours,\n        }\n    }\n\n    /// Create an encrypted session cookie from `VouchrsSession` (token data only)\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if encryption fails\n    pub fn create_session_cookie(\u0026self, session: \u0026VouchrsSession) -\u003e Result\u003cCookie\u003e {\n        // Use the ToCookie trait implementation\n        session.to_cookie(self)\n    }\n\n    /// Extract and decrypt session from HTTP request\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Session cookie is not found\n    /// - Decryption fails\n    /// - Session has expired\n    pub fn extract_session(\u0026self, req: \u0026HttpRequest) -\u003e Result\u003cVouchrsSession\u003e {\n        let cookie_value = req\n            .cookie(COOKIE_NAME)\n            .ok_or_else(|| anyhow!(\"Session not found\"))?\n            .value()\n            .to_string();\n\n        let session: VouchrsSession = self.decrypt_data(\u0026cookie_value)?;\n\n        // Check if tokens are expired\n        if session.expires_at \u003c= Utc::now() {\n            return Err(anyhow!(\"Session expired\"));\n        }\n\n        Ok(session)\n    }\n\n    /// Check if session needs token refresh (within 5 minutes of expiry)\n    #[must_use]\n    pub fn needs_token_refresh(\u0026self, session: \u0026VouchrsSession) -\u003e bool {\n        let now = Utc::now();\n        let buffer_time = chrono::Duration::minutes(5);\n        session.expires_at \u003c= now + buffer_time\n    }\n\n    /// Create a sign-out cookie (empty with immediate expiration)\n    #[must_use]\n    pub fn create_signout_cookie(\u0026self) -\u003e Cookie {\n        Cookie::build(COOKIE_NAME, \"\")\n            .http_only(true)\n            .secure(self.cookie_secure)\n            .same_site(actix_web::cookie::SameSite::Lax)\n            .path(\"/\")\n            .max_age(actix_web::cookie::time::Duration::seconds(0))\n            .finish()\n    }\n\n    /// Create an expired cookie to clear the session\n    #[must_use]\n    pub fn create_expired_cookie(\u0026self) -\u003e Cookie\u003c'static\u003e {\n        crate::utils::cookie::create_expired_cookie(COOKIE_NAME, self.cookie_secure)\n    }\n\n    /// Create a temporary cookie for storing OAuth state during the OAuth flow\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if encryption fails\n    pub fn create_temporary_state_cookie(\n        \u0026self,\n        oauth_state: \u0026OAuthState,\n    ) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        // Use the ToCookie trait implementation\n        oauth_state.to_cookie(self)\n    }\n\n    /// Get OAuth state from temporary cookie in request\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if decryption fails (other errors are logged and return None)\n    pub fn get_temporary_state_from_request(\n        \u0026self,\n        req: \u0026HttpRequest,\n    ) -\u003e Result\u003cOption\u003cOAuthState\u003e\u003e {\n        let cookie_name = crate::utils::cookie::OAUTH_STATE_COOKIE;\n        log::info!(\"Looking for temporary state cookie '{cookie_name}'\");\n\n        // Log all cookies in the request for debugging\n        crate::utils::cookie::log_cookies(req);\n\n        req.cookie(cookie_name).map_or_else(|| {\n            log::warn!(\"No temporary state cookie '{cookie_name}' found in request\");\n            Ok(None)\n        }, |cookie| {\n            log::info!(\n                \"Found temporary state cookie with value length: {}\",\n                cookie.value().len()\n            );\n            match self.decrypt_data::\u003cOAuthState\u003e(cookie.value()) {\n                Ok(oauth_state) =\u003e Ok(Some(oauth_state)),\n                Err(e) =\u003e {\n                    log::warn!(\"Failed to decrypt OAuth state cookie: {e}\");\n                    Ok(None)\n                }\n            }\n        })\n    }\n\n    /// Get session from HTTP request cookies\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if decryption fails (expired sessions return None)\n    pub fn get_session_from_request(\u0026self, req: \u0026HttpRequest) -\u003e Result\u003cOption\u003cVouchrsSession\u003e\u003e {\n        if let Some(cookie) = req.cookie(COOKIE_NAME) {\n            match self.decrypt_data::\u003cVouchrsSession\u003e(cookie.value()) {\n                Ok(session) =\u003e {\n                    // Check if session has expired\n                    if session.expires_at \u003c= Utc::now() {\n                        return Ok(None);\n                    }\n\n                    // Check if session needs token refresh (5 minutes before expiration)\n                    if session.expires_at - chrono::Duration::minutes(5) \u003c= Utc::now() {\n                        log::warn!(\n                            \"OAuth token needs refresh for provider: {}\",\n                            session.provider\n                        );\n                    }\n                    Ok(Some(session))\n                }\n                Err(e) if e.to_string().contains(\"Session expired\") =\u003e Ok(None),\n                Err(e) =\u003e Err(e),\n            }\n        } else {\n            Ok(None)\n        }\n    }\n\n    /// Create an expired temporary state cookie to clear it\n    #[must_use]\n    pub fn create_expired_temp_state_cookie(\u0026self) -\u003e Cookie\u003c'static\u003e {\n        crate::utils::cookie::create_expired_cookie(crate::utils::cookie::OAUTH_STATE_COOKIE, self.cookie_secure)\n    }\n\n    /// Decrypt and validate session from cookie value\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Decryption fails\n    /// - Session has expired\n    pub fn decrypt_and_validate_session(\u0026self, cookie_value: \u0026str) -\u003e Result\u003cVouchrsSession\u003e {\n        let session: VouchrsSession = self.decrypt_data(cookie_value)?;\n\n        // Check if session has expired\n        if session.expires_at \u003c= Utc::now() {\n            return Err(anyhow!(\"Session expired\"));\n        }\n\n        Ok(session)\n    }\n\n    /// Create an encrypted user data cookie from `VouchrsUserData`\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if encryption fails\n    pub fn create_user_cookie(\u0026self, user_data: \u0026VouchrsUserData) -\u003e Result\u003cCookie\u003e {\n        // Use the ToCookie trait implementation\n        user_data.to_cookie(self)\n    }\n\n    /// Extract user data from HTTP request cookie\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - User data cookie is not found\n    /// - Decryption fails\n    pub fn extract_user_data(\u0026self, req: \u0026HttpRequest) -\u003e Result\u003cVouchrsUserData\u003e {\n        let cookie_value = req\n            .cookie(USER_COOKIE_NAME)\n            .ok_or_else(|| anyhow!(\"User data not found\"))?\n            .value()\n            .to_string();\n\n        self.decrypt_data(\u0026cookie_value)\n    }\n\n    /// Get user data from HTTP request cookies (returns None if not found)\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if a critical failure occurs (decryption failures return None)\n    pub fn get_user_data_from_request(\u0026self, req: \u0026HttpRequest) -\u003e Result\u003cOption\u003cVouchrsUserData\u003e\u003e {\n        req.cookie(USER_COOKIE_NAME).map_or_else(|| Ok(None), |cookie| match self.decrypt_data::\u003cVouchrsUserData\u003e(cookie.value()) {\n                Ok(user_data) =\u003e Ok(Some(user_data)),\n                Err(e) =\u003e {\n                    log::warn!(\"Failed to decrypt user data cookie: {e}\");\n                    Ok(None)\n                }\n            })\n    }\n\n    /// Create an expired user cookie to clear user data\n    #[must_use]\n    pub fn create_expired_user_cookie(\u0026self) -\u003e Cookie\u003c'static\u003e {\n        crate::utils::cookie::create_expired_cookie(USER_COOKIE_NAME, self.cookie_secure)\n    }\n\n    /// Generic method to create a cookie with encrypted data\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if encryption fails\n    pub fn create_cookie\u003cT: Serialize\u003e(\n        \u0026self,\n        name: String,\n        data: Option\u003c\u0026T\u003e,\n        options: CookieOptions,\n    ) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        let value = match data {\n            Some(data) =\u003e self.encrypt_data(data)?,\n            None =\u003e String::new(),\n        };\n\n        Ok(Cookie::build(name, value)\n            .http_only(options.http_only)\n            .secure(self.cookie_secure \u0026\u0026 options.secure)\n            .same_site(options.same_site)\n            .path(options.path)\n            .max_age(options.max_age)\n            .finish())\n    }\n\n    /// Generic encryption function for any serializable data\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Serialization fails\n    /// - AES encryption fails\n    pub fn encrypt_data\u003cT: Serialize\u003e(\u0026self, data: \u0026T) -\u003e Result\u003cString\u003e {\n        encrypt_data(data, \u0026self.encryption_key)\n    }\n\n    /// Generic decryption function for any deserializable data\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Base64 decoding fails\n    /// - Data length is invalid\n    /// - AES decryption fails\n    /// - Deserialization fails\n    pub fn decrypt_data\u003cT: DeserializeOwned\u003e(\u0026self, encrypted_data: \u0026str) -\u003e Result\u003cT\u003e {\n        decrypt_data(encrypted_data, \u0026self.encryption_key)\n    }\n}\n\n/// Implementation of `ToCookie` for `VouchrsSession`\nimpl crate::utils::cookie::ToCookie\u003cSessionManager\u003e for VouchrsSession {\n    fn to_cookie(\u0026self, session_manager: \u0026SessionManager) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        session_manager.create_cookie(\n            COOKIE_NAME.to_string(),\n            Some(self),\n            CookieOptions {\n                same_site: actix_web::cookie::SameSite::Lax,\n                max_age: actix_web::cookie::time::Duration::hours(i64::try_from(session_manager.session_duration_hours).unwrap_or(24)),\n                ..Default::default()\n            },\n        )\n    }\n}\n\n/// Implementation of `ToCookie` for `VouchrsUserData`\nimpl crate::utils::cookie::ToCookie\u003cSessionManager\u003e for VouchrsUserData {\n    fn to_cookie(\u0026self, session_manager: \u0026SessionManager) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        session_manager.create_cookie(\n            USER_COOKIE_NAME.to_string(),\n            Some(self),\n            CookieOptions {\n                same_site: actix_web::cookie::SameSite::Lax,\n                max_age: actix_web::cookie::time::Duration::hours(i64::try_from(session_manager.session_duration_hours).unwrap_or(24)),\n                ..Default::default()\n            },\n        )\n    }\n}\n\n/// Implementation of `ToCookie` for `OAuthState`\nimpl crate::utils::cookie::ToCookie\u003cSessionManager\u003e for OAuthState {\n    fn to_cookie(\u0026self, session_manager: \u0026SessionManager) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        let cookie_name = crate::utils::cookie::OAUTH_STATE_COOKIE;\n        let options = CookieOptions {\n            same_site: actix_web::cookie::SameSite::Lax,\n            max_age: actix_web::cookie::time::Duration::minutes(10), // Short-lived for OAuth flow\n            ..Default::default()\n        };\n\n        let cookie =\n            session_manager.create_cookie(cookie_name.to_string(), Some(self), options)?;\n\n        log::info!(\n            \"Creating temporary state cookie: secure={}, name={}, encrypted_len={}\",\n            session_manager.cookie_secure,\n            cookie_name,\n            cookie.value().len()\n        );\n\n        Ok(cookie)\n    }\n}\n\n/// Helper function to get current timestamp\n/// \n/// # Panics\n/// \n/// Panics if the system time is before the Unix epoch (1970-01-01)\n#[must_use]\npub fn current_timestamp() -\u003e i64 {\n    let duration = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .expect(\"System time is before Unix epoch\");\n    \n    // Use try_from to safely convert, but realistically this won't overflow for centuries\n    i64::try_from(duration.as_secs()).unwrap_or(i64::MAX)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::test_helpers::create_test_session;\n    use chrono::Duration;\n\n    #[test]\n    fn test_token_encryption_decryption() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        let session = create_test_session();\n\n        // Test encryption with generic method\n        let encrypted = manager.encrypt_data(\u0026session).unwrap();\n        assert!(!encrypted.is_empty());\n\n        // Test decryption with generic method\n        let decrypted: VouchrsSession = manager.decrypt_data(\u0026encrypted).unwrap();\n        assert_eq!(session.provider, decrypted.provider);\n        assert_eq!(session.id_token, decrypted.id_token);\n        assert_eq!(session.refresh_token, decrypted.refresh_token);\n        assert_eq!(session.expires_at, decrypted.expires_at);\n    }\n\n    #[test]\n    fn test_needs_token_refresh() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        // Session with token expiring in 10 minutes (should NOT need refresh)\n        let mut session = create_test_session();\n        session.expires_at = Utc::now() + Duration::minutes(10);\n        assert!(!manager.needs_token_refresh(\u0026session));\n        // Session with token expiring in 2 minutes (should need refresh)\n        session.expires_at = Utc::now() + Duration::minutes(2);\n        assert!(manager.needs_token_refresh(\u0026session));\n        // Session with expired token (should need refresh)\n        session.expires_at = Utc::now() - Duration::minutes(10);\n        assert!(manager.needs_token_refresh(\u0026session));\n    }\n\n    #[test]\n    fn test_cookie_size_reduction() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        let session = create_test_session();\n\n        // Create cookie with token data (current approach)\n        let token_cookie = manager.create_session_cookie(\u0026session).unwrap();\n        let token_size = token_cookie.value().len();\n\n        // The current approach should work fine\n        let token_json = serde_json::to_string(\u0026session).unwrap();\n\n        println!(\"Token JSON size: {} bytes\", token_json.len());\n        println!(\"Token cookie size: {token_size} bytes\");\n\n        // Log the compact nature of the token data\n        assert!(!token_json.is_empty());\n        assert!(!token_cookie.value().is_empty());\n    }\n\n    #[test]\n    fn test_generic_encryption_decryption() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        let session = create_test_session();\n\n        // Test generic encryption\n        let encrypted = manager.encrypt_data(\u0026session).unwrap();\n        assert!(!encrypted.is_empty());\n\n        // Test generic decryption\n        let decrypted: VouchrsSession = manager.decrypt_data(\u0026encrypted).unwrap();\n        assert_eq!(session.provider, decrypted.provider);\n        assert_eq!(session.id_token, decrypted.id_token);\n        assert_eq!(session.refresh_token, decrypted.refresh_token);\n        assert_eq!(session.expires_at, decrypted.expires_at);\n    }\n\n    #[test]\n    fn test_to_cookie_trait() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        let session = create_test_session();\n\n        // Test ToCookie implementation for VouchrsSession\n        let cookie = session.to_cookie(\u0026manager).unwrap();\n        assert_eq!(cookie.name(), COOKIE_NAME);\n        assert!(!cookie.value().is_empty());\n\n        // Verify we can decrypt the cookie\n        let decrypted: VouchrsSession = manager.decrypt_data(cookie.value()).unwrap();\n        assert_eq!(session.provider, decrypted.provider);\n        assert_eq!(session.id_token, decrypted.id_token);\n    }\n}\n","traces":[{"line":16,"address":[3147952],"length":1,"stats":{"Line":0}},{"line":17,"address":[3798014],"length":1,"stats":{"Line":0}},{"line":22,"address":[3798032],"length":1,"stats":{"Line":0}},{"line":28,"address":[3413636,3413544,3413168],"length":1,"stats":{"Line":0}},{"line":29,"address":[3148025],"length":1,"stats":{"Line":0}},{"line":31,"address":[3851265,3851333,3851421],"length":1,"stats":{"Line":0}},{"line":32,"address":[3413555,3413340],"length":1,"stats":{"Line":0}},{"line":34,"address":[3148242],"length":1,"stats":{"Line":0}},{"line":50,"address":[3148496],"length":1,"stats":{"Line":9}},{"line":51,"address":[3413710],"length":1,"stats":{"Line":9}},{"line":65,"address":[3413792],"length":1,"stats":{"Line":1}},{"line":67,"address":[3851875],"length":1,"stats":{"Line":1}},{"line":78,"address":[3414955,3413856,3414947],"length":1,"stats":{"Line":0}},{"line":79,"address":[3798918,3798790,3799087],"length":1,"stats":{"Line":0}},{"line":81,"address":[3416928,3416932],"length":1,"stats":{"Line":0}},{"line":85,"address":[3149129,3149812],"length":1,"stats":{"Line":0}},{"line":88,"address":[3414716,3414631],"length":1,"stats":{"Line":0}},{"line":89,"address":[3852873,3852923],"length":1,"stats":{"Line":0}},{"line":92,"address":[3414737],"length":1,"stats":{"Line":0}},{"line":97,"address":[3414976],"length":1,"stats":{"Line":1}},{"line":98,"address":[3149859],"length":1,"stats":{"Line":1}},{"line":99,"address":[3799918],"length":1,"stats":{"Line":1}},{"line":100,"address":[3853122],"length":1,"stats":{"Line":1}},{"line":105,"address":[3415120,3415507,3415475],"length":1,"stats":{"Line":0}},{"line":106,"address":[3853365,3853347,3853491,3853230,3853540],"length":1,"stats":{"Line":0}},{"line":108,"address":[3853330],"length":1,"stats":{"Line":0}},{"line":109,"address":[3150141],"length":1,"stats":{"Line":0}},{"line":111,"address":[3853457,3853576,3853532,3853438],"length":1,"stats":{"Line":0}},{"line":117,"address":[3415520],"length":1,"stats":{"Line":0}},{"line":118,"address":[3150417],"length":1,"stats":{"Line":0}},{"line":126,"address":[3853680],"length":1,"stats":{"Line":0}},{"line":131,"address":[3150499],"length":1,"stats":{"Line":0}},{"line":139,"address":[3415648],"length":1,"stats":{"Line":0}},{"line":143,"address":[3800618],"length":1,"stats":{"Line":0}},{"line":144,"address":[3415820,3415711],"length":1,"stats":{"Line":0}},{"line":147,"address":[3415746],"length":1,"stats":{"Line":0}},{"line":149,"address":[3853852],"length":1,"stats":{"Line":0}},{"line":150,"address":[2582821,2582905],"length":1,"stats":{"Line":0}},{"line":151,"address":[2758728],"length":1,"stats":{"Line":0}},{"line":152,"address":[2584242,2583104,2582897],"length":1,"stats":{"Line":0}},{"line":153,"address":[2583394,2583227,2583271,2583134],"length":1,"stats":{"Line":0}},{"line":155,"address":[2583342],"length":1,"stats":{"Line":0}},{"line":157,"address":[2583617,2583238],"length":1,"stats":{"Line":0}},{"line":158,"address":[2759598],"length":1,"stats":{"Line":0}},{"line":159,"address":[3417857],"length":1,"stats":{"Line":0}},{"line":160,"address":[2583677,2583869,2583979],"length":1,"stats":{"Line":0}},{"line":161,"address":[3641638],"length":1,"stats":{"Line":0}},{"line":172,"address":[3417859,3417433,3416032],"length":1,"stats":{"Line":0}},{"line":173,"address":[3801207,3801014],"length":1,"stats":{"Line":0}},{"line":174,"address":[3801271,3801149],"length":1,"stats":{"Line":0}},{"line":175,"address":[3801373],"length":1,"stats":{"Line":0}},{"line":177,"address":[3801550,3801469],"length":1,"stats":{"Line":0}},{"line":178,"address":[3801649],"length":1,"stats":{"Line":0}},{"line":182,"address":[3801583,3801759],"length":1,"stats":{"Line":0}},{"line":183,"address":[3801926],"length":1,"stats":{"Line":0}},{"line":188,"address":[3151798],"length":1,"stats":{"Line":0}},{"line":190,"address":[3802403,3802605,3801335],"length":1,"stats":{"Line":0}},{"line":191,"address":[3152506],"length":1,"stats":{"Line":0}},{"line":194,"address":[3151123],"length":1,"stats":{"Line":0}},{"line":200,"address":[3417920],"length":1,"stats":{"Line":0}},{"line":201,"address":[3802897],"length":1,"stats":{"Line":0}},{"line":211,"address":[3803552,3802944,3803558],"length":1,"stats":{"Line":0}},{"line":212,"address":[3802985],"length":1,"stats":{"Line":0}},{"line":215,"address":[3856517,3856442],"length":1,"stats":{"Line":0}},{"line":216,"address":[3856598,3856645],"length":1,"stats":{"Line":0}},{"line":219,"address":[3153334],"length":1,"stats":{"Line":0}},{"line":227,"address":[3856752],"length":1,"stats":{"Line":2}},{"line":229,"address":[3803619],"length":1,"stats":{"Line":2}},{"line":239,"address":[3418672,3419163,3419169],"length":1,"stats":{"Line":0}},{"line":240,"address":[3418849,3419017,3418723],"length":1,"stats":{"Line":0}},{"line":242,"address":[3642016,3642020],"length":1,"stats":{"Line":0}},{"line":246,"address":[3804074],"length":1,"stats":{"Line":0}},{"line":254,"address":[3154128],"length":1,"stats":{"Line":2}},{"line":255,"address":[3642838,3642262,3642080,3642144,3642094,3642179],"length":1,"stats":{"Line":8}},{"line":256,"address":[3642361],"length":1,"stats":{"Line":2}},{"line":257,"address":[3642303],"length":1,"stats":{"Line":0}},{"line":258,"address":[2584568,2584757,2584824],"length":1,"stats":{"Line":0}},{"line":259,"address":[2760644],"length":1,"stats":{"Line":0}},{"line":266,"address":[3857456],"length":1,"stats":{"Line":0}},{"line":267,"address":[3857473],"length":1,"stats":{"Line":0}},{"line":275,"address":[2586810,2587674,2585946,2585120,2586848,2585984],"length":1,"stats":{"Line":4}},{"line":281,"address":[3644700,3642908,3643804],"length":1,"stats":{"Line":4}},{"line":282,"address":[3643160,3644952,3643869,3642973,3644056,3644765],"length":1,"stats":{"Line":8}},{"line":283,"address":[3644802,3643906,3644850,3643010,3643058,3643954],"length":1,"stats":{"Line":0}},{"line":286,"address":[2587488,2586459,2587367,2585595,2585807,2586503,2586624,2585317,2586181,2585760,2587535,2586671,2587323,2587045,2585639],"length":1,"stats":{"Line":20}},{"line":287,"address":[3421575,3419783,3420679],"length":1,"stats":{"Line":4}},{"line":288,"address":[2585607,2586471,2587335],"length":1,"stats":{"Line":4}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[2761593,2762489,2763385],"length":1,"stats":{"Line":4}},{"line":291,"address":[2586635,2587499,2585771],"length":1,"stats":{"Line":4}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[3422128,3422000,3422064],"length":1,"stats":{"Line":6}},{"line":303,"address":[3422099,3422035,3422163],"length":1,"stats":{"Line":5}},{"line":315,"address":[2763952,2763872,2764032],"length":1,"stats":{"Line":5}},{"line":316,"address":[2588117,2588037,2587957],"length":1,"stats":{"Line":5}},{"line":322,"address":[3594962,3594968,3594576],"length":1,"stats":{"Line":1}},{"line":323,"address":[3594928],"length":1,"stats":{"Line":2}},{"line":324,"address":[4390651],"length":1,"stats":{"Line":1}},{"line":325,"address":[3594655],"length":1,"stats":{"Line":2}},{"line":326,"address":[3671502],"length":1,"stats":{"Line":2}},{"line":327,"address":[4390692],"length":1,"stats":{"Line":2}},{"line":328,"address":[3594740,3594668],"length":1,"stats":{"Line":3}},{"line":329,"address":[3671473],"length":1,"stats":{"Line":2}},{"line":337,"address":[3594992,3595378,3595384],"length":1,"stats":{"Line":2}},{"line":338,"address":[3595344],"length":1,"stats":{"Line":2}},{"line":339,"address":[3060203],"length":1,"stats":{"Line":2}},{"line":340,"address":[4391103],"length":1,"stats":{"Line":2}},{"line":341,"address":[3595230],"length":1,"stats":{"Line":2}},{"line":342,"address":[3060244],"length":1,"stats":{"Line":2}},{"line":343,"address":[3060329,3060252],"length":1,"stats":{"Line":4}},{"line":344,"address":[3671889],"length":1,"stats":{"Line":2}},{"line":352,"address":[3615376,3616535,3616551],"length":1,"stats":{"Line":0}},{"line":353,"address":[3323627],"length":1,"stats":{"Line":0}},{"line":356,"address":[3323664],"length":1,"stats":{"Line":0}},{"line":360,"address":[3692361,3692281],"length":1,"stats":{"Line":0}},{"line":363,"address":[3692928],"length":1,"stats":{"Line":0}},{"line":370,"address":[3054148],"length":1,"stats":{"Line":0}},{"line":380,"address":[3419360],"length":1,"stats":{"Line":0}},{"line":381,"address":[3804356],"length":1,"stats":{"Line":0}},{"line":386,"address":[3804431],"length":1,"stats":{"Line":0}}],"covered":41,"coverable":120},{"path":["/","workspaces","vouchrs","src","session_builder.rs"],"content":"// Session builder for creating VouchrSession from ID token claims\n//\n// This module provides a unified approach for extracting user information from OAuth ID tokens\n// and mapping them to VouchrSession fields. It replaces the complex provider-specific extraction\n// logic with a standardized approach that works with all OAuth providers that issue standard\n// OpenID Connect ID tokens.\n//\n// Standard ID Token Claims Mapping:\n// - sub (subject) -\u003e provider_id: Unique identifier for the user from the provider\n// - email -\u003e user_email: User's email address\n// - iat (issued at) -\u003e created_at: When the token was issued\n// - exp (expires) -\u003e expires_at: When the token expires\n// - iss (issuer) -\u003e provider: OAuth provider (normalized from issuer URL)\n// - name, given_name+family_name -\u003e user_name: User's display name (optional)\n\nuse crate::utils::crypto::decode_jwt_payload;\nuse crate::models::CompleteSessionData;\nuse crate::utils::apple::AppleUserInfo;\nuse chrono::{DateTime, TimeZone, Utc};\nuse log::{debug, info, warn};\nuse serde_json::Value;\n\npub struct SessionBuilder;\n\nimpl SessionBuilder {\n    /// Creates a `CompleteSessionData` from OAuth tokens, extracting standard claims from the ID token\n    /// and using Apple user info to fill in missing fields if available\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - The ID token is missing or invalid\n    /// - JWT decoding fails\n    /// - Required claims are missing from the token\n    pub fn build_session(\n        provider: String,\n        id_token: Option\u003cString\u003e,\n        refresh_token: Option\u003cString\u003e,\n        expires_at: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cCompleteSessionData, String\u003e {\n        Self::build_session_with_apple_info(provider, id_token, refresh_token, expires_at, None)\n    }\n\n    /// Creates a `CompleteSessionData` from OAuth tokens with optional Apple user info for fallback\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - The ID token is missing or invalid\n    /// - JWT decoding fails\n    /// - Required claims are missing from the token\n    ///\n    /// # Panics\n    ///\n    /// This function panics if it cannot provide a fallback email address. However, the current\n    /// implementation always provides a default email, making panics unlikely.\n    #[allow(clippy::needless_pass_by_value)]\n    pub fn build_session_with_apple_info(\n        provider: String,\n        id_token: Option\u003cString\u003e,\n        refresh_token: Option\u003cString\u003e,\n        expires_at: DateTime\u003cUtc\u003e,\n        apple_user_info: Option\u003cAppleUserInfo\u003e,\n    ) -\u003e Result\u003cCompleteSessionData, String\u003e {\n        let id_token_ref = id_token.as_ref().ok_or(\"No ID token available\")?;\n\n        let claims = decode_jwt_payload(id_token_ref)\n            .map_err(|e| format!(\"Failed to decode ID token: {e}\"))?;\n\n        info!(\n            \"Building session from ID token claims for provider: {provider}\"\n        );\n        debug!(\n            \"ID token claims: {}\",\n            serde_json::to_string_pretty(\u0026claims).unwrap_or_default()\n        );\n\n        // Extract required claims\n        let provider_id = Self::extract_subject(\u0026claims)?;\n        let user_email = Self::extract_email(\u0026claims)\n            .or_else(|| {\n                // Fallback to Apple user info if email not in token\n                if let Some(ref apple_info) = apple_user_info {\n                    if let Some(ref email) = apple_info.email {\n                        debug!(\"Using Apple user info email as fallback: {email}\");\n                        return Some(email.clone());\n                    }\n                }\n                debug!(\"No email found in ID token or Apple user info, using default\");\n                Some(\"user@example.com\".to_string())\n            })\n            .unwrap(); // This unwrap is safe because we provide a default\n\n        // Extract optional claims\n        let mut user_name = Self::extract_name(\u0026claims);\n\n        // Use Apple user info name as fallback if name not found in ID token\n        if user_name.is_none() {\n            if let Some(ref apple_info) = apple_user_info {\n                let apple_name = apple_info.name.full_name();\n                if !apple_name.trim().is_empty() {\n                    debug!(\"Using Apple user info name as fallback: {apple_name}\");\n                    user_name = Some(apple_name);\n                }\n            }\n        }\n        let created_at = Self::extract_issued_at(\u0026claims);\n        // let expires_at = Self::extract_expires_at(\u0026claims);\n\n        // Normalize provider name from issuer if available\n        let normalized_provider = Self::normalize_provider(\u0026provider, \u0026claims);\n\n        info!(\n            \"Session built successfully - Email: {user_email}, Provider: {normalized_provider}, Provider ID: {provider_id}, Name: {user_name:?}\"\n        );\n\n        Ok(CompleteSessionData {\n            user_email,\n            user_name,\n            provider: normalized_provider,\n            provider_id,\n            id_token: id_token.clone(),\n            refresh_token,\n            expires_at,\n            created_at: created_at.unwrap_or_else(Utc::now),\n        })\n    }\n\n    /// Extract the subject (sub) claim - maps to `provider_id`\n    fn extract_subject(claims: \u0026Value) -\u003e Result\u003cString, String\u003e {\n        claims\n            .get(\"sub\")\n            .and_then(|v| v.as_str())\n            .map(std::string::ToString::to_string)\n            .ok_or_else(|| \"Missing or invalid 'sub' claim in ID token\".to_string())\n    }\n\n    /// Extract the email claim - maps to `user_email` (returns Option for fallback logic)\n    #[must_use]\n    pub fn extract_email(claims: \u0026Value) -\u003e Option\u003cString\u003e {\n        claims\n            .get(\"email\")\n            .and_then(|v| v.as_str())\n            .map(std::string::ToString::to_string)\n    }\n\n    /// Extract the name claim - maps to `user_name` (optional)\n    fn extract_name(claims: \u0026Value) -\u003e Option\u003cString\u003e {\n        // Try different name claim formats used by different providers\n\n        // Google uses 'name' field directly\n        if let Some(name) = claims.get(\"name\").and_then(|v| v.as_str()) {\n            if !name.trim().is_empty() {\n                debug!(\"Extracted name from 'name' claim: {name}\");\n                return Some(name.to_string());\n            }\n        }\n\n        // Apple and others might use given_name + family_name\n        let given_name = claims\n            .get(\"given_name\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"\");\n        let family_name = claims\n            .get(\"family_name\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"\");\n\n        if !given_name.is_empty() || !family_name.is_empty() {\n            let full_name = format!(\"{given_name} {family_name}\").trim().to_string();\n            if !full_name.is_empty() {\n                debug!(\n                    \"Extracted name from given_name + family_name: {full_name}\"\n                );\n                return Some(full_name);\n            }\n        }\n\n        debug!(\"No name information found in ID token claims\");\n        None\n    }\n\n    /// Generic timestamp extraction helper\n    fn extract_timestamp(claims: \u0026Value, field_name: \u0026str) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n        claims\n            .get(field_name)\n            .and_then(serde_json::Value::as_i64)\n            .and_then(|timestamp| if let chrono::LocalResult::Single(dt) = Utc.timestamp_opt(timestamp, 0) {\n                debug!(\n                    \"Extracted {field_name} from '{field_name}' claim: {dt}\"\n                );\n                Some(dt)\n            } else {\n                warn!(\n                    \"Invalid '{field_name}' timestamp in ID token: {timestamp}\"\n                );\n                None\n            })\n    }\n\n    /// Extract the issued at (iat) claim - maps to `created_at`\n    fn extract_issued_at(claims: \u0026Value) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n        Self::extract_timestamp(claims, \"iat\")\n    }\n\n    /// Normalize provider name from issuer claim if available\n    fn normalize_provider(provider: \u0026str, claims: \u0026Value) -\u003e String {\n        if let Some(issuer) = claims.get(\"iss\").and_then(|v| v.as_str()) {\n            debug!(\"Found issuer claim: {issuer}\");\n\n            // Map common issuer values to normalized provider names\n            if issuer.contains(\"accounts.google.com\") {\n                return \"google\".to_string();\n            } else if issuer.contains(\"appleid.apple.com\") {\n                return \"apple\".to_string();\n            }\n        }\n\n        // Fall back to the provider passed in from the state\n        provider.to_string()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::apple::{AppleUserInfo, AppleUserName};\n    use base64::Engine as _;\n    use chrono::Utc;\n    use serde_json::json;\n\n    fn minimal_id_token(sub: \u0026str) -\u003e String {\n        // JWT with only 'sub' claim, base64-encoded header and payload, signature ignored\n        let header = base64::engine::general_purpose::URL_SAFE_NO_PAD.encode(b\"{\\\"alg\\\":\\\"none\\\"}\");\n        let payload = base64::engine::general_purpose::URL_SAFE_NO_PAD\n            .encode(format!(r#\"{{\"sub\":\"{sub}\"}}\"#).as_bytes());\n        format!(\"{header}.{payload}.ignored\")\n    }\n\n    #[test]\n    fn test_apple_userinfo_copied_to_vouchrsession() {\n        let id_token = Some(minimal_id_token(\"apple-sub-123\"));\n        let refresh_token = Some(\"refresh123\".to_string());\n        let expires_at = Utc::now() + chrono::Duration::hours(1);\n        let apple_user_info = AppleUserInfo {\n            name: AppleUserName {\n                first_name: Some(\"Jane\".to_string()),\n                last_name: Some(\"Doe\".to_string()),\n            },\n            email: Some(\"jane.doe@apple.com\".to_string()),\n        };\n        // Test with AppleUserInfo as struct (Value::Object case)\n        let session = SessionBuilder::build_session_with_apple_info(\n            \"apple\".to_string(),\n            id_token.clone(),\n            refresh_token.clone(),\n            expires_at,\n            Some(apple_user_info.clone()),\n        )\n        .expect(\"Session should be built\");\n        assert_eq!(session.user_email, apple_user_info.email.clone().unwrap());\n        assert_eq!(\n            session.user_name.clone().unwrap(),\n            apple_user_info.name.full_name()\n        );\n        assert_eq!(session.provider, \"apple\");\n        assert_eq!(session.provider_id, \"apple-sub-123\");\n\n        // Test that session building works correctly with Apple user info\n        // The important part is that the Apple user info is properly incorporated into the session\n        assert_eq!(session.user_email, \"jane.doe@apple.com\");\n        assert_eq!(session.user_name.unwrap(), \"Jane Doe\");\n    }\n\n    #[test]\n    fn test_extract_subject_success() {\n        let claims = json!({\n            \"sub\": \"12345\",\n            \"email\": \"test@example.com\"\n        });\n\n        assert_eq!(SessionBuilder::extract_subject(\u0026claims).unwrap(), \"12345\");\n    }\n\n    #[test]\n    fn test_extract_subject_missing() {\n        let claims = json!({\n            \"email\": \"test@example.com\"\n        });\n\n        assert!(SessionBuilder::extract_subject(\u0026claims).is_err());\n    }\n\n    #[test]\n    fn test_extract_name_google_format() {\n        let claims = json!({\n            \"name\": \"John Doe\"\n        });\n\n        assert_eq!(\n            SessionBuilder::extract_name(\u0026claims),\n            Some(\"John Doe\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_extract_name_apple_format() {\n        let claims = json!({\n            \"given_name\": \"John\",\n            \"family_name\": \"Doe\"\n        });\n\n        assert_eq!(\n            SessionBuilder::extract_name(\u0026claims),\n            Some(\"John Doe\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_extract_name_missing() {\n        let claims = json!({\n            \"sub\": \"12345\",\n            \"email\": \"test@example.com\"\n        });\n\n        assert_eq!(SessionBuilder::extract_name(\u0026claims), None);\n    }\n}\n","traces":[{"line":35,"address":[3008896],"length":1,"stats":{"Line":3}},{"line":41,"address":[3436028],"length":1,"stats":{"Line":3}},{"line":58,"address":[3011756,3008976,3013511],"length":1,"stats":{"Line":2}},{"line":65,"address":[3877977,3873689,3873562],"length":1,"stats":{"Line":8}},{"line":67,"address":[3873855,3874034,3877975],"length":1,"stats":{"Line":6}},{"line":68,"address":[3635024,3635045],"length":1,"stats":{"Line":3}},{"line":70,"address":[3729919,3729823,3729973],"length":1,"stats":{"Line":9}},{"line":73,"address":[3010024,3010180,3009685,3010056],"length":1,"stats":{"Line":7}},{"line":79,"address":[3874993,3874590],"length":1,"stats":{"Line":6}},{"line":80,"address":[3437783,3437859],"length":1,"stats":{"Line":4}},{"line":81,"address":[2756464],"length":1,"stats":{"Line":1}},{"line":83,"address":[3805862],"length":1,"stats":{"Line":1}},{"line":84,"address":[3635377,3635293],"length":1,"stats":{"Line":2}},{"line":85,"address":[2756729,2756634],"length":1,"stats":{"Line":2}},{"line":86,"address":[2756665],"length":1,"stats":{"Line":1}},{"line":89,"address":[3415334,3414894],"length":1,"stats":{"Line":0}},{"line":90,"address":[3415266],"length":1,"stats":{"Line":0}},{"line":95,"address":[3875384,3875336],"length":1,"stats":{"Line":4}},{"line":98,"address":[3875457,3875392],"length":1,"stats":{"Line":6}},{"line":99,"address":[3876282,3875497],"length":1,"stats":{"Line":3}},{"line":100,"address":[3438153],"length":1,"stats":{"Line":2}},{"line":101,"address":[3731276,3731344,3731965],"length":1,"stats":{"Line":3}},{"line":102,"address":[3875761,3875861,3875696],"length":1,"stats":{"Line":5}},{"line":103,"address":[3438738,3438375],"length":1,"stats":{"Line":2}},{"line":107,"address":[3875479],"length":1,"stats":{"Line":1}},{"line":111,"address":[3438950],"length":1,"stats":{"Line":1}},{"line":113,"address":[3876487,3876687,3876400],"length":1,"stats":{"Line":8}},{"line":117,"address":[3732986],"length":1,"stats":{"Line":3}},{"line":118,"address":[3876505],"length":1,"stats":{"Line":3}},{"line":119,"address":[3876545],"length":1,"stats":{"Line":3}},{"line":120,"address":[3732281],"length":1,"stats":{"Line":3}},{"line":121,"address":[3876625],"length":1,"stats":{"Line":3}},{"line":122,"address":[3876665],"length":1,"stats":{"Line":3}},{"line":123,"address":[3439743],"length":1,"stats":{"Line":3}},{"line":125,"address":[3012590],"length":1,"stats":{"Line":3}},{"line":130,"address":[3878112],"length":1,"stats":{"Line":1}},{"line":131,"address":[3733838],"length":1,"stats":{"Line":1}},{"line":133,"address":[3806576,3806585],"length":1,"stats":{"Line":2}},{"line":135,"address":[2757244,2757232],"length":1,"stats":{"Line":2}},{"line":140,"address":[3013632],"length":1,"stats":{"Line":1}},{"line":141,"address":[3440864],"length":1,"stats":{"Line":3}},{"line":143,"address":[2757280,2757289],"length":1,"stats":{"Line":4}},{"line":148,"address":[3878320,3879926,3879920],"length":1,"stats":{"Line":1}},{"line":152,"address":[2757321,2757312],"length":1,"stats":{"Line":3}},{"line":153,"address":[3734151],"length":1,"stats":{"Line":1}},{"line":154,"address":[3441276,3441388],"length":1,"stats":{"Line":2}},{"line":155,"address":[3734401],"length":1,"stats":{"Line":1}},{"line":160,"address":[3878501],"length":1,"stats":{"Line":1}},{"line":162,"address":[3636105,3636096],"length":1,"stats":{"Line":2}},{"line":164,"address":[3441178],"length":1,"stats":{"Line":1}},{"line":166,"address":[3415705,3415696],"length":1,"stats":{"Line":2}},{"line":169,"address":[3879221,3878634],"length":1,"stats":{"Line":2}},{"line":170,"address":[3014413,3014683],"length":1,"stats":{"Line":1}},{"line":171,"address":[3014854],"length":1,"stats":{"Line":1}},{"line":172,"address":[3442162,3442097,3442261],"length":1,"stats":{"Line":3}},{"line":175,"address":[3014951],"length":1,"stats":{"Line":1}},{"line":179,"address":[3879251,3879962],"length":1,"stats":{"Line":2}},{"line":180,"address":[3442552],"length":1,"stats":{"Line":1}},{"line":184,"address":[3015520],"length":1,"stats":{"Line":1}},{"line":185,"address":[3880186],"length":1,"stats":{"Line":1}},{"line":188,"address":[3636160,3636337,3636187,3636922],"length":1,"stats":{"Line":0}},{"line":189,"address":[3636238,3636342],"length":1,"stats":{"Line":0}},{"line":192,"address":[3806946],"length":1,"stats":{"Line":0}},{"line":194,"address":[2758172,2757519],"length":1,"stats":{"Line":0}},{"line":197,"address":[2758164],"length":1,"stats":{"Line":0}},{"line":202,"address":[3015616],"length":1,"stats":{"Line":1}},{"line":203,"address":[3880257],"length":1,"stats":{"Line":1}},{"line":207,"address":[3880288],"length":1,"stats":{"Line":1}},{"line":208,"address":[3416784,3416793],"length":1,"stats":{"Line":1}},{"line":209,"address":[3880535,3880436],"length":1,"stats":{"Line":0}},{"line":212,"address":[3736190],"length":1,"stats":{"Line":0}},{"line":213,"address":[3016164],"length":1,"stats":{"Line":0}},{"line":214,"address":[3016122],"length":1,"stats":{"Line":0}},{"line":215,"address":[3880815],"length":1,"stats":{"Line":0}},{"line":220,"address":[3880483],"length":1,"stats":{"Line":1}}],"covered":63,"coverable":75},{"path":["/","workspaces","vouchrs","src","settings.rs"],"content":"use serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::fs;\nuse base64::{Engine as _, engine::general_purpose};\n\n// Additional imports for environment and logging setup\n\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct VouchrsSettings {\n    pub application: ApplicationSettings,\n    pub proxy: ProxySettings,\n    pub static_files: StaticFilesSettings,\n    pub session: SessionSettings,\n    pub cookies: CookieSettings,\n    pub logging: LoggingSettings,\n    pub providers: Vec\u003cProviderSettings\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ApplicationSettings {\n    pub host: String,\n    pub port: u16,\n    pub redirect_base_url: String,\n    pub cors_origins: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ProxySettings {\n    pub upstream_url: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct StaticFilesSettings {\n    pub assets_folder: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SessionSettings {\n    pub session_duration_hours: u64,\n    pub session_secret: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CookieSettings {\n    pub secure: bool,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct LoggingSettings {\n    pub level: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ProviderSettings {\n    pub name: String,\n    pub display_name: Option\u003cString\u003e,\n    pub discovery_url: Option\u003cString\u003e,\n    pub authorization_endpoint: Option\u003cString\u003e,\n    pub token_endpoint: Option\u003cString\u003e,\n    pub userinfo_endpoint: Option\u003cString\u003e,\n    pub jwks_uri: Option\u003cString\u003e,\n    pub signout_url: Option\u003cString\u003e,\n    pub scopes: Vec\u003cString\u003e,\n\n    // Direct values (can be overridden by environment variables)\n    pub client_id: Option\u003cString\u003e,\n    pub client_secret: Option\u003cString\u003e,\n\n    // Environment variable names for overrides\n    pub client_id_env: Option\u003cString\u003e,\n    pub client_secret_env: Option\u003cString\u003e,\n\n    pub enabled: bool,\n    pub extra_auth_params: HashMap\u003cString, String\u003e,\n    pub jwt_signing: Option\u003cJwtSigningConfig\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct JwtSigningConfig {\n    // Direct values (can be overridden by environment variables)\n    pub team_id: Option\u003cString\u003e,\n    pub key_id: Option\u003cString\u003e,\n    pub private_key_path: Option\u003cString\u003e,\n\n    // Environment variable names for overrides\n    pub team_id_env: Option\u003cString\u003e,\n    pub key_id_env: Option\u003cString\u003e,\n    pub private_key_path_env: Option\u003cString\u003e,\n}\n\nimpl Default for ApplicationSettings {\n    fn default() -\u003e Self {\n        Self {\n            host: \"0.0.0.0\".to_string(),\n            port: 8080,\n            redirect_base_url: \"http://localhost:8080\".to_string(),\n            cors_origins: \"http://localhost:3000,http://localhost:8080\".to_string(),\n        }\n    }\n}\n\nimpl Default for ProxySettings {\n    fn default() -\u003e Self {\n        Self {\n            upstream_url: \"http://localhost:3000\".to_string(),\n        }\n    }\n}\n\nimpl Default for StaticFilesSettings {\n    fn default() -\u003e Self {\n        Self {\n            assets_folder: \"src/static\".to_string(),\n        }\n    }\n}\n\nimpl Default for SessionSettings {\n    fn default() -\u003e Self {\n        Self {\n            session_duration_hours: 24,\n            session_secret: String::new(), // Will be generated if empty\n        }\n    }\n}\n\nimpl Default for CookieSettings {\n    fn default() -\u003e Self {\n        Self {\n            secure: true, // Default to secure cookies\n        }\n    }\n}\n\nimpl Default for LoggingSettings {\n    fn default() -\u003e Self {\n        Self {\n            level: \"info\".to_string(),\n        }\n    }\n}\n\nimpl Default for ProviderSettings {\n    fn default() -\u003e Self {\n        Self {\n            name: String::new(),\n            display_name: None,\n            discovery_url: None,\n            authorization_endpoint: None,\n            token_endpoint: None,\n            userinfo_endpoint: None,\n            jwks_uri: None,\n            signout_url: None,\n            scopes: vec![\"openid\".to_string(), \"email\".to_string()],\n            client_id: None,\n            client_secret: None,\n            client_id_env: None,\n            client_secret_env: None,\n            enabled: true,\n            extra_auth_params: HashMap::new(),\n            jwt_signing: None,\n        }\n    }\n}\n\nimpl VouchrsSettings {\n    /// Load settings from configuration files and environment variables\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Environment initialization fails\n    /// - Settings file cannot be read or parsed\n    /// - TOML parsing fails\n    pub fn load() -\u003e Result\u003cSelf, Box\u003cdyn std::error::Error\u003e\u003e {\n        // Initialize environment and logging\n        Self::initialize_environment()?;\n\n        // Load base settings from TOML or defaults\n        let mut settings = Self::load_base_settings()?;\n\n        // Apply environment variable overrides\n        Self::apply_env_overrides(\u0026mut settings);\n\n        Ok(settings)\n    }\n\n    /// Initialize environment variables and logging\n    /// \n    /// # Errors\n    /// \n    /// Initialize environment and logging\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if logger initialization fails\n    fn initialize_environment() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n        Self::load_env_file();\n        env_logger::try_init()?;\n        Ok(())\n    }\n\n    /// Load base settings from TOML file(s) or use defaults\n    /// Settings are loaded with the following priority (highest to lowest):\n    /// 1. Environment variables (applied separately after loading base settings)\n    /// 2. Settings.toml in `VOUCHRS_SECRETS_DIR` (if specified and exists)\n    /// 3. Settings.toml in current directory (if exists)\n    /// 4. Default settings\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Settings file cannot be read\n    /// - TOML parsing fails\n    fn load_base_settings() -\u003e Result\u003cSelf, Box\u003cdyn std::error::Error\u003e\u003e {\n        // 1. Start with default settings\n        let mut settings = Self::default();\n\n        // 2. Try to load from Settings.toml in current directory (lower priority)\n        let default_config_path = std::path::PathBuf::from(\"Settings.toml\");\n        if default_config_path.exists() {\n            let toml_content = fs::read_to_string(\u0026default_config_path)?;\n            settings = basic_toml::from_str(\u0026toml_content)?;\n            println!(\n                \"âœ“ Loaded base settings from {}\",\n                default_config_path.display()\n            );\n        }\n\n        // 3. If VOUCHRS_SECRETS_DIR is set and contains Settings.toml, override with those settings (higher priority)\n        if let Ok(secrets_dir) = std::env::var(\"VOUCHRS_SECRETS_DIR\") {\n            let secrets_path = std::path::Path::new(\u0026secrets_dir).join(\"Settings.toml\");\n            if secrets_path.exists() {\n                let secrets_toml_content = fs::read_to_string(\u0026secrets_path)?;\n                let secrets_settings: Self =\n                    basic_toml::from_str(\u0026secrets_toml_content)?;\n\n                println!(\"âœ“ Overriding settings from {}\", secrets_path.display());\n\n                // Replace settings with those from secrets directory\n                settings = secrets_settings;\n            } else {\n                println!(\n                    \"â„¹ VOUCHRS_SECRETS_DIR set but no Settings.toml found at: {}\",\n                    secrets_path.display()\n                );\n            }\n        }\n\n        // Environment variables will be applied next, after this function returns\n\n        Ok(settings)\n    }\n\n    /// Apply environment variable overrides to settings\n    fn apply_env_overrides(settings: \u0026mut Self) {\n        Self::apply_application_env_overrides(\u0026mut settings.application);\n        Self::apply_proxy_env_overrides(\u0026mut settings.proxy);\n        Self::apply_static_files_env_overrides(\u0026mut settings.static_files);\n        Self::apply_session_env_overrides(\u0026mut settings.session);\n        Self::apply_cookie_env_overrides(\u0026mut settings.cookies);\n        Self::apply_logging_env_overrides(\u0026mut settings.logging);\n    }\n\n    /// Apply environment overrides for application settings\n    fn apply_application_env_overrides(app_settings: \u0026mut ApplicationSettings) {\n        if let Ok(host) = std::env::var(\"HOST\") {\n            app_settings.host = host;\n        }\n        if let Ok(port_str) = std::env::var(\"PORT\") {\n            if let Ok(port) = port_str.parse::\u003cu16\u003e() {\n                app_settings.port = port;\n            }\n        }\n        if let Ok(redirect_base_url) = std::env::var(\"REDIRECT_BASE_URL\") {\n            app_settings.redirect_base_url = redirect_base_url;\n        }\n        if let Ok(cors_origins) = std::env::var(\"CORS_ORIGINS\") {\n            app_settings.cors_origins = cors_origins;\n        }\n    }\n\n    /// Apply environment overrides for proxy settings\n    fn apply_proxy_env_overrides(proxy_settings: \u0026mut ProxySettings) {\n        if let Ok(upstream_url) = std::env::var(\"UPSTREAM_URL\") {\n            proxy_settings.upstream_url = upstream_url;\n        }\n    }\n\n    /// Apply environment overrides for static files settings\n    fn apply_static_files_env_overrides(static_settings: \u0026mut StaticFilesSettings) {\n        if let Ok(assets_folder) = std::env::var(\"STATIC_FOLDER_PATH\") {\n            static_settings.assets_folder = assets_folder;\n        }\n    }\n\n    /// Apply environment overrides for session settings\n    pub fn apply_session_env_overrides(session_settings: \u0026mut SessionSettings) {\n        if let Ok(session_duration_str) = std::env::var(\"SESSION_DURATION_HOURS\") {\n            if let Ok(session_duration) = session_duration_str.parse::\u003cu64\u003e() {\n                session_settings.session_duration_hours = session_duration;\n            }\n        }\n        \n        // Check if SESSION_SECRET environment variable is set\n        let env_secret_set = if let Ok(session_secret) = std::env::var(\"SESSION_SECRET\") {\n            if session_secret.is_empty() {\n                false\n            } else {\n                session_settings.session_secret = session_secret;\n                true\n            }\n        } else {\n            false\n        };\n        \n        // Generate random session secret if no environment variable was set and current value is empty\n        if !env_secret_set \u0026\u0026 session_settings.session_secret.is_empty() {\n            session_settings.session_secret = Self::generate_random_session_secret();\n            Self::warn_about_generated_secret(\u0026session_settings.session_secret);\n        }\n    }\n    \n    /// Generate a cryptographically secure random session secret\n    /// \n    /// Uses the same secure random source as our crypto utilities\n    /// Generates 32 bytes (256 bits) of entropy for AES-256 compatibility\n    fn generate_random_session_secret() -\u003e String {\n        use rand::RngCore;\n        let mut secret = [0u8; 32]; // 256 bits for AES-256\n        rand::thread_rng().fill_bytes(\u0026mut secret);\n        general_purpose::STANDARD.encode(secret)\n    }\n    \n    /// Display warnings about using a generated session secret\n    fn warn_about_generated_secret(secret: \u0026str) {\n        eprintln!(\"âš ï¸  WARNING: Using auto-generated session secret\");\n        eprintln!(\"ðŸ“ Generated secret: {secret}\");\n        eprintln!(\"ðŸ”’ For production use, set the SESSION_SECRET environment variable\");\n        eprintln!(\"   or configure session_secret in Settings.toml\");\n        eprintln!(\"ðŸ’¡ This secret will change on each restart unless explicitly configured\");\n    }\n\n    /// Apply environment overrides for cookie settings\n    fn apply_cookie_env_overrides(cookie_settings: \u0026mut CookieSettings) {\n        if let Ok(cookie_secure_str) = std::env::var(\"COOKIE_SECURE\") {\n            if let Ok(cookie_secure) = cookie_secure_str.parse::\u003cbool\u003e() {\n                cookie_settings.secure = cookie_secure;\n            }\n        }\n    }\n\n    /// Apply environment overrides for logging settings\n    fn apply_logging_env_overrides(logging_settings: \u0026mut LoggingSettings) {\n        if let Ok(log_level) = std::env::var(\"RUST_LOG\") {\n            logging_settings.level = log_level;\n        }\n    }\n\n    /// Load environment variables from .env file\n    fn load_env_file() {\n        if let Ok(contents) = std::fs::read_to_string(\".env\") {\n            for line in contents.lines() {\n                if let Some((key, value)) = line.split_once('=') {\n                    std::env::set_var(key.trim(), value.trim());\n                }\n            }\n        }\n    }\n\n    /// Get the bind address for the server\n    #[must_use]\n    pub fn get_bind_address(\u0026self) -\u003e String {\n        format!(\"{}:{}\", self.application.host, self.application.port)\n    }\n\n    /// Get CORS origins as a vector of strings\n    #[must_use]\n    pub fn get_cors_origins(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.application\n            .cors_origins\n            .split(',')\n            .map(|s| s.trim().to_string())\n            .collect()\n    }\n\n    /// Get enabled providers\n    #[must_use]\n    pub fn get_enabled_providers(\u0026self) -\u003e Vec\u003c\u0026ProviderSettings\u003e {\n        self.providers.iter().filter(|p| p.enabled).collect()\n    }\n\n    /// Get provider by name\n    #[must_use]\n    pub fn get_provider(\u0026self, name: \u0026str) -\u003e Option\u003c\u0026ProviderSettings\u003e {\n        self.providers.iter().find(|p| p.name == name)\n    }\n}\n\nimpl ProviderSettings {\n    /// Get the client ID, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_client_id(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.client_id_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.client_id.clone()\n    }\n\n    /// Get the client secret, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_client_secret(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.client_secret_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.client_secret.clone()\n    }\n}\n\nimpl JwtSigningConfig {\n    /// Get the team ID, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_team_id(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.team_id_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.team_id.clone()\n    }\n\n    /// Get the key ID, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_key_id(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.key_id_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.key_id.clone()\n    }\n\n    /// Get the private key path, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_private_key_path(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.private_key_path_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.private_key_path.clone()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serial_test::serial;\n\n    // Helper function to clean all relevant environment variables for tests\n    fn clean_env_vars() {\n        std::env::remove_var(\"SESSION_SECRET\");\n        std::env::remove_var(\"SESSION_DURATION_HOURS\");\n        std::env::remove_var(\"VOUCHRS_SECRETS_DIR\");\n    }\n\n    #[test]\n    fn test_session_secret_configuration() {\n        // Test default value - should be empty and will be generated when processed\n        let default_session_settings = SessionSettings::default();\n        assert_eq!(default_session_settings.session_secret, \"\");\n        assert_eq!(default_session_settings.session_duration_hours, 24);\n    }\n\n    #[test]\n    #[serial]\n    fn test_session_secret_env_override() {\n        // Make sure the environment is clean\n        clean_env_vars();\n\n        let mut session_settings = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: \"default-secret\".to_string(),\n        };\n\n        // Set environment variable\n        std::env::set_var(\"SESSION_SECRET\", \"env-override-secret\");\n\n        // Apply environment overrides\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings);\n\n        assert_eq!(session_settings.session_secret, \"env-override-secret\");\n\n        // Clean up\n        std::env::remove_var(\"SESSION_SECRET\");\n    }\n\n    #[test]\n    #[serial]\n    fn test_session_duration_env_override() {\n        // Make sure the environment is clean\n        clean_env_vars();\n\n        let mut session_settings = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: \"test-secret\".to_string(),\n        };\n\n        // Set environment variable\n        std::env::set_var(\"SESSION_DURATION_HOURS\", \"48\");\n\n        // Apply environment overrides\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings);\n\n        assert_eq!(session_settings.session_duration_hours, 48);\n        assert_eq!(session_settings.session_secret, \"test-secret\"); // Should remain unchanged\n\n        // Clean up\n        clean_env_vars();\n    }\n\n    #[test]\n    #[serial]\n    fn test_session_env_override() {\n        // Make sure the environment is clean\n        clean_env_vars();\n\n        let mut session_settings = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: \"test-secret\".to_string(),\n        };\n\n        // Apply environment overrides\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings);\n\n        assert_eq!(session_settings.session_secret, \"test-secret\"); // Should remain unchanged\n        \n        clean_env_vars();\n    }\n\n    #[test]\n    #[serial]\n    fn test_settings_dir_precedence() {\n        clean_env_vars();\n        \n        // Setup temp dirs for testing\n        let temp_dir = tempfile::tempdir().unwrap();\n        let temp_path = temp_dir.path();\n\n        // Create a Settings.toml in the root with specific values\n        let root_settings_content = r#\"\n[session]\nsession_secret = \"root-secret-key\"\n\"#;\n\n        // Create a Settings.toml in the \"secrets\" dir with different values\n        let secrets_dir = temp_path.join(\"secrets\");\n        std::fs::create_dir_all(\u0026secrets_dir).unwrap();\n\n        let secrets_settings_content = r#\"\n[session]\nsession_secret = \"secrets-secret-key\"\n\"#;\n\n        // Write the files\n        std::fs::write(temp_path.join(\"Settings.toml\"), root_settings_content).unwrap();\n        std::fs::write(secrets_dir.join(\"Settings.toml\"), secrets_settings_content).unwrap();\n\n        // First test: No VOUCHR_SECRETS_DIR set, should use root Settings.toml\n        std::env::remove_var(\"VOUCHR_SECRETS_DIR\");\n\n        // Mock the load_base_settings to use our temp paths\n        let actual_settings = VouchrsSettings::load_base_settings().unwrap();\n\n        // Validate default values were not overridden in this mock test\n        // This is a limitation of the test due to searching in current directory\n        assert_eq!(\n            actual_settings.session.session_secret,\n            \"\"  // Default is now empty string\n        );\n\n        // Add a proper integration test that would validate this behavior in a controlled environment\n        // For now, we'll just document how it should work\n        println!(\"Note: Full precedence testing requires integration tests with file path control\");\n        \n        clean_env_vars();\n    }\n\n    #[test]\n    #[serial]\n    fn test_vouchrs_secrets_dir_precedence() {\n        clean_env_vars();\n        \n        // This is a conceptual test illustrating the expected behavior\n        // of the settings precedence. A full integration test would require\n        // more control over the file system.\n\n        // Mock settings from root Settings.toml\n        let mut mock_root_settings = VouchrsSettings::default();\n        mock_root_settings.session.session_secret = \"root-secret-key\".to_string();\n\n\n        // Mock settings from VOUCHRS_SECRETS_DIR Settings.toml\n        let mut mock_secrets_settings = VouchrsSettings::default();\n        mock_secrets_settings.session.session_secret = \"secrets-secret-key\".to_string();\n\n        // Scenario 1: No VOUCHRS_SECRETS_DIR, use root settings\n        assert_eq!(mock_root_settings.session.session_secret, \"root-secret-key\");\n\n        // Scenario 2: With VOUCHRS_SECRETS_DIR, prefer settings from secrets dir\n        assert_eq!(\n            mock_secrets_settings.session.session_secret,\n            \"secrets-secret-key\"\n        );\n\n        // Scenario 3: Environment variables override both\n        let mut settings_with_env = mock_secrets_settings.clone();\n        std::env::set_var(\"SESSION_SECRET\", \"env-secret-key\");\n\n        VouchrsSettings::apply_session_env_overrides(\u0026mut settings_with_env.session);\n\n        assert_eq!(settings_with_env.session.session_secret, \"env-secret-key\");\n\n        // Clean up\n        clean_env_vars();\n    }\n\n    #[test]\n    #[serial]\n    fn test_session_secret_auto_generation() {\n        // Make sure the environment is clean\n        clean_env_vars();\n        \n        let mut session_settings = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: String::new(), // Empty, should trigger auto-generation\n        };\n\n        // Apply environment overrides (which includes auto-generation)\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings);\n\n        // Should have generated a non-empty secret\n        assert!(!session_settings.session_secret.is_empty());\n        assert!(session_settings.session_secret.len() \u003e 40); // Base64 encoded 32 bytes should be ~44 chars\n        \n        // Generate another one to ensure they're different\n        let mut session_settings2 = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: String::new(),\n        };\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings2);\n        \n        // Should be different each time\n        assert_ne!(session_settings.session_secret, session_settings2.session_secret);\n        \n        clean_env_vars();\n    }\n}\n","traces":[{"line":92,"address":[2855745,2855472,2855739],"length":1,"stats":{"Line":3}},{"line":94,"address":[2591294],"length":1,"stats":{"Line":3}},{"line":96,"address":[2591330],"length":1,"stats":{"Line":3}},{"line":97,"address":[2855578],"length":1,"stats":{"Line":4}},{"line":103,"address":[3695520],"length":1,"stats":{"Line":4}},{"line":105,"address":[2855773],"length":1,"stats":{"Line":4}},{"line":111,"address":[2591648],"length":1,"stats":{"Line":4}},{"line":113,"address":[3532413],"length":1,"stats":{"Line":4}},{"line":119,"address":[2855920],"length":1,"stats":{"Line":4}},{"line":122,"address":[2855933],"length":1,"stats":{"Line":4}},{"line":136,"address":[3532576],"length":1,"stats":{"Line":4}},{"line":138,"address":[3532589],"length":1,"stats":{"Line":4}},{"line":144,"address":[2856096,2857277,2857488],"length":1,"stats":{"Line":0}},{"line":146,"address":[3695878],"length":1,"stats":{"Line":0}},{"line":154,"address":[2592059,2591998,2593158],"length":1,"stats":{"Line":0}},{"line":160,"address":[3696373],"length":1,"stats":{"Line":0}},{"line":175,"address":[2857933,2857504,2857939],"length":1,"stats":{"Line":0}},{"line":177,"address":[3697281],"length":1,"stats":{"Line":0}},{"line":180,"address":[3697385],"length":1,"stats":{"Line":0}},{"line":183,"address":[2593633],"length":1,"stats":{"Line":0}},{"line":185,"address":[2857874],"length":1,"stats":{"Line":0}},{"line":197,"address":[2857952],"length":1,"stats":{"Line":0}},{"line":198,"address":[3697716],"length":1,"stats":{"Line":0}},{"line":199,"address":[3697721],"length":1,"stats":{"Line":0}},{"line":200,"address":[3697779],"length":1,"stats":{"Line":0}},{"line":215,"address":[3700387,3700771,3697808],"length":1,"stats":{"Line":1}},{"line":217,"address":[2593879],"length":1,"stats":{"Line":1}},{"line":220,"address":[2858116],"length":1,"stats":{"Line":1}},{"line":221,"address":[2594080,2594000],"length":1,"stats":{"Line":2}},{"line":222,"address":[3534897,3537542],"length":1,"stats":{"Line":1}},{"line":223,"address":[2858805,2858545,2858628],"length":1,"stats":{"Line":2}},{"line":224,"address":[2859006],"length":1,"stats":{"Line":1}},{"line":231,"address":[3698063,3698929,3698884],"length":1,"stats":{"Line":2}},{"line":232,"address":[3698969,3699064],"length":1,"stats":{"Line":0}},{"line":233,"address":[2859344,2859427],"length":1,"stats":{"Line":0}},{"line":234,"address":[3537239,3536039,3536242],"length":1,"stats":{"Line":0}},{"line":235,"address":[3699694,3699623],"length":1,"stats":{"Line":0}},{"line":238,"address":[2860216,2860148],"length":1,"stats":{"Line":0}},{"line":241,"address":[2860412,2860355],"length":1,"stats":{"Line":0}},{"line":243,"address":[3536122],"length":1,"stats":{"Line":0}},{"line":252,"address":[2860822],"length":1,"stats":{"Line":1}},{"line":256,"address":[3537616],"length":1,"stats":{"Line":0}},{"line":257,"address":[3537630],"length":1,"stats":{"Line":0}},{"line":258,"address":[3537640],"length":1,"stats":{"Line":0}},{"line":259,"address":[2596822],"length":1,"stats":{"Line":0}},{"line":260,"address":[2596836],"length":1,"stats":{"Line":0}},{"line":261,"address":[2861126],"length":1,"stats":{"Line":0}},{"line":262,"address":[2596870],"length":1,"stats":{"Line":0}},{"line":266,"address":[2861454,2861425,2861168],"length":1,"stats":{"Line":0}},{"line":267,"address":[2597148,2596916,2597015],"length":1,"stats":{"Line":0}},{"line":268,"address":[2861331,2861394,2861315],"length":1,"stats":{"Line":0}},{"line":270,"address":[3701332,3701251],"length":1,"stats":{"Line":0}},{"line":271,"address":[2597342,2597500,2597520,2597413],"length":1,"stats":{"Line":0}},{"line":272,"address":[3701548],"length":1,"stats":{"Line":0}},{"line":275,"address":[3701735,3701640,3701911],"length":1,"stats":{"Line":0}},{"line":276,"address":[2862115,2862015,2862035],"length":1,"stats":{"Line":0}},{"line":278,"address":[2597940,2598038,2598214],"length":1,"stats":{"Line":0}},{"line":279,"address":[2862350,2862370,2862450],"length":1,"stats":{"Line":0}},{"line":284,"address":[2598542,2598516,2598304],"length":1,"stats":{"Line":0}},{"line":285,"address":[2598318,2598387,2598511],"length":1,"stats":{"Line":0}},{"line":286,"address":[2598485,2598412,2598428],"length":1,"stats":{"Line":0}},{"line":291,"address":[3702640,3702852,3702878],"length":1,"stats":{"Line":0}},{"line":292,"address":[2863087,2862894,2862963],"length":1,"stats":{"Line":0}},{"line":293,"address":[2598732,2598716,2598789],"length":1,"stats":{"Line":0}},{"line":298,"address":[2863502,2863184,2863496],"length":1,"stats":{"Line":1}},{"line":299,"address":[3703050,3702964],"length":1,"stats":{"Line":2}},{"line":300,"address":[2599051,2599116,2599190,2599173],"length":1,"stats":{"Line":4}},{"line":301,"address":[2863458],"length":1,"stats":{"Line":1}},{"line":306,"address":[2863941,2863628,2863562],"length":1,"stats":{"Line":3}},{"line":307,"address":[2863809,2863686,2863742],"length":1,"stats":{"Line":2}},{"line":308,"address":[3703564],"length":1,"stats":{"Line":0}},{"line":310,"address":[3540376,3540313],"length":1,"stats":{"Line":1}},{"line":311,"address":[3703678],"length":1,"stats":{"Line":1}},{"line":314,"address":[2599351],"length":1,"stats":{"Line":1}},{"line":318,"address":[2864080,2864111],"length":1,"stats":{"Line":2}},{"line":319,"address":[3540696,3540722],"length":1,"stats":{"Line":1}},{"line":320,"address":[2864264],"length":1,"stats":{"Line":1}},{"line":328,"address":[3541029,3541035,3540848],"length":1,"stats":{"Line":1}},{"line":330,"address":[2600029],"length":1,"stats":{"Line":1}},{"line":331,"address":[2864314],"length":1,"stats":{"Line":1}},{"line":332,"address":[2864401],"length":1,"stats":{"Line":1}},{"line":336,"address":[2600224],"length":1,"stats":{"Line":1}},{"line":337,"address":[3704273],"length":1,"stats":{"Line":1}},{"line":338,"address":[3541102],"length":1,"stats":{"Line":1}},{"line":339,"address":[3704384],"length":1,"stats":{"Line":1}},{"line":340,"address":[2864659],"length":1,"stats":{"Line":1}},{"line":341,"address":[2600422],"length":1,"stats":{"Line":1}},{"line":345,"address":[2600772,2600766,2600480],"length":1,"stats":{"Line":0}},{"line":346,"address":[2600561,2600497],"length":1,"stats":{"Line":0}},{"line":347,"address":[3704682,3704774,3704623,3704753],"length":1,"stats":{"Line":0}},{"line":348,"address":[3541569],"length":1,"stats":{"Line":0}},{"line":354,"address":[3541696,3541934,3541908],"length":1,"stats":{"Line":0}},{"line":355,"address":[2600862,2600931,2601055],"length":1,"stats":{"Line":0}},{"line":356,"address":[2865260,2865317,2865244],"length":1,"stats":{"Line":0}},{"line":361,"address":[3705936,3705942,3705200],"length":1,"stats":{"Line":0}},{"line":362,"address":[2865447,2865563],"length":1,"stats":{"Line":0}},{"line":363,"address":[3542244,3542165],"length":1,"stats":{"Line":0}},{"line":364,"address":[2865858,2865967],"length":1,"stats":{"Line":0}},{"line":365,"address":[3542636],"length":1,"stats":{"Line":0}},{"line":373,"address":[2601968],"length":1,"stats":{"Line":0}},{"line":374,"address":[3706061],"length":1,"stats":{"Line":0}},{"line":379,"address":[2602160],"length":1,"stats":{"Line":0}},{"line":380,"address":[2866502],"length":1,"stats":{"Line":0}},{"line":383,"address":[3010197,3010144],"length":1,"stats":{"Line":0}},{"line":389,"address":[2866576],"length":1,"stats":{"Line":0}},{"line":390,"address":[2866608],"length":1,"stats":{"Line":0}},{"line":395,"address":[3543232],"length":1,"stats":{"Line":0}},{"line":396,"address":[3010289,3010272],"length":1,"stats":{"Line":0}},{"line":403,"address":[2866752],"length":1,"stats":{"Line":0}},{"line":404,"address":[3706535],"length":1,"stats":{"Line":0}},{"line":405,"address":[2602597,2602531],"length":1,"stats":{"Line":0}},{"line":406,"address":[2866931],"length":1,"stats":{"Line":0}},{"line":409,"address":[2866868],"length":1,"stats":{"Line":0}},{"line":414,"address":[3706752],"length":1,"stats":{"Line":0}},{"line":415,"address":[2602711],"length":1,"stats":{"Line":0}},{"line":416,"address":[3706835,3706901],"length":1,"stats":{"Line":0}},{"line":417,"address":[2602867],"length":1,"stats":{"Line":0}},{"line":420,"address":[3543668],"length":1,"stats":{"Line":0}},{"line":427,"address":[2602928],"length":1,"stats":{"Line":4}},{"line":428,"address":[3543815],"length":1,"stats":{"Line":4}},{"line":429,"address":[3707129,3707070],"length":1,"stats":{"Line":0}},{"line":430,"address":[2867399],"length":1,"stats":{"Line":0}},{"line":433,"address":[2603039],"length":1,"stats":{"Line":4}},{"line":438,"address":[3707232],"length":1,"stats":{"Line":3}},{"line":439,"address":[2867495],"length":1,"stats":{"Line":3}},{"line":440,"address":[3544110,3544173],"length":1,"stats":{"Line":0}},{"line":441,"address":[3544203],"length":1,"stats":{"Line":0}},{"line":444,"address":[3707343],"length":1,"stats":{"Line":3}},{"line":449,"address":[2603408],"length":1,"stats":{"Line":3}},{"line":450,"address":[2867735],"length":1,"stats":{"Line":3}},{"line":451,"address":[3707613,3707550],"length":1,"stats":{"Line":0}},{"line":452,"address":[3707643],"length":1,"stats":{"Line":0}},{"line":455,"address":[3707583],"length":1,"stats":{"Line":3}}],"covered":52,"coverable":133},{"path":["/","workspaces","vouchrs","src","utils","apple.rs"],"content":"// Apple-specific utility functions\nuse crate::oauth::OAuthCallback;\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\n\n/// Parse and process Apple user information from various sources\n///\n/// This function can:\n/// 1. Parse a raw JSON Value into `AppleUserInfo` (when called with just the value)\n/// 2. Process OAuth callback data and existing user info (when called with callback and existing info)\n///\n/// Apple Sign In can provide user information in two ways:\n/// - In the initial token response (handled by the OAuth provider)\n/// - In the callback data's 'user' parameter (handled here)\n///\n/// When both sources are provided, the callback data is prioritized\n\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct AppleUserName {\n    #[serde(rename = \"firstName\")]\n    pub first_name: Option\u003cString\u003e,\n    #[serde(rename = \"lastName\")]\n    pub last_name: Option\u003cString\u003e,\n}\n\nimpl AppleUserName {\n    /// Get the full name by concatenating first and last name with a space\n    #[must_use]\n    pub fn full_name(\u0026self) -\u003e String {\n        format!(\n            \"{} {}\",\n            self.first_name.as_deref().unwrap_or(\"\"),\n            self.last_name.as_deref().unwrap_or(\"\")\n        )\n    }\n}\n\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct AppleUserInfo {\n    pub name: AppleUserName,\n    pub email: Option\u003cString\u003e,\n}\n\n/// Process Apple user information from a JSON value\n/// \n/// # Arguments\n/// \n/// * `source` - The JSON value containing Apple user information\n/// * `fallback_info` - Optional fallback information to use if parsing fails\n/// \n/// # Returns\n/// \n/// Returns `Some(AppleUserInfo)` if parsing succeeds or fallback is available, `None` otherwise\n#[must_use]\npub fn process_apple_user_info(\n    user_value: \u0026Value,\n    existing_user_info: Option\u003cAppleUserInfo\u003e,\n) -\u003e Option\u003cAppleUserInfo\u003e {\n    // If we already have user info, return it\n    if existing_user_info.is_some() {\n        return existing_user_info;\n    }\n\n    // Try to parse from JSON value\n    if let Ok(user_info) = serde_json::from_value::\u003cAppleUserInfo\u003e(user_value.clone()) {\n        return Some(user_info);\n    }\n\n    // If it's a JSON string, try to parse the string\n    if let Value::String(json_str) = user_value {\n        if let Ok(user_info) = serde_json::from_str::\u003cAppleUserInfo\u003e(json_str) {\n            return Some(user_info);\n        }\n    }\n\n    None\n}\n\n/// Process Apple user info from OAuth callback data\n///\n/// This is a convenience wrapper around `process_apple_user_info` that handles\n/// extracting the user JSON from the callback data\n#[must_use]\npub fn process_apple_callback(\n    callback_data: \u0026OAuthCallback,\n    fallback_info: Option\u003cAppleUserInfo\u003e,\n) -\u003e Option\u003cAppleUserInfo\u003e {\n    callback_data\n        .user\n        .as_ref()\n        .and_then(|user_json| process_apple_user_info(user_json, None))\n        .or(fallback_info)\n}\n\n/// Generate Apple client secret JWT\n/// This function creates a properly signed JWT that can be used as a client secret\n/// with Apple's OAuth endpoints.\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Team ID is not configured\n/// - Key ID is not configured\n/// - Private key path is not configured\n/// - Private key file cannot be read\n/// - Private key cannot be parsed\n/// - JWT serialization fails\npub fn generate_jwt_client_secret(\n    jwt_config: \u0026crate::settings::JwtSigningConfig,\n    client_id: \u0026str,\n) -\u003e Result\u003cString, String\u003e {\n    use crate::utils::crypto::{create_jwt, create_jwt_header, JwtAlgorithm};\n    use chrono::{Duration, Utc};\n\n    // Get required values using the getter methods\n    let team_id = jwt_config\n        .get_team_id()\n        .ok_or_else(|| \"Team ID not configured for Apple provider\".to_string())?;\n    let key_id = jwt_config\n        .get_key_id()\n        .ok_or_else(|| \"Key ID not configured for Apple provider\".to_string())?;\n    let private_key_path = jwt_config\n        .get_private_key_path()\n        .ok_or_else(|| \"Private key path not configured for Apple provider\".to_string())?;\n\n    // Read the private key file\n    let private_key_pem = std::fs::read_to_string(\u0026private_key_path)\n        .map_err(|_| \"Failed to read Apple private key file\".to_string())?;\n\n    // Create JWT header with Apple-specific key ID\n    let header = create_jwt_header(\u0026JwtAlgorithm::ES256, Some(\u0026key_id));\n\n    // Create JWT payload with Apple-specific claims\n    let now = Utc::now();\n    let exp = now + Duration::minutes(5);\n\n    let payload = serde_json::json!({\n        \"iss\": team_id,\n        \"iat\": now.timestamp(),\n        \"exp\": exp.timestamp(),\n        \"aud\": \"https://appleid.apple.com\",\n        \"sub\": client_id\n    });\n\n    // Use the generic JWT creation function\n    let jwt = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::ES256, private_key_pem.as_bytes())\n        .map_err(|e| format!(\"Failed to create Apple JWT: {e}\"))?;\n\n    log::debug!(\"Generated Apple client secret JWT\");\n    Ok(jwt)\n}\n\n\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_process_apple_user_info_from_object() {\n        let apple_user_info = AppleUserInfo {\n            name: AppleUserName {\n                first_name: Some(\"John\".to_string()),\n                last_name: Some(\"Doe\".to_string()),\n            },\n            email: Some(\"john.doe@apple.com\".to_string()),\n        };\n\n        let value = serde_json::to_value(\u0026apple_user_info).unwrap();\n        let parsed = process_apple_user_info(\u0026value, None).unwrap();\n\n        assert_eq!(parsed.email, Some(\"john.doe@apple.com\".to_string()));\n        assert_eq!(parsed.name.first_name, Some(\"John\".to_string()));\n        assert_eq!(parsed.name.last_name, Some(\"Doe\".to_string()));\n    }\n\n    #[test]\n    fn test_process_apple_user_info_from_string() {\n        let apple_user_info = AppleUserInfo {\n            name: AppleUserName {\n                first_name: Some(\"Jane\".to_string()),\n                last_name: Some(\"Smith\".to_string()),\n            },\n            email: Some(\"jane.smith@apple.com\".to_string()),\n        };\n\n        let json_string = serde_json::to_string(\u0026apple_user_info).unwrap();\n        let value = Value::String(json_string);\n        let parsed = process_apple_user_info(\u0026value, None).unwrap();\n\n        assert_eq!(parsed.email, Some(\"jane.smith@apple.com\".to_string()));\n        assert_eq!(parsed.name.first_name, Some(\"Jane\".to_string()));\n        assert_eq!(parsed.name.last_name, Some(\"Smith\".to_string()));\n    }\n\n    #[test]\n    fn test_process_apple_user_info_with_fallback() {\n        // Test with invalid value but valid fallback\n        let fallback = AppleUserInfo {\n            name: AppleUserName {\n                first_name: Some(\"Fallback\".to_string()),\n                last_name: Some(\"User\".to_string()),\n            },\n            email: Some(\"fallback@example.com\".to_string()),\n        };\n\n        let value = Value::Number(serde_json::Number::from(42));\n        let result = process_apple_user_info(\u0026value, Some(fallback.clone()));\n\n        assert!(result.is_some());\n        let user = result.unwrap();\n        assert_eq!(user.email, Some(\"fallback@example.com\".to_string()));\n    }\n}\n","traces":[{"line":29,"address":[3683584],"length":1,"stats":{"Line":2}},{"line":30,"address":[2904911,2904984],"length":1,"stats":{"Line":4}},{"line":32,"address":[2904868],"length":1,"stats":{"Line":2}},{"line":33,"address":[2904937],"length":1,"stats":{"Line":2}},{"line":55,"address":[3684560,3683888],"length":1,"stats":{"Line":1}},{"line":60,"address":[3683931,3684007],"length":1,"stats":{"Line":5}},{"line":61,"address":[2984523],"length":1,"stats":{"Line":1}},{"line":65,"address":[3443463,3443516,3443410],"length":1,"stats":{"Line":5}},{"line":66,"address":[3443544],"length":1,"stats":{"Line":1}},{"line":70,"address":[3684260],"length":1,"stats":{"Line":1}},{"line":71,"address":[3684422,3684286,3684347],"length":1,"stats":{"Line":3}},{"line":72,"address":[2905701],"length":1,"stats":{"Line":1}},{"line":76,"address":[2905561],"length":1,"stats":{"Line":0}},{"line":84,"address":[2906115,2906087,2905840],"length":1,"stats":{"Line":0}},{"line":88,"address":[2985114,2985285,2985196],"length":1,"stats":{"Line":0}},{"line":91,"address":[3225297,3225280],"length":1,"stats":{"Line":0}},{"line":92,"address":[3444093],"length":1,"stats":{"Line":0}},{"line":108,"address":[2988895,2985360,2989134],"length":1,"stats":{"Line":4}},{"line":116,"address":[2906339,2906174],"length":1,"stats":{"Line":5}},{"line":118,"address":[3444384],"length":1,"stats":{"Line":3}},{"line":119,"address":[2985666,2985834,2985729,2989132],"length":1,"stats":{"Line":6}},{"line":121,"address":[2906570],"length":1,"stats":{"Line":0}},{"line":122,"address":[2906763,2909879,2906868,2906700],"length":1,"stats":{"Line":6}},{"line":124,"address":[2986068],"length":1,"stats":{"Line":0}},{"line":127,"address":[3445185,3445037,3445104,3447835],"length":1,"stats":{"Line":8}},{"line":128,"address":[3225488,3225504],"length":1,"stats":{"Line":3}},{"line":131,"address":[3445353,3445282],"length":1,"stats":{"Line":4}},{"line":134,"address":[2907367],"length":1,"stats":{"Line":2}},{"line":135,"address":[3686187],"length":1,"stats":{"Line":2}},{"line":137,"address":[2987839,2988977,2987617,2987356,2987097,2987151,2986757,2986881,2987410],"length":1,"stats":{"Line":6}},{"line":139,"address":[2907911,2907841],"length":1,"stats":{"Line":4}},{"line":140,"address":[2987402,2987332],"length":1,"stats":{"Line":4}},{"line":146,"address":[3446911,3446824,3447047],"length":1,"stats":{"Line":4}},{"line":147,"address":[2438848,2438879],"length":1,"stats":{"Line":0}},{"line":149,"address":[2909342,2909246,2909156],"length":1,"stats":{"Line":3}},{"line":150,"address":[2909257],"length":1,"stats":{"Line":1}}],"covered":28,"coverable":36},{"path":["/","workspaces","vouchrs","src","utils","cookie.rs"],"content":"use actix_web::{cookie::Cookie, HttpRequest};\nuse anyhow::{anyhow, Result};\nuse log;\n\n/// Common cookie names used across the application\npub const COOKIE_NAME: \u0026str = \"vouchrs_session\";\npub const USER_COOKIE_NAME: \u0026str = \"vouchrs_user\";\npub const OAUTH_STATE_COOKIE: \u0026str = \"vouchr_oauth_state\";\n\n/// Trait for converting objects to cookies\npub trait ToCookie\u003cT\u003e {\n    /// Convert self to a cookie with provided name using `SessionManager` for encryption\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if the cookie creation fails (e.g., encryption failure)\n    fn to_cookie(\u0026self, manager: \u0026T) -\u003e Result\u003cCookie\u003c'static\u003e\u003e;\n}\n\n/// Options for cookie creation\npub struct CookieOptions {\n    pub http_only: bool,\n    pub secure: bool,\n    pub same_site: actix_web::cookie::SameSite,\n    pub path: String,\n    pub max_age: actix_web::cookie::time::Duration,\n}\n\nimpl Default for CookieOptions {\n    fn default() -\u003e Self {\n        Self {\n            http_only: true,\n            secure: true,\n            same_site: actix_web::cookie::SameSite::Strict,\n            path: \"/\".to_string(),\n            max_age: actix_web::cookie::time::Duration::hours(24),\n        }\n    }\n}\n\n/// Helper function to extract cookie value from `HttpRequest`\n/// \n/// # Errors\n/// \n/// Returns an error if the specified cookie is not found in the request\npub fn extract_cookie_value(req: \u0026HttpRequest, cookie_name: \u0026str) -\u003e Result\u003cString\u003e {\n    req.cookie(cookie_name)\n        .ok_or_else(|| anyhow!(\"Cookie not found: {cookie_name}\"))\n        .map(|cookie| cookie.value().to_string())\n}\n\n/// Create an expired cookie to clear a specific cookie\n#[must_use]\npub fn create_expired_cookie(name: \u0026str, secure: bool) -\u003e Cookie\u003c'static\u003e {\n    Cookie::build(name.to_owned(), \"\")\n        .http_only(true)\n        .secure(secure)\n        .same_site(actix_web::cookie::SameSite::Lax)\n        .path(\"/\")\n        .max_age(actix_web::cookie::time::Duration::seconds(-1))\n        .finish()\n}\n\n/// Helper function to extract and log cookies from a request\npub fn log_cookies(req: \u0026HttpRequest) {\n    if let Ok(cookies) = req.cookies() {\n        for cookie in cookies.iter() {\n            log::info!(\n                \"Found cookie: name='{}', secure={:?}\",\n                cookie.name(),\n                cookie.secure()\n            );\n        }\n    }\n}\n\n/// Filter cookies, removing `vouchrs_session` cookie\n#[must_use]\npub fn filter_vouchrs_cookies(cookie_str: \u0026str) -\u003e Option\u003cString\u003e {\n    let filtered_cookies: Vec\u003c\u0026str\u003e = cookie_str\n        .split(';')\n        .filter_map(|cookie| {\n            let trimmed = cookie.trim();\n            if trimmed.is_empty() || trimmed.starts_with(\u0026format!(\"{COOKIE_NAME}=\")) {\n                None\n            } else {\n                Some(trimmed)\n            }\n        })\n        .collect();\n\n    if filtered_cookies.is_empty() {\n        None\n    } else {\n        Some(filtered_cookies.join(\"; \"))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_filter_vouchrs_cookies() {\n        // Test with single vouchrs_session cookie\n        let cookies = \"vouchrs_session=abc123\";\n        assert_eq!(filter_vouchrs_cookies(cookies), None);\n\n        // Test with multiple cookies including vouchrs_session\n        let cookies = \"other_cookie=value; vouchrs_session=abc123; another_cookie=value2\";\n        assert_eq!(\n            filter_vouchrs_cookies(cookies),\n            Some(\"other_cookie=value; another_cookie=value2\".to_string())\n        );\n\n        // Test with no vouchrs_session cookie\n        let cookies = \"cookie1=value1; cookie2=value2\";\n        assert_eq!(\n            filter_vouchrs_cookies(cookies),\n            Some(\"cookie1=value1; cookie2=value2\".to_string())\n        );\n\n        // Test with empty string\n        assert_eq!(filter_vouchrs_cookies(\"\"), None);\n    }\n\n    #[test]\n    fn test_create_expired_cookie() {\n        let cookie = create_expired_cookie(\"test_cookie\", true);\n        assert_eq!(cookie.name(), \"test_cookie\");\n        assert_eq!(cookie.value(), \"\");\n        assert!(cookie.http_only().unwrap());\n        assert!(cookie.secure().unwrap());\n        assert_eq!(cookie.path().unwrap(), \"/\");\n        assert!(cookie.max_age().unwrap().whole_seconds() \u003c 0);\n    }\n}\n","traces":[{"line":30,"address":[3648258,3648252,3648080],"length":1,"stats":{"Line":4}},{"line":35,"address":[3755331],"length":1,"stats":{"Line":4}},{"line":36,"address":[3755357],"length":1,"stats":{"Line":4}},{"line":46,"address":[3787888],"length":1,"stats":{"Line":0}},{"line":47,"address":[3755538],"length":1,"stats":{"Line":0}},{"line":48,"address":[3799120,3799129],"length":1,"stats":{"Line":0}},{"line":49,"address":[2775456,2775483],"length":1,"stats":{"Line":0}},{"line":54,"address":[3129776,3130187,3130155],"length":1,"stats":{"Line":1}},{"line":55,"address":[3130132,3129960,3129823,3130084],"length":1,"stats":{"Line":4}},{"line":58,"address":[3129952],"length":1,"stats":{"Line":1}},{"line":60,"address":[3130024,3130050,3130124,3130168],"length":1,"stats":{"Line":2}},{"line":65,"address":[3756048,3756909,3756903],"length":1,"stats":{"Line":0}},{"line":66,"address":[3648834,3648901],"length":1,"stats":{"Line":0}},{"line":67,"address":[3649014,3648941],"length":1,"stats":{"Line":0}},{"line":68,"address":[3756444,3756635,3756509,3756689],"length":1,"stats":{"Line":0}},{"line":79,"address":[3131465,3131136,3131459],"length":1,"stats":{"Line":1}},{"line":80,"address":[3789393],"length":1,"stats":{"Line":1}},{"line":82,"address":[2775985,2775600,2775979],"length":1,"stats":{"Line":1}},{"line":83,"address":[3673033],"length":1,"stats":{"Line":2}},{"line":84,"address":[3673322,3673070,3673241],"length":1,"stats":{"Line":4}},{"line":85,"address":[3799612],"length":1,"stats":{"Line":2}},{"line":87,"address":[3799692],"length":1,"stats":{"Line":1}},{"line":92,"address":[3789583,3789473,3789533],"length":1,"stats":{"Line":3}},{"line":93,"address":[3757186],"length":1,"stats":{"Line":1}},{"line":95,"address":[3757155,3757211],"length":1,"stats":{"Line":3}}],"covered":17,"coverable":25},{"path":["/","workspaces","vouchrs","src","utils","crypto.rs"],"content":"// Cryptographic utilities for generating secure tokens and nonces\n\nuse aes_gcm::{\n    aead::{Aead, KeyInit},\n    Aes256Gcm, Key, Nonce,\n};\nuse anyhow::{anyhow, Context, Result};\nuse base64::{engine::general_purpose, Engine as _};\nuse rand::RngCore;\nuse serde::{de::DeserializeOwned, Serialize};\n\n/// Nonce size for AES-256-GCM encryption (96 bits)\npub const NONCE_SIZE: usize = 12;\n\n/// Encryption key size for AES-256 (256 bits)\npub const ENCRYPTION_KEY_SIZE: usize = 32;\n\n/// Generate a cryptographically secure CSRF token\n/// \n/// This generates a more compact token with higher entropy than UUID v4:\n/// - 24 bytes (192 bits) of entropy vs UUID's 122 bits\n/// - `Base64URL` encoding results in 32 characters vs UUID's 36 characters\n/// - Uses the same secure random source as our AES-GCM encryption\n/// \n/// Inspired by oauth2-proxy's approach but optimized for URL length\n/// \n/// # Returns\n/// \n/// A base64url-encoded string representing 24 bytes of cryptographically secure random data\n#[must_use]\npub fn generate_csrf_token() -\u003e String {\n    let mut nonce = [0u8; 24]; // 192 bits of entropy\n    rand::thread_rng().fill_bytes(\u0026mut nonce);\n    general_purpose::URL_SAFE_NO_PAD.encode(nonce)\n}\n\n/// Generate a cryptographically secure nonce of specified byte length\n/// \n/// This is a more general-purpose function for generating secure random data\n/// \n/// # Arguments\n/// \n/// * `length` - Number of bytes to generate (recommended: 16-32 for most use cases)\n/// \n/// # Returns\n/// \n/// A base64url-encoded string representing the specified bytes of random data\n#[must_use]\npub fn generate_nonce(length: usize) -\u003e String {\n    let mut nonce = vec![0u8; length];\n    rand::thread_rng().fill_bytes(\u0026mut nonce);\n    general_purpose::URL_SAFE_NO_PAD.encode(nonce)\n}\n\n/// Helper function to decode JWT token payload without verification\n/// This is used for debugging purposes only to inspect token claims\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - The JWT format is invalid (not 3 parts separated by dots)\n/// - Base64 decoding fails\n/// - UTF-8 decoding fails\n/// - JSON parsing fails\npub fn decode_jwt_payload(token: \u0026str) -\u003e Result\u003cserde_json::Value, String\u003e {\n    let parts: Vec\u003c\u0026str\u003e = token.split('.').collect();\n    if parts.len() != 3 {\n        return Err(\"Invalid JWT format\".to_string());\n    }\n\n    let payload_b64 = parts[1];\n    let payload_bytes = general_purpose::URL_SAFE_NO_PAD\n        .decode(payload_b64)\n        .or_else(|_| general_purpose::STANDARD.decode(payload_b64))\n        .map_err(|_| \"Base64 decode failed\")?;\n\n    let payload_str = String::from_utf8(payload_bytes).map_err(|_| \"UTF-8 decode failed\")?;\n\n    serde_json::from_str(\u0026payload_str).map_err(|_| \"JSON parse failed\".to_string())\n}\n\n/// Generic encryption function for any serializable data using AES-256-GCM\n/// \n/// # Arguments\n/// \n/// * `data` - The data to encrypt (must implement Serialize)\n/// * `key` - The encryption key (must be 32 bytes for AES-256)\n/// \n/// # Returns\n/// \n/// A Base64URL-encoded string containing the nonce + ciphertext\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Serialization fails\n/// - Key length is invalid\n/// - AES encryption fails\npub fn encrypt_data\u003cT: Serialize\u003e(data: \u0026T, key: \u0026[u8]) -\u003e Result\u003cString\u003e {\n    if key.len() != ENCRYPTION_KEY_SIZE {\n        return Err(anyhow!(\"Invalid key length: expected {} bytes, got {}\", ENCRYPTION_KEY_SIZE, key.len()));\n    }\n\n    // Serialize the data to JSON\n    let json_data = serde_json::to_string(data).context(\"Failed to serialize data\")?;\n\n    // Generate random nonce\n    let mut nonce_bytes = [0u8; NONCE_SIZE];\n    rand::thread_rng().fill_bytes(\u0026mut nonce_bytes);\n    let nonce = Nonce::from_slice(\u0026nonce_bytes);\n\n    // Encrypt the data\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(key));\n    let ciphertext = cipher\n        .encrypt(nonce, json_data.as_bytes())\n        .map_err(|e| anyhow!(\"AES encryption failed: {e}\"))?;\n\n    // Combine nonce + ciphertext and encode as base64\n    let mut combined = Vec::with_capacity(NONCE_SIZE + ciphertext.len());\n    combined.extend_from_slice(\u0026nonce_bytes);\n    combined.extend_from_slice(\u0026ciphertext);\n\n    Ok(general_purpose::URL_SAFE_NO_PAD.encode(\u0026combined))\n}\n\n/// Generic decryption function for any deserializable data using AES-256-GCM\n/// \n/// # Arguments\n/// \n/// * `encrypted_data` - Base64URL-encoded string containing nonce + ciphertext\n/// * `key` - The decryption key (must be 32 bytes for AES-256)\n/// \n/// # Returns\n/// \n/// The decrypted and deserialized data\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Key length is invalid\n/// - Base64 decoding fails\n/// - Data length is invalid\n/// - AES decryption fails\n/// - Deserialization fails\npub fn decrypt_data\u003cT: DeserializeOwned\u003e(encrypted_data: \u0026str, key: \u0026[u8]) -\u003e Result\u003cT\u003e {\n    if key.len() != ENCRYPTION_KEY_SIZE {\n        return Err(anyhow!(\"Invalid key length: expected {} bytes, got {}\", ENCRYPTION_KEY_SIZE, key.len()));\n    }\n\n    // Decode from base64\n    let combined = general_purpose::URL_SAFE_NO_PAD\n        .decode(encrypted_data)\n        .context(\"Failed to decode base64 data\")?;\n\n    if combined.len() \u003c NONCE_SIZE {\n        return Err(anyhow!(\"Invalid data length\"));\n    }\n\n    // Split nonce and ciphertext\n    let (nonce_bytes, ciphertext) = combined.split_at(NONCE_SIZE);\n    let nonce = Nonce::from_slice(nonce_bytes);\n\n    // Decrypt the data\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(key));\n    let plaintext = cipher\n        .decrypt(nonce, ciphertext)\n        .map_err(|e| anyhow!(\"AES decryption failed: {e}\"))?;\n\n    // Deserialize the data from JSON\n    let data: T = serde_json::from_slice(\u0026plaintext)\n        .context(\"Failed to deserialize data from decrypted JSON\")?;\n\n    Ok(data)\n}\n\n/// Derive a proper 32-byte encryption key from input key material\n/// \n/// This function ensures that any input key is properly extended or truncated\n/// to exactly 32 bytes for use with AES-256. For keys shorter than 32 bytes,\n/// it uses a simple hash-based extension method.\n/// \n/// # Arguments\n/// \n/// * `input_key` - The input key material (any length)\n/// \n/// # Returns\n/// \n/// A 32-byte encryption key suitable for AES-256\n/// \n/// # Note\n/// \n/// This is a simple key derivation method. For production use with weak keys,\n/// consider using proper key derivation functions like PBKDF2 or HKDF.\n#[must_use] pub fn derive_encryption_key(input_key: \u0026[u8]) -\u003e [u8; ENCRYPTION_KEY_SIZE] {\n    let mut encryption_key = [0u8; ENCRYPTION_KEY_SIZE];\n    let key_len = std::cmp::min(input_key.len(), ENCRYPTION_KEY_SIZE);\n    encryption_key[..key_len].copy_from_slice(\u0026input_key[..key_len]);\n\n    // If key is shorter than 32 bytes, derive the rest using a simple hash\n    if key_len \u003c ENCRYPTION_KEY_SIZE {\n        for i in key_len..ENCRYPTION_KEY_SIZE {\n            encryption_key[i] = encryption_key[i % key_len].wrapping_add(u8::try_from(i % 256).unwrap_or(0));\n        }\n    }\n\n    encryption_key\n}\n\n/// JWT signing algorithms supported by the generic JWT functions\n#[derive(Debug, Clone, Copy)]\npub enum JwtAlgorithm {\n    /// HMAC with SHA-256 (symmetric key)\n    HS256,\n    /// ECDSA with P-256 curve and SHA-256 (asymmetric key)\n    ES256,\n}\n\n/// Generic JWT creation function for different signing algorithms\n/// \n/// This function supports both HMAC-SHA256 (HS256) and ECDSA P-256 (ES256) signing.\n/// \n/// # Arguments\n/// \n/// * `header` - JWT header as a JSON value\n/// * `payload` - JWT payload/claims as a JSON value  \n/// * `algorithm` - The signing algorithm to use\n/// * `key_material` - Key material for signing:\n///   - For HS256: The shared secret as bytes\n///   - For ES256: PEM-encoded PKCS#8 private key as string\n/// \n/// # Returns\n/// \n/// A complete JWT string with header.payload.signature\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - JSON serialization fails\n/// - Key parsing fails (for ES256)\n/// - Signing operation fails\n/// - Base64 encoding fails\npub fn create_jwt(\n    header: \u0026serde_json::Value,\n    payload: \u0026serde_json::Value,\n    algorithm: JwtAlgorithm,\n    key_material: \u0026[u8],\n) -\u003e Result\u003cString\u003e {\n    // Serialize header and payload\n    let header_json = serde_json::to_string(header)\n        .context(\"Failed to serialize JWT header\")?;\n    let payload_json = serde_json::to_string(payload)\n        .context(\"Failed to serialize JWT payload\")?;\n    \n    // Base64URL encode header and payload\n    let header_b64 = general_purpose::URL_SAFE_NO_PAD.encode(header_json.as_bytes());\n    let payload_b64 = general_purpose::URL_SAFE_NO_PAD.encode(payload_json.as_bytes());\n    \n    let message = format!(\"{header_b64}.{payload_b64}\");\n    \n    // Sign the message based on algorithm\n    let signature_bytes = match algorithm {\n        JwtAlgorithm::HS256 =\u003e sign_jwt_hmac_sha256(message.as_bytes(), key_material)?,\n        JwtAlgorithm::ES256 =\u003e {\n            let key_pem = std::str::from_utf8(key_material)\n                .context(\"ES256 key material must be valid UTF-8 PEM\")?;\n            sign_jwt_es256(message.as_bytes(), key_pem)?\n        }\n    };\n    \n    let signature_b64 = general_purpose::URL_SAFE_NO_PAD.encode(\u0026signature_bytes);\n    \n    Ok(format!(\"{message}.{signature_b64}\"))\n}\n\n/// Sign a message using HMAC-SHA256\n/// \n/// # Arguments\n/// \n/// * `message` - The message to sign\n/// * `secret` - The shared secret key\n/// \n/// # Returns\n/// \n/// The HMAC-SHA256 signature as bytes\n/// \n/// # Errors\n/// \n/// Returns an error if HMAC computation fails\nfn sign_jwt_hmac_sha256(message: \u0026[u8], secret: \u0026[u8]) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n    use hmac::{Hmac, Mac};\n    use sha2::Sha256;\n    \n    type HmacSha256 = Hmac\u003cSha256\u003e;\n    \n    let mut mac = \u003cHmacSha256 as Mac\u003e::new_from_slice(secret)\n        .context(\"Invalid HMAC key length\")?;\n    mac.update(message);\n    \n    Ok(mac.finalize().into_bytes().to_vec())\n}\n\n/// Sign a message using ECDSA P-256 with SHA-256 (ES256)\n/// \n/// # Arguments\n/// \n/// * `message` - The message to sign\n/// * `private_key_pem` - PEM-encoded PKCS#8 private key\n/// \n/// # Returns\n/// \n/// The ES256 signature as bytes\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Private key parsing fails\n/// - Signing operation fails\nfn sign_jwt_es256(message: \u0026[u8], private_key_pem: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n    use p256::ecdsa::{signature::Signer, Signature, SigningKey};\n    use p256::pkcs8::DecodePrivateKey;\n    \n    let signing_key = SigningKey::from_pkcs8_pem(private_key_pem)\n        .map_err(|e| anyhow!(\"Failed to parse ECDSA private key: {e:?}\"))?;\n    \n    let signature: Signature = signing_key.sign(message);\n    Ok(signature.to_bytes().to_vec())\n}\n\n/// Helper function to create JWT header for common algorithms\n/// \n/// # Arguments\n/// \n/// * `algorithm` - The JWT algorithm\n/// * `key_id` - Optional key ID (for ES256 with key rotation)\n/// \n/// # Returns\n/// \n/// A JSON value representing the JWT header\n#[must_use]\npub fn create_jwt_header(algorithm: \u0026JwtAlgorithm, key_id: Option\u003c\u0026str\u003e) -\u003e serde_json::Value {\n    let alg_str = match algorithm {\n        JwtAlgorithm::HS256 =\u003e \"HS256\",\n        JwtAlgorithm::ES256 =\u003e \"ES256\",\n    };\n    \n    let mut header = serde_json::json!({\n        \"alg\": alg_str,\n        \"typ\": \"JWT\"\n    });\n    \n    if let Some(kid) = key_id {\n        header[\"kid\"] = serde_json::Value::String(kid.to_string());\n    }\n    \n    header\n}\n\n/// Helper function to create standard JWT payload with common claims\n/// \n/// # Arguments\n/// \n/// * `issuer` - The issuer (iss) claim\n/// * `subject` - The subject (sub) claim  \n/// * `audience` - The audience (aud) claim\n/// * `expiry_minutes` - Token expiry time in minutes from now\n/// * `additional_claims` - Additional custom claims to include\n/// \n/// # Returns\n/// \n/// A JSON value representing the JWT payload\n#[must_use]\npub fn create_jwt_payload(\n    issuer: \u0026str,\n    subject: \u0026str,\n    audience: \u0026str,\n    expiry_minutes: i64,\n    additional_claims: Option\u003c\u0026serde_json::Value\u003e,\n) -\u003e serde_json::Value {\n    use chrono::{Duration, Utc};\n    \n    let now = Utc::now();\n    let exp = now + Duration::minutes(expiry_minutes);\n    \n    let mut payload = serde_json::json!({\n        \"iss\": issuer,\n        \"sub\": subject,\n        \"aud\": audience,\n        \"iat\": now.timestamp(),\n        \"exp\": exp.timestamp()\n    });\n    \n    // Merge additional claims if provided\n    if let Some(serde_json::Value::Object(additional_map)) = additional_claims {\n        if let serde_json::Value::Object(ref mut payload_map) = payload {\n            for (key, value) in additional_map {\n                payload_map.insert(key.clone(), value.clone());\n            }\n        }\n    }\n    \n    payload\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n    \n    // Test secret key for HMAC operations - generated dynamically\n    fn get_test_secret() -\u003e Vec\u003cu8\u003e {\n        b\"test_secret_key_for_hmac_testing_32b\".to_vec()\n    }\n    \n    // Generate a test P-256 (NIST curve) private key for ES256 testing\n    // This avoids hardcoding a private key in the source code\n    fn generate_test_es256_key() -\u003e String {\n        // Only import these crates inside the test module\n        use p256::pkcs8::{EncodePrivateKey, LineEnding};\n        use p256::ecdsa::{SigningKey};\n        use rand::thread_rng;\n        \n        // Generate a new random key each time using thread_rng from rand crate\n        let signing_key = SigningKey::random(\u0026mut thread_rng());\n        \n        // Convert to PKCS#8 PEM format\n        signing_key.to_pkcs8_pem(LineEnding::LF)\n            .expect(\"Failed to generate test ES256 key\")\n            .to_string()\n    }\n\n    #[test]\n    fn test_create_jwt_header_hs256() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        \n        assert_eq!(header[\"alg\"], \"HS256\");\n        assert_eq!(header[\"typ\"], \"JWT\");\n        assert!(header.get(\"kid\").is_none());\n    }\n\n    #[test]\n    fn test_create_jwt_header_es256_with_kid() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::ES256, Some(\"test-key-id\"));\n        \n        assert_eq!(header[\"alg\"], \"ES256\");\n        assert_eq!(header[\"typ\"], \"JWT\");\n        assert_eq!(header[\"kid\"], \"test-key-id\");\n    }\n\n    #[test]\n    fn test_create_jwt_payload() {\n        let payload = create_jwt_payload(\n            \"test-issuer\",\n            \"test-subject\", \n            \"test-audience\",\n            60, // 1 hour\n            None,\n        );\n        \n        assert_eq!(payload[\"iss\"], \"test-issuer\");\n        assert_eq!(payload[\"sub\"], \"test-subject\");\n        assert_eq!(payload[\"aud\"], \"test-audience\");\n        assert!(payload[\"iat\"].is_number());\n        assert!(payload[\"exp\"].is_number());\n        \n        // Verify expiry is 1 hour from now\n        let iat = payload[\"iat\"].as_i64().unwrap();\n        let exp = payload[\"exp\"].as_i64().unwrap();\n        assert_eq!(exp - iat, 3600); // 60 minutes * 60 seconds\n    }\n\n    #[test]\n    fn test_create_jwt_payload_with_additional_claims() {\n        let additional_claims = json!({\n            \"custom_field\": \"custom_value\",\n            \"number_field\": 123\n        });\n        \n        let payload = create_jwt_payload(\n            \"test-issuer\",\n            \"test-subject\",\n            \"test-audience\", \n            5,\n            Some(\u0026additional_claims),\n        );\n        \n        assert_eq!(payload[\"iss\"], \"test-issuer\");\n        assert_eq!(payload[\"custom_field\"], \"custom_value\");\n        assert_eq!(payload[\"number_field\"], 123);\n    }\n\n    #[test]\n    fn test_hmac_sha256_signing() {\n        let test_secret = get_test_secret();\n        let message = b\"test.message\";\n        let result = sign_jwt_hmac_sha256(message, \u0026test_secret);\n        \n        assert!(result.is_ok());\n        let signature = result.unwrap();\n        assert!(!signature.is_empty());\n        assert_eq!(signature.len(), 32); // SHA-256 produces 32-byte hash\n    }\n\n    #[test]\n    fn test_hmac_sha256_deterministic() {\n        let message = b\"test.message\";\n        let test_secret = get_test_secret();\n        \n        let sig1 = sign_jwt_hmac_sha256(message, \u0026test_secret).unwrap();\n        let sig2 = sign_jwt_hmac_sha256(message, \u0026test_secret).unwrap();\n        \n        assert_eq!(sig1, sig2, \"HMAC signatures should be deterministic\");\n    }\n\n    #[test]\n    fn test_hmac_sha256_different_messages() {\n        let message1 = b\"test.message1\";\n        let message2 = b\"test.message2\";\n        let test_secret = get_test_secret();\n        \n        let sig1 = sign_jwt_hmac_sha256(message1, \u0026test_secret).unwrap();\n        let sig2 = sign_jwt_hmac_sha256(message2, \u0026test_secret).unwrap();\n        \n        assert_ne!(sig1, sig2, \"Different messages should produce different signatures\");\n    }\n\n    #[test]\n    fn test_create_jwt_hs256() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        let payload = json!({\n            \"sub\": \"test-user\",\n            \"iat\": 1_234_567_890,\n            \"exp\": 1_234_571_490\n        });\n        \n        let test_secret = get_test_secret();\n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::HS256, \u0026test_secret);\n        \n        assert!(result.is_ok());\n        let jwt = result.unwrap();\n        \n        // JWT should have 3 parts separated by dots\n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        assert_eq!(parts.len(), 3);\n        \n        // Decode and verify header\n        let header_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[0]).unwrap();\n        let decoded_header: serde_json::Value = serde_json::from_slice(\u0026header_bytes).unwrap();\n        assert_eq!(decoded_header[\"alg\"], \"HS256\");\n        assert_eq!(decoded_header[\"typ\"], \"JWT\");\n        \n        // Decode and verify payload\n        let payload_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[1]).unwrap();\n        let decoded_payload: serde_json::Value = serde_json::from_slice(\u0026payload_bytes).unwrap();\n        assert_eq!(decoded_payload[\"sub\"], \"test-user\");\n        assert_eq!(decoded_payload[\"iat\"], 1_234_567_890);\n        assert_eq!(decoded_payload[\"exp\"], 1_234_571_490);\n    }\n\n    #[test]\n    fn test_create_jwt_hs256_verification() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        let payload = json!({\n            \"sub\": \"test-user\",\n            \"iss\": \"test-issuer\"\n        });\n        \n        let test_secret = get_test_secret();\n        let jwt = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::HS256, \u0026test_secret).unwrap();\n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        \n        // Manually verify HMAC signature\n        let message = format!(\"{}.{}\", parts[0], parts[1]);\n        let expected_signature = sign_jwt_hmac_sha256(message.as_bytes(), \u0026test_secret).unwrap();\n        let expected_signature_b64 = general_purpose::URL_SAFE_NO_PAD.encode(\u0026expected_signature);\n        \n        assert_eq!(parts[2], expected_signature_b64);\n    }\n\n    #[test]\n    fn test_es256_signing_deterministic_within_same_key() {\n        // ES256 produces different signatures each time (due to random k value),\n        // but we should be able to sign successfully\n        let message = b\"test.message\";\n        \n        // Generate a test key for this test\n        let test_es256_key = generate_test_es256_key();\n        \n        let result1 = sign_jwt_es256(message, \u0026test_es256_key);\n        let result2 = sign_jwt_es256(message, \u0026test_es256_key);\n        \n        assert!(result1.is_ok());\n        assert!(result2.is_ok());\n        \n        let sig1 = result1.unwrap();\n        let sig2 = result2.unwrap();\n        \n        // ES256 signatures are not deterministic due to random k value\n        // But they should both be 64 bytes (32 bytes r + 32 bytes s)\n        assert_eq!(sig1.len(), 64);\n        assert_eq!(sig2.len(), 64);\n    }\n\n    #[test]\n    fn test_create_jwt_es256() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::ES256, Some(\"test-key\"));\n        let payload = json!({\n            \"sub\": \"test-user\",\n            \"iss\": \"test-issuer\",\n            \"aud\": \"https://api.example.com\"\n        });\n        \n        // Generate a key for this test\n        let test_es256_key = generate_test_es256_key();\n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::ES256, test_es256_key.as_bytes());\n        \n        assert!(result.is_ok());\n        let jwt = result.unwrap();\n        \n        // JWT should have 3 parts separated by dots\n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        assert_eq!(parts.len(), 3);\n        \n        // Decode and verify header\n        let header_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[0]).unwrap();\n        let decoded_header: serde_json::Value = serde_json::from_slice(\u0026header_bytes).unwrap();\n        assert_eq!(decoded_header[\"alg\"], \"ES256\");\n        assert_eq!(decoded_header[\"typ\"], \"JWT\");\n        assert_eq!(decoded_header[\"kid\"], \"test-key\");\n        \n        // Decode and verify payload\n        let payload_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[1]).unwrap();\n        let decoded_payload: serde_json::Value = serde_json::from_slice(\u0026payload_bytes).unwrap();\n        assert_eq!(decoded_payload[\"sub\"], \"test-user\");\n        assert_eq!(decoded_payload[\"iss\"], \"test-issuer\");\n        assert_eq!(decoded_payload[\"aud\"], \"https://api.example.com\");\n        \n        // Signature should be base64url encoded and non-empty\n        assert!(!parts[2].is_empty());\n        let signature_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[2]).unwrap();\n        assert_eq!(signature_bytes.len(), 64); // ES256 signature is 64 bytes\n    }\n\n    #[test]\n    fn test_create_jwt_invalid_es256_key() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::ES256, None);\n        let payload = json!({\"sub\": \"test\"});\n        let invalid_key = b\"not-a-valid-pem-key\";\n        \n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::ES256, invalid_key);\n        \n        assert!(result.is_err());\n        let error = result.unwrap_err();\n        assert!(error.to_string().contains(\"Failed to parse ECDSA private key\"));\n    }\n\n    #[test]\n    fn test_create_jwt_malformed_es256_key() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::ES256, None);\n        let payload = json!({\"sub\": \"test\"});\n        let malformed_key = \"-----BEGIN PRIVATE KEY-----\\ninvalid\\n-----END PRIVATE KEY-----\";\n        \n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::ES256, malformed_key.as_bytes());\n        \n        assert!(result.is_err());\n        let error = result.unwrap_err();\n        assert!(error.to_string().contains(\"Failed to parse ECDSA private key\"));\n    }\n\n    #[test]\n    fn test_hmac_invalid_key_length() {\n        // Test with zero-length key (should still work with HMAC)\n        let message = b\"test.message\";\n        let empty_key = b\"\";\n        \n        let result = sign_jwt_hmac_sha256(message, empty_key);\n        // HMAC should work with any key length, including empty\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_jwt_algorithm_debug() {\n        // Test that the enum implements Debug properly\n        let hs256 = JwtAlgorithm::HS256;\n        let es256 = JwtAlgorithm::ES256;\n        \n        assert!(format!(\"{hs256:?}\").contains(\"HS256\"));\n        assert!(format!(\"{es256:?}\").contains(\"ES256\"));\n    }\n\n    #[test]\n    fn test_jwt_algorithm_clone() {\n        // Test that the enum implements Clone properly\n        let original = JwtAlgorithm::HS256;\n        let cloned = original;\n        \n        // They should be equal (though we can't test equality directly without PartialEq)\n        assert!(format!(\"{original:?}\") == format!(\"{cloned:?}\"));\n    }\n\n    #[test]\n    fn test_empty_jwt_payload() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        let payload = json!({});\n        \n        let test_secret = get_test_secret();\n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::HS256, \u0026test_secret);\n        \n        assert!(result.is_ok());\n        let jwt = result.unwrap();\n        \n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        assert_eq!(parts.len(), 3);\n        \n        // Should be able to decode empty payload\n        let payload_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[1]).unwrap();\n        let decoded_payload: serde_json::Value = serde_json::from_slice(\u0026payload_bytes).unwrap();\n        assert!(decoded_payload.is_object());\n        assert!(decoded_payload.as_object().unwrap().is_empty());\n    }\n\n    #[test]\n    fn test_large_jwt_payload() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        let large_string = \"x\".repeat(1000);\n        let payload = json!({\n            \"large_field\": large_string,\n            \"sub\": \"test-user\"\n        });\n        \n        let test_secret = get_test_secret();\n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::HS256, \u0026test_secret);\n        \n        assert!(result.is_ok());\n        let jwt = result.unwrap();\n        \n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        assert_eq!(parts.len(), 3);\n        \n        // Should be able to decode large payload\n        let payload_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[1]).unwrap();\n        let decoded_payload: serde_json::Value = serde_json::from_slice(\u0026payload_bytes).unwrap();\n        assert_eq!(decoded_payload[\"sub\"], \"test-user\");\n        assert_eq!(decoded_payload[\"large_field\"], large_string);\n    }\n}\n","traces":[{"line":31,"address":[3895935,3895941,3895760],"length":1,"stats":{"Line":0}},{"line":32,"address":[3191405],"length":1,"stats":{"Line":0}},{"line":33,"address":[3470878],"length":1,"stats":{"Line":0}},{"line":34,"address":[3470965],"length":1,"stats":{"Line":0}},{"line":49,"address":[3471329,3471335,3471040],"length":1,"stats":{"Line":0}},{"line":50,"address":[3895977],"length":1,"stats":{"Line":0}},{"line":51,"address":[3098106,3098162],"length":1,"stats":{"Line":0}},{"line":52,"address":[3471267],"length":1,"stats":{"Line":0}},{"line":65,"address":[3193066,3192965,3191920],"length":1,"stats":{"Line":5}},{"line":66,"address":[3191953],"length":1,"stats":{"Line":2}},{"line":67,"address":[3098540,3098478],"length":1,"stats":{"Line":10}},{"line":68,"address":[3193025,3192115],"length":1,"stats":{"Line":0}},{"line":71,"address":[3471610,3471538],"length":1,"stats":{"Line":7}},{"line":72,"address":[3192177,3192382,3193005],"length":1,"stats":{"Line":7}},{"line":74,"address":[2535489,2535472],"length":1,"stats":{"Line":2}},{"line":75,"address":[3192350],"length":1,"stats":{"Line":2}},{"line":77,"address":[2535553,2535552],"length":1,"stats":{"Line":8}},{"line":79,"address":[3245376,3245392],"length":1,"stats":{"Line":8}},{"line":99,"address":[3247024,3245488,3248665,3250224,3248624,3250265,3248688,3247065,3247088],"length":1,"stats":{"Line":6}},{"line":100,"address":[2535752,2537304,2538856],"length":1,"stats":{"Line":6}},{"line":101,"address":[2537428,2535876,2538980],"length":1,"stats":{"Line":0}},{"line":105,"address":[3950274,3949923,3951523,3951874,3953474,3953123],"length":1,"stats":{"Line":6}},{"line":108,"address":[3953572,3950372,3951972],"length":1,"stats":{"Line":5}},{"line":109,"address":[2539400,2537848,2537783,2536231,2536296,2539335],"length":1,"stats":{"Line":12}},{"line":110,"address":[2539513,2536409,2537961],"length":1,"stats":{"Line":6}},{"line":113,"address":[3247844,3249444,3246244],"length":1,"stats":{"Line":6}},{"line":114,"address":[3155856,3152795,3154395,3152656,3155995,3154256],"length":1,"stats":{"Line":6}},{"line":115,"address":[3154180,3155780,3152580],"length":1,"stats":{"Line":6}},{"line":116,"address":[3156772,3156768,3156672,3155979,3156676,3154379,3152779,3156576,3156580],"length":1,"stats":{"Line":0}},{"line":119,"address":[3248192,3246665,3246592,3248265,3249792,3249865],"length":1,"stats":{"Line":12}},{"line":120,"address":[3951098,3952698,3954298],"length":1,"stats":{"Line":6}},{"line":121,"address":[3154701,3156301,3153101],"length":1,"stats":{"Line":8}},{"line":123,"address":[3250078,3246878,3248478],"length":1,"stats":{"Line":8}},{"line":145,"address":[2542345,2543921,2542249,2540640,2542368,2544016,2545669,2545765,2544032],"length":1,"stats":{"Line":5}},{"line":146,"address":[3254244,3252424,3250648],"length":1,"stats":{"Line":5}},{"line":147,"address":[3956935,3958761,3955159],"length":1,"stats":{"Line":0}},{"line":151,"address":[3156956,3157336,3158732,3160558,3160938,3159112],"length":1,"stats":{"Line":6}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[3251203,3251130,3252979,3254732,3252906,3254805],"length":1,"stats":{"Line":12}},{"line":156,"address":[2541298,2543044,2542281,2543953,2544690,2545701],"length":1,"stats":{"Line":0}},{"line":160,"address":[3959179,3955645,3957353,3957421,3959247,3955577],"length":1,"stats":{"Line":12}},{"line":161,"address":[3161272,3159446,3157670],"length":1,"stats":{"Line":6}},{"line":164,"address":[3159485,3157709,3161314],"length":1,"stats":{"Line":7}},{"line":165,"address":[3253252,3253435,3251547,3253323,3254051,3251476,3255152,3255081,3252247,3251659,3255267,3255775],"length":1,"stats":{"Line":16}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[3255984,3253419,3255251,3251643,3255888,3255988,3256080,3256084,3255892],"length":1,"stats":{"Line":3}},{"line":170,"address":[2541776,2543528,2543736,2545168,2543619,2545259,2541990,2541867,2545382],"length":1,"stats":{"Line":12}},{"line":173,"address":[3255661,3252076,3253868],"length":1,"stats":{"Line":6}},{"line":194,"address":[3193088],"length":1,"stats":{"Line":9}},{"line":195,"address":[3897499],"length":1,"stats":{"Line":9}},{"line":196,"address":[3472577],"length":1,"stats":{"Line":9}},{"line":197,"address":[3897548],"length":1,"stats":{"Line":9}},{"line":200,"address":[3099744],"length":1,"stats":{"Line":9}},{"line":201,"address":[3472768,3473026],"length":1,"stats":{"Line":4}},{"line":202,"address":[3472859,3473036],"length":1,"stats":{"Line":2}},{"line":206,"address":[3897664],"length":1,"stats":{"Line":9}},{"line":242,"address":[3100096,3102457,3102366],"length":1,"stats":{"Line":3}},{"line":249,"address":[3898207,3898079],"length":1,"stats":{"Line":3}},{"line":251,"address":[3473521,3475355,3473354,3473405],"length":1,"stats":{"Line":11}},{"line":255,"address":[3473681,3473610],"length":1,"stats":{"Line":13}},{"line":256,"address":[3194311,3194379],"length":1,"stats":{"Line":14}},{"line":258,"address":[3100869,3100937],"length":1,"stats":{"Line":14}},{"line":261,"address":[3474016],"length":1,"stats":{"Line":7}},{"line":262,"address":[3194673,3194762,3195008],"length":1,"stats":{"Line":6}},{"line":264,"address":[3195913,3194643,3195032,3195150],"length":1,"stats":{"Line":10}},{"line":266,"address":[3475272,3474592],"length":1,"stats":{"Line":7}},{"line":270,"address":[3474359],"length":1,"stats":{"Line":5}},{"line":272,"address":[3195590,3195522],"length":1,"stats":{"Line":5}},{"line":289,"address":[3475376],"length":1,"stats":{"Line":3}},{"line":295,"address":[3102668,3102563],"length":1,"stats":{"Line":4}},{"line":297,"address":[3196285],"length":1,"stats":{"Line":4}},{"line":299,"address":[3196296],"length":1,"stats":{"Line":5}},{"line":318,"address":[3475808,3476421,3476427],"length":1,"stats":{"Line":3}},{"line":322,"address":[3475893,3475983],"length":1,"stats":{"Line":8}},{"line":323,"address":[3475967],"length":1,"stats":{"Line":6}},{"line":325,"address":[3103330],"length":1,"stats":{"Line":3}},{"line":326,"address":[3103395],"length":1,"stats":{"Line":3}},{"line":340,"address":[3901472,3902640,3902634],"length":1,"stats":{"Line":4}},{"line":341,"address":[3103603],"length":1,"stats":{"Line":4}},{"line":342,"address":[3901569],"length":1,"stats":{"Line":1}},{"line":343,"address":[3901546],"length":1,"stats":{"Line":4}},{"line":346,"address":[3476683,3477609,3476890,3476571],"length":1,"stats":{"Line":4}},{"line":351,"address":[3477103,3477563],"length":1,"stats":{"Line":9}},{"line":352,"address":[3198092,3198030,3197829,3197942,3198244],"length":1,"stats":{"Line":8}},{"line":355,"address":[3902226],"length":1,"stats":{"Line":3}},{"line":372,"address":[3104800,3106918,3106924],"length":1,"stats":{"Line":1}},{"line":381,"address":[3902783],"length":1,"stats":{"Line":1}},{"line":382,"address":[3477813],"length":1,"stats":{"Line":1}},{"line":384,"address":[3199119,3198900,3199392,3200473,3198684,3199651,3198565,3199338,3199597],"length":1,"stats":{"Line":6}},{"line":388,"address":[3105848,3105778],"length":1,"stats":{"Line":4}},{"line":389,"address":[3903941,3904011],"length":1,"stats":{"Line":4}},{"line":393,"address":[3479287,3479174],"length":1,"stats":{"Line":3}},{"line":394,"address":[3200028],"length":1,"stats":{"Line":1}},{"line":395,"address":[3479360,3479411],"length":1,"stats":{"Line":2}},{"line":396,"address":[3106739,3106785],"length":1,"stats":{"Line":1}},{"line":401,"address":[3106412],"length":1,"stats":{"Line":1}}],"covered":81,"coverable":96},{"path":["/","workspaces","vouchrs","src","utils","error_handler.rs"],"content":"use actix_web::HttpResponse;\nuse crate::session::SessionManager;\n\npub struct ErrorHandler;\n\nimpl ErrorHandler {\n    /// Create an OAuth error redirect with cookie clearing\n    #[must_use]\n    pub fn oauth_error_redirect(\n        session_manager: \u0026SessionManager,\n        error_type: \u0026str,\n        redirect_url: Option\u003c\u0026str\u003e\n    ) -\u003e HttpResponse {\n        let clear_cookie = session_manager.create_expired_cookie();\n        let location = redirect_url.unwrap_or(\"/oauth2/sign_in\");\n        \n        let final_url = if location.contains('?') {\n            format!(\"{location}\u0026error={error_type}\")\n        } else {\n            format!(\"{location}?error={error_type}\")\n        };\n        \n        HttpResponse::Found()\n            .cookie(clear_cookie)\n            .append_header((\"Location\", final_url))\n            .finish()\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","utils","logging.rs"],"content":"// Centralized logging utilities to reduce verbose logging patterns\nuse crate::utils::apple::AppleUserInfo;\nuse log::{debug, info, warn};\n\npub struct LoggingHelper;\n\nimpl LoggingHelper {\n    /// Log OAuth token response in a standardized format\n    pub fn log_oauth_token_response(provider: \u0026str, apple_user_info: Option\u003c\u0026AppleUserInfo\u003e) {\n        info!(\"=== OAuth Token Exchange Success for {provider} ===\");\n        // Expires at, refresh token, and id token are now on VouchrSession or passed separately.\n        if provider == \"apple\" {\n            Self::log_apple_user_info(apple_user_info);\n        }\n        info!(\"=== End OAuth Token Analysis ===\");\n    }\n\n    /// Log Apple user info in a standardized format\n    fn log_apple_user_info(apple_user_info: Option\u003c\u0026AppleUserInfo\u003e) {\n        info!(\"=== Apple User Info Analysis ===\");\n        info!(\"Apple user info present: {}\", apple_user_info.is_some());\n\n        if let Some(user_info) = apple_user_info {\n            info!(\"Apple user info email: {:?}\", user_info.email);\n            info!(\"Apple user info name: {:?}\", user_info.name.full_name());\n            info!(\n                \"Apple user info first_name: {:?}\",\n                user_info.name.first_name\n            );\n            info!(\"Apple user info last_name: {:?}\", user_info.name.last_name);\n\n            // Log raw JSON serialization for complete debugging\n            if let Ok(user_info_json) = serde_json::to_string_pretty(user_info) {\n                info!(\"Apple user info JSON:\\n{user_info_json}\");\n            }\n        } else {\n            warn!(\"Apple OAuth completed but no user info was returned in the token response\");\n            warn!(\"This may happen on subsequent logins or if user info was not requested\");\n        }\n    }\n\n    /// Log provider initialization status\n    pub fn log_provider_init(provider_name: \u0026str, display_name: Option\u003c\u0026str\u003e, configured: bool) {\n        let name = display_name.unwrap_or(provider_name);\n        if configured {\n            info!(\"âœ… {name} OAuth2 configured ({provider_name})\");\n        } else {\n            info!(\n                \"âŒ {name} OAuth2 not configured - missing environment variables\"\n            );\n        }\n    }\n\n    /// Log OAuth provider initialization start\n    pub fn log_oauth_provider_initialization() {\n        info!(\"ðŸ”§ Initializing OAuth providers from configuration...\");\n    }\n\n    /// Log that a provider is disabled\n    pub fn log_oauth_provider_disabled(provider_name: \u0026str) {\n        info!(\"â­ï¸  Provider {provider_name} is disabled, skipping\");\n    }\n\n    /// Log that a provider is configured\n    pub fn log_oauth_provider_configured(display_name: \u0026str, provider_name: \u0026str) {\n        info!(\"âœ… {display_name} OAuth2 configured ({provider_name})\");\n    }\n\n    /// Log that a provider is not configured\n    pub fn log_oauth_provider_not_configured(display_name: \u0026str) {\n        info!(\n            \"âŒ {display_name} OAuth2 not configured - missing environment variables\"\n        );\n    }\n\n    /// Log summary of configured OAuth providers\n    pub fn log_oauth_providers_summary(provider_names: \u0026[\u0026String]) {\n        info!(\"ðŸŽ¯ Configured OAuth providers: {provider_names:?}\");\n    }\n\n    /// Log OAuth URL building\n    pub fn log_oauth_url_built(\n        provider: \u0026str,\n        scopes: \u0026str,\n        extra_params: \u0026std::collections::HashMap\u003cString, String\u003e,\n    ) {\n        info!(\n            \"ðŸ” Built {provider} OAuth URL with scopes: {scopes} and extra params: {extra_params:?}\"\n        );\n    }\n\n    /// Log token exchange start\n    pub fn log_token_exchange_start(provider: \u0026str) {\n        info!(\n            \"ðŸ”„ Exchanging authorization code for tokens with {provider}\"\n        );\n    }\n\n    /// Log raw Apple token response for debugging\n    pub fn log_apple_token_response_raw(response_text: \u0026str) {\n        info!(\"=== Raw Apple Token Response ===\");\n        info!(\"Response text: {response_text}\");\n        info!(\"=== End Raw Apple Token Response ===\");\n    }\n\n    /// Log raw token response for other providers\n    pub fn log_token_response_raw(provider: \u0026str, response_text: \u0026str) {\n        debug!(\"Raw {provider} token response: {response_text}\");\n    }\n\n    /// Log token exchange summary\n    pub fn log_token_exchange_summary(\n        provider: \u0026str,\n        refresh_token: Option\u003c\u0026String\u003e,\n        id_token: Option\u003c\u0026String\u003e,\n        token_type: \u0026str,\n        expires_in: Option\u003ci64\u003e,\n    ) {\n        let refresh_status = refresh_token.map_or(\"No\", |_| \"Yes\");\n        let id_status = id_token.map_or(\"No\", |_| \"Yes\");\n        \n        info!(\"ðŸ” Token exchange summary for {provider}: refresh_token={refresh_status}, id_token={id_status}, token_type={token_type}, expires_in={expires_in:?}\");\n    }\n\n    /// Log session creation success\n    pub fn log_session_created(user_email: \u0026str, provider: \u0026str) {\n        info!(\n            \"Successfully built session for user: {user_email} (provider: {provider})\"\n        );\n    }\n\n    /// Log OAuth callback details in development mode\n    pub fn log_callback_debug(\n        req: \u0026actix_web::HttpRequest,\n        callback_data: \u0026crate::oauth::OAuthCallback,\n    ) {\n        debug!(\n            \"OAuth callback received via {}: {callback_data:?}\",\n            req.method()\n        );\n        debug!(\"Callback request headers: {:?}\", req.headers());\n        debug!(\n            \"Callback request connection info: {:?}\",\n            req.connection_info()\n        );\n    }\n}\n","traces":[{"line":9,"address":[3744064],"length":1,"stats":{"Line":0}},{"line":10,"address":[3565150,3565212],"length":1,"stats":{"Line":0}},{"line":12,"address":[2880173],"length":1,"stats":{"Line":0}},{"line":13,"address":[3734779],"length":1,"stats":{"Line":0}},{"line":15,"address":[3744351,3744410],"length":1,"stats":{"Line":0}},{"line":19,"address":[2883053,2883047,2880640],"length":1,"stats":{"Line":0}},{"line":20,"address":[3744604,3744689],"length":1,"stats":{"Line":0}},{"line":21,"address":[3565699,3565936],"length":1,"stats":{"Line":0}},{"line":23,"address":[3566190,3568127,3565899],"length":1,"stats":{"Line":0}},{"line":24,"address":[3745151,3745282],"length":1,"stats":{"Line":0}},{"line":25,"address":[3735621,3735948],"length":1,"stats":{"Line":0}},{"line":26,"address":[3745516,3745927],"length":1,"stats":{"Line":0}},{"line":30,"address":[3745881,3746229],"length":1,"stats":{"Line":0}},{"line":33,"address":[3736902,3736553],"length":1,"stats":{"Line":0}},{"line":34,"address":[3746549,3746639,3746667],"length":1,"stats":{"Line":0}},{"line":37,"address":[3735575,3737524],"length":1,"stats":{"Line":0}},{"line":38,"address":[2883145,2883360],"length":1,"stats":{"Line":0}},{"line":43,"address":[3747488],"length":1,"stats":{"Line":0}},{"line":44,"address":[3737947],"length":1,"stats":{"Line":0}},{"line":45,"address":[3747596],"length":1,"stats":{"Line":0}},{"line":46,"address":[2883687,2883961],"length":1,"stats":{"Line":0}},{"line":48,"address":[3568738,3568656],"length":1,"stats":{"Line":0}},{"line":55,"address":[3748192],"length":1,"stats":{"Line":0}},{"line":56,"address":[3748196,3748229],"length":1,"stats":{"Line":0}},{"line":60,"address":[3748368],"length":1,"stats":{"Line":0}},{"line":61,"address":[3738768,3738807],"length":1,"stats":{"Line":0}},{"line":65,"address":[3569664],"length":1,"stats":{"Line":0}},{"line":66,"address":[2884721,2884682],"length":1,"stats":{"Line":0}},{"line":70,"address":[2884976],"length":1,"stats":{"Line":0}},{"line":71,"address":[3739328,3739367],"length":1,"stats":{"Line":0}},{"line":77,"address":[3749168],"length":1,"stats":{"Line":0}},{"line":78,"address":[3749223,3749184],"length":1,"stats":{"Line":0}},{"line":82,"address":[2885456],"length":1,"stats":{"Line":0}},{"line":87,"address":[3749440,3749479],"length":1,"stats":{"Line":0}},{"line":93,"address":[3749792],"length":1,"stats":{"Line":0}},{"line":94,"address":[3749847,3749808],"length":1,"stats":{"Line":0}},{"line":100,"address":[2886080],"length":1,"stats":{"Line":0}},{"line":101,"address":[3571175,3571104],"length":1,"stats":{"Line":0}},{"line":102,"address":[3740463,3740685],"length":1,"stats":{"Line":0}},{"line":103,"address":[2886303,2886580],"length":1,"stats":{"Line":0}},{"line":107,"address":[3750704],"length":1,"stats":{"Line":0}},{"line":108,"address":[2886817,2886778],"length":1,"stats":{"Line":0}},{"line":112,"address":[3572080],"length":1,"stats":{"Line":0}},{"line":119,"address":[3506021,3506016],"length":1,"stats":{"Line":0}},{"line":120,"address":[3572198],"length":1,"stats":{"Line":0}},{"line":122,"address":[3572265,3572226],"length":1,"stats":{"Line":0}},{"line":126,"address":[3742016],"length":1,"stats":{"Line":0}},{"line":127,"address":[2887745,2887706],"length":1,"stats":{"Line":0}},{"line":133,"address":[3752949,3752955,3751952],"length":1,"stats":{"Line":0}},{"line":137,"address":[2888139],"length":1,"stats":{"Line":0}},{"line":141,"address":[3742392,3742754],"length":1,"stats":{"Line":0}},{"line":142,"address":[3743081,3742708,3743014],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":52},{"path":["/","workspaces","vouchrs","src","utils","mod.rs"],"content":"pub mod apple;\npub mod cookie;\npub mod crypto;\npub mod logging;\npub mod redirect_validator;\npub mod response_builder;\npub mod user_agent;\n\n// Make test utilities available for both unit tests and integration tests\npub mod test_helpers;\npub mod test_request_builder;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","utils","redirect_validator.rs"],"content":"use actix_web::HttpResponse;\nuse log::{debug, warn};\n\n/// Validate post-authentication redirect URLs to prevent open redirect attacks\n/// Balanced approach between security and simplicity\n/// \n/// # Errors\n/// \n/// Returns an `HttpResponse` error in the following cases:\n/// - Empty redirect URL\n/// - URL exceeds 2048 characters\n/// - URL doesn't start with a single forward slash\n/// - URL contains dangerous characters (control chars, Unicode tricks)\n/// - URL contains path traversal patterns\n/// - URL contains encoded double slashes\n/// - URL contains protocol injection attempts\n/// - URL contains suspicious redirect parameters in query string\npub fn validate_post_auth_redirect(redirect_url: \u0026str) -\u003e Result\u003cString, HttpResponse\u003e {\n    debug!(\"Validating post-authentication redirect URL: {redirect_url}\");\n    \n    // Empty redirects are invalid\n    if redirect_url.is_empty() {\n        return Err(invalid_redirect_error());\n    }\n    \n    // Length limit to prevent DoS\n    if redirect_url.len() \u003e 2048 {\n        warn!(\"Redirect URL too long: {} characters\", redirect_url.len());\n        return Err(invalid_redirect_error());\n    }\n    \n    // Must start with a single slash (relative URL only)\n    if !redirect_url.starts_with('/') || redirect_url.starts_with(\"//\") {\n        warn!(\"Invalid redirect URL format: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Check for control characters and other dangerous characters\n    if contains_dangerous_characters(redirect_url) {\n        warn!(\"Dangerous characters in redirect URL: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Simple path traversal check (including encoded variants)\n    if contains_path_traversal(redirect_url) {\n        warn!(\"Path traversal attempt in redirect: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Check for encoded slashes that could create // \n    if contains_encoded_double_slash(redirect_url) {\n        warn!(\"Encoded double slash in redirect: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Basic protocol injection check (including mixed case)\n    if contains_protocol_injection(redirect_url) {\n        warn!(\"Protocol injection attempt in redirect: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Check for suspicious query parameters that could be open redirects\n    if contains_redirect_in_query(redirect_url) {\n        warn!(\"Redirect parameter in query string: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    Ok(redirect_url.to_string())\n}\n\n/// Check for dangerous characters including control chars and Unicode tricks\nfn contains_dangerous_characters(url: \u0026str) -\u003e bool {\n    // Check for null bytes\n    if url.contains('\\0') || url.contains(\"%00\") {\n        return true;\n    }\n    \n    // Check for control characters (both raw and encoded)\n    let control_patterns = [\n        \"\\n\", \"\\r\", \"\\t\", // Raw control chars\n        \"%0a\", \"%0A\", \"%0d\", \"%0D\", \"%09\", // Encoded newline, carriage return, tab\n        \"%01\", \"%02\", \"%03\", \"%04\", \"%05\", \"%06\", \"%07\", \"%08\", // Other control chars\n        \"%0b\", \"%0B\", \"%0c\", \"%0C\", \"%0e\", \"%0E\", \"%0f\", \"%0F\",\n    ];\n    \n    let url_lower = url.to_lowercase();\n    for pattern in \u0026control_patterns {\n        if url.contains(pattern) || url_lower.contains(pattern) {\n            return true;\n        }\n    }\n    \n    // Check for Unicode direction override characters and various spaces\n    if url.chars().any(|c| matches!(c, \n        '\\u{202A}'..='\\u{202E}' | // LTR/RTL override\n        '\\u{2060}'..='\\u{2069}' | // Word joiner and invisible separators\n        '\\u{200B}'..='\\u{200F}' | // Zero-width space and marks\n        '\\u{FEFF}' |              // Zero-width no-break space\n        '\\u{2000}'..='\\u{200A}' | // Various Unicode spaces (en space, em space, etc.)\n        '\\u{00A0}' |              // Non-breaking space\n        '\\u{1680}' |              // Ogham space mark\n        '\\u{180E}' |              // Mongolian vowel separator\n        '\\u{2028}' |              // Line separator\n        '\\u{2029}' |              // Paragraph separator\n        '\\u{205F}' |              // Medium mathematical space\n        '\\u{3000}'                // Ideographic space\n    )) {\n        return true;\n    }\n    \n    false\n}\n\n/// Check for path traversal patterns including encoded variants\nfn contains_path_traversal(url: \u0026str) -\u003e bool {\n    // Direct check\n    if url.contains(\"..\") || url.contains('\\\\') {\n        return true;\n    }\n    \n    // Check URL-encoded variants\n    let encoded_patterns = [\n        \"%2e%2e\", \"%2E%2E\", // ..\n        \"%2e%2e%2f\", \"%2E%2E%2F\", // ../\n        \"%2e%2e%5c\", \"%2E%2E%5C\", // ..\\\n        \"%252e%252e\", \"%252E%252E\", // Double-encoded ..\n        \"%c0%ae\", \"%c1%9c\", // Unicode encoding tricks\n        \"%5c\", \"%5C\", // \\\n        \"%252f\", \"%252F\", // Double-encoded /\n        \"%255c\", \"%255C\", // Double-encoded \\\n    ];\n    \n    let url_lower = url.to_lowercase();\n    for pattern in \u0026encoded_patterns {\n        if url_lower.contains(pattern) {\n            return true;\n        }\n    }\n    \n    false\n}\n\n/// Check for encoded slashes that could create //\nfn contains_encoded_double_slash(url: \u0026str) -\u003e bool {\n    let patterns = [\n        \"%2f%2f\", \"%2F%2F\", // //\n        \"%252f%252f\", \"%252F%252F\", // Double-encoded //\n        \"%2f%252f\", \"%252f%2f\", // Mixed encoding\n        \"/%2f\", \"/%2F\", // Leading to //\n        \"%5c%5c\", \"%5C%5C\", // \\\\\n    ];\n    \n    let url_lower = url.to_lowercase();\n    for pattern in \u0026patterns {\n        if url_lower.contains(pattern) {\n            return true;\n        }\n    }\n    \n    // Check for patterns that would result in // after decoding\n    if url.contains(\"/%2f\") || url.contains(\"/%2F\") ||\n       url.contains(\"/%252f\") || url.contains(\"/%252F\") {\n        return true;\n    }\n    \n    false\n}\n\n/// Check for protocol injection attempts\nfn contains_protocol_injection(url: \u0026str) -\u003e bool {\n    let protocols = [\n        \"javascript:\", \"data:\", \"vbscript:\", \"file:\", \"about:\",\n        \"chrome:\", \"chrome-extension:\", \"ms-browser-extension:\",\n        \"opera:\", \"brave:\", \"edge:\",\n    ];\n    \n    let url_lower = url.to_lowercase();\n    \n    // Direct protocol check\n    for protocol in \u0026protocols {\n        if url_lower.contains(protocol) {\n            return true;\n        }\n    }\n    \n    // Check for encoded protocols\n    let encoded_protocols = [\n        \"%6a%61%76%61%73%63%72%69%70%74%3a\", // javascript:\n        \"%64%61%74%61%3a\", // data:\n        \"\u0026#106;\u0026#97;\u0026#118;\u0026#97;\u0026#115;\u0026#99;\u0026#114;\u0026#105;\u0026#112;\u0026#116;\u0026#58;\", // HTML entity encoded javascript:\n        \"\\\\x6A\\\\x61\\\\x76\\\\x61\\\\x73\\\\x63\\\\x72\\\\x69\\\\x70\\\\x74\\\\x3A\", // Hex escaped javascript:\n    ];\n    \n    for encoded_protocol in \u0026encoded_protocols {\n        if url_lower.contains(encoded_protocol) {\n            return true;\n        }\n    }\n    \n    false\n}\n\n/// Check for redirect parameters in query string\nfn contains_redirect_in_query(url: \u0026str) -\u003e bool {\n    // Common redirect parameter names\n    let redirect_params = [\n        \"redirect\", \"redirect_uri\", \"redirect_url\", \"return\", \"returnurl\",\n        \"return_url\", \"returnto\", \"return_to\", \"next\", \"goto\", \"target\",\n        \"destination\", \"dest\", \"continue\", \"url\", \"link\", \"ref\",\n        \"callback\", \"callback_url\", \"success_url\", \"failure_url\",\n    ];\n    \n    let url_lower = url.to_lowercase();\n    \n    // Check if URL has query string\n    if let Some(query_start) = url_lower.find('?') {\n        let query_part = \u0026url_lower[query_start + 1..];\n        \n        for param in \u0026redirect_params {\n            // Check for parameter=value pattern\n            let patterns = [\n                format!(\"{param}=\"),\n                format!(\"{param}\u0026\"),\n                format!(\"{param}%3d\"), // URL encoded =\n                format!(\"{param}%3D\"),\n            ];\n            \n            for pattern in \u0026patterns {\n                if query_part.contains(pattern) {\n                    return true;\n                }\n            }\n        }\n    }\n    \n    false\n}\n\n/// Create a generic invalid redirect error response\nfn invalid_redirect_error() -\u003e HttpResponse {\n    HttpResponse::BadRequest().json(serde_json::json!({\n        \"error\": \"invalid_redirect\",\n        \"error_description\": \"The redirect URL is invalid or potentially unsafe\"\n    }))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_valid_redirects() {\n        // Valid paths should pass\n        assert!(validate_post_auth_redirect(\"/home\").is_ok());\n        assert!(validate_post_auth_redirect(\"/app/dashboard\").is_ok());\n        assert!(validate_post_auth_redirect(\"/\").is_ok());\n        assert!(validate_post_auth_redirect(\"/page?param=value\").is_ok());\n        assert!(validate_post_auth_redirect(\"/path#anchor\").is_ok());\n    }\n\n    #[test]\n    fn test_empty_redirect() {\n        assert!(validate_post_auth_redirect(\"\").is_err());\n    }\n\n    #[test]\n    fn test_protocol_injection() {\n        // Direct protocol injection\n        assert!(validate_post_auth_redirect(\"/javascript:alert(1)\").is_err());\n        assert!(validate_post_auth_redirect(\"/data:text/html,\u003cscript\u003ealert(1)\u003c/script\u003e\").is_err());\n        \n        // Case variations\n        assert!(validate_post_auth_redirect(\"/JavaScript:alert(1)\").is_err());\n        assert!(validate_post_auth_redirect(\"/JAVASCRIPT:alert(1)\").is_err());\n        \n        // URL encoded\n        assert!(validate_post_auth_redirect(\"/%6a%61%76%61%73%63%72%69%70%74%3aalert(1)\").is_err());\n    }\n\n    #[test]\n    fn test_double_slash() {\n        // Direct double slash\n        assert!(validate_post_auth_redirect(\"//evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"//evil.com/path\").is_err());\n        \n        // Encoded slashes\n        assert!(validate_post_auth_redirect(\"/%2f%2fevil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/%2F%2Fevil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/%252f%252fevil.com\").is_err());\n    }\n\n    #[test]\n    fn test_path_traversal() {\n        // Direct traversal\n        assert!(validate_post_auth_redirect(\"/../etc/passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"/../../etc/passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"/path/../../../etc/passwd\").is_err());\n        \n        // Backslashes\n        assert!(validate_post_auth_redirect(\"/..\\\\etc\\\\passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"\\\\..\\\\etc\\\\passwd\").is_err());\n        \n        // URL encoded\n        assert!(validate_post_auth_redirect(\"/%2e%2e/etc/passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"/%2e%2e%2f%2e%2e%2fetc/passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"/%252e%252e/etc/passwd\").is_err());\n    }\n\n    #[test]\n    fn test_control_characters() {\n        // Raw control characters\n        assert!(validate_post_auth_redirect(\"/path\\nHeader: Value\").is_err());\n        assert!(validate_post_auth_redirect(\"/path\\rHeader: Value\").is_err());\n        assert!(validate_post_auth_redirect(\"/path\\0null\").is_err());\n        \n        // URL encoded control characters\n        assert!(validate_post_auth_redirect(\"/path%0aHeader:%20Value\").is_err());\n        assert!(validate_post_auth_redirect(\"/path%0dHeader:%20Value\").is_err());\n        assert!(validate_post_auth_redirect(\"/path%00null\").is_err());\n    }\n\n    #[test]\n    fn test_unicode_tricks() {\n        // Unicode direction override\n        assert!(validate_post_auth_redirect(\"/path\\u{202E}reversed\").is_err());\n        \n        // Zero-width characters\n        assert!(validate_post_auth_redirect(\"/path\\u{200B}invisible\").is_err());\n        assert!(validate_post_auth_redirect(\"/path\\u{FEFF}bom\").is_err());\n        \n        // Various Unicode spaces\n        assert!(validate_post_auth_redirect(\"/path\\u{2000}space\").is_err());\n        assert!(validate_post_auth_redirect(\"/path\\u{3000}ideographic\").is_err());\n    }\n\n    #[test]\n    fn test_query_string_redirects() {\n        // Common redirect parameters\n        assert!(validate_post_auth_redirect(\"/page?redirect=http://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?redirect_uri=http://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?return_url=http://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?next=http://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?goto=http://evil.com\").is_err());\n        \n        // Multiple parameters\n        assert!(validate_post_auth_redirect(\"/page?safe=true\u0026redirect=http://evil.com\").is_err());\n        \n        // URL encoded equals\n        assert!(validate_post_auth_redirect(\"/page?redirect%3dhttp://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?redirect%3Dhttp://evil.com\").is_err());\n    }\n\n    #[test]\n    fn test_length_limit() {\n        let long_path = \"/\".to_string() + \u0026\"a\".repeat(2048);\n        assert!(validate_post_auth_redirect(\u0026long_path).is_err());\n        \n        let max_path = \"/\".to_string() + \u0026\"a\".repeat(2047);\n        assert!(validate_post_auth_redirect(\u0026max_path).is_ok());\n    }\n\n    #[test]\n    fn test_complex_valid_paths() {\n        // Valid complex paths that should pass\n        assert!(validate_post_auth_redirect(\"/app/user/profile/123\").is_ok());\n        assert!(validate_post_auth_redirect(\"/search?q=rust+programming\u0026page=2\").is_ok());\n        assert!(validate_post_auth_redirect(\"/docs/api/v2#authentication\").is_ok());\n        assert!(validate_post_auth_redirect(\"/files/document.pdf\").is_ok());\n        assert!(validate_post_auth_redirect(\"/user@example/profile\").is_ok());\n    }\n\n    #[test]\n    fn test_edge_cases() {\n        // Must start with /\n        assert!(validate_post_auth_redirect(\"home\").is_err());\n        assert!(validate_post_auth_redirect(\"./home\").is_err());\n        assert!(validate_post_auth_redirect(\"~/home\").is_err());\n        \n        // Various invalid patterns\n        assert!(validate_post_auth_redirect(\"/\\0\").is_err());\n        assert!(validate_post_auth_redirect(\"/\\n\").is_err());\n        assert!(validate_post_auth_redirect(\"/\\r\").is_err());\n        \n        // Just a slash is valid\n        assert!(validate_post_auth_redirect(\"/\").is_ok());\n    }\n}\n","traces":[{"line":18,"address":[3889488],"length":1,"stats":{"Line":2}},{"line":19,"address":[4065995,4066054],"length":1,"stats":{"Line":6}},{"line":22,"address":[3856650],"length":1,"stats":{"Line":4}},{"line":23,"address":[3693829],"length":1,"stats":{"Line":1}},{"line":27,"address":[3693804],"length":1,"stats":{"Line":4}},{"line":28,"address":[3693897,3696104],"length":1,"stats":{"Line":2}},{"line":29,"address":[3696063],"length":1,"stats":{"Line":1}},{"line":33,"address":[4066318,4066437],"length":1,"stats":{"Line":8}},{"line":34,"address":[3695832,3693943],"length":1,"stats":{"Line":3}},{"line":35,"address":[3858863],"length":1,"stats":{"Line":2}},{"line":39,"address":[3694021],"length":1,"stats":{"Line":3}},{"line":40,"address":[3694061,3695560],"length":1,"stats":{"Line":2}},{"line":41,"address":[4067967],"length":1,"stats":{"Line":1}},{"line":45,"address":[4066488],"length":1,"stats":{"Line":8}},{"line":46,"address":[3694128,3695288],"length":1,"stats":{"Line":2}},{"line":47,"address":[3891215],"length":1,"stats":{"Line":1}},{"line":51,"address":[4066555],"length":1,"stats":{"Line":7}},{"line":52,"address":[4066643,4067464],"length":1,"stats":{"Line":2}},{"line":53,"address":[3858047],"length":1,"stats":{"Line":1}},{"line":57,"address":[3890142],"length":1,"stats":{"Line":6}},{"line":58,"address":[3857816,3857334],"length":1,"stats":{"Line":2}},{"line":59,"address":[4067151],"length":1,"stats":{"Line":1}},{"line":63,"address":[3694241],"length":1,"stats":{"Line":5}},{"line":64,"address":[4066920,4066830],"length":1,"stats":{"Line":2}},{"line":65,"address":[3694434],"length":1,"stats":{"Line":1}},{"line":68,"address":[3694308],"length":1,"stats":{"Line":4}},{"line":72,"address":[3860646,3860640,3859440],"length":1,"stats":{"Line":4}},{"line":74,"address":[3892369],"length":1,"stats":{"Line":2}},{"line":75,"address":[3859519],"length":1,"stats":{"Line":1}},{"line":79,"address":[3859539],"length":1,"stats":{"Line":5}},{"line":86,"address":[3893077],"length":1,"stats":{"Line":6}},{"line":87,"address":[3893094,3893174],"length":1,"stats":{"Line":15}},{"line":88,"address":[3860393,3860612,3860559],"length":1,"stats":{"Line":28}},{"line":89,"address":[3860590],"length":1,"stats":{"Line":2}},{"line":94,"address":[2612640,2612730,2612688,2612854],"length":1,"stats":{"Line":36}},{"line":95,"address":[2612653,2612681],"length":1,"stats":{"Line":10}},{"line":96,"address":[3842378,3842429],"length":1,"stats":{"Line":10}},{"line":97,"address":[3842414,3842540],"length":1,"stats":{"Line":10}},{"line":99,"address":[3842557,3842577],"length":1,"stats":{"Line":10}},{"line":108,"address":[3893414],"length":1,"stats":{"Line":1}},{"line":111,"address":[3893393],"length":1,"stats":{"Line":8}},{"line":115,"address":[3697584,3698422,3698416],"length":1,"stats":{"Line":8}},{"line":117,"address":[3697617],"length":1,"stats":{"Line":8}},{"line":118,"address":[4070130],"length":1,"stats":{"Line":1}},{"line":122,"address":[3860774],"length":1,"stats":{"Line":7}},{"line":133,"address":[3894084],"length":1,"stats":{"Line":7}},{"line":134,"address":[4070581,4070661],"length":1,"stats":{"Line":8}},{"line":135,"address":[3894294,3894359],"length":1,"stats":{"Line":15}},{"line":136,"address":[4070867],"length":1,"stats":{"Line":1}},{"line":140,"address":[3894311],"length":1,"stats":{"Line":7}},{"line":144,"address":[3894432,3895250,3895256],"length":1,"stats":{"Line":3}},{"line":145,"address":[4070951],"length":1,"stats":{"Line":7}},{"line":153,"address":[3698739],"length":1,"stats":{"Line":7}},{"line":154,"address":[3698761,3698832],"length":1,"stats":{"Line":14}},{"line":155,"address":[3894933,3895215],"length":1,"stats":{"Line":14}},{"line":156,"address":[3862347],"length":1,"stats":{"Line":1}},{"line":161,"address":[4071443,4071531],"length":1,"stats":{"Line":12}},{"line":162,"address":[4071547],"length":1,"stats":{"Line":6}},{"line":163,"address":[3895037],"length":1,"stats":{"Line":0}},{"line":166,"address":[3699163],"length":1,"stats":{"Line":6}},{"line":170,"address":[3896254,3895280,3896260],"length":1,"stats":{"Line":5}},{"line":171,"address":[3862413],"length":1,"stats":{"Line":6}},{"line":177,"address":[3895600],"length":1,"stats":{"Line":6}},{"line":180,"address":[3895697,3895617],"length":1,"stats":{"Line":12}},{"line":181,"address":[3862914,3863323],"length":1,"stats":{"Line":12}},{"line":182,"address":[3863351],"length":1,"stats":{"Line":1}},{"line":187,"address":[4072310],"length":1,"stats":{"Line":5}},{"line":194,"address":[4072418],"length":1,"stats":{"Line":5}},{"line":195,"address":[3896155,3896090],"length":1,"stats":{"Line":10}},{"line":196,"address":[3863287],"length":1,"stats":{"Line":1}},{"line":200,"address":[3700103],"length":1,"stats":{"Line":5}},{"line":204,"address":[3865544,3865538,3863392],"length":1,"stats":{"Line":2}},{"line":206,"address":[3896317],"length":1,"stats":{"Line":5}},{"line":213,"address":[4073364],"length":1,"stats":{"Line":5}},{"line":216,"address":[3700978,3700895],"length":1,"stats":{"Line":10}},{"line":217,"address":[3864180,3864228],"length":1,"stats":{"Line":2}},{"line":219,"address":[3864326],"length":1,"stats":{"Line":3}},{"line":221,"address":[3701985],"length":1,"stats":{"Line":3}},{"line":222,"address":[3701345],"length":1,"stats":{"Line":2}},{"line":223,"address":[4073972,4074043],"length":1,"stats":{"Line":5}},{"line":224,"address":[3864838,3864767],"length":1,"stats":{"Line":6}},{"line":225,"address":[3864938,3865009],"length":1,"stats":{"Line":6}},{"line":228,"address":[3702188,3702121],"length":1,"stats":{"Line":6}},{"line":229,"address":[3702335,3702298],"length":1,"stats":{"Line":6}},{"line":230,"address":[3702344],"length":1,"stats":{"Line":1}},{"line":236,"address":[3897092],"length":1,"stats":{"Line":4}},{"line":240,"address":[3898464,3899183,3899211],"length":1,"stats":{"Line":1}},{"line":241,"address":[3898566,3898679,3898897,3899161,3899189,3898480],"length":1,"stats":{"Line":2}}],"covered":87,"coverable":88},{"path":["/","workspaces","vouchrs","src","utils","response_builder.rs"],"content":"// filepath: /workspaces/vouchrs/src/utils/response_builder.rs\nuse actix_web::{cookie::Cookie, web, HttpRequest, HttpResponse};\nuse reqwest;\nuse std::collections::HashMap;\nuse url;\nuse log::{debug, warn};\n\nuse crate::utils::cookie::filter_vouchrs_cookies;\n\npub struct ResponseBuilder;\n\n// Helper function to check for hop-by-hop headers\n#[must_use]\npub fn is_hop_by_hop_header(name: \u0026str) -\u003e bool {\n    matches!(\n        name,\n        \"connection\"\n            | \"keep-alive\"\n            | \"proxy-authenticate\"\n            | \"proxy-authorization\"\n            | \"te\"\n            | \"trailers\"\n            | \"transfer-encoding\"\n            | \"upgrade\"\n    )\n}\n\nimpl ResponseBuilder {\n    /// Create a redirect response with optional cookies\n    #[must_use]\n    pub fn redirect(location: \u0026str, cookies: Option\u003cVec\u003cCookie\u003e\u003e) -\u003e HttpResponse {\n        let mut builder = HttpResponse::Found();\n\n        if let Some(cookies_vec) = cookies {\n            for cookie in cookies_vec {\n                builder.cookie(cookie);\n            }\n        }\n\n        builder.append_header((\"Location\", location)).finish()\n    }\n\n    /// Create a redirect response with a single cookie\n    #[must_use]\n    pub fn redirect_with_cookie(location: \u0026str, cookie: Option\u003cCookie\u003e) -\u003e HttpResponse {\n        let cookies = cookie.map(|c| vec![c]);\n        Self::redirect(location, cookies)\n    }\n\n    /// Create an error redirect response\n    #[must_use]\n    pub fn error_redirect(location: \u0026str, error_param: \u0026str) -\u003e HttpResponse {\n        let redirect_url = if location.contains('?') {\n            format!(\"{location}\u0026error={error_param}\")\n        } else {\n            format!(\"{location}?error={error_param}\")\n        };\n\n        Self::redirect(\u0026redirect_url, None)\n    }\n\n    /// Create a success redirect response with cookie\n    #[must_use]\n    pub fn success_redirect_with_cookie(location: \u0026str, cookie: Cookie) -\u003e HttpResponse {\n        Self::redirect(location, Some(vec![cookie]))\n    }\n\n    /// Create a success redirect response with multiple cookies\n    #[must_use]\n    pub fn success_redirect_with_cookies(location: \u0026str, cookies: Vec\u003cCookie\u003e) -\u003e HttpResponse {\n        Self::redirect(location, Some(cookies))\n    }\n\n    /// Convert Actix HTTP method to reqwest method\n    /// \n    /// # Errors\n    /// \n    /// Returns an `HttpResponse` error if the HTTP method is not supported\n    pub fn convert_http_method(\n        method: \u0026actix_web::http::Method,\n    ) -\u003e Result\u003creqwest::Method, HttpResponse\u003e {\n        match method.as_str() {\n            \"GET\" =\u003e Ok(reqwest::Method::GET),\n            \"POST\" =\u003e Ok(reqwest::Method::POST),\n            \"PUT\" =\u003e Ok(reqwest::Method::PUT),\n            \"DELETE\" =\u003e Ok(reqwest::Method::DELETE),\n            \"PATCH\" =\u003e Ok(reqwest::Method::PATCH),\n            \"HEAD\" =\u003e Ok(reqwest::Method::HEAD),\n            \"OPTIONS\" =\u003e Ok(reqwest::Method::OPTIONS),\n            method_str =\u003e Err(HttpResponse::BadRequest().json(serde_json::json!({\n                \"error\": \"bad_request\",\n                \"message\": format!(\"HTTP method '{method_str}' is not supported\")\n            }))),\n        }\n    }\n\n    /// Forward request headers (excluding Authorization, Cookie with `vouchrs_session`, and hop-by-hop headers)\n    pub fn forward_request_headers(\n        mut request_builder: reqwest::RequestBuilder,\n        req: \u0026HttpRequest,\n    ) -\u003e reqwest::RequestBuilder {\n        for (name, value) in req.headers() {\n            let name_str = name.as_str().to_lowercase();\n\n            // Skip authorization and hop-by-hop headers\n            if name_str == \"authorization\" || is_hop_by_hop_header(\u0026name_str) {\n                continue;\n            }\n\n            // Special handling for cookies\n            if name_str == \"cookie\" {\n                if let Ok(cookie_str) = value.to_str() {\n                    if let Some(filtered_cookie) = filter_vouchrs_cookies(cookie_str) {\n                        request_builder = request_builder.header(name.as_str(), filtered_cookie);\n                    }\n                }\n                continue;\n            }\n\n            // Add other headers\n            if let Ok(value_str) = value.to_str() {\n                request_builder = request_builder.header(name.as_str(), value_str);\n            }\n        }\n        request_builder\n    }\n\n    /// Forward query parameters\n    pub fn forward_query_parameters(\n        mut request_builder: reqwest::RequestBuilder,\n        query_params: \u0026web::Query\u003cHashMap\u003cString, String\u003e\u003e,\n    ) -\u003e reqwest::RequestBuilder {\n        if !query_params.is_empty() {\n            for (key, value) in query_params.iter() {\n                request_builder = request_builder.query(\u0026[(key, value)]);\n            }\n        }\n        request_builder\n    }\n\n    /// Forward request body if present\n    pub fn forward_request_body(\n        mut request_builder: reqwest::RequestBuilder,\n        body: \u0026web::Bytes,\n    ) -\u003e reqwest::RequestBuilder {\n        if !body.is_empty() {\n            request_builder = request_builder.body(body.to_vec());\n        }\n        request_builder\n    }\n\n    /// Build the upstream URL by combining base URL with request path\n    /// Simple URL construction for admin-controlled upstream URLs\n    /// No redirect protection needed since upstream URLs are controlled by admins\n    /// \n    /// # Errors\n    /// \n    /// Returns an `HttpResponse` error if:\n    /// - The base URL cannot be parsed\n    /// - The path cannot be joined with the base URL\n    pub fn build_upstream_url(base_url: \u0026str, request_path: \u0026str) -\u003e Result\u003cString, HttpResponse\u003e {\n        debug!(\"Building upstream URL - base: {base_url}, path: {request_path}\");\n        \n        // Parse base URL\n        let base = url::Url::parse(base_url)\n            .map_err(|e| {\n                warn!(\"Failed to parse base URL '{base_url}': {e}\");\n                HttpResponse::BadRequest().json(serde_json::json!({\n                    \"error\": \"bad_request\",\n                    \"message\": \"Invalid upstream URL configuration\"\n                }))\n            })?;\n\n        // Normalize the request path by removing leading slashes\n        let clean_path = request_path.trim_start_matches('/');\n        \n        // Join the path with the base URL\n        let final_url = base.join(clean_path)\n            .map_err(|e| {\n                warn!(\"Failed to join URL '{base_url}' + '{clean_path}': {e}\");\n                HttpResponse::BadRequest().json(serde_json::json!({\n                    \"error\": \"bad_request\", \n                    \"message\": \"Invalid request path\"\n                }))\n            })?;\n            \n        debug!(\"Successfully built upstream URL: {final_url}\");\n        Ok(final_url.to_string())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::ResponseBuilder;\n\n    /// Test that legitimate upstream URLs still work with simplified `build_upstream_url`\n    #[test]\n    fn test_upstream_url_building() {\n        let base_url = \"https://api.example.com\";\n        \n        let legitimate_paths = vec![\n            \"/api/v1/users\",\n            \"/users/123\",\n            \"/api/data.json\",\n            \"/path/to/resource\",\n            \"/search?q=test\",\n            \"/uploads/file.pdf\",\n        ];\n\n        for path in legitimate_paths {\n            let result = ResponseBuilder::build_upstream_url(base_url, path);\n            assert!(result.is_ok(), \"Legitimate upstream path should work: {path}\");\n            let url = result.unwrap();\n            assert!(url.starts_with(base_url), \"URL should start with base URL: {url}\");\n        }\n    }\n}\n\n\n","traces":[{"line":14,"address":[3444144],"length":1,"stats":{"Line":1}},{"line":15,"address":[3673932],"length":1,"stats":{"Line":1}},{"line":31,"address":[3674144,3674893,3674771],"length":1,"stats":{"Line":0}},{"line":32,"address":[3749120],"length":1,"stats":{"Line":0}},{"line":34,"address":[3674295],"length":1,"stats":{"Line":0}},{"line":35,"address":[3444804,3444651,3444939],"length":1,"stats":{"Line":0}},{"line":36,"address":[3233080,3233114],"length":1,"stats":{"Line":0}},{"line":40,"address":[3749715,3749328],"length":1,"stats":{"Line":0}},{"line":45,"address":[3233280],"length":1,"stats":{"Line":0}},{"line":46,"address":[3445263],"length":1,"stats":{"Line":0}},{"line":47,"address":[3749929],"length":1,"stats":{"Line":0}},{"line":52,"address":[3675561,3675024,3675567],"length":1,"stats":{"Line":0}},{"line":53,"address":[3675061],"length":1,"stats":{"Line":0}},{"line":54,"address":[3233618],"length":1,"stats":{"Line":0}},{"line":56,"address":[3233442],"length":1,"stats":{"Line":0}},{"line":59,"address":[3233782,3233862],"length":1,"stats":{"Line":0}},{"line":64,"address":[3675924,3675584,3675952],"length":1,"stats":{"Line":0}},{"line":65,"address":[3675631,3675714],"length":1,"stats":{"Line":0}},{"line":70,"address":[3675968],"length":1,"stats":{"Line":0}},{"line":71,"address":[3446278],"length":1,"stats":{"Line":0}},{"line":79,"address":[3236012,3234384,3235984],"length":1,"stats":{"Line":0}},{"line":82,"address":[3234420],"length":1,"stats":{"Line":0}},{"line":83,"address":[3234516,3234457],"length":1,"stats":{"Line":0}},{"line":84,"address":[3234488,3234599],"length":1,"stats":{"Line":0}},{"line":85,"address":[3751163,3751274],"length":1,"stats":{"Line":0}},{"line":86,"address":[3446606,3446717],"length":1,"stats":{"Line":0}},{"line":87,"address":[3676401,3676512],"length":1,"stats":{"Line":0}},{"line":88,"address":[3751523,3751412],"length":1,"stats":{"Line":0}},{"line":89,"address":[3676567,3676697],"length":1,"stats":{"Line":0}},{"line":90,"address":[3752187,3752605,3752043,3751714,3752577,3751578,3751827,3752214],"length":1,"stats":{"Line":0}},{"line":92,"address":[3235419,3235487],"length":1,"stats":{"Line":0}},{"line":98,"address":[3677712,3678787,3679399],"length":1,"stats":{"Line":1}},{"line":102,"address":[3677770,3677890],"length":1,"stats":{"Line":2}},{"line":103,"address":[3236475,3236386],"length":1,"stats":{"Line":2}},{"line":106,"address":[3236494,3236568,3236631],"length":1,"stats":{"Line":3}},{"line":111,"address":[3678336],"length":1,"stats":{"Line":1}},{"line":112,"address":[3753337,3753731,3754303],"length":1,"stats":{"Line":3}},{"line":113,"address":[3449174,3449584],"length":1,"stats":{"Line":2}},{"line":114,"address":[3237616,3237416,3237310],"length":1,"stats":{"Line":1}},{"line":121,"address":[3236696,3237068,3236759,3236836],"length":1,"stats":{"Line":0}},{"line":122,"address":[3236878,3237073],"length":1,"stats":{"Line":0}},{"line":125,"address":[3753033],"length":1,"stats":{"Line":1}},{"line":129,"address":[3680012,3679983,3679440],"length":1,"stats":{"Line":0}},{"line":133,"address":[3679483,3679561],"length":1,"stats":{"Line":0}},{"line":134,"address":[3754581,3754519,3754906],"length":1,"stats":{"Line":0}},{"line":135,"address":[3679855],"length":1,"stats":{"Line":0}},{"line":138,"address":[3754545],"length":1,"stats":{"Line":0}},{"line":142,"address":[3450320,3450728],"length":1,"stats":{"Line":0}},{"line":146,"address":[3755003,3755083,3755341],"length":1,"stats":{"Line":0}},{"line":147,"address":[3755195,3755094,3755346],"length":1,"stats":{"Line":0}},{"line":149,"address":[3755164],"length":1,"stats":{"Line":0}},{"line":161,"address":[3757179,3755408,3757157],"length":1,"stats":{"Line":1}},{"line":162,"address":[3680517,3680657],"length":1,"stats":{"Line":2}},{"line":165,"address":[3755476,3755883],"length":1,"stats":{"Line":1}},{"line":166,"address":[3725579,3725551,3724512],"length":1,"stats":{"Line":0}},{"line":167,"address":[3724622,3724540],"length":1,"stats":{"Line":0}},{"line":168,"address":[3555350,3555961,3555019,3555463,3555681,3555989],"length":1,"stats":{"Line":0}},{"line":175,"address":[3681263,3681173],"length":1,"stats":{"Line":2}},{"line":178,"address":[3681534,3681279],"length":1,"stats":{"Line":1}},{"line":179,"address":[2511692,2510592,2511664],"length":1,"stats":{"Line":0}},{"line":180,"address":[2878768,2878850],"length":1,"stats":{"Line":0}},{"line":181,"address":[3726699,3725679,3726174,3726671,3726061,3726392],"length":1,"stats":{"Line":0}},{"line":187,"address":[3681845,3681755,3681881],"length":1,"stats":{"Line":3}},{"line":188,"address":[3681851,3682152],"length":1,"stats":{"Line":2}}],"covered":18,"coverable":64},{"path":["/","workspaces","vouchrs","src","utils","test_helpers.rs"],"content":"// Test utilities shared across modules\nuse crate::models::VouchrsSession;\nuse crate::settings::{ApplicationSettings, SessionSettings, ProxySettings, VouchrsSettings};\nuse chrono::{Duration, Utc};\n\n/// Create a test session for use in unit tests\n#[must_use]\npub fn create_test_session() -\u003e VouchrsSession {\n    VouchrsSession {\n        id_token: Some(\"test_id_token\".to_string()),\n        refresh_token: Some(\"test_refresh_token\".to_string()),\n        provider: \"google\".to_string(),\n        expires_at: Utc::now() + Duration::hours(1),\n    }\n}\n\n/// Create test settings for use in unit tests\n#[must_use]\npub fn create_test_settings() -\u003e VouchrsSettings {\n    VouchrsSettings {\n        application: ApplicationSettings {\n            host: \"0.0.0.0\".to_string(),\n            port: 8080,\n            redirect_base_url: \"http://localhost:8080\".to_string(),\n            cors_origins: \"http://localhost:3000\".to_string(),\n        },\n        proxy: ProxySettings {\n            upstream_url: \"http://localhost:3000\".to_string(),\n        },\n        session: SessionSettings {\n            session_duration_hours: 24,\n            session_secret: \"test-secret-key\".to_string(),\n        },\n        ..Default::default()\n    }\n}\n","traces":[{"line":8,"address":[3358271,3358277,3357792],"length":1,"stats":{"Line":7}},{"line":10,"address":[3357809],"length":1,"stats":{"Line":7}},{"line":11,"address":[3357930,3357865],"length":1,"stats":{"Line":14}},{"line":12,"address":[3357956],"length":1,"stats":{"Line":7}},{"line":13,"address":[3358090,3358025],"length":1,"stats":{"Line":14}},{"line":19,"address":[3359212,3358304,3359206],"length":1,"stats":{"Line":3}},{"line":21,"address":[3358494],"length":1,"stats":{"Line":3}},{"line":27,"address":[3358648],"length":1,"stats":{"Line":3}},{"line":30,"address":[3358752],"length":1,"stats":{"Line":3}}],"covered":9,"coverable":9},{"path":["/","workspaces","vouchrs","src","utils","test_request_builder.rs"],"content":"// Test request builders for common test patterns\nuse actix_web::http::header;\nuse actix_web::{test, HttpRequest};\n\npub struct TestRequestBuilder;\n\nimpl TestRequestBuilder {\n    /// Create a browser request with typical browser headers\n    #[must_use]\n    pub fn browser_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((\n                header::ACCEPT,\n                \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n            ))\n            .insert_header((\n                header::USER_AGENT,\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n            ))\n            .to_http_request()\n    }\n\n    /// Create an API request with typical API client headers\n    #[must_use]\n    pub fn api_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((header::ACCEPT, \"application/json\"))\n            .insert_header((header::USER_AGENT, \"MyApp/1.0\"))\n            .to_http_request()\n    }\n\n    /// Create a request with client hints headers\n    #[must_use]\n    pub fn client_hints_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((\n                \"sec-ch-ua\",\n                \"\\\"Google Chrome\\\";v=\\\"91\\\", \\\"Chromium\\\";v=\\\"91\\\"\",\n            ))\n            .insert_header((\"sec-ch-ua-platform\", \"\\\"Windows\\\"\"))\n            .insert_header((\"sec-ch-ua-mobile\", \"?0\"))\n            .insert_header((\"accept-language\", \"en-US,en;q=0.9,es;q=0.8\"))\n            .to_http_request()\n    }\n\n    /// Create a mobile browser request\n    #[must_use]\n    pub fn mobile_browser_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((\n                header::ACCEPT,\n                \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n            ))\n            .insert_header((\n                header::USER_AGENT,\n                \"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15\",\n            ))\n            .insert_header((\"sec-ch-ua-mobile\", \"?1\"))\n            .to_http_request()\n    }\n\n    /// Create a request with specific User-Agent for platform testing\n    #[must_use]\n    pub fn user_agent_request(user_agent: \u0026str) -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((header::USER_AGENT, user_agent))\n            .to_http_request()\n    }\n\n    /// Create an empty request with no headers\n    #[must_use]\n    pub fn empty_request() -\u003e HttpRequest {\n        test::TestRequest::default().to_http_request()\n    }\n\n    /// Create a request with macOS User-Agent and French language\n    #[must_use]\n    pub fn macos_french_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((\n                header::USER_AGENT,\n                \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\",\n            ))\n            .insert_header((\"accept-language\", \"fr-FR,fr;q=0.9\"))\n            .to_http_request()\n    }\n\n    /// Create a request with specific cookie header\n    #[must_use]\n    pub fn with_cookies(cookies: \u0026str) -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((header::COOKIE, cookies))\n            .to_http_request()\n    }\n}\n","traces":[{"line":10,"address":[3127520],"length":1,"stats":{"Line":2}},{"line":11,"address":[3127527,3127744,3127628],"length":1,"stats":{"Line":6}},{"line":12,"address":[3127541],"length":1,"stats":{"Line":2}},{"line":16,"address":[3127657],"length":1,"stats":{"Line":2}},{"line":25,"address":[3127792],"length":1,"stats":{"Line":1}},{"line":26,"address":[3128016,3127799,3127900],"length":1,"stats":{"Line":5}},{"line":27,"address":[3127813],"length":1,"stats":{"Line":1}},{"line":28,"address":[3127929],"length":1,"stats":{"Line":2}},{"line":34,"address":[3128064],"length":1,"stats":{"Line":1}},{"line":35,"address":[3128151,3128234,3128083,3128317,3128400],"length":1,"stats":{"Line":5}},{"line":36,"address":[3128097],"length":1,"stats":{"Line":1}},{"line":40,"address":[3128180],"length":1,"stats":{"Line":1}},{"line":41,"address":[3128263],"length":1,"stats":{"Line":1}},{"line":42,"address":[3128346],"length":1,"stats":{"Line":1}},{"line":48,"address":[3128448],"length":1,"stats":{"Line":0}},{"line":49,"address":[3128672,3128455,3128755,3128556],"length":1,"stats":{"Line":0}},{"line":50,"address":[3128469],"length":1,"stats":{"Line":0}},{"line":54,"address":[3128585],"length":1,"stats":{"Line":0}},{"line":58,"address":[3128701],"length":1,"stats":{"Line":0}},{"line":64,"address":[3128800],"length":1,"stats":{"Line":1}},{"line":65,"address":[3128933,3128833],"length":1,"stats":{"Line":2}},{"line":66,"address":[3128857],"length":1,"stats":{"Line":1}},{"line":72,"address":[3128992],"length":1,"stats":{"Line":2}},{"line":73,"address":[3128999],"length":1,"stats":{"Line":1}},{"line":78,"address":[3129040],"length":1,"stats":{"Line":1}},{"line":79,"address":[3129047,3129148,3129231],"length":1,"stats":{"Line":4}},{"line":80,"address":[3129061],"length":1,"stats":{"Line":2}},{"line":84,"address":[3129177],"length":1,"stats":{"Line":2}},{"line":90,"address":[3129280],"length":1,"stats":{"Line":1}},{"line":91,"address":[3129413,3129313],"length":1,"stats":{"Line":2}},{"line":92,"address":[3129337],"length":1,"stats":{"Line":1}}],"covered":26,"coverable":31},{"path":["/","workspaces","vouchrs","src","utils","user_agent.rs"],"content":"// User agent extraction and platform detection utilities\nuse actix_web::HttpRequest;\n\n/// User agent information extracted from HTTP headers\n#[derive(Debug, Clone)]\npub struct UserAgentInfo {\n    pub user_agent: Option\u003cString\u003e,\n    pub platform: Option\u003cString\u003e,\n    pub lang: Option\u003cString\u003e,\n    pub mobile: u8, // 0 or 1\n}\n\n/// Extract user agent information from HTTP request headers\n/// Uses modern client hints headers first, with fallback to traditional User-Agent header\n#[must_use]\npub fn extract_user_agent_info(req: \u0026HttpRequest) -\u003e UserAgentInfo {\n    let headers = req.headers();\n\n    // Try to get user agent from modern client hints or fallback to User-Agent header\n    let user_agent = headers\n        .get(\"sec-ch-ua\")\n        .and_then(|h| h.to_str().ok())\n        .map(ToString::to_string)\n        .or_else(|| {\n            headers\n                .get(\"user-agent\")\n                .and_then(|h| h.to_str().ok())\n                .map(ToString::to_string)\n        });\n\n    // Try to get platform from client hints or derive from User-Agent\n    let platform = headers\n        .get(\"sec-ch-ua-platform\")\n        .and_then(|h| h.to_str().ok())\n        .map(|s| s.trim_matches('\"').to_string())\n        .or_else(|| {\n            user_agent.as_ref().map_or_else(|| Some(\"Unknown\".to_string()), |ua| Some(derive_platform_from_user_agent(ua)))\n        });\n\n    // Extract language preference from Accept-Language header\n    let lang = headers\n        .get(\"accept-language\")\n        .and_then(|h| h.to_str().ok())\n        .map(|s| s.split(',').next().unwrap_or(\"\").trim().to_string())\n        .filter(|s| !s.is_empty());\n\n    // Detect mobile from client hints\n    let mobile = headers\n        .get(\"sec-ch-ua-mobile\")\n        .and_then(|h| h.to_str().ok())\n        .map_or(0, |s| u8::from(s.contains('1')));\n\n    UserAgentInfo {\n        user_agent,\n        platform,\n        lang,\n        mobile,\n    }\n}\n\n/// Derive platform from User-Agent string\n/// Detects common platforms like Windows, macOS, Linux, Android, iOS, Chrome OS\n#[must_use]\npub fn derive_platform_from_user_agent(user_agent: \u0026str) -\u003e String {\n    let ua_lower = user_agent.to_lowercase();\n\n    if ua_lower.contains(\"android\") {\n        \"Android\".to_string()\n    } else if ua_lower.contains(\"iphone\") || ua_lower.contains(\"ipad\") || ua_lower.contains(\"ios\") {\n        \"iOS\".to_string()\n    } else if ua_lower.contains(\"chrome os\") || ua_lower.contains(\"cros\") {\n        \"Chrome OS\".to_string()\n    } else if ua_lower.contains(\"windows\") {\n        \"Windows\".to_string()\n    } else if ua_lower.contains(\"macintosh\") || ua_lower.contains(\"mac os\") {\n        \"macOS\".to_string()\n    } else if ua_lower.contains(\"linux\") {\n        \"Linux\".to_string()\n    } else {\n        \"Unknown\".to_string()\n    }\n}\n\n/// Determine if a request came from a browser vs an API client\n/// Browsers typically send Accept headers that include text/html\n#[must_use]\npub fn is_browser_request(req: \u0026HttpRequest) -\u003e bool {\n    if let Some(accept_header) = req.headers().get(\"accept\") {\n        if let Ok(accept_str) = accept_header.to_str() {\n            // Browser requests typically accept text/html\n            return accept_str.contains(\"text/html\")\n                || accept_str.contains(\"application/xhtml+xml\");\n        }\n    }\n\n    // Fallback: check User-Agent for common browser patterns\n    if let Some(user_agent) = req.headers().get(\"user-agent\") {\n        if let Ok(ua_str) = user_agent.to_str() {\n            let ua_lower = ua_str.to_lowercase();\n            return ua_lower.contains(\"mozilla\")\n                || ua_lower.contains(\"chrome\")\n                || ua_lower.contains(\"safari\")\n                || ua_lower.contains(\"firefox\")\n                || ua_lower.contains(\"edge\");\n        }\n    }\n\n    false\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::test_request_builder::TestRequestBuilder;\n\n    #[test]\n    fn test_user_agent_extraction() {\n        // Test with modern client hints headers\n        let req = TestRequestBuilder::client_hints_request();\n\n        let user_agent_info = extract_user_agent_info(\u0026req);\n\n        assert_eq!(\n            user_agent_info.user_agent,\n            Some(\"\\\"Google Chrome\\\";v=\\\"91\\\", \\\"Chromium\\\";v=\\\"91\\\"\".to_string())\n        );\n        assert_eq!(user_agent_info.platform, Some(\"Windows\".to_string()));\n        assert_eq!(user_agent_info.lang, Some(\"en-US\".to_string()));\n        assert_eq!(user_agent_info.mobile, 0);\n\n        // Test with fallback to User-Agent header\n        let req = TestRequestBuilder::macos_french_request();\n\n        let user_agent_info = extract_user_agent_info(\u0026req);\n\n        assert_eq!(\n            user_agent_info.user_agent,\n            Some(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\".to_string())\n        );\n        assert_eq!(user_agent_info.platform, Some(\"macOS\".to_string())); // Derived from User-Agent\n        assert_eq!(user_agent_info.lang, Some(\"fr-FR\".to_string()));\n        assert_eq!(user_agent_info.mobile, 0); // Default when not specified\n    }\n\n    #[test]\n    fn test_platform_derivation_from_user_agent() {\n        // Test Windows detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Windows NT 10.0; Win64; x64)\"),\n            \"Windows\"\n        );\n\n        // Test macOS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)\"),\n            \"macOS\"\n        );\n\n        // Test Linux detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (X11; Linux x86_64)\"),\n            \"Linux\"\n        );\n\n        // Test Android detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Linux; Android 11; SM-G991B)\"),\n            \"Android\"\n        );\n\n        // Test iOS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\n                \"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)\"\n            ),\n            \"iOS\"\n        );\n\n        // Test Chrome OS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (X11; CrOS x86_64 14541.0.0)\"),\n            \"Chrome OS\"\n        );\n\n        // Test unknown platform - now returns \"Unknown\" instead of None\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Unknown Platform)\"),\n            \"Unknown\"\n        );\n    }\n\n    #[test]\n    fn test_is_browser_request() {\n        // Test browser detection with Accept: text/html\n        let browser_req = TestRequestBuilder::browser_request();\n        assert!(is_browser_request(\u0026browser_req));\n\n        // Test API client detection with Accept: application/json\n        let api_req = TestRequestBuilder::api_request();\n        assert!(!is_browser_request(\u0026api_req));\n\n        // Test with a user agent only request\n        let browser_ua_req = TestRequestBuilder::user_agent_request(\n            \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n        );\n        assert!(is_browser_request(\u0026browser_ua_req));\n\n        // Test API client via User-Agent\n        let api_ua_req = TestRequestBuilder::user_agent_request(\"curl/7.68.0\");\n        assert!(!is_browser_request(\u0026api_ua_req));\n\n        // Test unknown client (no Accept or User-Agent)\n        let unknown_req = TestRequestBuilder::empty_request();\n        assert!(!is_browser_request(\u0026unknown_req));\n    }\n}\n","traces":[{"line":16,"address":[3313120,3313957,3313963],"length":1,"stats":{"Line":1}},{"line":17,"address":[3788678],"length":1,"stats":{"Line":1}},{"line":20,"address":[3788707],"length":1,"stats":{"Line":1}},{"line":22,"address":[3362272,3362281],"length":1,"stats":{"Line":2}},{"line":24,"address":[3362320],"length":1,"stats":{"Line":2}},{"line":25,"address":[3362338],"length":1,"stats":{"Line":1}},{"line":27,"address":[3362409,3362400],"length":1,"stats":{"Line":4}},{"line":32,"address":[3819379,3819303],"length":1,"stats":{"Line":2}},{"line":34,"address":[3362448,3362457],"length":1,"stats":{"Line":2}},{"line":35,"address":[3843472,3843424],"length":1,"stats":{"Line":2}},{"line":36,"address":[3843520],"length":1,"stats":{"Line":1}},{"line":37,"address":[4082112,4082000,4082080,4081954,4082014],"length":1,"stats":{"Line":6}},{"line":41,"address":[3789050,3788973],"length":1,"stats":{"Line":2}},{"line":43,"address":[3362832,3362841],"length":1,"stats":{"Line":2}},{"line":44,"address":[3105904,3105928],"length":1,"stats":{"Line":2}},{"line":45,"address":[3106016,3106025],"length":1,"stats":{"Line":2}},{"line":48,"address":[3819628,3819705],"length":1,"stats":{"Line":2}},{"line":50,"address":[3363024,3363033],"length":1,"stats":{"Line":2}},{"line":51,"address":[3363086,3363072],"length":1,"stats":{"Line":2}},{"line":64,"address":[3313984,3315182,3315188],"length":1,"stats":{"Line":1}},{"line":65,"address":[3820103],"length":1,"stats":{"Line":1}},{"line":67,"address":[3789723,3789640],"length":1,"stats":{"Line":2}},{"line":68,"address":[3821260,3820301],"length":1,"stats":{"Line":2}},{"line":69,"address":[3314387,3314190,3314263],"length":1,"stats":{"Line":3}},{"line":70,"address":[3820425,3821258],"length":1,"stats":{"Line":2}},{"line":71,"address":[3842916,3843067],"length":1,"stats":{"Line":2}},{"line":72,"address":[3821256,3820727],"length":1,"stats":{"Line":2}},{"line":73,"address":[3314728],"length":1,"stats":{"Line":1}},{"line":74,"address":[3790409,3790758],"length":1,"stats":{"Line":2}},{"line":75,"address":[3790551,3790384,3790445],"length":1,"stats":{"Line":3}},{"line":76,"address":[3821252,3821011],"length":1,"stats":{"Line":2}},{"line":77,"address":[3821092],"length":1,"stats":{"Line":1}},{"line":78,"address":[3843499,3843554],"length":1,"stats":{"Line":2}},{"line":80,"address":[3315084,3315138],"length":1,"stats":{"Line":2}},{"line":87,"address":[3790800,3791768,3791762],"length":1,"stats":{"Line":1}},{"line":88,"address":[3790823],"length":1,"stats":{"Line":1}},{"line":89,"address":[3315319,3315453],"length":1,"stats":{"Line":2}},{"line":91,"address":[3821583,3821650],"length":1,"stats":{"Line":2}},{"line":92,"address":[3315539],"length":1,"stats":{"Line":2}},{"line":97,"address":[3791179,3790965],"length":1,"stats":{"Line":2}},{"line":98,"address":[3791258,3791195],"length":1,"stats":{"Line":2}},{"line":99,"address":[3791290],"length":1,"stats":{"Line":1}},{"line":100,"address":[3844256,3844117,3844194],"length":1,"stats":{"Line":3}},{"line":101,"address":[3821935,3821975],"length":1,"stats":{"Line":2}},{"line":102,"address":[3791524],"length":1,"stats":{"Line":2}},{"line":103,"address":[3791600],"length":1,"stats":{"Line":2}},{"line":104,"address":[3791676],"length":1,"stats":{"Line":2}},{"line":108,"address":[3791248],"length":1,"stats":{"Line":2}}],"covered":48,"coverable":48},{"path":["/","workspaces","vouchrs","tests","apple_jwt_integration_test.rs"],"content":"// Integration test for Apple JWT functions using the refactored crypto module\nuse std::fs;\nuse std::path::Path;\nuse vouchrs::settings::JwtSigningConfig;\nuse vouchrs::utils::apple::generate_jwt_client_secret;\nuse vouchrs::utils::crypto::decode_jwt_payload;\n\n// Helper function to create a test JWT signing config\nfn create_test_jwt_config() -\u003e JwtSigningConfig {\n    create_test_jwt_config_with_path(\"/tmp/test_apple_key.p8\")\n}\n\n// Helper function to create a test JWT signing config with custom path\nfn create_test_jwt_config_with_path(path: \u0026str) -\u003e JwtSigningConfig {\n    // Create a temporary test key file\n    let test_key = r\"-----BEGIN PRIVATE KEY-----\nMIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgpQUGzV2mpXNdjHnV\n9QFCar9R+eojTjLOXCisVV9xfvehRANCAATyHpTDz7xyWXHaC0FXYlwK5r4IpeHx\n1X4WXDZiAKUxHblBs1Kn15IR334KNiNP7gEWM+9BFuWh9uJwHGOBJXc/\n-----END PRIVATE KEY-----\";\n\n    fs::write(path, test_key).expect(\"Failed to write test key file\");\n\n    JwtSigningConfig {\n        team_id: Some(\"TEST123456\".to_string()),\n        key_id: Some(\"TEST789XYZ\".to_string()),\n        private_key_path: Some(path.to_string()),\n        team_id_env: None,\n        key_id_env: None,\n        private_key_path_env: None,\n    }\n}\n\n#[test]\nfn test_apple_jwt_creation_with_crypto_module() {\n    let jwt_config = create_test_jwt_config();\n    let client_id = \"com.example.testapp\";\n\n    // Generate Apple JWT using the refactored function\n    let result = generate_jwt_client_secret(\u0026jwt_config, client_id);\n    \n    match \u0026result {\n        Ok(_) =\u003e println!(\"âœ… Apple JWT generation succeeded\"),\n        Err(e) =\u003e println!(\"âŒ Apple JWT generation failed: {e}\"),\n    }\n    \n    assert!(result.is_ok(), \"Apple JWT generation should succeed: {:?}\", result.as_ref().err());\n    let jwt = result.unwrap();\n    \n    // Verify JWT format (should have 3 parts separated by dots)\n    let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n    assert_eq!(parts.len(), 3, \"JWT should have header.payload.signature format\");\n    \n    // Decode and verify header\n    let header_result = decode_jwt_payload(\u0026format!(\"{}.{}.dummy\", parts[0], parts[1]));\n    assert!(header_result.is_ok(), \"Should be able to decode JWT payload\");\n    \n    let payload = header_result.unwrap();\n    \n    // Verify Apple-specific claims\n    assert_eq!(payload[\"iss\"], \"TEST123456\", \"Issuer should be team ID\");\n    assert_eq!(payload[\"sub\"], client_id, \"Subject should be client ID\");\n    assert_eq!(payload[\"aud\"], \"https://appleid.apple.com\", \"Audience should be Apple ID\");\n    \n    // Verify timestamps are present and reasonable\n    assert!(payload[\"iat\"].is_number(), \"Issued at timestamp should be present\");\n    assert!(payload[\"exp\"].is_number(), \"Expiration timestamp should be present\");\n    \n    let iat = payload[\"iat\"].as_i64().unwrap();\n    let exp = payload[\"exp\"].as_i64().unwrap();\n    \n    // Token should expire 5 minutes (300 seconds) from issue time\n    assert_eq!(exp - iat, 300, \"Token should expire in 5 minutes\");\n    \n    // Verify signature is present and not empty\n    assert!(!parts[2].is_empty(), \"Signature should not be empty\");\n    \n    // Clean up test file\n    if Path::new(\"/tmp/test_apple_key.p8\").exists() {\n        fs::remove_file(\"/tmp/test_apple_key.p8\").unwrap();\n    }\n    \n    println!(\"âœ… Apple JWT integration test passed\");\n    println!(\"Generated JWT: {jwt}\");\n}\n\n#[test]\nfn test_apple_jwt_missing_config() {\n    let incomplete_config = JwtSigningConfig {\n        team_id: None, // Missing team ID\n        key_id: Some(\"TEST789XYZ\".to_string()),\n        private_key_path: Some(\"/tmp/nonexistent.p8\".to_string()),\n        team_id_env: None,\n        key_id_env: None,\n        private_key_path_env: None,\n    };\n    \n    let result = generate_jwt_client_secret(\u0026incomplete_config, \"com.example.test\");\n    \n    assert!(result.is_err(), \"Should fail with missing team ID\");\n    assert!(result.unwrap_err().contains(\"Team ID not configured\"));\n}\n\n#[test]\nfn test_apple_jwt_invalid_key_file() {\n    let invalid_config = JwtSigningConfig {\n        team_id: Some(\"TEST123456\".to_string()),\n        key_id: Some(\"TEST789XYZ\".to_string()),\n        private_key_path: Some(\"/tmp/nonexistent_key.p8\".to_string()),\n        team_id_env: None,\n        key_id_env: None,\n        private_key_path_env: None,\n    };\n    \n    let result = generate_jwt_client_secret(\u0026invalid_config, \"com.example.test\");\n    \n    assert!(result.is_err(), \"Should fail with missing key file\");\n    assert!(result.unwrap_err().contains(\"Failed to read Apple private key file\"));\n}\n\n#[test]\nfn test_apple_jwt_deterministic_with_same_input() {\n    let test_key_path = \"/tmp/test_apple_key_deterministic.p8\";\n    let jwt_config = create_test_jwt_config_with_path(test_key_path);\n    let client_id = \"com.example.testapp\";\n\n    // Generate two JWTs with the same parameters\n    let jwt1 = generate_jwt_client_secret(\u0026jwt_config, client_id).unwrap();\n    \n    // Wait a moment to ensure different timestamps\n    std::thread::sleep(std::time::Duration::from_millis(1001));\n    \n    let jwt2 = generate_jwt_client_secret(\u0026jwt_config, client_id).unwrap();\n    \n    // JWTs should be different due to different timestamps\n    assert_ne!(jwt1, jwt2, \"JWTs should differ due to different timestamps\");\n    \n    // But they should have the same structure\n    let parts1: Vec\u003c\u0026str\u003e = jwt1.split('.').collect();\n    let parts2: Vec\u003c\u0026str\u003e = jwt2.split('.').collect();\n    \n    // Headers should be identical (same algorithm and key ID)\n    assert_eq!(parts1[0], parts2[0], \"Headers should be identical\");\n    \n    // Payloads should differ only in timestamps\n    let payload1 = decode_jwt_payload(\u0026format!(\"{}.{}.dummy\", parts1[0], parts1[1])).unwrap();\n    let payload2 = decode_jwt_payload(\u0026format!(\"{}.{}.dummy\", parts2[0], parts2[1])).unwrap();\n    \n    assert_eq!(payload1[\"iss\"], payload2[\"iss\"], \"Issuers should match\");\n    assert_eq!(payload1[\"sub\"], payload2[\"sub\"], \"Subjects should match\");\n    assert_eq!(payload1[\"aud\"], payload2[\"aud\"], \"Audiences should match\");\n    \n    // Timestamps should be different\n    assert_ne!(payload1[\"iat\"], payload2[\"iat\"], \"Issue times should differ\");\n    assert_ne!(payload1[\"exp\"], payload2[\"exp\"], \"Expiry times should differ\");\n    \n    // Clean up test file\n    if Path::new(test_key_path).exists() {\n        fs::remove_file(test_key_path).unwrap();\n    }\n    \n    println!(\"âœ… Apple JWT deterministic test passed\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","tests","integration_test.rs"],"content":"// Integration test for JWT settings and user cookie functionality\nuse vouchrs::models::VouchrsUserData;\nuse vouchrs::session::SessionManager;\nuse vouchrs::utils::test_helpers::{create_test_session, create_test_settings};\nuse vouchrs::utils::user_agent::UserAgentInfo;\n\n/// Helper function to create test user data with optional context\nfn create_test_user_data(\n    email: \u0026str,\n    name: Option\u003cString\u003e,\n    provider: \u0026str,\n    provider_id: \u0026str,\n    client_ip: Option\u003c\u0026str\u003e,\n    user_agent_info: Option\u003c\u0026UserAgentInfo\u003e,\n) -\u003e VouchrsUserData {\n    VouchrsUserData {\n        email: email.to_string(),\n        name,\n        provider: provider.to_string(),\n        provider_id: provider_id.to_string(),\n        client_ip: client_ip.map(std::string::ToString::to_string),\n        user_agent: user_agent_info.and_then(|ua| ua.user_agent.clone()),\n        platform: user_agent_info.and_then(|ua| ua.platform.clone()),\n        lang: user_agent_info.and_then(|ua| ua.lang.clone()),\n        mobile: user_agent_info.map_or(0, |ua| i32::from(ua.mobile)),\n        session_start: Some(chrono::Utc::now().timestamp()), // Adding session_start as Unix timestamp for test\n    }\n}\n\n#[test]\nfn test_user_cookie_contains_required_fields() {\n    // Create a session with proper provider_id set\n    let session = create_test_session();\n\n    let settings = create_test_settings();\n\n    // Create user agent info with platform\n    let user_agent_info = UserAgentInfo {\n        user_agent: Some(\n            \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\".to_string(),\n        ),\n        platform: Some(\"macOS\".to_string()),\n        lang: Some(\"en-US\".to_string()),\n        mobile: 0,\n    };\n\n    // Create user data manually since we now have separate token and user data\n    let user_data = create_test_user_data(\n        \"test@example.com\",\n        Some(\"Test User\".to_string()),\n        \u0026session.provider,\n        \"123456789\",\n        Some(\"192.168.1.1\"),\n        Some(\u0026user_agent_info),\n    );\n\n    // Verify user data contains all required fields\n    assert_eq!(\n        user_data.provider, session.provider,\n        \"Provider should match session\"\n    );\n    assert_eq!(\n        user_data.client_ip,\n        Some(\"192.168.1.1\".to_string()),\n        \"Client IP should be set\"\n    );\n    assert_eq!(\n        user_data.platform,\n        Some(\"macOS\".to_string()),\n        \"Platform should be extracted from user agent\"\n    );\n    assert_eq!(\n        user_data.lang,\n        Some(\"en-US\".to_string()),\n        \"Language should be set\"\n    );\n    assert_eq!(user_data.mobile, 0, \"Mobile flag should be set\");\n\n    // Test user cookie encryption/decryption\n    let session_manager = SessionManager::new(settings.session.session_secret.as_bytes(), false, settings.session.session_duration_hours);\n    let user_cookie = session_manager\n        .create_user_cookie(\u0026user_data)\n        .expect(\"Should create user cookie\");\n\n    // Verify cookie has correct properties\n    assert_eq!(user_cookie.name(), \"vouchrs_user\");\n    assert_eq!(\n        user_cookie.http_only(),\n        Some(true),\n        \"User cookie should be HTTP-only\"\n    );\n    assert_eq!(user_cookie.path(), Some(\"/\"));\n\n    // Test that we can decrypt the user data back using a mock request\n    let test_req = actix_web::test::TestRequest::default()\n        .cookie(user_cookie.clone())\n        .to_http_request();\n\n    let decrypted_data = session_manager\n        .get_user_data_from_request(\u0026test_req)\n        .expect(\"Should get user data from request\")\n        .expect(\"Should have user data\");\n\n    assert_eq!(decrypted_data.email, user_data.email);\n    assert_eq!(decrypted_data.provider, user_data.provider);\n    assert_eq!(decrypted_data.platform, user_data.platform);\n\n    println!(\"âœ… All user cookie functionality verified successfully\");\n}\n\n#[test]\nfn test_minimal_user_data() {\n    // Test creating user data with minimal information\n    let session = create_test_session();\n\n    let settings = create_test_settings();\n\n    // Create user data without user agent info or client IP\n    let user_data = create_test_user_data(\n        \"test@example.com\",\n        Some(\"Test User\".to_string()),\n        \u0026session.provider,\n        \"123456789\",\n        None,\n        None,\n    );\n\n    // Verify required fields are present\n    assert_eq!(user_data.provider, session.provider);\n    assert_eq!(\n        user_data.client_ip, None,\n        \"Client IP should be None when not provided\"\n    );\n    assert_eq!(\n        user_data.platform, None,\n        \"Platform should be None when not provided\"\n    );\n    assert_eq!(user_data.mobile, 0, \"Mobile should default to 0\");\n\n    // Test encryption/decryption with minimal data\n    let session_manager = SessionManager::new(settings.session.session_secret.as_bytes(), false, settings.session.session_duration_hours);\n    let user_cookie = session_manager\n        .create_user_cookie(\u0026user_data)\n        .expect(\"Should create user cookie\");\n\n    // Test that we can decrypt the user data back using a mock request\n    let test_req = actix_web::test::TestRequest::default()\n        .cookie(user_cookie.clone())\n        .to_http_request();\n\n    let decrypted_data = session_manager\n        .get_user_data_from_request(\u0026test_req)\n        .expect(\"Should get user data from request\")\n        .expect(\"Should have user data\");\n\n    assert_eq!(decrypted_data.email, user_data.email);\n    assert_eq!(decrypted_data.client_ip, None);\n\n    println!(\"âœ… Minimal user data test passed\");\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","workspaces","vouchrs","src","handlers","auth.rs"],"content":"// Authentication handlers: sign-in and sign-out\nuse crate::oauth::{OAuthConfig, OAuthState};\nuse crate::session::SessionManager;\nuse crate::settings::VouchrsSettings;\nuse crate::utils::crypto::generate_csrf_token;\nuse crate::utils::response_builder::ResponseBuilder;\nuse actix_web::{web, HttpRequest, HttpResponse, Result};\nuse log::{debug, error, info};\n\nuse super::static_files::get_sign_in_page;\nuse serde::Deserialize;\n#[derive(Deserialize)]\npub struct SignInQuery {\n    pub provider: Option\u003cString\u003e,\n    pub rd: Option\u003cString\u003e,\n}\n\n/// OAuth sign in handler\n/// \n/// # Errors\n/// Returns an error if provider is not found, authentication fails,\n/// or redirect URL generation fails\npub async fn oauth_sign_in(\n    query: web::Query\u003cSignInQuery\u003e,\n    _req: HttpRequest,\n    oauth_config: web::Data\u003cOAuthConfig\u003e,\n    settings: web::Data\u003cVouchrsSettings\u003e,\n    session_manager: web::Data\u003cSessionManager\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    // Clear any existing session by setting an expired cookie\n    let clear_cookie = session_manager.create_expired_cookie();\n\n    match \u0026query.provider {\n        Some(provider) if oauth_config.get_client_configured(provider) =\u003e {\n            // Generate state for CSRF protection using high-entropy crypto-secure token\n            let csrf_state = generate_csrf_token();\n\n            // Create OAuth state object\n            let oauth_state = OAuthState {\n                state: csrf_state,\n                provider: provider.clone(),\n                redirect_url: query.rd.clone(),\n            };\n\n            // ðŸ”’ SECURITY: Use encrypted state parameter to prevent tampering\n            // This prevents attackers from modifying the provider name or redirect URL\n            let actual_state = match session_manager.encrypt_data(\u0026oauth_state) {\n                Ok(encrypted_state) =\u003e {\n                    info!(\"Using encrypted state parameter for {provider} OAuth (tamper-proof)\");\n                    encrypted_state\n                }\n                Err(e) =\u003e {\n                    error!(\"Failed to encrypt OAuth state: {e}\");\n                    let clear_cookie = session_manager.create_expired_cookie();\n                    return Ok(HttpResponse::Found()\n                        .cookie(clear_cookie)\n                        .append_header((\"Location\", \"/oauth2/sign_in?error=state_encryption_failed\"))\n                        .finish());\n                }\n            };\n            let mut response_builder = HttpResponse::Found();\n            response_builder.cookie(clear_cookie);\n\n            debug!(\n                \"Generated encrypted OAuth state for provider {provider}: length = {} chars\",\n                actual_state.len()\n            );\n            debug!(\n                \"Stored OAuth state for provider: {provider}, using encrypted state parameter (tamper-proof)\"\n            );\n\n            // Get authorization URL\n            match oauth_config.get_auth_url(provider, \u0026actual_state) {\n                Ok(auth_url) =\u003e {\n                    info!(\"Redirecting to {provider} OAuth: {auth_url}\");\n                    Ok(response_builder\n                        .append_header((\"Location\", auth_url))\n                        .finish())\n                }\n                Err(e) =\u003e {\n                    error!(\"Failed to get auth URL for {provider}: {e}\");\n                    let error_clear_cookie = session_manager.create_expired_cookie();\n                    Ok(ResponseBuilder::redirect_with_cookie(\n                        \"/oauth2/sign_in?error=oauth_config\",\n                        Some(error_clear_cookie),\n                    ))\n                }\n            }\n        }\n        Some(provider) =\u003e {\n            let clear_cookie = session_manager.create_expired_cookie();\n            let error_url = format!(\n                \"/oauth2/sign_in?error=unsupported_provider\u0026provider={provider}\"\n            );\n            Ok(ResponseBuilder::redirect_with_cookie(\n                \u0026error_url,\n                Some(clear_cookie),\n            ))\n        }\n        None =\u003e {\n            // Return login page HTML\n            let clear_cookie = session_manager.create_expired_cookie();\n            Ok(HttpResponse::Ok()\n                .cookie(clear_cookie)\n                .content_type(\"text/html\")\n                .body(get_sign_in_page(\u0026settings)))\n        }\n    }\n}\n\n/// OAuth sign out handler\n/// \n/// # Errors\n/// Returns an error if session validation fails or cookie clearing fails\npub async fn oauth_sign_out(\n    req: HttpRequest,\n    oauth_config: web::Data\u003cOAuthConfig\u003e,\n    session_manager: web::Data\u003cSessionManager\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    // Get the user's provider before clearing the session\n    let provider = match session_manager.get_session_from_request(\u0026req) {\n        Ok(Some(session)) =\u003e Some(session.provider),\n        _ =\u003e None,\n    };\n\n    // Create expired cookies to clear both session and user data\n    let clear_session_cookie = session_manager.create_expired_cookie();\n    let clear_user_cookie = session_manager.create_expired_user_cookie();\n    info!(\"User signed out and both session and user data cleared\");\n\n    // If we have a provider, check if it supports sign-out URL\n    if let Some(provider_name) = provider {\n        if let Some(signout_url) = oauth_config.get_signout_url(\u0026provider_name) {\n            info!(\"Redirecting to {provider_name} sign-out: {signout_url}\");\n            return Ok(ResponseBuilder::success_redirect_with_cookies(\n                \u0026signout_url,\n                vec![clear_session_cookie, clear_user_cookie],\n            ));\n        }\n        debug!(\n            \"Provider {provider_name} does not support automatic sign-out\"\n        );\n    }\n\n    // Default: redirect to login page\n    Ok(ResponseBuilder::success_redirect_with_cookies(\n        \"/oauth2/sign_in\",\n        vec![clear_session_cookie, clear_user_cookie],\n    ))\n}\n","traces":[{"line":23,"address":[2527312],"length":1,"stats":{"Line":0}},{"line":31,"address":[2718859,2718779],"length":1,"stats":{"Line":0}},{"line":33,"address":[2718977,2718913],"length":1,"stats":{"Line":0}},{"line":34,"address":[2719615,2719017],"length":1,"stats":{"Line":0}},{"line":36,"address":[2719759],"length":1,"stats":{"Line":0}},{"line":41,"address":[2720489],"length":1,"stats":{"Line":0}},{"line":42,"address":[2720568,2720635],"length":1,"stats":{"Line":0}},{"line":47,"address":[3576358,3576437],"length":1,"stats":{"Line":0}},{"line":48,"address":[2720972],"length":1,"stats":{"Line":0}},{"line":49,"address":[3576624,3576720,3576780],"length":1,"stats":{"Line":0}},{"line":50,"address":[2721106],"length":1,"stats":{"Line":0}},{"line":52,"address":[2720908],"length":1,"stats":{"Line":0}},{"line":53,"address":[2724880,2724909,2720924],"length":1,"stats":{"Line":0}},{"line":54,"address":[2724894,2725211],"length":1,"stats":{"Line":0}},{"line":55,"address":[2725251,2725356,2725491],"length":1,"stats":{"Line":0}},{"line":56,"address":[2725308],"length":1,"stats":{"Line":0}},{"line":57,"address":[2725429],"length":1,"stats":{"Line":0}},{"line":58,"address":[2725380,2725633],"length":1,"stats":{"Line":0}},{"line":61,"address":[2721138],"length":1,"stats":{"Line":0}},{"line":62,"address":[2721491],"length":1,"stats":{"Line":0}},{"line":64,"address":[2721800],"length":1,"stats":{"Line":0}},{"line":68,"address":[2722151,2721666,2722119],"length":1,"stats":{"Line":0}},{"line":73,"address":[2722133,2722732,2722487,2722617],"length":1,"stats":{"Line":0}},{"line":74,"address":[2722833],"length":1,"stats":{"Line":0}},{"line":75,"address":[2722966,2722873,2723109],"length":1,"stats":{"Line":0}},{"line":76,"address":[2723091,2723443],"length":1,"stats":{"Line":0}},{"line":77,"address":[2722976],"length":1,"stats":{"Line":0}},{"line":80,"address":[2722753],"length":1,"stats":{"Line":0}},{"line":81,"address":[2722785,2723634,2723605],"length":1,"stats":{"Line":0}},{"line":82,"address":[2723948,2723619],"length":1,"stats":{"Line":0}},{"line":83,"address":[2724020],"length":1,"stats":{"Line":0}},{"line":85,"address":[2724013],"length":1,"stats":{"Line":0}},{"line":90,"address":[2719720],"length":1,"stats":{"Line":0}},{"line":91,"address":[2719812,2719736],"length":1,"stats":{"Line":0}},{"line":92,"address":[2719929,2719858],"length":1,"stats":{"Line":0}},{"line":95,"address":[2720240],"length":1,"stats":{"Line":0}},{"line":96,"address":[2720037],"length":1,"stats":{"Line":0}},{"line":97,"address":[2720104],"length":1,"stats":{"Line":0}},{"line":102,"address":[2719075],"length":1,"stats":{"Line":0}},{"line":103,"address":[3574797,3574688,3574876,3574996],"length":1,"stats":{"Line":0}},{"line":104,"address":[2719235],"length":1,"stats":{"Line":0}},{"line":106,"address":[3574907],"length":1,"stats":{"Line":0}},{"line":115,"address":[3797824],"length":1,"stats":{"Line":0}},{"line":121,"address":[2726181,2726101,2726303],"length":1,"stats":{"Line":0}},{"line":122,"address":[2726340,2726535],"length":1,"stats":{"Line":0}},{"line":123,"address":[2726272],"length":1,"stats":{"Line":0}},{"line":127,"address":[3582558,3582682],"length":1,"stats":{"Line":0}},{"line":128,"address":[2727033,2726961],"length":1,"stats":{"Line":0}},{"line":129,"address":[2727172,2727079,2727224],"length":1,"stats":{"Line":0}},{"line":132,"address":[3582973,3583252],"length":1,"stats":{"Line":0}},{"line":133,"address":[3583292,3583399],"length":1,"stats":{"Line":0}},{"line":134,"address":[2727872,2727909,2727754],"length":1,"stats":{"Line":0}},{"line":135,"address":[2728524],"length":1,"stats":{"Line":0}},{"line":136,"address":[2727886],"length":1,"stats":{"Line":0}},{"line":137,"address":[2728251],"length":1,"stats":{"Line":0}},{"line":140,"address":[2729007,2728933],"length":1,"stats":{"Line":0}},{"line":146,"address":[2729570],"length":1,"stats":{"Line":0}},{"line":148,"address":[2727530,2729314],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":58},{"path":["/","workspaces","vouchrs","src","handlers","callback.rs"],"content":"// OAuth callback handler\nuse crate::oauth::{OAuthCallback, OAuthConfig, OAuthState, get_state_from_callback};\nuse crate::session::SessionManager;\nuse actix_web::{web, HttpRequest, HttpResponse, Result};\nuse chrono::{DateTime, Utc};\nuse log::{debug, error};\n\nuse crate::session_builder::SessionBuilder;\nuse crate::utils::apple::{process_apple_callback, AppleUserInfo};\nuse crate::utils::logging::LoggingHelper;\nuse crate::utils::redirect_validator::validate_post_auth_redirect;\nuse crate::utils::response_builder::ResponseBuilder;\nuse crate::utils::user_agent::extract_user_agent_info;\n\n/// Parameters for session finalization\nstruct SessionFinalizeParams {\n    provider: String,\n    id_token: Option\u003cString\u003e,\n    refresh_token: Option\u003cString\u003e,\n    expires_at: DateTime\u003cUtc\u003e,\n    apple_user_info: Option\u003cAppleUserInfo\u003e,\n    redirect_url: Option\u003cString\u003e,\n}\n\n/// OAuth callback handler\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - OAuth state validation fails\n/// - Authorization code exchange fails\n/// - Session building fails\n/// - Cookie creation fails\npub async fn oauth_callback(\n    query: web::Query\u003cOAuthCallback\u003e,\n    form: Option\u003cweb::Form\u003cOAuthCallback\u003e\u003e,\n    req: HttpRequest,\n    oauth_config: web::Data\u003cOAuthConfig\u003e,\n    session_manager: web::Data\u003cSessionManager\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    // Extract callback data from either query params or form\n    let callback_data = extract_callback_data(query, form);\n    LoggingHelper::log_callback_debug(\u0026req, \u0026callback_data);\n\n    // Validate callback and extract required data\n    let (code, oauth_state) = match validate_callback(\u0026callback_data, \u0026session_manager, \u0026req) {\n        Ok(data) =\u003e data,\n        Err(response) =\u003e return Ok(response),\n    };\n\n    // Exchange code for OAuth tokens\n    let token_result = oauth_config\n        .exchange_code_for_tokens(\u0026oauth_state.provider, \u0026code)\n        .await;\n\n    let (id_token, refresh_token, expires_at, apple_user_info) = match token_result {\n        Ok(result) =\u003e result,\n        Err(e) =\u003e {\n            error!(\"Failed to exchange code for user info: {e}\");\n            let clear_cookie = session_manager.create_expired_cookie();\n            return Ok(HttpResponse::Found()\n                .cookie(clear_cookie)\n                .append_header((\"Location\", \"/oauth2/sign_in?error=auth_failed\"))\n                .finish());\n        }\n    };\n\n    LoggingHelper::log_oauth_token_response(\u0026oauth_state.provider, apple_user_info.as_ref());\n\n    // Process additional Apple user info if available\n    let processed_apple_info = process_apple_callback(\u0026callback_data, apple_user_info);\n\n    // Build and complete the session\n    let result = build_and_finalize_session(\n        \u0026req,\n        \u0026session_manager,\n        SessionFinalizeParams {\n            provider: oauth_state.provider,\n            id_token,\n            refresh_token,\n            expires_at,\n            apple_user_info: processed_apple_info,\n            redirect_url: oauth_state.redirect_url,\n        },\n    );\n\n    Ok(result)\n}\n\n/// Extract callback data from either query parameters or form submission\nfn extract_callback_data(\n    query: web::Query\u003cOAuthCallback\u003e,\n    form: Option\u003cweb::Form\u003cOAuthCallback\u003e\u003e,\n) -\u003e OAuthCallback {\n    form.map_or_else(|| {\n        debug!(\"OAuth callback received via query: {query:?}\");\n        query.into_inner()\n    }, |form_data| {\n        debug!(\"OAuth callback received via form_post: {form_data:?}\");\n        form_data.into_inner()\n    })\n}\n\n/// Validate the callback data and extract the required code and OAuth state\nfn validate_callback(\n    callback_data: \u0026OAuthCallback,\n    session_manager: \u0026SessionManager,\n    req: \u0026HttpRequest,\n) -\u003e Result\u003c(String, OAuthState), HttpResponse\u003e {\n    // Check for OAuth errors\n    if let Some(_error) = \u0026callback_data.error {\n        let clear_cookie = session_manager.create_expired_cookie();\n        return Err(HttpResponse::Found()\n            .cookie(clear_cookie)\n            .append_header((\"Location\", \"/oauth2/sign_in?error=auth_failed\"))\n            .finish());\n    }\n\n    // Get authorization code\n    let code = if let Some(code) = \u0026callback_data.code {\n        code.clone()\n    } else {\n        error!(\"No authorization code received\");\n        let clear_cookie = session_manager.create_expired_cookie();\n        return Err(HttpResponse::Found()\n            .cookie(clear_cookie)\n            .append_header((\"Location\", \"/oauth2/sign_in?error=auth_failed\"))\n            .finish());\n    };\n\n    // Get state parameter\n    let received_state = if let Some(state) = \u0026callback_data.state {\n        state.clone()\n    } else {\n        error!(\"No state parameter received\");\n        let clear_cookie = session_manager.create_expired_cookie();\n        return Err(HttpResponse::Found()\n            .cookie(clear_cookie)\n            .append_header((\"Location\", \"/oauth2/sign_in?error=oauth_state_error\"))\n            .finish());\n    };\n\n    // Parse and validate OAuth state\n    match get_state_from_callback(\u0026received_state, session_manager, req) {\n        Ok(state) =\u003e {\n            debug!(\"OAuth state verified for provider: {}\", state.provider);\n            Ok((code, state))\n        }\n        Err(e) =\u003e {\n            error!(\"Failed to parse OAuth state: {e}\");\n            let clear_cookie = session_manager.create_expired_cookie();\n            Err(HttpResponse::Found()\n                .cookie(clear_cookie)\n                .append_header((\"Location\", \"/oauth2/sign_in?error=oauth_state_error\"))\n                .finish())\n        }\n    }\n}\n\n// Function moved to utils/apple_utils.rs\n\n/// Build session and finalize the authentication process\nfn build_and_finalize_session(\n    req: \u0026HttpRequest,\n    session_manager: \u0026SessionManager,\n    params: SessionFinalizeParams,\n) -\u003e HttpResponse {\n    // Extract client info\n    let client_ip = req\n        .connection_info()\n        .realip_remote_addr()\n        .map(std::string::ToString::to_string);\n    let user_agent_info = extract_user_agent_info(req);\n\n    // Build the session (without access token)\n    let session_result = SessionBuilder::build_session_with_apple_info(\n        params.provider.clone(),\n        params.id_token,\n        params.refresh_token,\n        params.expires_at,\n        params.apple_user_info,\n    );\n\n    match session_result {\n        Ok(complete_session) =\u003e {\n            LoggingHelper::log_session_created(\u0026complete_session.user_email, \u0026params.provider);\n\n            // Split complete session into token data and user data\n            let session = complete_session.to_session();\n            let user_data =\n                complete_session.to_user_data(client_ip.as_deref(), Some(\u0026user_agent_info));\n\n            // Create both session and user cookies\n            let session_cookie = match session_manager.create_session_cookie(\u0026session) {\n                Ok(cookie) =\u003e cookie,\n                Err(e) =\u003e {\n                    error!(\"Failed to create session cookie: {e}\");\n                    let clear_cookie = session_manager.create_expired_cookie();\n                    return HttpResponse::Found()\n                        .cookie(clear_cookie)\n                        .append_header((\"Location\", \"/oauth2/sign_in?error=session_build_error\"))\n                        .finish();\n                }\n            };\n\n            let user_cookie = match session_manager.create_user_cookie(\u0026user_data) {\n                Ok(cookie) =\u003e cookie,\n                Err(e) =\u003e {\n                    error!(\"Failed to create user cookie: {e}\");\n                    let clear_cookie = session_manager.create_expired_cookie();\n                    return HttpResponse::Found()\n                        .cookie(clear_cookie)\n                        .append_header((\"Location\", \"/oauth2/sign_in?error=session_build_error\"))\n                        .finish();\n                }\n            };\n\n            let clear_temp_cookie = session_manager.create_expired_temp_state_cookie();\n            let redirect_to = params.redirect_url.unwrap_or_else(|| \"/\".to_string());\n\n            // Validate the redirect URL to prevent open redirect attacks\n            let validated_redirect = validate_post_auth_redirect(\u0026redirect_to).unwrap_or_else(|_| {\n                error!(\"Invalid post-authentication redirect URL '{redirect_to}': rejecting\");\n                // Fallback to safe default on validation failure\n                \"/\".to_string()\n            });\n\n            // Create response with multiple cookies\n            ResponseBuilder::success_redirect_with_cookies(\n                \u0026validated_redirect,\n                vec![session_cookie, user_cookie, clear_temp_cookie],\n            )\n        }\n        Err(e) =\u003e {\n            error!(\"Failed to build session from ID token: {e}\");\n            let clear_cookie = session_manager.create_expired_cookie();\n            HttpResponse::Found()\n                .cookie(clear_cookie)\n                .append_header((\"Location\", \"/oauth2/sign_in?error=session_build_error\"))\n                .finish()\n        }\n    }\n}\n","traces":[{"line":34,"address":[3861904],"length":1,"stats":{"Line":0}},{"line":42,"address":[3649421],"length":1,"stats":{"Line":0}},{"line":43,"address":[3425413],"length":1,"stats":{"Line":0}},{"line":46,"address":[2521273,2521570],"length":1,"stats":{"Line":0}},{"line":47,"address":[2765006],"length":1,"stats":{"Line":0}},{"line":48,"address":[3425653],"length":1,"stats":{"Line":0}},{"line":52,"address":[3426217,3426263,3425957,3426050,3426582],"length":1,"stats":{"Line":0}},{"line":53,"address":[3650213],"length":1,"stats":{"Line":0}},{"line":54,"address":[2765592,2765532,2765880,2765681,2764645],"length":1,"stats":{"Line":0}},{"line":56,"address":[3650754,3650901],"length":1,"stats":{"Line":0}},{"line":57,"address":[3650899],"length":1,"stats":{"Line":0}},{"line":58,"address":[3650791],"length":1,"stats":{"Line":0}},{"line":59,"address":[2768023,2768063,2765975],"length":1,"stats":{"Line":0}},{"line":60,"address":[3652877,3653217],"length":1,"stats":{"Line":0}},{"line":61,"address":[2768417,2768649,2768522],"length":1,"stats":{"Line":0}},{"line":62,"address":[2524846],"length":1,"stats":{"Line":0}},{"line":63,"address":[3429299],"length":1,"stats":{"Line":0}},{"line":64,"address":[2525171,2524918],"length":1,"stats":{"Line":0}},{"line":68,"address":[2522683,2522784],"length":1,"stats":{"Line":0}},{"line":71,"address":[2766394,2766559],"length":1,"stats":{"Line":0}},{"line":75,"address":[3651415],"length":1,"stats":{"Line":0}},{"line":76,"address":[3427293,3427359],"length":1,"stats":{"Line":0}},{"line":77,"address":[2523367],"length":1,"stats":{"Line":0}},{"line":78,"address":[2523093],"length":1,"stats":{"Line":0}},{"line":79,"address":[2523146],"length":1,"stats":{"Line":0}},{"line":80,"address":[3651622],"length":1,"stats":{"Line":0}},{"line":82,"address":[3427518],"length":1,"stats":{"Line":0}},{"line":83,"address":[3651750],"length":1,"stats":{"Line":0}},{"line":87,"address":[2767220],"length":1,"stats":{"Line":0}},{"line":91,"address":[3141872],"length":1,"stats":{"Line":0}},{"line":95,"address":[3712422],"length":1,"stats":{"Line":0}},{"line":96,"address":[3654232,3654103,3654006],"length":1,"stats":{"Line":0}},{"line":97,"address":[3654119],"length":1,"stats":{"Line":0}},{"line":98,"address":[2526032,2526007,2526533,2526558,2525981,2525562],"length":1,"stats":{"Line":0}},{"line":99,"address":[3430406,3430632,3430503],"length":1,"stats":{"Line":0}},{"line":100,"address":[2526167],"length":1,"stats":{"Line":0}},{"line":105,"address":[3142624,3142630,3141952],"length":1,"stats":{"Line":0}},{"line":111,"address":[3712551],"length":1,"stats":{"Line":0}},{"line":112,"address":[3405007],"length":1,"stats":{"Line":0}},{"line":113,"address":[3862328,3862491,3862624],"length":1,"stats":{"Line":0}},{"line":114,"address":[3142257],"length":1,"stats":{"Line":0}},{"line":115,"address":[3405274],"length":1,"stats":{"Line":0}},{"line":116,"address":[3862518,3862765],"length":1,"stats":{"Line":0}},{"line":120,"address":[3862854,3862355],"length":1,"stats":{"Line":0}},{"line":121,"address":[3142678],"length":1,"stats":{"Line":0}},{"line":123,"address":[3145510,3142758],"length":1,"stats":{"Line":0}},{"line":124,"address":[3408379],"length":1,"stats":{"Line":0}},{"line":125,"address":[3866110,3865983,3865700],"length":1,"stats":{"Line":0}},{"line":126,"address":[3716287],"length":1,"stats":{"Line":0}},{"line":127,"address":[3145844],"length":1,"stats":{"Line":0}},{"line":128,"address":[3866007,3866243],"length":1,"stats":{"Line":0}},{"line":132,"address":[3405596,3405700],"length":1,"stats":{"Line":0}},{"line":133,"address":[3405708],"length":1,"stats":{"Line":0}},{"line":135,"address":[3144762,3144794,3142839],"length":1,"stats":{"Line":0}},{"line":136,"address":[3865213,3864976],"length":1,"stats":{"Line":0}},{"line":137,"address":[3145260,3145017,3145125],"length":1,"stats":{"Line":0}},{"line":138,"address":[3865281],"length":1,"stats":{"Line":0}},{"line":139,"address":[3715754],"length":1,"stats":{"Line":0}},{"line":140,"address":[3145149,3145383],"length":1,"stats":{"Line":0}},{"line":144,"address":[3863123,3863219],"length":1,"stats":{"Line":0}},{"line":145,"address":[3863355],"length":1,"stats":{"Line":0}},{"line":146,"address":[3863531,3863435,3863751],"length":1,"stats":{"Line":0}},{"line":147,"address":[3863541],"length":1,"stats":{"Line":0}},{"line":149,"address":[3405979],"length":1,"stats":{"Line":0}},{"line":150,"address":[3143932,3143119,3143964],"length":1,"stats":{"Line":0}},{"line":151,"address":[3406842],"length":1,"stats":{"Line":0}},{"line":152,"address":[3714778,3714881,3715008],"length":1,"stats":{"Line":0}},{"line":153,"address":[3407226],"length":1,"stats":{"Line":0}},{"line":154,"address":[3714954],"length":1,"stats":{"Line":0}},{"line":163,"address":[3148889,3146096,3150561],"length":1,"stats":{"Line":0}},{"line":169,"address":[3866672,3866580,3866393],"length":1,"stats":{"Line":0}},{"line":172,"address":[3866730,3866623],"length":1,"stats":{"Line":0}},{"line":173,"address":[3146597],"length":1,"stats":{"Line":0}},{"line":177,"address":[3866828],"length":1,"stats":{"Line":0}},{"line":178,"address":[3409600],"length":1,"stats":{"Line":0}},{"line":179,"address":[3717280],"length":1,"stats":{"Line":0}},{"line":180,"address":[3146740],"length":1,"stats":{"Line":0}},{"line":181,"address":[3866988],"length":1,"stats":{"Line":0}},{"line":184,"address":[3717476],"length":1,"stats":{"Line":0}},{"line":185,"address":[3717629],"length":1,"stats":{"Line":0}},{"line":186,"address":[3147166,3147063],"length":1,"stats":{"Line":0}},{"line":189,"address":[3717812],"length":1,"stats":{"Line":0}},{"line":190,"address":[3717942,3717839],"length":1,"stats":{"Line":0}},{"line":194,"address":[3717993,3718064],"length":1,"stats":{"Line":0}},{"line":195,"address":[3718217],"length":1,"stats":{"Line":0}},{"line":196,"address":[3147497],"length":1,"stats":{"Line":0}},{"line":197,"address":[3147513,3149773,3149805],"length":1,"stats":{"Line":0}},{"line":198,"address":[3412803,3413091],"length":1,"stats":{"Line":0}},{"line":199,"address":[3150318,3150183,3150075],"length":1,"stats":{"Line":0}},{"line":200,"address":[3413159],"length":1,"stats":{"Line":0}},{"line":201,"address":[3870576],"length":1,"stats":{"Line":0}},{"line":202,"address":[3413378,3413231],"length":1,"stats":{"Line":0}},{"line":206,"address":[3147681,3147729],"length":1,"stats":{"Line":0}},{"line":207,"address":[3147882],"length":1,"stats":{"Line":0}},{"line":208,"address":[3410726],"length":1,"stats":{"Line":0}},{"line":209,"address":[3148990,3147782,3149022],"length":1,"stats":{"Line":0}},{"line":210,"address":[3869600,3869300],"length":1,"stats":{"Line":0}},{"line":211,"address":[3720068,3720195,3719960],"length":1,"stats":{"Line":0}},{"line":212,"address":[3720020],"length":1,"stats":{"Line":0}},{"line":213,"address":[3149485],"length":1,"stats":{"Line":0}},{"line":214,"address":[3149579,3149436],"length":1,"stats":{"Line":0}},{"line":218,"address":[3718542,3718610],"length":1,"stats":{"Line":0}},{"line":219,"address":[3430940,3430928],"length":1,"stats":{"Line":0}},{"line":222,"address":[3655120,3655532],"length":1,"stats":{"Line":0}},{"line":223,"address":[2770299,2770417,2770380],"length":1,"stats":{"Line":0}},{"line":225,"address":[3655239],"length":1,"stats":{"Line":0}},{"line":230,"address":[3411234],"length":1,"stats":{"Line":0}},{"line":231,"address":[3411343],"length":1,"stats":{"Line":0}},{"line":234,"address":[3717513],"length":1,"stats":{"Line":0}},{"line":235,"address":[3717545,3721371,3721335],"length":1,"stats":{"Line":0}},{"line":236,"address":[3870997],"length":1,"stats":{"Line":0}},{"line":237,"address":[3150945,3151183,3151048],"length":1,"stats":{"Line":0}},{"line":238,"address":[3871381],"length":1,"stats":{"Line":0}},{"line":239,"address":[3871461],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":114},{"path":["/","workspaces","vouchrs","src","handlers","debug.rs"],"content":"// Debug handler for sessions\nuse crate::session::SessionManager;\nuse actix_web::{web, HttpRequest, HttpResponse, Result};\nuse log::{debug, error, info};\n\n/// `OAuth2` userinfo endpoint - returns user data from encrypted user cookie\n/// \n/// # Errors\n/// Returns an error if session extraction fails or user data is invalid\npub async fn oauth_userinfo(\n    req: HttpRequest,\n    session_manager: web::Data\u003cSessionManager\u003e,\n    _settings: web::Data\u003ccrate::settings::VouchrsSettings\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    use crate::utils::cookie::USER_COOKIE_NAME;\n\n    // Get the vouchrs_user cookie directly\n    req.cookie(USER_COOKIE_NAME).map_or_else(|| {\n        debug!(\"Userinfo endpoint: No vouchrs_user cookie found\");\n        Ok(HttpResponse::Unauthorized().json(serde_json::json!({\n            \"error\": \"no_user_data\",\n            \"error_description\": \"No user data cookie found. Please authenticate first.\"\n        })))\n    }, |cookie| match session_manager.decrypt_data::\u003ccrate::models::VouchrsUserData\u003e(cookie.value()) {\n        Ok(user_data) =\u003e {\n            info!(\n                \"Userinfo endpoint: returning raw user data for user: {}\",\n                user_data.email\n            );\n\n            // Return the complete user data as raw JSON\n            Ok(HttpResponse::Ok().json(user_data))\n        }\n        Err(e) =\u003e {\n            error!(\"Userinfo endpoint: Error decrypting user cookie: {e}\");\n            Ok(HttpResponse::Unauthorized().json(serde_json::json!({\n                \"error\": \"invalid_cookie\",\n                \"error_description\": \"Failed to decrypt user cookie data\",\n                \"details\": e.to_string()\n            })))\n        }\n    })\n}\n\n/// Debug endpoint - returns debug information from session\n/// \n/// # Errors\n/// Returns an error if session extraction fails or debug data is invalid\npub async fn oauth_debug(\n    req: HttpRequest,\n    session_manager: web::Data\u003cSessionManager\u003e,\n    _settings: web::Data\u003ccrate::settings::VouchrsSettings\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    // Check if debug mode is enabled via environment variable\n    let debug_enabled = std::env::var(\"OAUTH_DEBUG_ENABLED\")\n        .unwrap_or_else(|_| \"false\".to_string())\n        .to_lowercase()\n        == \"true\";\n\n    if !debug_enabled {\n        error!(\"OAuth debug endpoint accessed but OAUTH_DEBUG_ENABLED is not set to true\");\n        return Ok(HttpResponse::Ok().json(serde_json::json!({\n            \"error\": \"debug_disabled\",\n            \"error_description\": \"Debug endpoint disabled. Set OAUTH_DEBUG_ENABLED=true to enable this endpoint\"\n        })));\n    }\n\n    match session_manager.get_session_from_request(\u0026req) {\n        Ok(Some(session)) =\u003e {\n            // Also try to get user data from user cookie\n            let user_data = session_manager\n                .get_user_data_from_request(\u0026req)\n                .unwrap_or(None);\n\n            let debug_response = serde_json::json!({\n                \"session_data\": {\n                    \"provider\": session.provider,\n                    \"expires_at\": session.expires_at,\n                    \"id_token\": session.id_token,\n                    \"refresh_token\": session.refresh_token,\n                },\n                \"debug_info\": {\n                    \"session_cookie_name\": \"vouchrs_session\",\n                    \"user_cookie_name\": \"vouchrs_user\",\n                    \"user_cookie\": user_data,\n                    \"timestamp\": chrono::Utc::now(),\n                }\n            });\n\n            Ok(HttpResponse::Ok().json(debug_response))\n        }\n        Ok(None) =\u003e {\n            debug!(\"Debug endpoint: No valid session found\");\n            Ok(HttpResponse::Unauthorized().json(create_no_session_response(\u0026req)))\n        }\n        Err(e) =\u003e {\n            error!(\"Debug endpoint: Error retrieving session: {e}\");\n            Ok(HttpResponse::Unauthorized().json(create_session_error_response(\u0026req, \u0026e)))\n        }\n    }\n}\n\nfn create_no_session_response(req: \u0026HttpRequest) -\u003e serde_json::Value {\n    let raw_cookie_data = req.cookie(\"vouchrs_session\").map(|cookie| {\n        let cookie_value = cookie.value();\n        serde_json::json!({\n            \"raw_encrypted_data\": cookie_value,\n            \"cookie_length\": cookie_value.len(),\n            \"cookie_preview\": format!(\"{}...{}\",\n                \u0026cookie_value[..std::cmp::min(50, cookie_value.len())],\n                if cookie_value.len() \u003e 100 {\n                    \u0026cookie_value[cookie_value.len()-20..]\n                } else {\n                    \"\"\n                }\n            ),\n            \"note\": \"Cookie found but session is invalid, expired, or failed to decrypt\"\n        })\n    });\n\n    serde_json::json!({\n        \"error\": \"No session\",\n        \"message\": \"No valid session found\",\n        \"cookie_analysis\": {\n            \"decryption_successful\": false,\n            \"session_cookie_found\": raw_cookie_data.is_some(),\n            \"raw_cookie_data\": raw_cookie_data,\n            \"possible_reasons\": [\n                \"Session expired\",\n                \"Cookie decryption failed (wrong key)\",\n                \"Cookie corrupted or invalid format\",\n                \"No session cookie present\"\n            ]\n        },\n        \"debug_info\": {\n            \"timestamp\": chrono::Utc::now(),\n            \"has_cookies\": req.cookies().map(|cookies| !cookies.is_empty()).unwrap_or(false)\n        }\n    })\n}\n\nfn create_session_error_response(\n    req: \u0026HttpRequest,\n    error: \u0026dyn std::fmt::Display,\n) -\u003e serde_json::Value {\n    let raw_cookie_data = req.cookie(\"vouchrs_session\").map(|cookie| {\n        let cookie_value = cookie.value();\n        serde_json::json!({\n            \"raw_encrypted_data\": cookie_value,\n            \"cookie_length\": cookie_value.len(),\n            \"cookie_preview\": format!(\"{}...{}\",\n                \u0026cookie_value[..std::cmp::min(50, cookie_value.len())],\n                if cookie_value.len() \u003e 100 {\n                    \u0026cookie_value[cookie_value.len()-20..]\n                } else {\n                    \"\"\n                }\n            ),\n            \"note\": \"Cookie found but decryption/validation failed\"\n        })\n    });\n\n    serde_json::json!({\n        \"error\": \"Session error\",\n        \"message\": format!(\"Error retrieving session: {}\", error),\n        \"cookie_analysis\": {\n            \"decryption_successful\": false,\n            \"session_cookie_found\": raw_cookie_data.is_some(),\n            \"raw_cookie_data\": raw_cookie_data,\n            \"error_details\": format!(\"{}\", error)\n        },\n        \"debug_info\": {\n            \"timestamp\": chrono::Utc::now()\n        }\n    })\n}\n","traces":[{"line":10,"address":[3777120],"length":1,"stats":{"Line":0}},{"line":18,"address":[3025854,3024691,3024944,3025882,3024584],"length":1,"stats":{"Line":0}},{"line":19,"address":[3025042,3024960],"length":1,"stats":{"Line":0}},{"line":20,"address":[3025222,3025860,3025007,3025541,3025331,3025832],"length":1,"stats":{"Line":0}},{"line":24,"address":[4083178,4086449,4084884,4083947,4084046,4083920,4083825],"length":1,"stats":{"Line":0}},{"line":25,"address":[3364863],"length":1,"stats":{"Line":0}},{"line":26,"address":[3026217,3026304,3026332],"length":1,"stats":{"Line":0}},{"line":32,"address":[4084750,4084338,4084626],"length":1,"stats":{"Line":0}},{"line":34,"address":[3265170],"length":1,"stats":{"Line":0}},{"line":35,"address":[3365644,3364818,3365616],"length":1,"stats":{"Line":0}},{"line":36,"address":[3027220,3028308,3027804,3027271,3026930],"length":1,"stats":{"Line":0}},{"line":39,"address":[3366493],"length":1,"stats":{"Line":0}},{"line":49,"address":[3777168],"length":1,"stats":{"Line":0}},{"line":55,"address":[3267841,3267963,3268059,3267744],"length":1,"stats":{"Line":0}},{"line":56,"address":[4093904,4093920],"length":1,"stats":{"Line":0}},{"line":58,"address":[3367643,3367700,3367538],"length":1,"stats":{"Line":0}},{"line":60,"address":[4087089],"length":1,"stats":{"Line":0}},{"line":61,"address":[3268226,3268198,3268119],"length":1,"stats":{"Line":0}},{"line":62,"address":[3268607,3268204,3268449,3268904,3269569,3268500,3269531,3268838,3268538],"length":1,"stats":{"Line":0}},{"line":68,"address":[3030639,3029076,3030501],"length":1,"stats":{"Line":0}},{"line":69,"address":[3030676],"length":1,"stats":{"Line":0}},{"line":71,"address":[3031507,3030780,3031431],"length":1,"stats":{"Line":0}},{"line":73,"address":[3370267],"length":1,"stats":{"Line":0}},{"line":75,"address":[3372476,3370411,3372730,3372546,3371348,3370910,3370373,3373598,3372223,3370843,3371992,3370545,3371418,3370615,3372792,3370469,3371923,3371164,3371094,3371792,3372289,3371847,3370322],"length":1,"stats":{"Line":0}},{"line":86,"address":[3273141],"length":1,"stats":{"Line":0}},{"line":90,"address":[3273728,3273554,3273617],"length":1,"stats":{"Line":0}},{"line":93,"address":[3369571,3369644,3369672],"length":1,"stats":{"Line":0}},{"line":94,"address":[4088994,4089231,4089302],"length":1,"stats":{"Line":0}},{"line":96,"address":[3369350],"length":1,"stats":{"Line":0}},{"line":97,"address":[3035036,3030594,3035008],"length":1,"stats":{"Line":0}},{"line":98,"address":[3373902,3374190,3374276],"length":1,"stats":{"Line":0}},{"line":103,"address":[3560902,3561089,3557504],"length":1,"stats":{"Line":0}},{"line":104,"address":[2511838],"length":1,"stats":{"Line":0}},{"line":105,"address":[3275070,3275170],"length":1,"stats":{"Line":0}},{"line":106,"address":[4094777,4095913,4095309,4095885,4094170,4094568,4094514],"length":1,"stats":{"Line":0}},{"line":108,"address":[3375216,3375142],"length":1,"stats":{"Line":0}},{"line":109,"address":[3375849,3375578,3375699],"length":1,"stats":{"Line":0}},{"line":110,"address":[3375405,3375482],"length":1,"stats":{"Line":0}},{"line":111,"address":[3375669,3375844,3375605],"length":1,"stats":{"Line":0}},{"line":112,"address":[3276039,3276099],"length":1,"stats":{"Line":0}},{"line":114,"address":[3375644],"length":1,"stats":{"Line":0}},{"line":121,"address":[2512012,2514707,2514358,2514211,2515080,2512863,2512121,2515108,2511964,2513253,2512793,2513040,2514593,2512331,2512537],"length":1,"stats":{"Line":0}},{"line":126,"address":[3727821,3727886],"length":1,"stats":{"Line":0}},{"line":136,"address":[3729443],"length":1,"stats":{"Line":0}},{"line":137,"address":[3729686,3729746],"length":1,"stats":{"Line":0}},{"line":142,"address":[3783726,3783886,3780816],"length":1,"stats":{"Line":0}},{"line":146,"address":[4097963,4097891,4096000],"length":1,"stats":{"Line":0}},{"line":147,"address":[3037842,3037742],"length":1,"stats":{"Line":0}},{"line":148,"address":[3278921,3278893,3277522,3277576,3277785,3278317,3277178],"length":1,"stats":{"Line":0}},{"line":150,"address":[3277494,3277568],"length":1,"stats":{"Line":0}},{"line":151,"address":[3278201,3277930,3278051],"length":1,"stats":{"Line":0}},{"line":152,"address":[3038429,3038506],"length":1,"stats":{"Line":0}},{"line":153,"address":[4097172,4096933,4096997],"length":1,"stats":{"Line":0}},{"line":154,"address":[3278023,3278083],"length":1,"stats":{"Line":0}},{"line":156,"address":[3377628],"length":1,"stats":{"Line":0}},{"line":163,"address":[2516977,2517556,2517137,2518158,2518130,2516263,2517144,2515622,2515990,2515513,2515465,2517703,2516766,2515997,2516589,2515830,2516519],"length":1,"stats":{"Line":0}},{"line":165,"address":[3781326,3781394],"length":1,"stats":{"Line":0}},{"line":168,"address":[2516564,2516508],"length":1,"stats":{"Line":0}},{"line":170,"address":[3732124,3732192],"length":1,"stats":{"Line":0}},{"line":173,"address":[3732866],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":60},{"path":["/","workspaces","vouchrs","src","handlers","mod.rs"],"content":"// HTTP request handlers for OAuth proxy\npub mod auth;\npub mod callback;\npub mod debug;\npub mod static_files;\npub mod proxy_upstream;\n\n#[cfg(test)]\nmod tests;\n\n// Re-export the main handler functions\npub use auth::{oauth_sign_in, oauth_sign_out};\npub use callback::oauth_callback;\npub use debug::{oauth_debug, oauth_userinfo};\npub use static_files::{health, serve_static};\npub use proxy_upstream::proxy_upstream;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","handlers","proxy_upstream.rs"],"content":"use actix_web::{web, HttpRequest, HttpResponse, Result as ActixResult};\nuse reqwest::Client;\nuse std::collections::HashMap;\n\nuse crate::{\n    models::VouchrsSession,\n    oauth::{check_and_refresh_tokens, OAuthConfig},\n    session::SessionManager,\n    settings::VouchrsSettings,\n    utils::response_builder::{is_hop_by_hop_header, ResponseBuilder},\n    utils::user_agent::is_browser_request,\n};\n\n/// HTTP client for making upstream requests\nstatic CLIENT: std::sync::LazyLock\u003cClient\u003e = std::sync::LazyLock::new(Client::new);\n\n/// Generic catch-all proxy handler that forwards requests as-is to upstream\n/// Proxy requests with authentication\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Authentication fails (missing or invalid session)\n/// - Request building fails\n/// - Upstream server is unreachable\n#[allow(clippy::implicit_hasher)]\npub async fn proxy_upstream(\n    req: HttpRequest,\n    query_params: web::Query\u003cHashMap\u003cString, String\u003e\u003e,\n    body: web::Bytes,\n    session_manager: web::Data\u003cSessionManager\u003e,\n    settings: web::Data\u003cVouchrsSettings\u003e,\n    oauth_config: web::Data\u003cOAuthConfig\u003e,\n) -\u003e ActixResult\u003cHttpResponse\u003e {\n    // Extract and validate session from encrypted cookie\n    let session = match extract_session_from_request(\u0026req, \u0026session_manager) {\n        Ok(session) =\u003e session,\n        Err(response) =\u003e return Ok(response),\n    };\n\n    // Check and refresh tokens if necessary\n    let _tokens =\n        match check_and_refresh_tokens(session.clone(), \u0026oauth_config, \u0026session.provider).await {\n            Ok(tokens) =\u003e tokens,\n            Err(response) =\u003e return Ok(response),\n        };\n\n    // Build and execute upstream request\n    let upstream_url =\n        match ResponseBuilder::build_upstream_url(\u0026settings.proxy.upstream_url, req.path()) {\n            Ok(url) =\u003e url,\n            Err(response) =\u003e return Ok(response),\n        };\n\n    let upstream_response =\n        match execute_upstream_request(\u0026req, \u0026query_params, \u0026body, \u0026upstream_url).await {\n            Ok(response) =\u003e response,\n            Err(response) =\u003e return Ok(response),\n        };\n\n    // Forward upstream response back to client\n    forward_upstream_response(upstream_response, \u0026req, \u0026settings).await\n}\n\n/// Execute the upstream request with proper headers and body\n/// \n/// # Errors\n/// \n/// Returns an `HttpResponse` error if:\n/// - HTTP method conversion fails\n/// - Upstream request fails\nasync fn execute_upstream_request(\n    req: \u0026HttpRequest,\n    query_params: \u0026web::Query\u003cHashMap\u003cString, String\u003e\u003e,\n    body: \u0026web::Bytes,\n    upstream_url: \u0026str,\n) -\u003e Result\u003creqwest::Response, HttpResponse\u003e {\n    let reqwest_method = ResponseBuilder::convert_http_method(req.method())?;\n\n    let mut request_builder = CLIENT\n        .request(reqwest_method, upstream_url)\n        .header(\"User-Agent\", \"Vouchrs-Proxy/1.0\");\n\n    // Forward headers, query params, and body\n    request_builder = ResponseBuilder::forward_request_headers(request_builder, req);\n    request_builder = ResponseBuilder::forward_query_parameters(request_builder, query_params);\n    request_builder = ResponseBuilder::forward_request_body(request_builder, body);\n\n    // Execute the request\n    request_builder.send().await.map_err(|err| {\n        // Return a simple error response\n        HttpResponse::BadGateway().json(serde_json::json!({\n            \"error\": \"upstream_error\",\n            \"message\": format!(\"Failed to reach upstream service: {err}\")\n        }))\n    })\n}\n\n// Functions have been moved to ResponseBuilder\n\n/// Forward upstream response back to client, handling 401/403 redirects for browsers\n/// \n/// # Errors\n/// \n/// Returns an error if reading the upstream response body fails\nasync fn forward_upstream_response(\n    upstream_response: reqwest::Response,\n    req: \u0026HttpRequest,\n    settings: \u0026VouchrsSettings,\n) -\u003e ActixResult\u003cHttpResponse\u003e {\n    let status_code = upstream_response.status();\n\n    // Check if this is a 401 Unauthorized response\n    if status_code == reqwest::StatusCode::UNAUTHORIZED {\n        // Determine if this is a browser request \n        if is_browser_request(req) {\n            // Redirect browser requests to sign-in page\n            let sign_in_url = format!(\"{}/oauth2/sign_in\", settings.application.redirect_base_url);\n            return Ok(HttpResponse::Found()\n                .insert_header((\"Location\", sign_in_url.clone()))\n                .json(serde_json::json!({\n                    \"error\": \"authentication_required\",\n                    \"message\": \"Authentication required. Redirecting to sign-in page.\",\n                    \"redirect_url\": sign_in_url\n                })));\n        }\n        // For non-browser requests, return 401 with JSON error\n        return Ok(HttpResponse::Unauthorized().json(serde_json::json!({\n            \"error\": \"unauthorized\",\n            \"message\": \"Authentication required. Please obtain a valid session cookie or bearer token.\"\n        })));\n    }\n\n    // For all other status codes, forward the response as-is\n    let actix_status = actix_web::http::StatusCode::from_u16(status_code.as_u16())\n        .unwrap_or(actix_web::http::StatusCode::INTERNAL_SERVER_ERROR);\n\n    let mut response_builder = HttpResponse::build(actix_status);\n\n    // Forward relevant headers (excluding hop-by-hop headers)\n    for (name, value) in upstream_response.headers() {\n        let name_str = name.as_str().to_lowercase();\n        if !is_hop_by_hop_header(\u0026name_str) {\n            if let Ok(value_str) = value.to_str() {\n                response_builder.insert_header((name.as_str(), value_str));\n            }\n        }\n    }\n\n    // Get response body\n    let response_body = upstream_response.bytes().await.map_err(|err| {\n        actix_web::error::ErrorBadGateway(format!(\"Failed to read upstream response: {err}\"))\n    })?;\n\n    Ok(response_builder.body(response_body))\n}\n\n/// Extract and validate session from encrypted cookie\n/// \n/// # Errors\n/// \n/// Returns an `HttpResponse` error if:\n/// - No session cookie is found\n/// - Session is invalid or expired\nfn extract_session_from_request(\n    req: \u0026HttpRequest,\n    session_manager: \u0026SessionManager,\n) -\u003e Result\u003cVouchrsSession, HttpResponse\u003e {\n    // Helper function to handle authentication errors\n    let handle_auth_error = |message: \u0026str| {\n        if is_browser_request(req) {\n            // For browser requests, redirect to sign-in page\n            let sign_in_url = \"/oauth2/sign_in\";\n            HttpResponse::Found()\n                .insert_header((\"Location\", sign_in_url))\n                .finish()\n        } else {\n            // For non-browser requests, return JSON error\n            HttpResponse::Unauthorized().json(serde_json::json!({\n                \"error\": \"unauthorized\",\n                \"message\": message\n            }))\n        }\n    };\n\n    // Extract session cookie\n    let cookie = req\n        .cookie(\"vouchrs_session\")\n        .ok_or_else(|| handle_auth_error(\"No session cookie found. Please authenticate first.\"))?;\n\n    // Decrypt and validate session\n    session_manager.decrypt_and_validate_session(cookie.value()).map_or_else(|_| Err(handle_auth_error(\n        \"Session is invalid or expired. Please authenticate again.\",\n    )), Ok)\n}\n\n// is_hop_by_hop_header function has been moved to utils::response_builder\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::test_helpers::create_test_settings;\n    use crate::utils::test_request_builder::TestRequestBuilder;\n    use crate::utils::user_agent::{derive_platform_from_user_agent, extract_user_agent_info};\n\n    #[test]\n    fn test_hop_by_hop_headers() {\n        use crate::utils::response_builder::is_hop_by_hop_header;\n        assert!(is_hop_by_hop_header(\"connection\"));\n        assert!(is_hop_by_hop_header(\"transfer-encoding\"));\n        assert!(!is_hop_by_hop_header(\"content-type\"));\n        assert!(!is_hop_by_hop_header(\"authorization\"));\n    }\n\n    #[test]\n    fn test_user_agent_extraction() {\n        // Test with modern client hints headers\n        let req = TestRequestBuilder::client_hints_request();\n\n        let user_agent_info = extract_user_agent_info(\u0026req);\n\n        assert_eq!(\n            user_agent_info.user_agent,\n            Some(\"\\\"Google Chrome\\\";v=\\\"91\\\", \\\"Chromium\\\";v=\\\"91\\\"\".to_string())\n        );\n        assert_eq!(user_agent_info.platform, Some(\"Windows\".to_string()));\n        assert_eq!(user_agent_info.lang, Some(\"en-US\".to_string()));\n        assert_eq!(user_agent_info.mobile, 0);\n\n        // Test with fallback to User-Agent header\n        let req = TestRequestBuilder::macos_french_request();\n\n        let user_agent_info = extract_user_agent_info(\u0026req);\n\n        assert_eq!(\n            user_agent_info.user_agent,\n            Some(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\".to_string())\n        );\n        assert_eq!(user_agent_info.platform, Some(\"macOS\".to_string())); // Derived from User-Agent\n        assert_eq!(user_agent_info.lang, Some(\"fr-FR\".to_string()));\n        assert_eq!(user_agent_info.mobile, 0); // Default when not specified\n    }\n\n    #[test]\n    fn test_platform_derivation_from_user_agent() {\n        // Test Windows detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Windows NT 10.0; Win64; x64)\"),\n            \"Windows\".to_string()\n        );\n\n        // Test macOS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)\"),\n            \"macOS\".to_string()\n        );\n\n        // Test Linux detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (X11; Linux x86_64)\"),\n            \"Linux\".to_string()\n        );\n\n        // Test Android detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Linux; Android 11; SM-G991B)\"),\n            \"Android\".to_string()\n        );\n\n        // Test iOS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\n                \"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)\"\n            ),\n            \"iOS\".to_string()\n        );\n\n        // Test Chrome OS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (X11; CrOS x86_64 14541.0.0)\"),\n            \"Chrome OS\".to_string()\n        );\n\n        // Test unknown platform - now returns \"Unknown\" instead of None\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Unknown Platform)\"),\n            \"Unknown\".to_string()\n        );\n    }\n\n    #[tokio::test]\n    async fn test_401_redirect_for_browser_requests() {\n        // Test browser request (Accept: text/html)\n        let browser_req = TestRequestBuilder::browser_request();\n\n        let settings = create_test_settings();\n\n        // Test that browser requests are properly detected\n        assert!(\n            is_browser_request(\u0026browser_req),\n            \"Should detect browser request\"\n        );\n\n        // Test API request (Accept: application/json)\n        let api_req = TestRequestBuilder::api_request();\n\n        assert!(!is_browser_request(\u0026api_req), \"Should detect API request\");\n\n        // Test that the redirect URL is properly constructed\n        let expected_redirect_url =\n            format!(\"{}/oauth2/sign_in\", settings.application.redirect_base_url);\n        assert_eq!(\n            expected_redirect_url,\n            \"http://localhost:8080/oauth2/sign_in\"\n        );\n    }\n\n    #[test]\n    fn test_browser_detection() {\n        // Test browser detection with Accept: text/html\n        let browser_req = TestRequestBuilder::browser_request();\n        assert!(is_browser_request(\u0026browser_req));\n\n        // Test API client detection with Accept: application/json\n        let api_req = TestRequestBuilder::api_request();\n        assert!(!is_browser_request(\u0026api_req));\n\n        // Test browser detection via User-Agent fallback\n        let browser_ua_req = TestRequestBuilder::user_agent_request(\n            \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n        );\n        assert!(is_browser_request(\u0026browser_ua_req));\n\n        // Test API client via User-Agent\n        let api_ua_req = TestRequestBuilder::user_agent_request(\"curl/7.68.0\");\n        assert!(!is_browser_request(\u0026api_ua_req));\n\n        // Test unknown client (no Accept or User-Agent)\n        let unknown_req = TestRequestBuilder::empty_request();\n        assert!(!is_browser_request(\u0026unknown_req));\n    }\n\n    #[test]\n    fn test_sign_in_url_generation() {\n        let settings = create_test_settings();\n        let expected_url = format!(\"{}/oauth2/sign_in\", settings.application.redirect_base_url);\n        assert_eq!(expected_url, \"http://localhost:8080/oauth2/sign_in\");\n    }\n\n    #[tokio::test]\n    async fn test_cookie_filtering() {\n        // Create a mock HTTP request with cookies\n        let cookies =\n            \"vouchrs_session=test_session_value; another_cookie=value; third_cookie=value3\";\n        let req = TestRequestBuilder::with_cookies(cookies);\n\n        // Create a reqwest RequestBuilder\n        let client = Client::new();\n        let request_builder = client.get(\"http://example.com\");\n\n        // Apply header forwarding\n        let modified_builder = ResponseBuilder::forward_request_headers(request_builder, \u0026req);\n\n        // Since we can't inspect the actual headers directly in the builder,\n        // we need to convert it to a request and check the headers\n        let request = modified_builder.build().expect(\"Failed to build request\");\n        let headers = request.headers();\n\n        // Check that the Cookie header exists but doesn't contain vouchrs_session\n        if let Some(cookie_header) = headers.get(reqwest::header::COOKIE) {\n            let cookie_str = cookie_header\n                .to_str()\n                .expect(\"Failed to convert cookie header to string\");\n            assert!(\n                !cookie_str.contains(\"vouchrs_session=\"),\n                \"Cookie header should not contain vouchrs_session\"\n            );\n            assert!(\n                cookie_str.contains(\"another_cookie=value\"),\n                \"Cookie header should contain other cookies\"\n            );\n            assert!(\n                cookie_str.contains(\"third_cookie=value3\"),\n                \"Cookie header should contain other cookies\"\n            );\n        } else {\n            panic!(\"Cookie header is missing\");\n        }\n    }\n}\n","traces":[{"line":27,"address":[3842464],"length":1,"stats":{"Line":0}},{"line":36,"address":[3240702,3240506],"length":1,"stats":{"Line":0}},{"line":37,"address":[3240841],"length":1,"stats":{"Line":0}},{"line":38,"address":[3335040],"length":1,"stats":{"Line":0}},{"line":42,"address":[3241613,3241035,3241545,3241437,3241065,3240588,3241251],"length":1,"stats":{"Line":0}},{"line":44,"address":[3336252],"length":1,"stats":{"Line":0}},{"line":45,"address":[3070800],"length":1,"stats":{"Line":0}},{"line":49,"address":[4047099,4047006],"length":1,"stats":{"Line":0}},{"line":51,"address":[3336784],"length":1,"stats":{"Line":0}},{"line":52,"address":[3242471],"length":1,"stats":{"Line":0}},{"line":55,"address":[3336854,3337000,3337165,3334865],"length":1,"stats":{"Line":0}},{"line":57,"address":[4048266],"length":1,"stats":{"Line":0}},{"line":58,"address":[3337410],"length":1,"stats":{"Line":0}},{"line":62,"address":[3337723,3337784,3338590,3334886,3337974],"length":1,"stats":{"Line":0}},{"line":72,"address":[3892528],"length":1,"stats":{"Line":0}},{"line":78,"address":[3074212,3074103],"length":1,"stats":{"Line":0}},{"line":80,"address":[4050599,4050724],"length":1,"stats":{"Line":0}},{"line":81,"address":[3340124],"length":1,"stats":{"Line":0}},{"line":85,"address":[3246020],"length":1,"stats":{"Line":0}},{"line":86,"address":[3340380],"length":1,"stats":{"Line":0}},{"line":87,"address":[4051047],"length":1,"stats":{"Line":0}},{"line":90,"address":[3342191,3340652,3342219,3340886,3341127,3341168,3340594,3339684],"length":1,"stats":{"Line":0}},{"line":92,"address":[3247060,3247389,3247560,3247015,3247913,3247941,3246934,3247173,3247533],"length":1,"stats":{"Line":0}},{"line":94,"address":[3247365,3247433],"length":1,"stats":{"Line":0}},{"line":106,"address":[3824960],"length":1,"stats":{"Line":0}},{"line":111,"address":[3077062,3076908],"length":1,"stats":{"Line":0}},{"line":114,"address":[3342681],"length":1,"stats":{"Line":0}},{"line":116,"address":[3249604,3248512],"length":1,"stats":{"Line":0}},{"line":118,"address":[3249637,3250603],"length":1,"stats":{"Line":0}},{"line":119,"address":[3079307,3080416,3079513],"length":1,"stats":{"Line":0}},{"line":120,"address":[4055650,4055582],"length":1,"stats":{"Line":0}},{"line":121,"address":[3345534,3345857,3345600,3345303,3345189,3346260,3345234,3345787],"length":1,"stats":{"Line":0}},{"line":128,"address":[3250126,3249722,3249760,3249671,3249829,3250539,3250060,3249610],"length":1,"stats":{"Line":0}},{"line":135,"address":[3248541,3248474],"length":1,"stats":{"Line":0}},{"line":138,"address":[3077242],"length":1,"stats":{"Line":0}},{"line":141,"address":[3077267,3077356],"length":1,"stats":{"Line":0}},{"line":142,"address":[3343455,3343203],"length":1,"stats":{"Line":0}},{"line":143,"address":[4054042,4054113],"length":1,"stats":{"Line":0}},{"line":144,"address":[3077955,3078008],"length":1,"stats":{"Line":0}},{"line":145,"address":[3343730],"length":1,"stats":{"Line":0}},{"line":151,"address":[3253072,3252116,3248345,3249089,3252434,3253298,3253292,3248973],"length":1,"stats":{"Line":0}},{"line":152,"address":[3081705,3081657],"length":1,"stats":{"Line":0}},{"line":155,"address":[3252535,3252658],"length":1,"stats":{"Line":0}},{"line":165,"address":[3825491,3825497,3825056],"length":1,"stats":{"Line":0}},{"line":170,"address":[3842838],"length":1,"stats":{"Line":0}},{"line":171,"address":[3081934],"length":1,"stats":{"Line":0}},{"line":173,"address":[3347603],"length":1,"stats":{"Line":0}},{"line":174,"address":[3082840,3082081,3081997],"length":1,"stats":{"Line":0}},{"line":175,"address":[3253460],"length":1,"stats":{"Line":0}},{"line":179,"address":[3348450,3347841,3348478,3347954,3348170,3347659],"length":1,"stats":{"Line":0}},{"line":187,"address":[3825246,3825099],"length":1,"stats":{"Line":0}},{"line":189,"address":[3348609,3348592],"length":1,"stats":{"Line":0}},{"line":192,"address":[3348798,3348753,3348656,3348682,3348792],"length":1,"stats":{"Line":0}},{"line":194,"address":[3254455,3254512],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":54},{"path":["/","workspaces","vouchrs","src","handlers","static_files.rs"],"content":"use crate::models::HealthResponse;\nuse crate::settings::VouchrsSettings;\nuse actix_web::{web, HttpResponse, Result};\nuse log::debug;\nuse std::fs;\n\n/// Health check endpoint\n/// \n/// # Errors\n/// Returns an error if health status cannot be determined\npub async fn health() -\u003e Result\u003cHttpResponse\u003e {\n    let response = HealthResponse {\n        status: \"ok\".to_string(),\n        message: \"Vouchrs OIDC Reverse Proxy is running\".to_string(),\n    };\n    Ok(HttpResponse::Ok().json(response))\n}\n\n/// Serve static files from the configured static directory\n///\n/// # Errors\n///\n/// Returns an error if:\n/// - The requested file cannot be read\n/// - The file path is invalid\npub async fn serve_static(\n    path: web::Path\u003cString\u003e,\n    settings: web::Data\u003cVouchrsSettings\u003e,\n) -\u003e Result\u003cHttpResponse\u003e {\n    let filename = path.into_inner();\n    let file_path = format!(\"{}/{}\", settings.static_files.assets_folder, filename);\n\n    debug!(\"Attempting to serve static file: {file_path}\");\n\n    fs::read(\u0026file_path).map_or_else(|_| {\n        debug!(\"Static file not found: {file_path}\");\n        Ok(HttpResponse::NotFound().json(serde_json::json!({\n            \"error\": \"not_found\",\n            \"message\": \"File not found\"\n        })))\n    }, |contents| {\n        let content_type = match file_path.split('.').next_back() {\n            Some(\"html\") =\u003e \"text/html\",\n            Some(\"css\") =\u003e \"text/css\",\n            Some(\"js\") =\u003e \"application/javascript\",\n            Some(\"png\") =\u003e \"image/png\",\n            Some(\"jpg\" | \"jpeg\") =\u003e \"image/jpeg\",\n            Some(\"gif\") =\u003e \"image/gif\",\n            Some(\"svg\") =\u003e \"image/svg+xml\",\n            Some(\"ico\") =\u003e \"image/x-icon\",\n            _ =\u003e \"text/plain\",\n        };\n\n        Ok(HttpResponse::Ok().content_type(content_type).body(contents))\n    })\n}\n\n// Helper function to get sign-in page HTML (reused from original handlers)\n#[must_use]\npub fn get_sign_in_page(settings: \u0026VouchrsSettings) -\u003e String {\n    let html_path = format!(\"{}/sign-in.html\", settings.static_files.assets_folder);\n    std::fs::read_to_string(\u0026html_path).unwrap_or_else(|_| generate_dynamic_sign_in_page(settings))\n}\n\n// Generate dynamic sign-in page with providers from configuration\n#[must_use]\npub fn generate_dynamic_sign_in_page(settings: \u0026VouchrsSettings) -\u003e String {\n    let provider_buttons = generate_provider_buttons(settings);\n    let brand_name = settings.application.redirect_base_url.clone();\n    \n    format!(\n        r#\"\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"UTF-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e\n    \u003ctitle\u003eSign In - {brand_name}\u003c/title\u003e\n    \u003cstyle\u003e{}\u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"login-box\"\u003e\n            \u003ch1\u003eSign In\u003c/h1\u003e\n            \u003cp\u003eChoose your authentication provider\u003c/p\u003e\n            \u003cdiv class=\"button-container\"\u003e\n                {provider_buttons}\n            \u003c/div\u003e\n            \u003cdiv class=\"footer\"\u003e\n                \u003cp\u003eProtected by \u003ca href=\"https://github.com/vouchrs/vouchrs\" target=\"_blank\"\u003eVouchrs\u003c/a\u003e\u003c/p\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\"#,\n        get_sign_in_styles(),\n        brand_name = brand_name,\n        provider_buttons = provider_buttons\n    )\n}\n\nfn generate_provider_buttons(settings: \u0026VouchrsSettings) -\u003e String {\n    settings\n        .get_enabled_providers()\n        .iter()\n        .map(|provider| {\n            let display_name = provider.display_name.as_ref()\n                .unwrap_or(\u0026provider.name)\n                .clone();\n            let provider_class = format!(\"provider-{}\", provider.name.to_lowercase());\n            format!(\n                r#\"\u003ca href=\"/oauth2/sign_in?provider={}\" class=\"provider-button {}\"\u003e\n                    \u003cspan\u003eContinue with {}\u003c/span\u003e\n                \u003c/a\u003e\"#,\n                provider.name, provider_class, display_name\n            )\n        })\n        .collect::\u003cVec\u003c_\u003e\u003e()\n        .join(\"\\n                \")\n}\n\n#[allow(clippy::too_many_lines)]\nconst fn get_sign_in_styles() -\u003e \u0026'static str {\n    r\"\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        \n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n            min-height: 100vh;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n        }\n        \n        .container {\n            width: 100%;\n            max-width: 400px;\n        }\n        \n        .login-box {\n            background: white;\n            border-radius: 10px;\n            box-shadow: 0 14px 28px rgba(0,0,0,0.12), 0 10px 10px rgba(0,0,0,0.08);\n            padding: 40px;\n        }\n        \n        h1 {\n            color: #333;\n            font-size: 28px;\n            font-weight: 600;\n            text-align: center;\n            margin-bottom: 10px;\n        }\n        \n        p {\n            color: #666;\n            text-align: center;\n            margin-bottom: 30px;\n        }\n        \n        .button-container {\n            display: flex;\n            flex-direction: column;\n            gap: 15px;\n            margin-bottom: 30px;\n        }\n        \n        .provider-button {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 12px 20px;\n            border-radius: 6px;\n            text-decoration: none;\n            font-weight: 500;\n            font-size: 16px;\n            transition: all 0.3s ease;\n            border: 2px solid transparent;\n        }\n        \n        .provider-button:hover {\n            transform: translateY(-1px);\n            box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n        }\n        \n        /* Provider-specific colors */\n        .provider-google {\n            background: #4285f4;\n            color: white;\n        }\n        \n        .provider-google:hover {\n            background: #3367d6;\n        }\n        \n        .provider-github {\n            background: #24292e;\n            color: white;\n        }\n        \n        .provider-github:hover {\n            background: #1a1e22;\n        }\n        \n        .provider-microsoft {\n            background: #0078d4;\n            color: white;\n        }\n        \n        .provider-microsoft:hover {\n            background: #0063b1;\n        }\n        \n        .provider-apple {\n            background: #000;\n            color: white;\n        }\n        \n        .provider-apple:hover {\n            background: #333;\n        }\n        \n        /* Generic provider style */\n        .provider-button:not(.provider-google):not(.provider-github):not(.provider-microsoft):not(.provider-apple) {\n            background: #6366f1;\n            color: white;\n        }\n        \n        .provider-button:not(.provider-google):not(.provider-github):not(.provider-microsoft):not(.provider-apple):hover {\n            background: #5558e3;\n        }\n        \n        .footer {\n            text-align: center;\n            padding-top: 20px;\n            border-top: 1px solid #e9ecef;\n        }\n        \n        .footer p {\n            color: #999;\n            font-size: 14px;\n            margin: 0;\n        }\n        \n        .footer a {\n            color: #6366f1;\n            text-decoration: none;\n        }\n        \n        .footer a:hover {\n            text-decoration: underline;\n        }\n        \n        @media (max-width: 480px) {\n            .login-box {\n                padding: 30px 20px;\n            }\n            \n            h1 {\n                font-size: 24px;\n            }\n        }\n    \"\n}\n","traces":[{"line":11,"address":[3135888,3136392,3135776,3135805,3135866],"length":1,"stats":{"Line":0}},{"line":13,"address":[3055118],"length":1,"stats":{"Line":0}},{"line":14,"address":[3055211],"length":1,"stats":{"Line":0}},{"line":16,"address":[3136040,3136100,3136218],"length":1,"stats":{"Line":0}},{"line":26,"address":[3325648],"length":1,"stats":{"Line":0}},{"line":30,"address":[3055812],"length":1,"stats":{"Line":0}},{"line":31,"address":[3836200,3836136],"length":1,"stats":{"Line":0}},{"line":33,"address":[3136864,3136954,3136990],"length":1,"stats":{"Line":0}},{"line":35,"address":[3836992,3836774,3838186,3838214,3836480],"length":1,"stats":{"Line":0}},{"line":36,"address":[3837144,3837116,3837019],"length":1,"stats":{"Line":0}},{"line":37,"address":[3837777,3838164,3837122,3837446,3837395,3838192,3837559],"length":1,"stats":{"Line":0}},{"line":41,"address":[3138601,3138720,3137551,3139835,3137882],"length":1,"stats":{"Line":0}},{"line":42,"address":[3058116,3058027],"length":1,"stats":{"Line":0}},{"line":43,"address":[3058280,3058319,3058217],"length":1,"stats":{"Line":0}},{"line":44,"address":[3139069,3139006,3139108],"length":1,"stats":{"Line":0}},{"line":45,"address":[3838697,3838658,3838595],"length":1,"stats":{"Line":0}},{"line":46,"address":[3459050,3459011,3458948],"length":1,"stats":{"Line":0}},{"line":47,"address":[3058493,3058556],"length":1,"stats":{"Line":0}},{"line":48,"address":[3058631,3058707],"length":1,"stats":{"Line":0}},{"line":49,"address":[3139493,3139394,3139454],"length":1,"stats":{"Line":0}},{"line":50,"address":[3839040,3838980],"length":1,"stats":{"Line":0}},{"line":51,"address":[3138970],"length":1,"stats":{"Line":0}},{"line":54,"address":[3459457,3459354],"length":1,"stats":{"Line":0}},{"line":60,"address":[3232249,3232255,3231984],"length":1,"stats":{"Line":0}},{"line":61,"address":[3232013],"length":1,"stats":{"Line":0}},{"line":62,"address":[3232133,3232199],"length":1,"stats":{"Line":0}},{"line":67,"address":[3325984,3326449,3326455],"length":1,"stats":{"Line":0}},{"line":68,"address":[3326019],"length":1,"stats":{"Line":0}},{"line":69,"address":[3326029],"length":1,"stats":{"Line":0}},{"line":71,"address":[4036241],"length":1,"stats":{"Line":0}},{"line":95,"address":[3232378,3232441],"length":1,"stats":{"Line":0}},{"line":101,"address":[3233119,3233113,3232768],"length":1,"stats":{"Line":0}},{"line":102,"address":[2589101,2589027,2589249],"length":1,"stats":{"Line":0}},{"line":105,"address":[3059264,3059983,3059977],"length":1,"stats":{"Line":0}},{"line":106,"address":[3459830,3459857],"length":1,"stats":{"Line":0}},{"line":107,"address":[3140046],"length":1,"stats":{"Line":0}},{"line":109,"address":[3059360,3059431],"length":1,"stats":{"Line":0}},{"line":110,"address":[3059697,3059760],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":38},{"path":["/","workspaces","vouchrs","src","handlers","tests.rs"],"content":"// Tests for handlers \nuse crate::session_builder::SessionBuilder;\nuse crate::utils::apple::{AppleUserInfo, AppleUserName};\nuse chrono::Utc;\n\n#[test]\nfn test_session_builder_with_apple_user_info_fallback() {\n    // Test SessionBuilder using Apple user info when ID token lacks name\n    let apple_user_info = AppleUserInfo {\n        name: AppleUserName {\n            first_name: Some(\"John\".to_string()),\n            last_name: Some(\"Doe\".to_string()),\n        },\n        email: Some(\"john.doe@example.com\".to_string()),\n    };\n    let id_token = Some(\"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiZW1haWwiOiJmYWxsYmFja0BleGFtcGxlLmNvbSJ9.invalid\".to_string());\n    let refresh_token = None;\n    let expires_at = Utc::now();\n    let result = SessionBuilder::build_session_with_apple_info(\n        \"apple\".to_string(),\n        id_token,\n        refresh_token,\n        expires_at,\n        Some(apple_user_info),\n    );\n\n    assert!(result.is_ok());\n    let session = result.unwrap();\n    assert_eq!(session.user_email, \"fallback@example.com\"); // From ID token\n    assert_eq!(session.user_name, Some(\"John Doe\".to_string())); // From Apple user info fallback\n    assert_eq!(session.provider_id, \"1234567890\");\n}\n\n#[test]\nfn test_session_builder_with_google_tokens() {\n    // Test SessionBuilder with Google-style ID tokens (name in 'name' field)\n    let id_token = Some(\"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiZW1haWwiOiJnb29nbGVAZXhhbXBsZS5jb20iLCJuYW1lIjoiR29vZ2xlIFVzZXIifQ.invalid\".to_string());\n    let refresh_token = None;\n    let expires_at = Utc::now();\n    let result =\n        SessionBuilder::build_session(\"google\".to_string(), id_token, refresh_token, expires_at);\n\n    assert!(result.is_ok());\n    let session = result.unwrap();\n    assert_eq!(session.user_email, \"google@example.com\");\n    assert_eq!(session.user_name, Some(\"Google User\".to_string()));\n    assert_eq!(session.provider_id, \"1234567890\");\n}\n\n#[test]\nfn test_session_builder_with_invalid_token() {\n    // Test SessionBuilder with actually invalid JWT token\n    let id_token = Some(\"completely.invalid.token\".to_string());\n    let refresh_token = None;\n    let expires_at = Utc::now();\n    let result =\n        SessionBuilder::build_session(\"test\".to_string(), id_token, refresh_token, expires_at);\n\n    // This should fail because the token format is invalid\n    assert!(result.is_err());\n    assert!(result.unwrap_err().contains(\"Base64 decode failed\"));\n}\n\n#[test]\nfn test_session_builder_without_id_token() {\n    // Test SessionBuilder when no ID token is provided\n    let id_token = None;\n    let refresh_token = None;\n    let expires_at = Utc::now();\n    let result =\n        SessionBuilder::build_session(\"test\".to_string(), id_token, refresh_token, expires_at);\n\n    // This should fail because no ID token is available\n    assert!(result.is_err());\n    assert!(result.unwrap_err().contains(\"No ID token available\"));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","lib.rs"],"content":"\n#![warn(clippy::pedantic)]\n#![warn(clippy::cargo)]\n#![deny(warnings)]\n#![allow(clippy::multiple_crate_versions)]\n\npub mod handlers;\npub mod models;\npub mod oauth;\npub mod session;\npub mod session_builder;\npub mod settings;\npub mod utils;\n\n// Re-export commonly used items\npub use handlers::{\n    health, oauth_callback, oauth_debug, oauth_sign_in, oauth_sign_out,\n    oauth_userinfo,\n};\npub use models::VouchrsSession;\npub use oauth::OAuthConfig;\npub use session::SessionManager;\npub use settings::VouchrsSettings;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","main.rs"],"content":"#![warn(clippy::pedantic)]\n#![warn(clippy::cargo)]\n#![deny(warnings)]\n#![allow(clippy::multiple_crate_versions)]\n\n\nuse actix_cors::Cors;\nuse actix_web::{middleware::Logger, web, App, HttpServer};\nuse vouchrs::{\n    handlers::{\n        health, oauth_callback, oauth_debug, oauth_sign_in, oauth_sign_out,\n        oauth_userinfo, serve_static, proxy_upstream\n    },\n    oauth::OAuthConfig,\n    session::SessionManager,\n    settings::VouchrsSettings,\n};\n\n#[actix_web::main]\nasync fn main() -\u003e std::io::Result\u003c()\u003e {\n    // Load configuration from Settings.toml and environment variables\n    // This also loads .env file and initializes the logger\n    let settings = VouchrsSettings::load()\n        .map_err(|e| std::io::Error::other(format!(\"Failed to load settings: {e}\")))?;\n\n    // Initialize OAuth configuration with config-driven providers\n    let mut oauth_config = OAuthConfig::new();\n    oauth_config\n        .initialize_from_settings(\u0026settings)\n        .await\n        .map_err(|e| {\n            std::io::Error::other(format!(\"Failed to initialize OAuth providers: {e}\"))\n        })?;\n\n    println!(\"âœ“ Using stateless sessions with encrypted cookies\");\n    start_server(oauth_config, settings).await\n}\n\n/// Start the server with stateless sessions\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Server binding fails\n/// - Server fails to start\nasync fn start_server(\n    oauth_config: OAuthConfig,\n    settings: VouchrsSettings,\n) -\u003e std::io::Result\u003c()\u003e {\n    let bind_address = settings.get_bind_address();\n    print_startup_info(\u0026bind_address, \"Stateless\", \u0026settings);\n\n    // Initialize session manager with encryption key from settings\n    let session_manager = SessionManager::new(\n        settings.session.session_secret.as_bytes(),\n        settings.cookies.secure,\n        settings.session.session_duration_hours,\n    );\n\n    // Configure CORS for SPAs\n    let cors_origins = settings.get_cors_origins();\n\n    HttpServer::new(move || {\n        let cors_origins = cors_origins.clone();\n        let cors = Cors::default()\n            .allowed_origin_fn(move |origin, _| {\n                cors_origins\n                    .iter()\n                    .any(|allowed| allowed == origin.to_str().unwrap_or(\"\"))\n            })\n            .allowed_methods(vec![\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"])\n            .allowed_headers(vec![\"Authorization\", \"Content-Type\", \"Accept\"])\n            .supports_credentials()\n            .max_age(3600);\n\n        App::new()\n            .app_data(web::Data::new(oauth_config.clone()))\n            .app_data(web::Data::new(settings.clone()))\n            .app_data(web::Data::new(session_manager.clone()))\n            .wrap(cors)\n            .wrap(Logger::default())\n            .configure(configure_services)\n    })\n    .bind(\u0026bind_address)?\n    .run()\n    .await\n}\n\nfn configure_services(cfg: \u0026mut web::ServiceConfig) {\n    cfg\n        // OAuth2 endpoints \n        .route(\"/oauth2/sign_in\", web::get().to(oauth_sign_in))\n        .route(\"/oauth2/sign_out\", web::get().to(oauth_sign_out))\n        .route(\"/oauth2/sign_out\", web::post().to(oauth_sign_out))\n        .route(\"/oauth2/callback\", web::get().to(oauth_callback))\n        .route(\"/oauth2/callback\", web::post().to(oauth_callback))\n        .route(\"/oauth2/debug\", web::get().to(oauth_debug))\n        .route(\"/oauth2/userinfo\", web::get().to(oauth_userinfo))\n        // Static files endpoint\n        .route(\"/oauth2/static/{filename:.*}\", web::get().to(serve_static))\n        // Health endpoint\n        .route(\"/ping\", web::get().to(health))\n        // Catch-all proxy for any other path - provider determined from session\n        .default_service(\n            web::route()\n                .guard(actix_web::guard::fn_guard(|req| {\n                    let path = req.head().uri.path();\n                    !path.starts_with(\"/oauth2\") \u0026\u0026 !path.starts_with(\"/ping\")\n                }))\n                .to(proxy_upstream),\n        );\n}\n\nfn print_startup_info(bind_address: \u0026str, session_backend: \u0026str, settings: \u0026VouchrsSettings) {\n    println!(\n        \"Starting Vouchrs OIDC Reverse Proxy on http://{bind_address}\"\n    );\n    println!(\"Session Backend: {session_backend}\");\n    println!();\n    println!(\"OAuth2 endpoints:\");\n    println!(\"  GET  /oauth2/sign_in  - Login/logout page\");\n    println!(\"  GET|POST /oauth2/sign_out - Clear session\");\n    println!(\"  GET|POST /oauth2/callback - OAuth callback (POST for Apple form_post)\");\n    println!();\n    println!(\"OAuth callback URL for identity providers:\");\n    println!(\n        \"  {}/oauth2/callback\",\n        settings.application.redirect_base_url\n    );\n    println!();\n    if session_backend == \"Stateless\" {\n        println!(\"Sidecar Proxy endpoints (with automatic OAuth token injection):\");\n        println!(\"  ALL {{any path}}                   - Proxy to upstream service as-is\");\n        println!(\"                                    (except /oauth2/* and /health)\");\n        println!(\n            \"                                    Upstream URL: {}\",\n            settings.proxy.upstream_url\n        );\n        println!();\n    }\n    println!(\"System endpoints:\");\n    println!(\"  GET  /ping            - Health check\");\n    println!(\"  GET  /oauth2/static/* - Static files (HTML, CSS, JS, images)\");\n    println!(\n        \"  Static files folder: {}\",\n        settings.static_files.assets_folder\n    );\n}\n","traces":[{"line":23,"address":[2631116,2631660,2631256,2631339],"length":1,"stats":{"Line":0}},{"line":24,"address":[2632670,2631323,2632640],"length":1,"stats":{"Line":0}},{"line":27,"address":[2631432],"length":1,"stats":{"Line":0}},{"line":28,"address":[2631496,2631598,2632071,2631919,2632364,2631978],"length":1,"stats":{"Line":0}},{"line":30,"address":[2631758,2631628,2631591,2631162,2631951],"length":1,"stats":{"Line":0}},{"line":31,"address":[2632880,2633077],"length":1,"stats":{"Line":0}},{"line":32,"address":[2632895,2632955],"length":1,"stats":{"Line":0}},{"line":35,"address":[2632097],"length":1,"stats":{"Line":0}},{"line":36,"address":[2792039],"length":1,"stats":{"Line":0}},{"line":46,"address":[2392896],"length":1,"stats":{"Line":0}},{"line":50,"address":[2627197],"length":1,"stats":{"Line":0}},{"line":51,"address":[2627321,2627411],"length":1,"stats":{"Line":0}},{"line":55,"address":[2627445],"length":1,"stats":{"Line":0}},{"line":56,"address":[2627487],"length":1,"stats":{"Line":0}},{"line":57,"address":[2627502],"length":1,"stats":{"Line":0}},{"line":61,"address":[2627528],"length":1,"stats":{"Line":0}},{"line":63,"address":[2630524,2628235,2628944,2628658,2628323,2627929,2627562,2630647,2628033],"length":1,"stats":{"Line":0}},{"line":64,"address":[2628974],"length":1,"stats":{"Line":0}},{"line":65,"address":[2629067,2629185,2629458,2629777,2629730],"length":1,"stats":{"Line":0}},{"line":66,"address":[2630688,2629127],"length":1,"stats":{"Line":0}},{"line":67,"address":[2630712],"length":1,"stats":{"Line":0}},{"line":69,"address":[2630782,2630768],"length":1,"stats":{"Line":0}},{"line":71,"address":[2629497,2630625,2629210,2629222],"length":1,"stats":{"Line":0}},{"line":72,"address":[2629535,2629523,2630603,2629769],"length":1,"stats":{"Line":0}},{"line":74,"address":[2629823],"length":1,"stats":{"Line":0}},{"line":76,"address":[2629831,2630123,2630418,2629986,2630347,2630263,2630470],"length":1,"stats":{"Line":0}},{"line":77,"address":[2630022,2629923,2629896,2630574],"length":1,"stats":{"Line":0}},{"line":78,"address":[2630159,2630556,2630038,2630057],"length":1,"stats":{"Line":0}},{"line":79,"address":[2630197,2630294,2630175,2630538],"length":1,"stats":{"Line":0}},{"line":80,"address":[2630354,2630302],"length":1,"stats":{"Line":0}},{"line":81,"address":[2630454,2630514,2630362,2630377],"length":1,"stats":{"Line":0}},{"line":84,"address":[2628010,2627898],"length":1,"stats":{"Line":0}},{"line":86,"address":[2628288,2628682,2628486,2628228,2627260],"length":1,"stats":{"Line":0}},{"line":89,"address":[2394085,2394053,2392976],"length":1,"stats":{"Line":0}},{"line":90,"address":[2393876,2392996,2394032,2393279,2393361,2393673,2393166,2393772,2393561,2393469,2393065],"length":1,"stats":{"Line":0}},{"line":92,"address":[2393004],"length":1,"stats":{"Line":0}},{"line":93,"address":[2393123],"length":1,"stats":{"Line":0}},{"line":94,"address":[2393198],"length":1,"stats":{"Line":0}},{"line":95,"address":[2393310],"length":1,"stats":{"Line":0}},{"line":96,"address":[2393404],"length":1,"stats":{"Line":0}},{"line":97,"address":[2393506],"length":1,"stats":{"Line":0}},{"line":98,"address":[2393610],"length":1,"stats":{"Line":0}},{"line":100,"address":[2393717],"length":1,"stats":{"Line":0}},{"line":102,"address":[2393821],"length":1,"stats":{"Line":0}},{"line":105,"address":[2393964,2394003,2393898],"length":1,"stats":{"Line":0}},{"line":106,"address":[2393923],"length":1,"stats":{"Line":0}},{"line":107,"address":[2630875],"length":1,"stats":{"Line":0}},{"line":108,"address":[2630918],"length":1,"stats":{"Line":0}},{"line":114,"address":[2394096],"length":1,"stats":{"Line":0}},{"line":115,"address":[2394136],"length":1,"stats":{"Line":0}},{"line":118,"address":[2394206],"length":1,"stats":{"Line":0}},{"line":119,"address":[2394300],"length":1,"stats":{"Line":0}},{"line":120,"address":[2394335],"length":1,"stats":{"Line":0}},{"line":121,"address":[2394370],"length":1,"stats":{"Line":0}},{"line":122,"address":[2394405],"length":1,"stats":{"Line":0}},{"line":123,"address":[2394440],"length":1,"stats":{"Line":0}},{"line":124,"address":[2394475],"length":1,"stats":{"Line":0}},{"line":125,"address":[2394510],"length":1,"stats":{"Line":0}},{"line":126,"address":[2394550],"length":1,"stats":{"Line":0}},{"line":130,"address":[2394643],"length":1,"stats":{"Line":0}},{"line":131,"address":[2394678],"length":1,"stats":{"Line":0}},{"line":132,"address":[2394915],"length":1,"stats":{"Line":0}},{"line":133,"address":[2394950],"length":1,"stats":{"Line":0}},{"line":134,"address":[2394985],"length":1,"stats":{"Line":0}},{"line":135,"address":[2395025],"length":1,"stats":{"Line":0}},{"line":139,"address":[2395118],"length":1,"stats":{"Line":0}},{"line":141,"address":[2394704],"length":1,"stats":{"Line":0}},{"line":142,"address":[2394739],"length":1,"stats":{"Line":0}},{"line":143,"address":[2394774],"length":1,"stats":{"Line":0}},{"line":144,"address":[2394814],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":70},{"path":["/","workspaces","vouchrs","src","models.rs"],"content":"use chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\n\n#[derive(Serialize, Deserialize)]\npub struct HealthResponse {\n    pub status: String,\n    pub message: String,\n}\n\n/// User data structure for the `vouchrs_user` cookie\n/// Contains only essential user information (not JWT metadata)\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct VouchrsUserData {\n    pub email: String,\n    pub name: Option\u003cString\u003e,\n    pub provider: String,\n    pub provider_id: String,\n    pub client_ip: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub platform: Option\u003cString\u003e,\n    pub lang: Option\u003cString\u003e,\n    pub mobile: i32,\n    pub session_start: Option\u003ci64\u003e,\n}\n\n/// Session structure containing only essential token data for cookies\n/// User data is now stored separately in the `vouchrs_user` cookie\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct VouchrsSession {\n    pub id_token: Option\u003cString\u003e,\n    pub refresh_token: Option\u003cString\u003e,\n    pub provider: String,\n    pub expires_at: DateTime\u003cUtc\u003e,\n}\n\nimpl VouchrsSession {\n    /// Check if tokens need refresh (within 5 minutes of expiry)\n    #[must_use]\n    pub fn needs_refresh(\u0026self) -\u003e bool {\n        let now = chrono::Utc::now();\n        let buffer_minutes = chrono::Duration::minutes(5);\n        self.expires_at \u003c= now + buffer_minutes\n    }\n}\n\n/// Complete session data structure used during OAuth flow\n/// Contains both user data and token data before splitting into separate cookies\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct CompleteSessionData {\n    pub user_email: String,\n    pub user_name: Option\u003cString\u003e,\n    pub provider: String,\n    pub provider_id: String,\n    pub id_token: Option\u003cString\u003e,\n    pub refresh_token: Option\u003cString\u003e,\n    pub expires_at: DateTime\u003cUtc\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl CompleteSessionData {\n    /// Extract token data as `VouchrsSession`\n    #[must_use]\n    pub fn to_session(\u0026self) -\u003e VouchrsSession {\n        VouchrsSession {\n            id_token: self.id_token.clone(),\n            refresh_token: self.refresh_token.clone(),\n            provider: self.provider.clone(),\n            expires_at: self.expires_at,\n        }\n    }\n\n    /// Extract user data as `VouchrsUserData` with additional context\n    #[must_use]\n    pub fn to_user_data(\n        \u0026self,\n        client_ip: Option\u003c\u0026str\u003e,\n        user_agent_info: Option\u003c\u0026crate::utils::user_agent::UserAgentInfo\u003e,\n    ) -\u003e VouchrsUserData {\n        VouchrsUserData {\n            email: self.user_email.clone(),\n            name: self.user_name.clone(),\n            provider: self.provider.clone(),\n            provider_id: self.provider_id.clone(),\n            client_ip: client_ip.map(std::string::ToString::to_string),\n            user_agent: user_agent_info.and_then(|ua| ua.user_agent.clone()),\n            platform: user_agent_info.and_then(|ua| ua.platform.clone()),\n            lang: user_agent_info.and_then(|ua| ua.lang.clone()),\n            mobile: user_agent_info.map_or(0, |ua| i32::from(ua.mobile)),\n            session_start: Some(self.created_at.timestamp()), // Convert created_at to Unix timestamp\n        }\n    }\n}\n","traces":[{"line":39,"address":[3058272],"length":1,"stats":{"Line":0}},{"line":40,"address":[3593069],"length":1,"stats":{"Line":0}},{"line":41,"address":[4389112],"length":1,"stats":{"Line":0}},{"line":42,"address":[3669803],"length":1,"stats":{"Line":0}},{"line":63,"address":[3669872,3670199,3670193],"length":1,"stats":{"Line":0}},{"line":65,"address":[3669902],"length":1,"stats":{"Line":0}},{"line":66,"address":[4389279],"length":1,"stats":{"Line":0}},{"line":67,"address":[4389338],"length":1,"stats":{"Line":0}},{"line":68,"address":[3058595],"length":1,"stats":{"Line":0}},{"line":74,"address":[3059739,3058752,3059745],"length":1,"stats":{"Line":0}},{"line":80,"address":[3058821],"length":1,"stats":{"Line":0}},{"line":81,"address":[3670312],"length":1,"stats":{"Line":0}},{"line":82,"address":[3670378],"length":1,"stats":{"Line":0}},{"line":83,"address":[3670441],"length":1,"stats":{"Line":0}},{"line":84,"address":[3670512],"length":1,"stats":{"Line":0}},{"line":85,"address":[2872688,2872672],"length":1,"stats":{"Line":0}},{"line":86,"address":[3251440,3251456],"length":1,"stats":{"Line":0}},{"line":87,"address":[3650896,3650912],"length":1,"stats":{"Line":0}},{"line":88,"address":[2872800,2872809],"length":1,"stats":{"Line":0}},{"line":89,"address":[3594147],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","workspaces","vouchrs","src","oauth.rs"],"content":"// Config-driven OAuth implementation using provider configurations from settings\n// Supports dynamic discovery endpoints and customizable provider configurations\n\n// Standard library imports\nuse std::collections::HashMap;\nuse std::env;\n\n// Third-party imports\nuse actix_web::HttpResponse;\nuse base64::Engine as _;\nuse chrono::Utc;\nuse log::debug;\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\n\n// Local imports\nuse crate::models::VouchrsSession;\nuse crate::settings::{ProviderSettings, VouchrsSettings};\nuse crate::utils::apple;\nuse crate::utils::logging::LoggingHelper;\n\n// ============================================================================\n// Error Types\n// ============================================================================\n\n/// Error types for OAuth operations\n#[derive(Debug)]\npub enum OAuthError {\n    Configuration(String),\n    Network(String),\n    InvalidResponse(String),\n}\n\nimpl std::fmt::Display for OAuthError {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            Self::Configuration(msg) =\u003e write!(f, \"Configuration error: {msg}\"),\n            Self::Network(msg) =\u003e write!(f, \"Network error: {msg}\"),\n            Self::InvalidResponse(msg) =\u003e write!(f, \"Invalid response: {msg}\"),\n        }\n    }\n}\n\nimpl std::error::Error for OAuthError {}\n\n// ============================================================================\n// Core Data Structures\n// ============================================================================\n\n/// OAuth callback structure for handling responses from OAuth providers\n#[derive(Deserialize, Debug)]\npub struct OAuthCallback {\n    pub code: Option\u003cString\u003e,\n    pub state: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n    pub user: Option\u003cserde_json::Value\u003e, // Apple sends user info in form POST on first login\n}\n\n/// OAuth state structure for CSRF protection and flow tracking\n#[derive(Serialize, Deserialize, Debug)]\npub struct OAuthState {\n    pub state: String,\n    pub provider: String,\n    pub redirect_url: Option\u003cString\u003e,\n}\n\n/// OAuth tokens structure for session management\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct OAuthTokens {\n    pub token_type: String,\n    pub scope: Option\u003cString\u003e,\n}\n\n// ============================================================================\n// Internal Structures\n// ============================================================================\n\n/// Apple JWT claims structure for client secret generation\n#[derive(Debug, Serialize, Deserialize)]\nstruct AppleJwtClaims {\n    iss: String, // Team ID\n    iat: i64,    // Issued at time\n    exp: i64,    // Expiration time\n    aud: String, // Audience (always \"https://appleid.apple.com\")\n    sub: String, // Client ID\n}\n\n/// Token response structure from OAuth providers\n#[derive(Debug, Deserialize)]\nstruct TokenResponse {\n    refresh_token: Option\u003cString\u003e,\n    id_token: Option\u003cString\u003e,\n    token_type: String,\n    expires_in: Option\u003cu64\u003e,\n    user: Option\u003capple::AppleUserInfo\u003e, // Apple-specific user info field\n}\n\n// ============================================================================\n// Provider Configuration\n// ============================================================================\n\n/// Runtime provider configuration with resolved endpoints\n#[derive(Debug, Clone)]\npub struct RuntimeProvider {\n    pub settings: ProviderSettings,\n    pub auth_url: String,\n    pub token_url: String,\n    pub client_id: Option\u003cString\u003e,\n    pub client_secret: Option\u003cString\u003e,\n}\n\nimpl RuntimeProvider {\n    /// Creates a `RuntimeProvider` from settings\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - Discovery URL cannot be resolved\n    /// - Required configuration is missing\n    /// - Network errors occur during discovery\n    pub async fn from_settings(settings: ProviderSettings) -\u003e Result\u003cSelf, String\u003e {\n        // Use the new getter methods instead of direct environment variable access\n        let client_id = settings.get_client_id();\n        let client_secret = settings.get_client_secret();\n\n        // Resolve endpoints from discovery URL or use direct URLs\n        let (auth_url, token_url) = if let Some(ref discovery_url) = settings.discovery_url {\n            Self::resolve_from_discovery(discovery_url).await?\n        } else {\n            let auth_url = settings.authorization_endpoint.clone().ok_or_else(|| {\n                format!(\"Provider {} missing authorization_endpoint\", settings.name)\n            })?;\n            let token_url = settings\n                .token_endpoint\n                .clone()\n                .ok_or_else(|| format!(\"Provider {} missing token_endpoint\", settings.name))?;\n            (auth_url, token_url)\n        };\n\n        Ok(Self {\n            settings,\n            auth_url,\n            token_url,\n            client_id,\n            client_secret,\n        })\n    }\n\n    /// Resolve authorization and token endpoints from discovery URL\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Network request to discovery URL fails\n    /// - Response cannot be parsed as JSON\n    /// - Required endpoints are missing from discovery document\n    async fn resolve_from_discovery(discovery_url: \u0026str) -\u003e Result\u003c(String, String), String\u003e {\n        let resp = reqwest::get(discovery_url)\n            .await\n            .map_err(|e| e.to_string())?;\n        let doc: serde_json::Value = resp.json().await.map_err(|e| e.to_string())?;\n        let auth_url = doc[\"authorization_endpoint\"]\n            .as_str()\n            .ok_or_else(|| \"Missing authorization_endpoint in discovery document\".to_string())?\n            .to_string();\n        let token_url = doc[\"token_endpoint\"]\n            .as_str()\n            .ok_or_else(|| \"Missing token_endpoint in discovery document\".to_string())?\n            .to_string();\n        Ok((auth_url, token_url))\n    }\n\n    /// Check if the provider is properly configured\n    #[must_use]\n    pub const fn is_configured(\u0026self) -\u003e bool {\n        self.client_id.is_some()\n            \u0026\u0026 (self.client_secret.is_some() || self.settings.jwt_signing.is_some())\n    }\n}\n\n// ============================================================================\n// Type Aliases\n// ============================================================================\n\n/// Result type for token exchange operations\n/// Returns (`id_token`, `refresh_token`, `expires_at`, `apple_user_info_fallback`)\ntype TokenExchangeResult = Result\u003c\n    (\n        Option\u003cString\u003e,\n        Option\u003cString\u003e,\n        chrono::DateTime\u003cUtc\u003e,\n        Option\u003capple::AppleUserInfo\u003e,\n    ),\n    String,\n\u003e;\n\n// ============================================================================\n// OAuth Configuration\n// ============================================================================\n\n/// Config-driven OAuth configuration with multiple provider support\n#[derive(Clone)]\npub struct OAuthConfig {\n    pub providers: HashMap\u003cString, RuntimeProvider\u003e,\n    pub redirect_base_url: String,\n    http_client: reqwest::Client,\n}\n\nimpl Default for OAuthConfig {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl OAuthConfig {\n    /// Create a new OAuth configuration\n    #[must_use]\n    pub fn new() -\u003e Self {\n        let redirect_base_url =\n            env::var(\"REDIRECT_BASE_URL\").unwrap_or_else(|_| \"http://localhost:8080\".to_string());\n\n        Self {\n            providers: HashMap::new(),\n            redirect_base_url,\n            http_client: reqwest::Client::new(),\n        }\n    }\n\n    /// Initialize providers from settings\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - Provider validation fails for any enabled provider\n    /// - Required environment variables are missing for enabled providers\n    /// - Provider configuration is invalid or incomplete\n    /// - No providers are successfully configured\n    pub async fn initialize_from_settings(\n        \u0026mut self,\n        settings: \u0026VouchrsSettings,\n    ) -\u003e Result\u003c(), String\u003e {\n        LoggingHelper::log_oauth_provider_initialization();\n\n        for provider_settings in \u0026settings.providers {\n            if !provider_settings.enabled {\n                LoggingHelper::log_oauth_provider_disabled(\u0026provider_settings.name);\n                continue;\n            }\n\n            match RuntimeProvider::from_settings(provider_settings.clone()).await {\n                Ok(runtime_provider) =\u003e {\n                    if runtime_provider.is_configured() {\n                        LoggingHelper::log_oauth_provider_configured(\n                            provider_settings\n                                .display_name\n                                .as_deref()\n                                .unwrap_or(\u0026provider_settings.name),\n                            \u0026provider_settings.name,\n                        );\n                        self.providers\n                            .insert(provider_settings.name.clone(), runtime_provider);\n                    } else {\n                        LoggingHelper::log_oauth_provider_not_configured(\n                            provider_settings\n                                .display_name\n                                .as_deref()\n                                .unwrap_or(\u0026provider_settings.name),\n                        );\n                    }\n                }\n                Err(e) =\u003e {\n                    log::error!(\n                        \"âŒ Failed to initialize provider {}: {e}\",\n                        provider_settings.name\n                    );\n                }\n            }\n        }\n        if self.providers.is_empty() {\n            return Err(\"No OAuth providers are configured. Please configure at least one provider in Settings.toml and set the required environment variables.\".to_string());\n        }\n        let provider_names: Vec\u003c_\u003e = self.providers.keys().collect();\n        LoggingHelper::log_oauth_providers_summary(\u0026provider_names);\n\n        Ok(())\n    }\n\n    /// Check if a provider's client is configured\n    #[must_use]\n    pub fn get_client_configured(\u0026self, provider: \u0026str) -\u003e bool {\n        self.providers\n            .get(provider)\n            .is_some_and(RuntimeProvider::is_configured)\n    }\n\n    /// Get the authorization URL for a provider\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - The specified provider is not configured\n    /// - The client ID is not configured for the provider\n    /// - The authorization URL is malformed\n    pub fn get_auth_url(\u0026self, provider: \u0026str, state: \u0026str) -\u003e Result\u003cString, String\u003e {\n        let runtime_provider = self\n            .providers\n            .get(provider)\n            .ok_or_else(|| format!(\"Provider {provider} not configured\"))?;\n\n        // Get client ID using the new getter method\n        let client_id = runtime_provider\n            .settings\n            .get_client_id()\n            .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n\n        // Build authorization URL\n        let redirect_uri = format!(\"{}/oauth2/callback\", self.redirect_base_url);\n        let scopes = runtime_provider.settings.scopes.join(\" \");\n\n        // Start with base parameters\n        let mut url = url::Url::parse(\u0026runtime_provider.auth_url).map_err(|e| e.to_string())?;\n        url.query_pairs_mut()\n            .append_pair(\"client_id\", \u0026client_id)\n            .append_pair(\"redirect_uri\", \u0026redirect_uri)\n            .append_pair(\"response_type\", \"code\")\n            .append_pair(\"scope\", \u0026scopes)\n            .append_pair(\"state\", state);\n\n        // Add provider-specific extra parameters\n        for (key, value) in \u0026runtime_provider.settings.extra_auth_params {\n            url.query_pairs_mut().append_pair(key, value);\n        }\n\n        LoggingHelper::log_oauth_url_built(\n            provider,\n            \u0026scopes,\n            \u0026runtime_provider.settings.extra_auth_params,\n        );\n\n        Ok(url.to_string())\n    }\n\n    /// Exchange OAuth authorization code for OAuth tokens\n    /// This manually handles the token exchange to properly capture ID tokens\n    /// Returns (`id_token`, `refresh_token`, `expires_at`, `Option\u003cAppleUserInfo\u003e`) for Apple user info fallback\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Provider is not configured\n    /// - Client credentials are missing\n    /// - Token exchange request fails\n    /// - Response parsing fails\n    pub async fn exchange_code_for_tokens(\n        \u0026self,\n        provider: \u0026str,\n        code: \u0026str,\n    ) -\u003e TokenExchangeResult {\n        let runtime_provider = self\n            .providers\n            .get(provider)\n            .ok_or_else(|| format!(\"Provider {provider} not configured\"))?;\n\n        // Prepare token exchange parameters\n        let params = self.prepare_token_exchange_params(provider, code, runtime_provider)?;\n\n        // Execute token exchange request\n        let response_text = self.execute_token_exchange(provider, runtime_provider, \u0026params).await?;\n\n        // Parse and process the token response\n        Self::process_token_response(provider, \u0026response_text)\n    }\n\n    /// Prepare parameters for token exchange request\n    fn prepare_token_exchange_params(\n        \u0026self,\n        provider: \u0026str,\n        code: \u0026str,\n        runtime_provider: \u0026RuntimeProvider,\n    ) -\u003e Result\u003cHashMap\u003cString, String\u003e, String\u003e {\n        let redirect_uri = format!(\"{}/oauth2/callback\", self.redirect_base_url);\n        let mut params = HashMap::new();\n        \n        // Basic OAuth parameters\n        params.insert(\"grant_type\".to_string(), \"authorization_code\".to_string());\n        params.insert(\"code\".to_string(), code.to_string());\n        params.insert(\"redirect_uri\".to_string(), redirect_uri);\n\n        // Client credentials\n        let client_id = runtime_provider\n            .settings\n            .get_client_id()\n            .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n\n        params.insert(\"client_id\".to_string(), client_id);\n\n        // Handle client secret or JWT signing\n        if let Some(ref secret) = runtime_provider.client_secret {\n            // Regular OAuth with client secret\n            params.insert(\"client_secret\".to_string(), secret.clone());\n        } else if let Some(ref jwt_config) = runtime_provider.settings.jwt_signing {\n            // JWT signing (Apple)\n            let client_id = runtime_provider\n                .settings\n                .get_client_id()\n                .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n            let client_secret = crate::utils::apple::generate_jwt_client_secret(jwt_config, \u0026client_id)?;\n            params.insert(\"client_secret\".to_string(), client_secret);\n        } else {\n            return Err(\"No client secret or JWT signing configuration for provider\".to_string());\n        }\n\n        Ok(params)\n    }\n\n    /// Execute the token exchange HTTP request\n    async fn execute_token_exchange(\n        \u0026self,\n        provider: \u0026str,\n        runtime_provider: \u0026RuntimeProvider,\n        params: \u0026HashMap\u003cString, String\u003e,\n    ) -\u003e Result\u003cString, String\u003e {\n        LoggingHelper::log_token_exchange_start(provider);\n        \n        let response = self\n            .http_client\n            .post(\u0026runtime_provider.token_url)\n            .form(params)\n            .send()\n            .await\n            .map_err(|e| format!(\"Failed to exchange code for token: {e}\"))?;\n\n        let status = response.status();\n        if !status.is_success() {\n            let error_text = response\n                .text()\n                .await\n                .unwrap_or_else(|_| \"Unknown error\".to_string());\n            return Err(format!(\n                \"Token exchange failed with status {status}: {error_text}\"\n            ));\n        }\n\n        response\n            .text()\n            .await\n            .map_err(|e| format!(\"Failed to read response text: {e}\"))\n    }\n\n    /// Process the token response and extract relevant information\n    fn process_token_response(\n        provider: \u0026str,\n        response_text: \u0026str,\n    ) -\u003e TokenExchangeResult {\n        // Log the raw token response for debugging\n        if provider == \"apple\" {\n            LoggingHelper::log_apple_token_response_raw(response_text);\n        } else {\n            LoggingHelper::log_token_response_raw(provider, response_text);\n        }\n\n        let token_response: TokenResponse = serde_json::from_str(response_text)\n            .map_err(|e| format!(\"Failed to parse token response: {e}\"))?;\n\n        // Calculate token expiration\n        let expires_at = token_response.expires_in.map_or_else(|| {\n            // Default to 1 hour if no expiration provided\n            Utc::now() + chrono::Duration::hours(1)\n        }, |expires_in| {\n            Utc::now() + chrono::Duration::seconds(i64::try_from(expires_in).unwrap_or(3600))\n        });\n\n        // Log detailed information about what we extracted\n        LoggingHelper::log_token_exchange_summary(\n            provider,\n            token_response.refresh_token.as_ref(),\n            token_response.id_token.as_ref(),\n            \u0026token_response.token_type,\n            token_response.expires_in.map(|v| i64::try_from(v).unwrap_or(3600)),\n        );\n\n        Ok((\n            token_response.id_token,\n            token_response.refresh_token,\n            expires_at,\n            token_response.user,\n        ))\n    }\n\n    /// Get the signout URL for a provider\n    #[must_use]\n    pub fn get_signout_url(\u0026self, provider: \u0026str) -\u003e Option\u003cString\u003e {\n        self.providers\n            .get(provider)\n            .and_then(|p| p.settings.signout_url.clone())\n    }\n\n    /// Get list of enabled provider names\n    #[must_use]\n    pub fn get_enabled_providers(\u0026self) -\u003e Vec\u003c\u0026str\u003e {\n        self.providers.keys().map(std::string::String::as_str).collect()\n    }\n\n    /// Get provider display name\n    #[must_use]\n    pub fn get_provider_display_name(\u0026self, provider: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n        self.providers\n            .get(provider)\n            .and_then(|p| p.settings.display_name.as_deref())\n    }\n}\n\n\n\n// ============================================================================\n// Token Management Functions\n// ============================================================================\n\n// Static HTTP client for making token refresh requests\nstatic CLIENT: std::sync::LazyLock\u003creqwest::Client\u003e =\n    std::sync::LazyLock::new(reqwest::Client::new);\n\n/// Check if tokens need refresh and refresh them if necessary\n/// \n/// # Errors\n/// \n/// Returns an `HttpResponse` error if:\n/// - Tokens are expired and no refresh token is available\n/// - Token refresh fails\npub async fn check_and_refresh_tokens(\n    mut session: VouchrsSession,\n    oauth_config: \u0026OAuthConfig,\n    provider: \u0026str,\n) -\u003e Result\u003cVouchrsSession, HttpResponse\u003e {\n    // Check if tokens need refresh (within 5 minutes of expiry)\n    let now = chrono::Utc::now();\n    let buffer_time = chrono::Duration::minutes(5);\n    if session.expires_at \u003e now + buffer_time {\n        return Ok(session);\n    }\n\n    // Attempt to refresh tokens\n    let refresh_token = session.refresh_token.as_ref().ok_or_else(|| {\n        HttpResponse::Unauthorized().json(serde_json::json!({\n            \"error\": \"unauthorized\",\n            \"message\": \"OAuth tokens expired and no refresh token available. Please re-authenticate.\"\n        }))\n    })?;\n\n    // Call refresh_oauth_tokens and update session fields\n    match refresh_tokens(refresh_token, oauth_config, provider).await {\n        Ok((new_id_token, new_refresh_token, new_expires_at)) =\u003e {\n            session.id_token = new_id_token;\n            session.refresh_token = new_refresh_token;\n            session.expires_at = new_expires_at;\n            Ok(session)\n        }\n        Err(err) =\u003e Err(HttpResponse::Unauthorized().json(serde_json::json!({\n            \"error\": \"token_refresh_failed\",\n            \"message\": format!(\"Failed to refresh OAuth tokens: {err}\")\n        }))),\n    }\n}\n\n/// Refresh OAuth tokens using the refresh token\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Provider is not configured\n/// - Client credentials are missing or cannot be generated\n/// - Token refresh request fails\n/// - Response parsing fails\npub async fn refresh_tokens(\n    refresh_token: \u0026str,\n    oauth_config: \u0026OAuthConfig,\n    provider: \u0026str,\n) -\u003e Result\u003c\n    (\n        Option\u003cString\u003e,\n        Option\u003cString\u003e,\n        chrono::DateTime\u003cchrono::Utc\u003e,\n    ),\n    String,\n\u003e {\n    // Get provider configuration\n    let runtime_provider = oauth_config\n        .providers\n        .get(provider)\n        .ok_or_else(|| format!(\"Provider {provider} not configured\"))?;\n\n    let client_id = runtime_provider\n        .client_id\n        .as_ref()\n        .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n\n    // Handle client credentials based on provider configuration\n    let client_secret = if let Some(ref secret) = runtime_provider.client_secret {\n        secret.clone()\n    } else if let Some(ref jwt_config) = runtime_provider.settings.jwt_signing {\n        // Generate JWT client secret for Apple\n        let client_id = runtime_provider\n            .settings\n            .get_client_id()\n            .ok_or_else(|| format!(\"Client ID not configured for provider {provider}\"))?;\n        apple::generate_jwt_client_secret(jwt_config, \u0026client_id)\n            .map_err(|e| format!(\"Failed to generate client secret: {e}\"))?\n    } else {\n        return Err(format!(\n            \"No client secret or JWT signing configuration for provider {provider}\"\n        ));\n    };\n\n    let params = [\n        (\"grant_type\", \"refresh_token\"),\n        (\"refresh_token\", refresh_token),\n        (\"client_id\", client_id.as_str()),\n        (\"client_secret\", client_secret.as_str()),\n    ];\n\n    let response = CLIENT\n        .post(\u0026runtime_provider.token_url)\n        .form(\u0026params)\n        .send()\n        .await\n        .map_err(|e| format!(\"HTTP request failed: {e}\"))?;\n\n    if !response.status().is_success() {\n        let status = response.status();\n        let error_text = response\n            .text()\n            .await\n            .unwrap_or_else(|_| \"Unknown error\".to_string());\n        return Err(format!(\n            \"Token refresh failed with status {status}: {error_text}\"\n        ));\n    }\n\n    // Parse token response extracting id_token, refresh_token, expires_at\n    let token_response: Value = response\n        .json()\n        .await\n        .map_err(|e| format!(\"Failed to parse token response: {e}\"))?;\n\n    let expires_in = token_response[\"expires_in\"].as_u64().unwrap_or(3600); // Default to 1 hour\n\n    let new_refresh_token = token_response[\"refresh_token\"]\n        .as_str()\n        .map(ToString::to_string);\n\n    let new_id_token = token_response[\"id_token\"].as_str().map(ToString::to_string);\n\n    let new_expires_at = chrono::Utc::now() + chrono::Duration::seconds(i64::try_from(expires_in).unwrap_or(3600));\n\n    Ok((new_id_token, new_refresh_token, new_expires_at))\n}\n\n// ============================================================================\n// Utility Functions\n// ============================================================================\n\n// ============================================================================\n// OAuth State Management\n// ============================================================================\n\n/// Parse OAuth state from received state parameter and retrieve stored state from cookie\n/// This eliminates provider-specific branching logic by using the stored OAuth state\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - The received state does not match the stored CSRF token\n/// - No stored state is found and encrypted state decryption fails\n/// - The encrypted state format is invalid\npub fn get_state_from_callback(\n    received_state: \u0026str,\n    session_manager: \u0026crate::session::SessionManager,\n    req: \u0026actix_web::HttpRequest,\n) -\u003e Result\u003ccrate::oauth::OAuthState, String\u003e {\n    debug!(\"Received OAuth state parameter: length = {} characters\", received_state.len());\n\n    // First, try to get the stored OAuth state from temporary cookie (legacy compatibility)\n    match session_manager.get_temporary_state_from_request(req) {\n        Ok(Some(stored_state)) =\u003e {\n            // For legacy cookie-based state, verify the received state matches the stored CSRF token\n            if stored_state.state == received_state {\n                debug!(\n                    \"OAuth state verified: stored state matches received state for provider {}\",\n                    stored_state.provider\n                );\n                Ok(stored_state)\n            } else {\n                Err(\n                    \"OAuth state mismatch: received state does not match stored CSRF token\"\n                        .to_string(),\n                )\n            }\n        }\n        Ok(None) =\u003e {\n            // ðŸ”’ SECURITY: Try to decrypt the received state parameter\n            // This prevents tampering with provider name or redirect URL\n            match session_manager.decrypt_data::\u003ccrate::oauth::OAuthState\u003e(received_state) {\n                Ok(decrypted_state) =\u003e {\n                    debug!(\n                        \"Successfully decrypted OAuth state for provider: {}\",\n                        decrypted_state.provider\n                    );\n                    Ok(decrypted_state)\n                }\n                Err(e) =\u003e {\n                    debug!(\"Failed to decrypt OAuth state: {e}\");\n                    // Fallback: Try parsing as legacy plain-text state (for backwards compatibility)\n                    parse_stateless_oauth_state(received_state)\n                }\n            }\n        }\n        Err(e) =\u003e {\n            debug!(\"Failed to retrieve stored OAuth state: {e}\");\n            // Try decrypting the state parameter directly\n            match session_manager.decrypt_data::\u003ccrate::oauth::OAuthState\u003e(received_state) {\n                Ok(decrypted_state) =\u003e {\n                    debug!(\n                        \"Successfully decrypted OAuth state for provider: {}\",\n                        decrypted_state.provider\n                    );\n                    Ok(decrypted_state)\n                }\n                Err(decrypt_error) =\u003e {\n                    debug!(\"Failed to decrypt OAuth state: {decrypt_error}\");\n                    // Final fallback: Parse as legacy plain-text state\n                    parse_stateless_oauth_state(received_state)\n                }\n            }\n        }\n    }\n}\n\n/// Parse OAuth state when no stored state is available (stateless mode)\n/// \n/// âš ï¸  **DEPRECATED \u0026 VULNERABLE**: This function is kept for backwards compatibility only.\n/// Plain-text state parameters can be tampered with by attackers to modify provider names\n/// or redirect URLs. New implementations should use encrypted state parameters.\n/// \n/// This handles cases where the provider info needs to be extracted from the state parameter itself\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - The state format is invalid (missing provider information)\n/// - Cannot determine provider from simple CSRF token in stateless mode\nfn parse_stateless_oauth_state(received_state: \u0026str) -\u003e Result\u003ccrate::oauth::OAuthState, String\u003e {\n    debug!(\n        \"Attempting to parse stateless OAuth state: '{received_state}'\"\n    );\n    debug!(\"Contains pipe character: {}\", received_state.contains('|'));\n\n    if received_state.contains('|') {\n        // New format: \"csrf_token|provider|optional_redirect\"\n        let parts: Vec\u003c\u0026str\u003e = received_state.split('|').collect();\n\n        if parts.len() \u003c 2 {\n            return Err(\"Stateless OAuth state missing provider information\".to_string());\n        }\n\n        let csrf_state = parts[0].to_string();\n        let provider = parts[1].to_string();\n\n        let redirect_url = if parts.len() \u003e 2 {\n            // Try URL_SAFE_NO_PAD first, then fallback to STANDARD for backwards compatibility\n            base64::engine::general_purpose::URL_SAFE_NO_PAD.decode(parts[2])\n                .or_else(|_| base64::engine::general_purpose::STANDARD.decode(parts[2]))\n                .map_or(None, |decoded_bytes| String::from_utf8(decoded_bytes).ok())\n        } else {\n            None\n        };\n\n        debug!(\n            \"Successfully parsed stateless OAuth state for provider: {provider}\"\n        );\n\n        Ok(crate::oauth::OAuthState {\n            state: csrf_state,\n            provider,\n            redirect_url,\n        })\n    } else {\n        // Simple CSRF token without provider or redirect URL\n        Err(\"Cannot determine provider from simple CSRF token in stateless mode\".to_string())\n    }\n}\n\n// ============================================================================\n// Tests\n// ============================================================================\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_stateless_oauth_state_simple() {\n        let result = parse_stateless_oauth_state(\"simple_csrf_token\");\n\n        // Should fail because we can't determine provider in stateless mode\n        assert!(result.is_err());\n        assert!(result.unwrap_err().contains(\"Cannot determine provider\"));\n    }\n\n    #[test]\n    fn test_parse_stateless_oauth_state_with_provider_and_redirect() {\n        let redirect_url = \"/dashboard\";\n        let encoded_redirect =\n            base64::engine::general_purpose::URL_SAFE_NO_PAD.encode(redirect_url.as_bytes());\n        let state = format!(\"csrf_token|google|{encoded_redirect}\");\n\n        let result = parse_stateless_oauth_state(\u0026state);\n\n        // Should succeed with the new format\n        assert!(result.is_ok());\n        let oauth_state = result.unwrap();\n        assert_eq!(oauth_state.state, \"csrf_token\");\n        assert_eq!(oauth_state.provider, \"google\");\n        assert_eq!(oauth_state.redirect_url, Some(redirect_url.to_string()));\n    }\n\n    #[test]\n    fn test_parse_stateless_oauth_state_with_provider_without_redirect() {\n        let state = \"csrf_token|google\";\n\n        let result = parse_stateless_oauth_state(state);\n\n        // Should succeed with the new format\n        assert!(result.is_ok());\n        let oauth_state = result.unwrap();\n        assert_eq!(oauth_state.state, \"csrf_token\");\n        assert_eq!(oauth_state.provider, \"google\");\n        assert_eq!(oauth_state.redirect_url, None);\n    }\n\n    #[test]\n    fn test_parse_stateless_oauth_state_invalid_base64() {\n        let state = \"csrf_token|google|invalid_base64!@#\";\n\n        let result = parse_stateless_oauth_state(state);\n\n        // Should succeed but ignore invalid base64 redirect URL\n        assert!(result.is_ok());\n        let oauth_state = result.unwrap();\n        assert_eq!(oauth_state.state, \"csrf_token\");\n        assert_eq!(oauth_state.provider, \"google\");\n        assert_eq!(oauth_state.redirect_url, None);\n    }\n\n    #[test]\n    fn test_encrypted_state_security_fix() {\n        use crate::session::SessionManager;\n        \n        // Create a session manager for encryption/decryption\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let session_manager = SessionManager::new(key, false, 24);\n        \n        // Create an OAuth state\n        let original_state = OAuthState {\n            state: \"csrf_token_123\".to_string(),\n            provider: \"google\".to_string(),\n            redirect_url: Some(\"/dashboard\".to_string()),\n        };\n        \n        // Encrypt the state (this is what we now do in auth.rs)\n        let encrypted_state = session_manager.encrypt_data(\u0026original_state).unwrap();\n        \n        // Verify that the encrypted state doesn't contain plain text provider info\n        assert!(!encrypted_state.contains(\"google\"));\n        assert!(!encrypted_state.contains(\"dashboard\"));\n        assert!(!encrypted_state.contains(\"csrf_token_123\"));\n        \n        // Verify that we can decrypt it back correctly\n        let decrypted_state: OAuthState = session_manager.decrypt_data(\u0026encrypted_state).unwrap();\n        assert_eq!(decrypted_state.state, original_state.state);\n        assert_eq!(decrypted_state.provider, original_state.provider);\n        assert_eq!(decrypted_state.redirect_url, original_state.redirect_url);\n    }\n\n    #[test]\n    fn test_tampered_encrypted_state_fails() {\n        use crate::session::SessionManager;\n        \n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let session_manager = SessionManager::new(key, false, 24);\n        \n        let original_state = OAuthState {\n            state: \"csrf_token_123\".to_string(),\n            provider: \"google\".to_string(),\n            redirect_url: Some(\"/dashboard\".to_string()),\n        };\n        \n        let encrypted_state = session_manager.encrypt_data(\u0026original_state).unwrap();\n        \n        // Tamper with the encrypted state by changing one character\n        let mut chars: Vec\u003cchar\u003e = encrypted_state.chars().collect();\n        if let Some(last_char) = chars.last_mut() {\n            *last_char = if *last_char == 'A' { 'B' } else { 'A' };\n        }\n        let tampered_state: String = chars.into_iter().collect();\n        \n        // Attempting to decrypt tampered state should fail\n        let result = session_manager.decrypt_data::\u003cOAuthState\u003e(\u0026tampered_state);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_legacy_plaintext_state_still_works() {\n        // Test that our fallback to legacy parsing still works for backwards compatibility\n        let legacy_state = \"csrf_token|google|L2Rhc2hib2FyZA==\"; // base64(\"/dashboard\")\n        \n        let result = parse_stateless_oauth_state(legacy_state);\n        assert!(result.is_ok());\n        \n        let oauth_state = result.unwrap();\n        assert_eq!(oauth_state.state, \"csrf_token\");\n        assert_eq!(oauth_state.provider, \"google\");\n        assert_eq!(oauth_state.redirect_url, Some(\"/dashboard\".to_string()));\n    }\n}\n","traces":[{"line":35,"address":[3039936],"length":1,"stats":{"Line":0}},{"line":36,"address":[3039968],"length":1,"stats":{"Line":0}},{"line":37,"address":[3309863],"length":1,"stats":{"Line":0}},{"line":38,"address":[3601753],"length":1,"stats":{"Line":0}},{"line":39,"address":[3310080],"length":1,"stats":{"Line":0}},{"line":121,"address":[2615778,2617911,2615728,2617396,2615889,2617388],"length":1,"stats":{"Line":0}},{"line":123,"address":[2615860],"length":1,"stats":{"Line":0}},{"line":124,"address":[3961821],"length":1,"stats":{"Line":0}},{"line":127,"address":[3257531,3259351,3258430],"length":1,"stats":{"Line":0}},{"line":128,"address":[3319297],"length":1,"stats":{"Line":0}},{"line":130,"address":[3962287,3963872,3962175,3963282,3961977],"length":1,"stats":{"Line":0}},{"line":131,"address":[3165814],"length":1,"stats":{"Line":0}},{"line":133,"address":[2616512,2616691,2616615],"length":1,"stats":{"Line":0}},{"line":136,"address":[3165920,3164383,3164463,3165942],"length":1,"stats":{"Line":0}},{"line":137,"address":[3164580],"length":1,"stats":{"Line":0}},{"line":140,"address":[3164920],"length":1,"stats":{"Line":0}},{"line":141,"address":[3164790],"length":1,"stats":{"Line":0}},{"line":144,"address":[2617012],"length":1,"stats":{"Line":0}},{"line":145,"address":[3962950],"length":1,"stats":{"Line":0}},{"line":157,"address":[3040445,3040432],"length":1,"stats":{"Line":0}},{"line":158,"address":[3260806,3259918,3260347,3260372,3260486,3260081],"length":1,"stats":{"Line":0}},{"line":159,"address":[3964717,3964479,3964332,3964533,3964422],"length":1,"stats":{"Line":0}},{"line":160,"address":[3168512,3168496,3166742],"length":1,"stats":{"Line":0}},{"line":161,"address":[3211058],"length":1,"stats":{"Line":0}},{"line":162,"address":[2619871,2619645,2619733,2620532],"length":1,"stats":{"Line":0}},{"line":164,"address":[2619839,2620768,2620780],"length":1,"stats":{"Line":0}},{"line":166,"address":[3965947,3966185,3966039],"length":1,"stats":{"Line":0}},{"line":168,"address":[2620149,2620816,2620828],"length":1,"stats":{"Line":0}},{"line":170,"address":[3168193],"length":1,"stats":{"Line":0}},{"line":175,"address":[3040464],"length":1,"stats":{"Line":0}},{"line":176,"address":[3678813],"length":1,"stats":{"Line":0}},{"line":177,"address":[3602187,3602153],"length":1,"stats":{"Line":0}},{"line":210,"address":[3040576],"length":1,"stats":{"Line":0}},{"line":211,"address":[3040584],"length":1,"stats":{"Line":0}},{"line":218,"address":[3040932,3040953,3040608],"length":1,"stats":{"Line":0}},{"line":219,"address":[2620864,2620880],"length":1,"stats":{"Line":0}},{"line":223,"address":[3040699],"length":1,"stats":{"Line":0}},{"line":225,"address":[3679125],"length":1,"stats":{"Line":0}},{"line":238,"address":[3310864],"length":1,"stats":{"Line":0}},{"line":242,"address":[3169121],"length":1,"stats":{"Line":0}},{"line":244,"address":[3967379,3967313,3969039],"length":1,"stats":{"Line":0}},{"line":245,"address":[3171018],"length":1,"stats":{"Line":0}},{"line":246,"address":[3265152,3265216],"length":1,"stats":{"Line":0}},{"line":250,"address":[3169359,3171520,3169390,3169162,3171468],"length":1,"stats":{"Line":0}},{"line":251,"address":[3967812],"length":1,"stats":{"Line":0}},{"line":252,"address":[2621806,2621868],"length":1,"stats":{"Line":0}},{"line":254,"address":[3169901,3170220],"length":1,"stats":{"Line":0}},{"line":257,"address":[3170153],"length":1,"stats":{"Line":0}},{"line":258,"address":[2622273],"length":1,"stats":{"Line":0}},{"line":260,"address":[3264130,3264033,3264049],"length":1,"stats":{"Line":0}},{"line":261,"address":[2622457,2622341,2622354],"length":1,"stats":{"Line":0}},{"line":264,"address":[3169858,3170046],"length":1,"stats":{"Line":0}},{"line":267,"address":[3968059],"length":1,"stats":{"Line":0}},{"line":271,"address":[3263364],"length":1,"stats":{"Line":0}},{"line":272,"address":[3264322,3264350,3263396],"length":1,"stats":{"Line":0}},{"line":279,"address":[3969128],"length":1,"stats":{"Line":0}},{"line":280,"address":[2623108,2623354],"length":1,"stats":{"Line":0}},{"line":282,"address":[2623158,2623077],"length":1,"stats":{"Line":0}},{"line":283,"address":[3171185,3171268],"length":1,"stats":{"Line":0}},{"line":285,"address":[3171289],"length":1,"stats":{"Line":0}},{"line":290,"address":[3041024],"length":1,"stats":{"Line":0}},{"line":291,"address":[3602706],"length":1,"stats":{"Line":0}},{"line":304,"address":[3043390,3041072,3043453],"length":1,"stats":{"Line":0}},{"line":305,"address":[3602834,3603000],"length":1,"stats":{"Line":0}},{"line":308,"address":[3041285],"length":1,"stats":{"Line":0}},{"line":311,"address":[3041382,3041515],"length":1,"stats":{"Line":0}},{"line":314,"address":[3171744,3171766],"length":1,"stats":{"Line":0}},{"line":317,"address":[3311555,3311492],"length":1,"stats":{"Line":0}},{"line":318,"address":[3680143,3680234],"length":1,"stats":{"Line":0}},{"line":321,"address":[3171872,3171891],"length":1,"stats":{"Line":0}},{"line":322,"address":[3312410,3312504,3312630,3312251],"length":1,"stats":{"Line":0}},{"line":323,"address":[3604122],"length":1,"stats":{"Line":0}},{"line":324,"address":[3604249],"length":1,"stats":{"Line":0}},{"line":326,"address":[3042687],"length":1,"stats":{"Line":0}},{"line":327,"address":[3312702,3312353],"length":1,"stats":{"Line":0}},{"line":330,"address":[3681209],"length":1,"stats":{"Line":0}},{"line":331,"address":[3043238,3042981],"length":1,"stats":{"Line":0}},{"line":336,"address":[3043019],"length":1,"stats":{"Line":0}},{"line":337,"address":[3681462],"length":1,"stats":{"Line":0}},{"line":340,"address":[3043100],"length":1,"stats":{"Line":0}},{"line":354,"address":[3605216],"length":1,"stats":{"Line":0}},{"line":359,"address":[3266050,3265801,3265935,3265818,3266597],"length":1,"stats":{"Line":0}},{"line":361,"address":[3265805],"length":1,"stats":{"Line":0}},{"line":362,"address":[3970386,3971638,3970294,3971616],"length":1,"stats":{"Line":0}},{"line":365,"address":[3172411,3172835],"length":1,"stats":{"Line":0}},{"line":368,"address":[3304407],"length":1,"stats":{"Line":0}},{"line":371,"address":[3173396,3173287],"length":1,"stats":{"Line":0}},{"line":375,"address":[3046097,3045136,3043536],"length":1,"stats":{"Line":0}},{"line":381,"address":[3313562],"length":1,"stats":{"Line":0}},{"line":382,"address":[3313730],"length":1,"stats":{"Line":0}},{"line":385,"address":[3682381,3682342,3682270,3684587],"length":1,"stats":{"Line":0}},{"line":386,"address":[3314085,3316085,3314017],"length":1,"stats":{"Line":0}},{"line":387,"address":[3044236],"length":1,"stats":{"Line":0}},{"line":390,"address":[3044484,3044375,3046038],"length":1,"stats":{"Line":0}},{"line":393,"address":[3267398,3267376],"length":1,"stats":{"Line":0}},{"line":395,"address":[3314641,3314569],"length":1,"stats":{"Line":0}},{"line":398,"address":[3314748],"length":1,"stats":{"Line":0}},{"line":400,"address":[3606686,3606902,3606600,3606713],"length":1,"stats":{"Line":0}},{"line":401,"address":[3044852,3045147],"length":1,"stats":{"Line":0}},{"line":403,"address":[3315165,3315218,3315996,3315328],"length":1,"stats":{"Line":0}},{"line":406,"address":[3267526,3267504],"length":1,"stats":{"Line":0}},{"line":407,"address":[3607221,3607297],"length":1,"stats":{"Line":0}},{"line":408,"address":[3684183,3684255],"length":1,"stats":{"Line":0}},{"line":410,"address":[3607795,3606976],"length":1,"stats":{"Line":0}},{"line":413,"address":[3606832],"length":1,"stats":{"Line":0}},{"line":417,"address":[3046128],"length":1,"stats":{"Line":0}},{"line":423,"address":[3174171],"length":1,"stats":{"Line":0}},{"line":425,"address":[3269252,3268488,3268602,3268185,3268041,3268460,3268104,3268030],"length":1,"stats":{"Line":0}},{"line":427,"address":[3972402],"length":1,"stats":{"Line":0}},{"line":430,"address":[3174506,3174750,3174446,3174209,3174563],"length":1,"stats":{"Line":0}},{"line":431,"address":[3174858,3176544,3176565],"length":1,"stats":{"Line":0}},{"line":433,"address":[3268824,3268728],"length":1,"stats":{"Line":0}},{"line":434,"address":[3175115],"length":1,"stats":{"Line":0}},{"line":435,"address":[3269049,3269504,3268863,3269446],"length":1,"stats":{"Line":0}},{"line":437,"address":[3973390,3973648,3972307,3973450,3973846],"length":1,"stats":{"Line":0}},{"line":438,"address":[2628560,2628544],"length":1,"stats":{"Line":0}},{"line":439,"address":[3175826,3175904],"length":1,"stats":{"Line":0}},{"line":444,"address":[3974471,3973309,3974571,3973553],"length":1,"stats":{"Line":0}},{"line":446,"address":[3267957,3269158,3269218,3269937,3270135],"length":1,"stats":{"Line":0}},{"line":447,"address":[3270597,3270576],"length":1,"stats":{"Line":0}},{"line":451,"address":[3047176,3046192,3047182],"length":1,"stats":{"Line":0}},{"line":456,"address":[3046257],"length":1,"stats":{"Line":0}},{"line":457,"address":[3684838],"length":1,"stats":{"Line":0}},{"line":459,"address":[3684804],"length":1,"stats":{"Line":0}},{"line":462,"address":[3316516,3316374],"length":1,"stats":{"Line":0}},{"line":463,"address":[3316468],"length":1,"stats":{"Line":0}},{"line":466,"address":[3316612],"length":1,"stats":{"Line":0}},{"line":468,"address":[2629085],"length":1,"stats":{"Line":0}},{"line":469,"address":[3271072,3271058],"length":1,"stats":{"Line":0}},{"line":470,"address":[3975463],"length":1,"stats":{"Line":0}},{"line":476,"address":[3608483],"length":1,"stats":{"Line":0}},{"line":477,"address":[3685195],"length":1,"stats":{"Line":0}},{"line":478,"address":[3046693],"length":1,"stats":{"Line":0}},{"line":479,"address":[3975552,3975561],"length":1,"stats":{"Line":0}},{"line":482,"address":[3608806],"length":1,"stats":{"Line":0}},{"line":483,"address":[3608680],"length":1,"stats":{"Line":0}},{"line":484,"address":[3046882],"length":1,"stats":{"Line":0}},{"line":486,"address":[3316984],"length":1,"stats":{"Line":0}},{"line":492,"address":[3047200],"length":1,"stats":{"Line":0}},{"line":493,"address":[3047268],"length":1,"stats":{"Line":0}},{"line":495,"address":[3177536,3177520],"length":1,"stats":{"Line":0}},{"line":500,"address":[3047312],"length":1,"stats":{"Line":0}},{"line":501,"address":[3047330],"length":1,"stats":{"Line":0}},{"line":506,"address":[3317456],"length":1,"stats":{"Line":0}},{"line":507,"address":[3609266],"length":1,"stats":{"Line":0}},{"line":509,"address":[3177577,3177568],"length":1,"stats":{"Line":0}},{"line":530,"address":[3685984],"length":1,"stats":{"Line":0}},{"line":536,"address":[3976051],"length":1,"stats":{"Line":0}},{"line":537,"address":[2629875],"length":1,"stats":{"Line":0}},{"line":538,"address":[3178123],"length":1,"stats":{"Line":0}},{"line":539,"address":[3271980],"length":1,"stats":{"Line":0}},{"line":543,"address":[3178793,3182859,3178395,3178237,3182112,3178585,3182831],"length":1,"stats":{"Line":0}},{"line":544,"address":[2633856,2633942,2634261,2634545,2634517,2634051],"length":1,"stats":{"Line":0}},{"line":551,"address":[2631074,2629809,2630410],"length":1,"stats":{"Line":0}},{"line":552,"address":[3977735],"length":1,"stats":{"Line":0}},{"line":553,"address":[3179783,3179757],"length":1,"stats":{"Line":0}},{"line":554,"address":[3978011,3978077],"length":1,"stats":{"Line":0}},{"line":555,"address":[3273872],"length":1,"stats":{"Line":0}},{"line":556,"address":[2631944],"length":1,"stats":{"Line":0}},{"line":558,"address":[2632209,2632257,2631349,2632654,2633632,2632821,2632814,2632360,2632587,2632295],"length":1,"stats":{"Line":0}},{"line":560,"address":[3274670,3274599],"length":1,"stats":{"Line":0}},{"line":574,"address":[3686096],"length":1,"stats":{"Line":0}},{"line":587,"address":[3183147,3183173,3183350,3183465,3185573],"length":1,"stats":{"Line":0}},{"line":589,"address":[3276863],"length":1,"stats":{"Line":0}},{"line":590,"address":[2640134,2640112,2635133,2635046],"length":1,"stats":{"Line":0}},{"line":592,"address":[3277399,3279280,3277284,3277238],"length":1,"stats":{"Line":0}},{"line":595,"address":[3981735,3986800,3981640,3986822],"length":1,"stats":{"Line":0}},{"line":598,"address":[3183756],"length":1,"stats":{"Line":0}},{"line":599,"address":[3981974,3981895],"length":1,"stats":{"Line":0}},{"line":600,"address":[3981929,3982124],"length":1,"stats":{"Line":0}},{"line":602,"address":[3184234,3184134,3185395,3184069],"length":1,"stats":{"Line":0}},{"line":605,"address":[3188848,3188870,3184122,3184202],"length":1,"stats":{"Line":0}},{"line":606,"address":[3982423,3982633,3982514],"length":1,"stats":{"Line":0}},{"line":607,"address":[3282709,3278233,3282688],"length":1,"stats":{"Line":0}},{"line":609,"address":[3277800,3279109],"length":1,"stats":{"Line":0}},{"line":614,"address":[3982969],"length":1,"stats":{"Line":0}},{"line":615,"address":[3982000],"length":1,"stats":{"Line":0}},{"line":616,"address":[3183974],"length":1,"stats":{"Line":0}},{"line":617,"address":[2636401,2635694],"length":1,"stats":{"Line":0}},{"line":618,"address":[3278504],"length":1,"stats":{"Line":0}},{"line":621,"address":[2636652,2636747,2637474,2636778,2637430,2636835,2638250,2637564],"length":1,"stats":{"Line":0}},{"line":622,"address":[3185084],"length":1,"stats":{"Line":0}},{"line":623,"address":[2636754],"length":1,"stats":{"Line":0}},{"line":625,"address":[3276937,3279512,3278884,3278944,3279316],"length":1,"stats":{"Line":0}},{"line":626,"address":[3987269,3983988,3987248],"length":1,"stats":{"Line":0}},{"line":628,"address":[2637707,2637793],"length":1,"stats":{"Line":0}},{"line":629,"address":[2637985,2637836],"length":1,"stats":{"Line":0}},{"line":630,"address":[3984951,3985009,3984452,3984566],"length":1,"stats":{"Line":0}},{"line":632,"address":[4026856],"length":1,"stats":{"Line":0}},{"line":633,"address":[3283104,3283088],"length":1,"stats":{"Line":0}},{"line":634,"address":[3280753,3280675],"length":1,"stats":{"Line":0}},{"line":640,"address":[3281130,3281188,3279975,3281301,3282257,3280295],"length":1,"stats":{"Line":0}},{"line":642,"address":[3223102],"length":1,"stats":{"Line":0}},{"line":643,"address":[3283200,3283221,3281269],"length":1,"stats":{"Line":0}},{"line":645,"address":[3281494,3281402],"length":1,"stats":{"Line":0}},{"line":647,"address":[3187847],"length":1,"stats":{"Line":0}},{"line":651,"address":[2639493,2639581],"length":1,"stats":{"Line":0}},{"line":653,"address":[3986167,3986235],"length":1,"stats":{"Line":0}},{"line":655,"address":[3188260],"length":1,"stats":{"Line":0}},{"line":675,"address":[3609488,3610882,3610876],"length":1,"stats":{"Line":0}},{"line":680,"address":[3609559,3609680],"length":1,"stats":{"Line":0}},{"line":683,"address":[3610007,3609620],"length":1,"stats":{"Line":0}},{"line":684,"address":[3610044],"length":1,"stats":{"Line":0}},{"line":686,"address":[3049455,3049680,3048291],"length":1,"stats":{"Line":0}},{"line":687,"address":[3688240,3688172,3688050],"length":1,"stats":{"Line":0}},{"line":691,"address":[3688178],"length":1,"stats":{"Line":0}},{"line":694,"address":[3049461],"length":1,"stats":{"Line":0}},{"line":702,"address":[3610173],"length":1,"stats":{"Line":0}},{"line":703,"address":[3610304],"length":1,"stats":{"Line":0}},{"line":704,"address":[3687072,3687168,3687231],"length":1,"stats":{"Line":0}},{"line":708,"address":[3687174],"length":1,"stats":{"Line":0}},{"line":710,"address":[3048382],"length":1,"stats":{"Line":0}},{"line":711,"address":[3610983,3610256,3610943],"length":1,"stats":{"Line":0}},{"line":713,"address":[3049095],"length":1,"stats":{"Line":0}},{"line":717,"address":[3686631],"length":1,"stats":{"Line":0}},{"line":718,"address":[3050027,3048102,3050075],"length":1,"stats":{"Line":0}},{"line":720,"address":[3320424,3320120],"length":1,"stats":{"Line":0}},{"line":721,"address":[3320522],"length":1,"stats":{"Line":0}},{"line":722,"address":[3050515,3050601,3050664],"length":1,"stats":{"Line":0}},{"line":726,"address":[3320698],"length":1,"stats":{"Line":0}},{"line":728,"address":[3050374],"length":1,"stats":{"Line":0}},{"line":729,"address":[3689568,3689608,3688957],"length":1,"stats":{"Line":0}},{"line":731,"address":[3612894],"length":1,"stats":{"Line":0}},{"line":751,"address":[3689920,3691970,3692049],"length":1,"stats":{"Line":5}},{"line":752,"address":[3690030,3689947],"length":1,"stats":{"Line":10}},{"line":755,"address":[3689984,3690295],"length":1,"stats":{"Line":10}},{"line":757,"address":[3322159,3321781],"length":1,"stats":{"Line":6}},{"line":759,"address":[3613953],"length":1,"stats":{"Line":4}},{"line":761,"address":[3052212,3052134],"length":1,"stats":{"Line":8}},{"line":762,"address":[3615293,3614141],"length":1,"stats":{"Line":0}},{"line":765,"address":[3614180,3614106],"length":1,"stats":{"Line":6}},{"line":766,"address":[3322499,3322414],"length":1,"stats":{"Line":8}},{"line":768,"address":[3614317,3614387,3614411],"length":1,"stats":{"Line":9}},{"line":770,"address":[3052525,3052713,3052611],"length":1,"stats":{"Line":7}},{"line":771,"address":[2641234,2641216],"length":1,"stats":{"Line":4}},{"line":772,"address":[3987870,3987856],"length":1,"stats":{"Line":5}},{"line":774,"address":[3322601],"length":1,"stats":{"Line":1}},{"line":777,"address":[3052561,3053113,3052773],"length":1,"stats":{"Line":4}},{"line":781,"address":[3614832],"length":1,"stats":{"Line":4}},{"line":782,"address":[3691376],"length":1,"stats":{"Line":2}},{"line":783,"address":[3052836],"length":1,"stats":{"Line":4}},{"line":784,"address":[3614784],"length":1,"stats":{"Line":4}},{"line":788,"address":[3613871],"length":1,"stats":{"Line":1}}],"covered":19,"coverable":243},{"path":["/","workspaces","vouchrs","src","session.rs"],"content":"use crate::models::{VouchrsSession, VouchrsUserData};\nuse crate::oauth::OAuthState;\nuse crate::utils::cookie::{CookieOptions, ToCookie, COOKIE_NAME, USER_COOKIE_NAME};\nuse crate::utils::crypto::{derive_encryption_key, encrypt_data, decrypt_data};\nuse actix_web::{cookie::Cookie, HttpRequest, HttpResponse, ResponseError};\nuse anyhow::{anyhow, Result};\nuse chrono::Utc;\nuse serde::{de::DeserializeOwned, Serialize};\nuse std::time::{SystemTime, UNIX_EPOCH};\n\n// Custom error wrapper for ResponseError implementation\n#[derive(Debug)]\npub struct SessionError(anyhow::Error);\n\nimpl std::fmt::Display for SessionError {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        self.0.fmt(f)\n    }\n}\n\nimpl From\u003canyhow::Error\u003e for SessionError {\n    fn from(err: anyhow::Error) -\u003e Self {\n        Self(err)\n    }\n}\n\nimpl ResponseError for SessionError {\n    fn error_response(\u0026self) -\u003e HttpResponse {\n        let error_msg = self.0.to_string();\n\n        if error_msg.contains(\"Session expired\") || error_msg.contains(\"Session not found\") {\n            HttpResponse::Unauthorized().json(\"Authentication required\")\n        } else {\n            HttpResponse::InternalServerError().json(\"Internal server error\")\n        }\n    }\n}\n\n/// Session Manager for stateless encrypted session handling\n#[derive(Clone)]\npub struct SessionManager {\n    encryption_key: [u8; 32],\n    cookie_secure: bool,\n    session_duration_hours: u64,\n}\n\nimpl SessionManager {\n    /// Create a new session manager with the provided key and cookie settings\n    #[must_use]\n    pub fn new(key: \u0026[u8], cookie_secure: bool, session_duration_hours: u64) -\u003e Self {\n        let encryption_key = derive_encryption_key(key);\n\n        Self {\n            encryption_key,\n            cookie_secure,\n            session_duration_hours,\n        }\n    }\n\n    /// Create an encrypted session cookie from `VouchrsSession` (token data only)\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if encryption fails\n    pub fn create_session_cookie(\u0026self, session: \u0026VouchrsSession) -\u003e Result\u003cCookie\u003e {\n        // Use the ToCookie trait implementation\n        session.to_cookie(self)\n    }\n\n    /// Extract and decrypt session from HTTP request\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Session cookie is not found\n    /// - Decryption fails\n    /// - Session has expired\n    pub fn extract_session(\u0026self, req: \u0026HttpRequest) -\u003e Result\u003cVouchrsSession\u003e {\n        let cookie_value = req\n            .cookie(COOKIE_NAME)\n            .ok_or_else(|| anyhow!(\"Session not found\"))?\n            .value()\n            .to_string();\n\n        let session: VouchrsSession = self.decrypt_data(\u0026cookie_value)?;\n\n        // Check if tokens are expired\n        if session.expires_at \u003c= Utc::now() {\n            return Err(anyhow!(\"Session expired\"));\n        }\n\n        Ok(session)\n    }\n\n    /// Check if session needs token refresh (within 5 minutes of expiry)\n    #[must_use]\n    pub fn needs_token_refresh(\u0026self, session: \u0026VouchrsSession) -\u003e bool {\n        let now = Utc::now();\n        let buffer_time = chrono::Duration::minutes(5);\n        session.expires_at \u003c= now + buffer_time\n    }\n\n    /// Create a sign-out cookie (empty with immediate expiration)\n    #[must_use]\n    pub fn create_signout_cookie(\u0026self) -\u003e Cookie {\n        Cookie::build(COOKIE_NAME, \"\")\n            .http_only(true)\n            .secure(self.cookie_secure)\n            .same_site(actix_web::cookie::SameSite::Lax)\n            .path(\"/\")\n            .max_age(actix_web::cookie::time::Duration::seconds(0))\n            .finish()\n    }\n\n    /// Create an expired cookie to clear the session\n    #[must_use]\n    pub fn create_expired_cookie(\u0026self) -\u003e Cookie\u003c'static\u003e {\n        crate::utils::cookie::create_expired_cookie(COOKIE_NAME, self.cookie_secure)\n    }\n\n    /// Create a temporary cookie for storing OAuth state during the OAuth flow\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if encryption fails\n    pub fn create_temporary_state_cookie(\n        \u0026self,\n        oauth_state: \u0026OAuthState,\n    ) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        // Use the ToCookie trait implementation\n        oauth_state.to_cookie(self)\n    }\n\n    /// Get OAuth state from temporary cookie in request\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if decryption fails (other errors are logged and return None)\n    pub fn get_temporary_state_from_request(\n        \u0026self,\n        req: \u0026HttpRequest,\n    ) -\u003e Result\u003cOption\u003cOAuthState\u003e\u003e {\n        let cookie_name = crate::utils::cookie::OAUTH_STATE_COOKIE;\n        log::info!(\"Looking for temporary state cookie '{cookie_name}'\");\n\n        // Log all cookies in the request for debugging\n        crate::utils::cookie::log_cookies(req);\n\n        req.cookie(cookie_name).map_or_else(|| {\n            log::warn!(\"No temporary state cookie '{cookie_name}' found in request\");\n            Ok(None)\n        }, |cookie| {\n            log::info!(\n                \"Found temporary state cookie with value length: {}\",\n                cookie.value().len()\n            );\n            match self.decrypt_data::\u003cOAuthState\u003e(cookie.value()) {\n                Ok(oauth_state) =\u003e Ok(Some(oauth_state)),\n                Err(e) =\u003e {\n                    log::warn!(\"Failed to decrypt OAuth state cookie: {e}\");\n                    Ok(None)\n                }\n            }\n        })\n    }\n\n    /// Get session from HTTP request cookies\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if decryption fails (expired sessions return None)\n    pub fn get_session_from_request(\u0026self, req: \u0026HttpRequest) -\u003e Result\u003cOption\u003cVouchrsSession\u003e\u003e {\n        if let Some(cookie) = req.cookie(COOKIE_NAME) {\n            match self.decrypt_data::\u003cVouchrsSession\u003e(cookie.value()) {\n                Ok(session) =\u003e {\n                    // Check if session has expired\n                    if session.expires_at \u003c= Utc::now() {\n                        return Ok(None);\n                    }\n\n                    // Check if session needs token refresh (5 minutes before expiration)\n                    if session.expires_at - chrono::Duration::minutes(5) \u003c= Utc::now() {\n                        log::warn!(\n                            \"OAuth token needs refresh for provider: {}\",\n                            session.provider\n                        );\n                    }\n                    Ok(Some(session))\n                }\n                Err(e) if e.to_string().contains(\"Session expired\") =\u003e Ok(None),\n                Err(e) =\u003e Err(e),\n            }\n        } else {\n            Ok(None)\n        }\n    }\n\n    /// Create an expired temporary state cookie to clear it\n    #[must_use]\n    pub fn create_expired_temp_state_cookie(\u0026self) -\u003e Cookie\u003c'static\u003e {\n        crate::utils::cookie::create_expired_cookie(crate::utils::cookie::OAUTH_STATE_COOKIE, self.cookie_secure)\n    }\n\n    /// Decrypt and validate session from cookie value\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Decryption fails\n    /// - Session has expired\n    pub fn decrypt_and_validate_session(\u0026self, cookie_value: \u0026str) -\u003e Result\u003cVouchrsSession\u003e {\n        let session: VouchrsSession = self.decrypt_data(cookie_value)?;\n\n        // Check if session has expired\n        if session.expires_at \u003c= Utc::now() {\n            return Err(anyhow!(\"Session expired\"));\n        }\n\n        Ok(session)\n    }\n\n    /// Create an encrypted user data cookie from `VouchrsUserData`\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if encryption fails\n    pub fn create_user_cookie(\u0026self, user_data: \u0026VouchrsUserData) -\u003e Result\u003cCookie\u003e {\n        // Use the ToCookie trait implementation\n        user_data.to_cookie(self)\n    }\n\n    /// Extract user data from HTTP request cookie\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - User data cookie is not found\n    /// - Decryption fails\n    pub fn extract_user_data(\u0026self, req: \u0026HttpRequest) -\u003e Result\u003cVouchrsUserData\u003e {\n        let cookie_value = req\n            .cookie(USER_COOKIE_NAME)\n            .ok_or_else(|| anyhow!(\"User data not found\"))?\n            .value()\n            .to_string();\n\n        self.decrypt_data(\u0026cookie_value)\n    }\n\n    /// Get user data from HTTP request cookies (returns None if not found)\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if a critical failure occurs (decryption failures return None)\n    pub fn get_user_data_from_request(\u0026self, req: \u0026HttpRequest) -\u003e Result\u003cOption\u003cVouchrsUserData\u003e\u003e {\n        req.cookie(USER_COOKIE_NAME).map_or_else(|| Ok(None), |cookie| match self.decrypt_data::\u003cVouchrsUserData\u003e(cookie.value()) {\n                Ok(user_data) =\u003e Ok(Some(user_data)),\n                Err(e) =\u003e {\n                    log::warn!(\"Failed to decrypt user data cookie: {e}\");\n                    Ok(None)\n                }\n            })\n    }\n\n    /// Create an expired user cookie to clear user data\n    #[must_use]\n    pub fn create_expired_user_cookie(\u0026self) -\u003e Cookie\u003c'static\u003e {\n        crate::utils::cookie::create_expired_cookie(USER_COOKIE_NAME, self.cookie_secure)\n    }\n\n    /// Generic method to create a cookie with encrypted data\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if encryption fails\n    pub fn create_cookie\u003cT: Serialize\u003e(\n        \u0026self,\n        name: String,\n        data: Option\u003c\u0026T\u003e,\n        options: CookieOptions,\n    ) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        let value = match data {\n            Some(data) =\u003e self.encrypt_data(data)?,\n            None =\u003e String::new(),\n        };\n\n        Ok(Cookie::build(name, value)\n            .http_only(options.http_only)\n            .secure(self.cookie_secure \u0026\u0026 options.secure)\n            .same_site(options.same_site)\n            .path(options.path)\n            .max_age(options.max_age)\n            .finish())\n    }\n\n    /// Generic encryption function for any serializable data\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Serialization fails\n    /// - AES encryption fails\n    pub fn encrypt_data\u003cT: Serialize\u003e(\u0026self, data: \u0026T) -\u003e Result\u003cString\u003e {\n        encrypt_data(data, \u0026self.encryption_key)\n    }\n\n    /// Generic decryption function for any deserializable data\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Base64 decoding fails\n    /// - Data length is invalid\n    /// - AES decryption fails\n    /// - Deserialization fails\n    pub fn decrypt_data\u003cT: DeserializeOwned\u003e(\u0026self, encrypted_data: \u0026str) -\u003e Result\u003cT\u003e {\n        decrypt_data(encrypted_data, \u0026self.encryption_key)\n    }\n}\n\n/// Implementation of `ToCookie` for `VouchrsSession`\nimpl crate::utils::cookie::ToCookie\u003cSessionManager\u003e for VouchrsSession {\n    fn to_cookie(\u0026self, session_manager: \u0026SessionManager) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        session_manager.create_cookie(\n            COOKIE_NAME.to_string(),\n            Some(self),\n            CookieOptions {\n                same_site: actix_web::cookie::SameSite::Lax,\n                max_age: actix_web::cookie::time::Duration::hours(i64::try_from(session_manager.session_duration_hours).unwrap_or(24)),\n                ..Default::default()\n            },\n        )\n    }\n}\n\n/// Implementation of `ToCookie` for `VouchrsUserData`\nimpl crate::utils::cookie::ToCookie\u003cSessionManager\u003e for VouchrsUserData {\n    fn to_cookie(\u0026self, session_manager: \u0026SessionManager) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        session_manager.create_cookie(\n            USER_COOKIE_NAME.to_string(),\n            Some(self),\n            CookieOptions {\n                same_site: actix_web::cookie::SameSite::Lax,\n                max_age: actix_web::cookie::time::Duration::hours(i64::try_from(session_manager.session_duration_hours).unwrap_or(24)),\n                ..Default::default()\n            },\n        )\n    }\n}\n\n/// Implementation of `ToCookie` for `OAuthState`\nimpl crate::utils::cookie::ToCookie\u003cSessionManager\u003e for OAuthState {\n    fn to_cookie(\u0026self, session_manager: \u0026SessionManager) -\u003e Result\u003cCookie\u003c'static\u003e\u003e {\n        let cookie_name = crate::utils::cookie::OAUTH_STATE_COOKIE;\n        let options = CookieOptions {\n            same_site: actix_web::cookie::SameSite::Lax,\n            max_age: actix_web::cookie::time::Duration::minutes(10), // Short-lived for OAuth flow\n            ..Default::default()\n        };\n\n        let cookie =\n            session_manager.create_cookie(cookie_name.to_string(), Some(self), options)?;\n\n        log::info!(\n            \"Creating temporary state cookie: secure={}, name={}, encrypted_len={}\",\n            session_manager.cookie_secure,\n            cookie_name,\n            cookie.value().len()\n        );\n\n        Ok(cookie)\n    }\n}\n\n/// Helper function to get current timestamp\n/// \n/// # Panics\n/// \n/// Panics if the system time is before the Unix epoch (1970-01-01)\n#[must_use]\npub fn current_timestamp() -\u003e i64 {\n    let duration = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .expect(\"System time is before Unix epoch\");\n    \n    // Use try_from to safely convert, but realistically this won't overflow for centuries\n    i64::try_from(duration.as_secs()).unwrap_or(i64::MAX)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::test_helpers::create_test_session;\n    use chrono::Duration;\n\n    #[test]\n    fn test_token_encryption_decryption() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        let session = create_test_session();\n\n        // Test encryption with generic method\n        let encrypted = manager.encrypt_data(\u0026session).unwrap();\n        assert!(!encrypted.is_empty());\n\n        // Test decryption with generic method\n        let decrypted: VouchrsSession = manager.decrypt_data(\u0026encrypted).unwrap();\n        assert_eq!(session.provider, decrypted.provider);\n        assert_eq!(session.id_token, decrypted.id_token);\n        assert_eq!(session.refresh_token, decrypted.refresh_token);\n        assert_eq!(session.expires_at, decrypted.expires_at);\n    }\n\n    #[test]\n    fn test_needs_token_refresh() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        // Session with token expiring in 10 minutes (should NOT need refresh)\n        let mut session = create_test_session();\n        session.expires_at = Utc::now() + Duration::minutes(10);\n        assert!(!manager.needs_token_refresh(\u0026session));\n        // Session with token expiring in 2 minutes (should need refresh)\n        session.expires_at = Utc::now() + Duration::minutes(2);\n        assert!(manager.needs_token_refresh(\u0026session));\n        // Session with expired token (should need refresh)\n        session.expires_at = Utc::now() - Duration::minutes(10);\n        assert!(manager.needs_token_refresh(\u0026session));\n    }\n\n    #[test]\n    fn test_cookie_size_reduction() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        let session = create_test_session();\n\n        // Create cookie with token data (current approach)\n        let token_cookie = manager.create_session_cookie(\u0026session).unwrap();\n        let token_size = token_cookie.value().len();\n\n        // The current approach should work fine\n        let token_json = serde_json::to_string(\u0026session).unwrap();\n\n        println!(\"Token JSON size: {} bytes\", token_json.len());\n        println!(\"Token cookie size: {token_size} bytes\");\n\n        // Log the compact nature of the token data\n        assert!(!token_json.is_empty());\n        assert!(!token_cookie.value().is_empty());\n    }\n\n    #[test]\n    fn test_generic_encryption_decryption() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        let session = create_test_session();\n\n        // Test generic encryption\n        let encrypted = manager.encrypt_data(\u0026session).unwrap();\n        assert!(!encrypted.is_empty());\n\n        // Test generic decryption\n        let decrypted: VouchrsSession = manager.decrypt_data(\u0026encrypted).unwrap();\n        assert_eq!(session.provider, decrypted.provider);\n        assert_eq!(session.id_token, decrypted.id_token);\n        assert_eq!(session.refresh_token, decrypted.refresh_token);\n        assert_eq!(session.expires_at, decrypted.expires_at);\n    }\n\n    #[test]\n    fn test_to_cookie_trait() {\n        let key = b\"test_key_32_bytes_long_for_testing_purposes\";\n        let manager = SessionManager::new(key, false, 24);\n        let session = create_test_session();\n\n        // Test ToCookie implementation for VouchrsSession\n        let cookie = session.to_cookie(\u0026manager).unwrap();\n        assert_eq!(cookie.name(), COOKIE_NAME);\n        assert!(!cookie.value().is_empty());\n\n        // Verify we can decrypt the cookie\n        let decrypted: VouchrsSession = manager.decrypt_data(cookie.value()).unwrap();\n        assert_eq!(session.provider, decrypted.provider);\n        assert_eq!(session.id_token, decrypted.id_token);\n    }\n}\n","traces":[{"line":16,"address":[3147952],"length":1,"stats":{"Line":0}},{"line":17,"address":[3798014],"length":1,"stats":{"Line":0}},{"line":22,"address":[3798032],"length":1,"stats":{"Line":0}},{"line":28,"address":[3413636,3413544,3413168],"length":1,"stats":{"Line":0}},{"line":29,"address":[3148025],"length":1,"stats":{"Line":0}},{"line":31,"address":[3851333,3851421,3851265],"length":1,"stats":{"Line":0}},{"line":32,"address":[3413555,3413340],"length":1,"stats":{"Line":0}},{"line":34,"address":[3148242],"length":1,"stats":{"Line":0}},{"line":50,"address":[3148496],"length":1,"stats":{"Line":9}},{"line":51,"address":[3413710],"length":1,"stats":{"Line":9}},{"line":65,"address":[3413792],"length":1,"stats":{"Line":1}},{"line":67,"address":[3851875],"length":1,"stats":{"Line":1}},{"line":78,"address":[3413856,3414955,3414947],"length":1,"stats":{"Line":0}},{"line":79,"address":[3799087,3798790,3798918],"length":1,"stats":{"Line":0}},{"line":81,"address":[3416928,3416932],"length":1,"stats":{"Line":0}},{"line":85,"address":[3149129,3149812],"length":1,"stats":{"Line":0}},{"line":88,"address":[3414716,3414631],"length":1,"stats":{"Line":0}},{"line":89,"address":[3852923,3852873],"length":1,"stats":{"Line":0}},{"line":92,"address":[3414737],"length":1,"stats":{"Line":0}},{"line":97,"address":[3414976],"length":1,"stats":{"Line":1}},{"line":98,"address":[3149859],"length":1,"stats":{"Line":1}},{"line":99,"address":[3799918],"length":1,"stats":{"Line":1}},{"line":100,"address":[3853122],"length":1,"stats":{"Line":1}},{"line":105,"address":[3415120,3415507,3415475],"length":1,"stats":{"Line":0}},{"line":106,"address":[3853347,3853540,3853230,3853491,3853365],"length":1,"stats":{"Line":0}},{"line":108,"address":[3853330],"length":1,"stats":{"Line":0}},{"line":109,"address":[3150141],"length":1,"stats":{"Line":0}},{"line":111,"address":[3853457,3853438,3853576,3853532],"length":1,"stats":{"Line":0}},{"line":117,"address":[3415520],"length":1,"stats":{"Line":0}},{"line":118,"address":[3150417],"length":1,"stats":{"Line":0}},{"line":126,"address":[3853680],"length":1,"stats":{"Line":0}},{"line":131,"address":[3150499],"length":1,"stats":{"Line":0}},{"line":139,"address":[3415648],"length":1,"stats":{"Line":0}},{"line":143,"address":[3800618],"length":1,"stats":{"Line":0}},{"line":144,"address":[3415711,3415820],"length":1,"stats":{"Line":0}},{"line":147,"address":[3415746],"length":1,"stats":{"Line":0}},{"line":149,"address":[3853852],"length":1,"stats":{"Line":0}},{"line":150,"address":[2582821,2582905],"length":1,"stats":{"Line":0}},{"line":151,"address":[2758728],"length":1,"stats":{"Line":0}},{"line":152,"address":[2584242,2583104,2582897],"length":1,"stats":{"Line":0}},{"line":153,"address":[2583271,2583227,2583134,2583394],"length":1,"stats":{"Line":0}},{"line":155,"address":[2583342],"length":1,"stats":{"Line":0}},{"line":157,"address":[2583617,2583238],"length":1,"stats":{"Line":0}},{"line":158,"address":[2759598],"length":1,"stats":{"Line":0}},{"line":159,"address":[3417857],"length":1,"stats":{"Line":0}},{"line":160,"address":[2583979,2583869,2583677],"length":1,"stats":{"Line":0}},{"line":161,"address":[3641638],"length":1,"stats":{"Line":0}},{"line":172,"address":[3417859,3417433,3416032],"length":1,"stats":{"Line":0}},{"line":173,"address":[3801207,3801014],"length":1,"stats":{"Line":0}},{"line":174,"address":[3801149,3801271],"length":1,"stats":{"Line":0}},{"line":175,"address":[3801373],"length":1,"stats":{"Line":0}},{"line":177,"address":[3801469,3801550],"length":1,"stats":{"Line":0}},{"line":178,"address":[3801649],"length":1,"stats":{"Line":0}},{"line":182,"address":[3801583,3801759],"length":1,"stats":{"Line":0}},{"line":183,"address":[3801926],"length":1,"stats":{"Line":0}},{"line":188,"address":[3151798],"length":1,"stats":{"Line":0}},{"line":190,"address":[3801335,3802403,3802605],"length":1,"stats":{"Line":0}},{"line":191,"address":[3152506],"length":1,"stats":{"Line":0}},{"line":194,"address":[3151123],"length":1,"stats":{"Line":0}},{"line":200,"address":[3417920],"length":1,"stats":{"Line":0}},{"line":201,"address":[3802897],"length":1,"stats":{"Line":0}},{"line":211,"address":[3802944,3803552,3803558],"length":1,"stats":{"Line":0}},{"line":212,"address":[3802985],"length":1,"stats":{"Line":0}},{"line":215,"address":[3856442,3856517],"length":1,"stats":{"Line":0}},{"line":216,"address":[3856645,3856598],"length":1,"stats":{"Line":0}},{"line":219,"address":[3153334],"length":1,"stats":{"Line":0}},{"line":227,"address":[3856752],"length":1,"stats":{"Line":2}},{"line":229,"address":[3803619],"length":1,"stats":{"Line":2}},{"line":239,"address":[3418672,3419163,3419169],"length":1,"stats":{"Line":0}},{"line":240,"address":[3418723,3418849,3419017],"length":1,"stats":{"Line":0}},{"line":242,"address":[3642020,3642016],"length":1,"stats":{"Line":0}},{"line":246,"address":[3804074],"length":1,"stats":{"Line":0}},{"line":254,"address":[3154128],"length":1,"stats":{"Line":2}},{"line":255,"address":[3642262,3642179,3642838,3642080,3642144,3642094],"length":1,"stats":{"Line":8}},{"line":256,"address":[3642361],"length":1,"stats":{"Line":2}},{"line":257,"address":[3642303],"length":1,"stats":{"Line":0}},{"line":258,"address":[2584568,2584824,2584757],"length":1,"stats":{"Line":0}},{"line":259,"address":[2760644],"length":1,"stats":{"Line":0}},{"line":266,"address":[3857456],"length":1,"stats":{"Line":0}},{"line":267,"address":[3857473],"length":1,"stats":{"Line":0}},{"line":275,"address":[2585984,2586810,2585120,2585946,2586848,2587674],"length":1,"stats":{"Line":4}},{"line":281,"address":[3644700,3642908,3643804],"length":1,"stats":{"Line":4}},{"line":282,"address":[3644765,3644952,3644056,3643869,3643160,3642973],"length":1,"stats":{"Line":8}},{"line":283,"address":[3643954,3643010,3644850,3643058,3643906,3644802],"length":1,"stats":{"Line":0}},{"line":286,"address":[2586624,2585317,2587488,2587535,2587045,2585595,2585760,2586503,2587323,2585639,2586181,2586671,2585807,2587367,2586459],"length":1,"stats":{"Line":20}},{"line":287,"address":[3420679,3421575,3419783],"length":1,"stats":{"Line":4}},{"line":288,"address":[2585607,2587335,2586471],"length":1,"stats":{"Line":4}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[2761593,2762489,2763385],"length":1,"stats":{"Line":4}},{"line":291,"address":[2586635,2587499,2585771],"length":1,"stats":{"Line":4}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[3422128,3422064,3422000],"length":1,"stats":{"Line":6}},{"line":303,"address":[3422163,3422035,3422099],"length":1,"stats":{"Line":5}},{"line":315,"address":[2764032,2763872,2763952],"length":1,"stats":{"Line":5}},{"line":316,"address":[2587957,2588117,2588037],"length":1,"stats":{"Line":5}},{"line":322,"address":[3594968,3594962,3594576],"length":1,"stats":{"Line":1}},{"line":323,"address":[3594928],"length":1,"stats":{"Line":2}},{"line":324,"address":[4390651],"length":1,"stats":{"Line":1}},{"line":325,"address":[3594655],"length":1,"stats":{"Line":2}},{"line":326,"address":[3671502],"length":1,"stats":{"Line":2}},{"line":327,"address":[4390692],"length":1,"stats":{"Line":2}},{"line":328,"address":[3594668,3594740],"length":1,"stats":{"Line":3}},{"line":329,"address":[3671473],"length":1,"stats":{"Line":2}},{"line":337,"address":[3595378,3594992,3595384],"length":1,"stats":{"Line":2}},{"line":338,"address":[3595344],"length":1,"stats":{"Line":2}},{"line":339,"address":[3060203],"length":1,"stats":{"Line":2}},{"line":340,"address":[4391103],"length":1,"stats":{"Line":2}},{"line":341,"address":[3595230],"length":1,"stats":{"Line":2}},{"line":342,"address":[3060244],"length":1,"stats":{"Line":2}},{"line":343,"address":[3060252,3060329],"length":1,"stats":{"Line":4}},{"line":344,"address":[3671889],"length":1,"stats":{"Line":2}},{"line":352,"address":[3616551,3615376,3616535],"length":1,"stats":{"Line":0}},{"line":353,"address":[3323627],"length":1,"stats":{"Line":0}},{"line":356,"address":[3323664],"length":1,"stats":{"Line":0}},{"line":360,"address":[3692281,3692361],"length":1,"stats":{"Line":0}},{"line":363,"address":[3692734,3692644,3692980,3692802],"length":1,"stats":{"Line":0}},{"line":370,"address":[3054148],"length":1,"stats":{"Line":0}},{"line":380,"address":[3419360],"length":1,"stats":{"Line":0}},{"line":381,"address":[3804356],"length":1,"stats":{"Line":0}},{"line":386,"address":[3804431],"length":1,"stats":{"Line":0}}],"covered":41,"coverable":120},{"path":["/","workspaces","vouchrs","src","session_builder.rs"],"content":"// Session builder for creating VouchrSession from ID token claims\n//\n// This module provides a unified approach for extracting user information from OAuth ID tokens\n// and mapping them to VouchrSession fields. It replaces the complex provider-specific extraction\n// logic with a standardized approach that works with all OAuth providers that issue standard\n// OpenID Connect ID tokens.\n//\n// Standard ID Token Claims Mapping:\n// - sub (subject) -\u003e provider_id: Unique identifier for the user from the provider\n// - email -\u003e user_email: User's email address\n// - iat (issued at) -\u003e created_at: When the token was issued\n// - exp (expires) -\u003e expires_at: When the token expires\n// - iss (issuer) -\u003e provider: OAuth provider (normalized from issuer URL)\n// - name, given_name+family_name -\u003e user_name: User's display name (optional)\n\nuse crate::utils::crypto::decode_jwt_payload;\nuse crate::models::CompleteSessionData;\nuse crate::utils::apple::AppleUserInfo;\nuse chrono::{DateTime, TimeZone, Utc};\nuse log::{debug, info, warn};\nuse serde_json::Value;\n\npub struct SessionBuilder;\n\nimpl SessionBuilder {\n    /// Creates a `CompleteSessionData` from OAuth tokens, extracting standard claims from the ID token\n    /// and using Apple user info to fill in missing fields if available\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - The ID token is missing or invalid\n    /// - JWT decoding fails\n    /// - Required claims are missing from the token\n    pub fn build_session(\n        provider: String,\n        id_token: Option\u003cString\u003e,\n        refresh_token: Option\u003cString\u003e,\n        expires_at: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cCompleteSessionData, String\u003e {\n        Self::build_session_with_apple_info(provider, id_token, refresh_token, expires_at, None)\n    }\n\n    /// Creates a `CompleteSessionData` from OAuth tokens with optional Apple user info for fallback\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if:\n    /// - The ID token is missing or invalid\n    /// - JWT decoding fails\n    /// - Required claims are missing from the token\n    ///\n    /// # Panics\n    ///\n    /// This function panics if it cannot provide a fallback email address. However, the current\n    /// implementation always provides a default email, making panics unlikely.\n    #[allow(clippy::needless_pass_by_value)]\n    pub fn build_session_with_apple_info(\n        provider: String,\n        id_token: Option\u003cString\u003e,\n        refresh_token: Option\u003cString\u003e,\n        expires_at: DateTime\u003cUtc\u003e,\n        apple_user_info: Option\u003cAppleUserInfo\u003e,\n    ) -\u003e Result\u003cCompleteSessionData, String\u003e {\n        let id_token_ref = id_token.as_ref().ok_or(\"No ID token available\")?;\n\n        let claims = decode_jwt_payload(id_token_ref)\n            .map_err(|e| format!(\"Failed to decode ID token: {e}\"))?;\n\n        info!(\n            \"Building session from ID token claims for provider: {provider}\"\n        );\n        debug!(\n            \"ID token claims: {}\",\n            serde_json::to_string_pretty(\u0026claims).unwrap_or_default()\n        );\n\n        // Extract required claims\n        let provider_id = Self::extract_subject(\u0026claims)?;\n        let user_email = Self::extract_email(\u0026claims)\n            .or_else(|| {\n                // Fallback to Apple user info if email not in token\n                if let Some(ref apple_info) = apple_user_info {\n                    if let Some(ref email) = apple_info.email {\n                        debug!(\"Using Apple user info email as fallback: {email}\");\n                        return Some(email.clone());\n                    }\n                }\n                debug!(\"No email found in ID token or Apple user info, using default\");\n                Some(\"user@example.com\".to_string())\n            })\n            .unwrap(); // This unwrap is safe because we provide a default\n\n        // Extract optional claims\n        let mut user_name = Self::extract_name(\u0026claims);\n\n        // Use Apple user info name as fallback if name not found in ID token\n        if user_name.is_none() {\n            if let Some(ref apple_info) = apple_user_info {\n                let apple_name = apple_info.name.full_name();\n                if !apple_name.trim().is_empty() {\n                    debug!(\"Using Apple user info name as fallback: {apple_name}\");\n                    user_name = Some(apple_name);\n                }\n            }\n        }\n        let created_at = Self::extract_issued_at(\u0026claims);\n        // let expires_at = Self::extract_expires_at(\u0026claims);\n\n        // Normalize provider name from issuer if available\n        let normalized_provider = Self::normalize_provider(\u0026provider, \u0026claims);\n\n        info!(\n            \"Session built successfully - Email: {user_email}, Provider: {normalized_provider}, Provider ID: {provider_id}, Name: {user_name:?}\"\n        );\n\n        Ok(CompleteSessionData {\n            user_email,\n            user_name,\n            provider: normalized_provider,\n            provider_id,\n            id_token: id_token.clone(),\n            refresh_token,\n            expires_at,\n            created_at: created_at.unwrap_or_else(Utc::now),\n        })\n    }\n\n    /// Extract the subject (sub) claim - maps to `provider_id`\n    fn extract_subject(claims: \u0026Value) -\u003e Result\u003cString, String\u003e {\n        claims\n            .get(\"sub\")\n            .and_then(|v| v.as_str())\n            .map(std::string::ToString::to_string)\n            .ok_or_else(|| \"Missing or invalid 'sub' claim in ID token\".to_string())\n    }\n\n    /// Extract the email claim - maps to `user_email` (returns Option for fallback logic)\n    #[must_use]\n    pub fn extract_email(claims: \u0026Value) -\u003e Option\u003cString\u003e {\n        claims\n            .get(\"email\")\n            .and_then(|v| v.as_str())\n            .map(std::string::ToString::to_string)\n    }\n\n    /// Extract the name claim - maps to `user_name` (optional)\n    fn extract_name(claims: \u0026Value) -\u003e Option\u003cString\u003e {\n        // Try different name claim formats used by different providers\n\n        // Google uses 'name' field directly\n        if let Some(name) = claims.get(\"name\").and_then(|v| v.as_str()) {\n            if !name.trim().is_empty() {\n                debug!(\"Extracted name from 'name' claim: {name}\");\n                return Some(name.to_string());\n            }\n        }\n\n        // Apple and others might use given_name + family_name\n        let given_name = claims\n            .get(\"given_name\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"\");\n        let family_name = claims\n            .get(\"family_name\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"\");\n\n        if !given_name.is_empty() || !family_name.is_empty() {\n            let full_name = format!(\"{given_name} {family_name}\").trim().to_string();\n            if !full_name.is_empty() {\n                debug!(\n                    \"Extracted name from given_name + family_name: {full_name}\"\n                );\n                return Some(full_name);\n            }\n        }\n\n        debug!(\"No name information found in ID token claims\");\n        None\n    }\n\n    /// Generic timestamp extraction helper\n    fn extract_timestamp(claims: \u0026Value, field_name: \u0026str) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n        claims\n            .get(field_name)\n            .and_then(serde_json::Value::as_i64)\n            .and_then(|timestamp| if let chrono::LocalResult::Single(dt) = Utc.timestamp_opt(timestamp, 0) {\n                debug!(\n                    \"Extracted {field_name} from '{field_name}' claim: {dt}\"\n                );\n                Some(dt)\n            } else {\n                warn!(\n                    \"Invalid '{field_name}' timestamp in ID token: {timestamp}\"\n                );\n                None\n            })\n    }\n\n    /// Extract the issued at (iat) claim - maps to `created_at`\n    fn extract_issued_at(claims: \u0026Value) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n        Self::extract_timestamp(claims, \"iat\")\n    }\n\n    /// Normalize provider name from issuer claim if available\n    fn normalize_provider(provider: \u0026str, claims: \u0026Value) -\u003e String {\n        if let Some(issuer) = claims.get(\"iss\").and_then(|v| v.as_str()) {\n            debug!(\"Found issuer claim: {issuer}\");\n\n            // Map common issuer values to normalized provider names\n            if issuer.contains(\"accounts.google.com\") {\n                return \"google\".to_string();\n            } else if issuer.contains(\"appleid.apple.com\") {\n                return \"apple\".to_string();\n            }\n        }\n\n        // Fall back to the provider passed in from the state\n        provider.to_string()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::apple::{AppleUserInfo, AppleUserName};\n    use base64::Engine as _;\n    use chrono::Utc;\n    use serde_json::json;\n\n    fn minimal_id_token(sub: \u0026str) -\u003e String {\n        // JWT with only 'sub' claim, base64-encoded header and payload, signature ignored\n        let header = base64::engine::general_purpose::URL_SAFE_NO_PAD.encode(b\"{\\\"alg\\\":\\\"none\\\"}\");\n        let payload = base64::engine::general_purpose::URL_SAFE_NO_PAD\n            .encode(format!(r#\"{{\"sub\":\"{sub}\"}}\"#).as_bytes());\n        format!(\"{header}.{payload}.ignored\")\n    }\n\n    #[test]\n    fn test_apple_userinfo_copied_to_vouchrsession() {\n        let id_token = Some(minimal_id_token(\"apple-sub-123\"));\n        let refresh_token = Some(\"refresh123\".to_string());\n        let expires_at = Utc::now() + chrono::Duration::hours(1);\n        let apple_user_info = AppleUserInfo {\n            name: AppleUserName {\n                first_name: Some(\"Jane\".to_string()),\n                last_name: Some(\"Doe\".to_string()),\n            },\n            email: Some(\"jane.doe@apple.com\".to_string()),\n        };\n        // Test with AppleUserInfo as struct (Value::Object case)\n        let session = SessionBuilder::build_session_with_apple_info(\n            \"apple\".to_string(),\n            id_token.clone(),\n            refresh_token.clone(),\n            expires_at,\n            Some(apple_user_info.clone()),\n        )\n        .expect(\"Session should be built\");\n        assert_eq!(session.user_email, apple_user_info.email.clone().unwrap());\n        assert_eq!(\n            session.user_name.clone().unwrap(),\n            apple_user_info.name.full_name()\n        );\n        assert_eq!(session.provider, \"apple\");\n        assert_eq!(session.provider_id, \"apple-sub-123\");\n\n        // Test that session building works correctly with Apple user info\n        // The important part is that the Apple user info is properly incorporated into the session\n        assert_eq!(session.user_email, \"jane.doe@apple.com\");\n        assert_eq!(session.user_name.unwrap(), \"Jane Doe\");\n    }\n\n    #[test]\n    fn test_extract_subject_success() {\n        let claims = json!({\n            \"sub\": \"12345\",\n            \"email\": \"test@example.com\"\n        });\n\n        assert_eq!(SessionBuilder::extract_subject(\u0026claims).unwrap(), \"12345\");\n    }\n\n    #[test]\n    fn test_extract_subject_missing() {\n        let claims = json!({\n            \"email\": \"test@example.com\"\n        });\n\n        assert!(SessionBuilder::extract_subject(\u0026claims).is_err());\n    }\n\n    #[test]\n    fn test_extract_name_google_format() {\n        let claims = json!({\n            \"name\": \"John Doe\"\n        });\n\n        assert_eq!(\n            SessionBuilder::extract_name(\u0026claims),\n            Some(\"John Doe\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_extract_name_apple_format() {\n        let claims = json!({\n            \"given_name\": \"John\",\n            \"family_name\": \"Doe\"\n        });\n\n        assert_eq!(\n            SessionBuilder::extract_name(\u0026claims),\n            Some(\"John Doe\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_extract_name_missing() {\n        let claims = json!({\n            \"sub\": \"12345\",\n            \"email\": \"test@example.com\"\n        });\n\n        assert_eq!(SessionBuilder::extract_name(\u0026claims), None);\n    }\n}\n","traces":[{"line":35,"address":[3008896],"length":1,"stats":{"Line":3}},{"line":41,"address":[3436028],"length":1,"stats":{"Line":3}},{"line":58,"address":[3011756,3013511,3008976],"length":1,"stats":{"Line":2}},{"line":65,"address":[3873689,3873562,3877977],"length":1,"stats":{"Line":8}},{"line":67,"address":[3877975,3874034,3873855],"length":1,"stats":{"Line":6}},{"line":68,"address":[3635024,3635045],"length":1,"stats":{"Line":3}},{"line":70,"address":[3729973,3729823,3729919],"length":1,"stats":{"Line":9}},{"line":73,"address":[3010056,3010180,3010024,3009685],"length":1,"stats":{"Line":7}},{"line":79,"address":[3874590,3874993],"length":1,"stats":{"Line":6}},{"line":80,"address":[3437783,3437859],"length":1,"stats":{"Line":4}},{"line":81,"address":[2756464],"length":1,"stats":{"Line":1}},{"line":83,"address":[3805862],"length":1,"stats":{"Line":1}},{"line":84,"address":[3635293,3635377],"length":1,"stats":{"Line":2}},{"line":85,"address":[2756634,2756729],"length":1,"stats":{"Line":2}},{"line":86,"address":[2756665],"length":1,"stats":{"Line":1}},{"line":89,"address":[3415334,3414894],"length":1,"stats":{"Line":0}},{"line":90,"address":[3415266],"length":1,"stats":{"Line":0}},{"line":95,"address":[3875336,3875384],"length":1,"stats":{"Line":4}},{"line":98,"address":[3875457,3875392],"length":1,"stats":{"Line":6}},{"line":99,"address":[3876282,3875497],"length":1,"stats":{"Line":3}},{"line":100,"address":[3438153],"length":1,"stats":{"Line":2}},{"line":101,"address":[3731344,3731965,3731276],"length":1,"stats":{"Line":3}},{"line":102,"address":[3875761,3875696,3875861],"length":1,"stats":{"Line":5}},{"line":103,"address":[3438375,3438738],"length":1,"stats":{"Line":2}},{"line":107,"address":[3875479],"length":1,"stats":{"Line":1}},{"line":111,"address":[3438950],"length":1,"stats":{"Line":1}},{"line":113,"address":[3876487,3876687,3876400],"length":1,"stats":{"Line":8}},{"line":117,"address":[3732986],"length":1,"stats":{"Line":3}},{"line":118,"address":[3876505],"length":1,"stats":{"Line":3}},{"line":119,"address":[3876545],"length":1,"stats":{"Line":3}},{"line":120,"address":[3732281],"length":1,"stats":{"Line":3}},{"line":121,"address":[3876625],"length":1,"stats":{"Line":3}},{"line":122,"address":[3876665],"length":1,"stats":{"Line":3}},{"line":123,"address":[3439743],"length":1,"stats":{"Line":3}},{"line":125,"address":[3012590],"length":1,"stats":{"Line":3}},{"line":130,"address":[3878112],"length":1,"stats":{"Line":1}},{"line":131,"address":[3733838],"length":1,"stats":{"Line":1}},{"line":133,"address":[3806585,3806576],"length":1,"stats":{"Line":2}},{"line":135,"address":[2757244,2757232],"length":1,"stats":{"Line":2}},{"line":140,"address":[3013632],"length":1,"stats":{"Line":1}},{"line":141,"address":[3440864],"length":1,"stats":{"Line":3}},{"line":143,"address":[2757289,2757280],"length":1,"stats":{"Line":4}},{"line":148,"address":[3878320,3879920,3879926],"length":1,"stats":{"Line":1}},{"line":152,"address":[2757312,2757321],"length":1,"stats":{"Line":3}},{"line":153,"address":[3734151],"length":1,"stats":{"Line":1}},{"line":154,"address":[3441388,3441276],"length":1,"stats":{"Line":2}},{"line":155,"address":[3734401],"length":1,"stats":{"Line":1}},{"line":160,"address":[3878501],"length":1,"stats":{"Line":1}},{"line":162,"address":[3636105,3636096],"length":1,"stats":{"Line":2}},{"line":164,"address":[3441178],"length":1,"stats":{"Line":1}},{"line":166,"address":[3415696,3415705],"length":1,"stats":{"Line":2}},{"line":169,"address":[3879221,3878634],"length":1,"stats":{"Line":2}},{"line":170,"address":[3014683,3014413],"length":1,"stats":{"Line":1}},{"line":171,"address":[3014854],"length":1,"stats":{"Line":1}},{"line":172,"address":[3442097,3442261,3442162],"length":1,"stats":{"Line":3}},{"line":175,"address":[3014951],"length":1,"stats":{"Line":1}},{"line":179,"address":[3879251,3879962],"length":1,"stats":{"Line":2}},{"line":180,"address":[3442552],"length":1,"stats":{"Line":1}},{"line":184,"address":[3015520],"length":1,"stats":{"Line":1}},{"line":185,"address":[3880186],"length":1,"stats":{"Line":1}},{"line":188,"address":[3636160,3636187,3636337,3636922],"length":1,"stats":{"Line":0}},{"line":189,"address":[3636238,3636342],"length":1,"stats":{"Line":0}},{"line":192,"address":[3806946],"length":1,"stats":{"Line":0}},{"line":194,"address":[2757519,2758172],"length":1,"stats":{"Line":0}},{"line":197,"address":[2758164],"length":1,"stats":{"Line":0}},{"line":202,"address":[3015616],"length":1,"stats":{"Line":1}},{"line":203,"address":[3880257],"length":1,"stats":{"Line":1}},{"line":207,"address":[3880288],"length":1,"stats":{"Line":1}},{"line":208,"address":[3416784,3416793],"length":1,"stats":{"Line":1}},{"line":209,"address":[3880436,3880535],"length":1,"stats":{"Line":0}},{"line":212,"address":[3736190],"length":1,"stats":{"Line":0}},{"line":213,"address":[3016164],"length":1,"stats":{"Line":0}},{"line":214,"address":[3016122],"length":1,"stats":{"Line":0}},{"line":215,"address":[3880815],"length":1,"stats":{"Line":0}},{"line":220,"address":[3880483],"length":1,"stats":{"Line":1}}],"covered":63,"coverable":75},{"path":["/","workspaces","vouchrs","src","settings.rs"],"content":"use serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::fs;\nuse base64::{Engine as _, engine::general_purpose};\n\n// Additional imports for environment and logging setup\n\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct VouchrsSettings {\n    pub application: ApplicationSettings,\n    pub proxy: ProxySettings,\n    pub static_files: StaticFilesSettings,\n    pub session: SessionSettings,\n    pub cookies: CookieSettings,\n    pub logging: LoggingSettings,\n    pub providers: Vec\u003cProviderSettings\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ApplicationSettings {\n    pub host: String,\n    pub port: u16,\n    pub redirect_base_url: String,\n    pub cors_origins: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ProxySettings {\n    pub upstream_url: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct StaticFilesSettings {\n    pub assets_folder: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SessionSettings {\n    pub session_duration_hours: u64,\n    pub session_secret: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CookieSettings {\n    pub secure: bool,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct LoggingSettings {\n    pub level: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ProviderSettings {\n    pub name: String,\n    pub display_name: Option\u003cString\u003e,\n    pub discovery_url: Option\u003cString\u003e,\n    pub authorization_endpoint: Option\u003cString\u003e,\n    pub token_endpoint: Option\u003cString\u003e,\n    pub userinfo_endpoint: Option\u003cString\u003e,\n    pub jwks_uri: Option\u003cString\u003e,\n    pub signout_url: Option\u003cString\u003e,\n    pub scopes: Vec\u003cString\u003e,\n\n    // Direct values (can be overridden by environment variables)\n    pub client_id: Option\u003cString\u003e,\n    pub client_secret: Option\u003cString\u003e,\n\n    // Environment variable names for overrides\n    pub client_id_env: Option\u003cString\u003e,\n    pub client_secret_env: Option\u003cString\u003e,\n\n    pub enabled: bool,\n    pub extra_auth_params: HashMap\u003cString, String\u003e,\n    pub jwt_signing: Option\u003cJwtSigningConfig\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct JwtSigningConfig {\n    // Direct values (can be overridden by environment variables)\n    pub team_id: Option\u003cString\u003e,\n    pub key_id: Option\u003cString\u003e,\n    pub private_key_path: Option\u003cString\u003e,\n\n    // Environment variable names for overrides\n    pub team_id_env: Option\u003cString\u003e,\n    pub key_id_env: Option\u003cString\u003e,\n    pub private_key_path_env: Option\u003cString\u003e,\n}\n\nimpl Default for ApplicationSettings {\n    fn default() -\u003e Self {\n        Self {\n            host: \"0.0.0.0\".to_string(),\n            port: 8080,\n            redirect_base_url: \"http://localhost:8080\".to_string(),\n            cors_origins: \"http://localhost:3000,http://localhost:8080\".to_string(),\n        }\n    }\n}\n\nimpl Default for ProxySettings {\n    fn default() -\u003e Self {\n        Self {\n            upstream_url: \"http://localhost:3000\".to_string(),\n        }\n    }\n}\n\nimpl Default for StaticFilesSettings {\n    fn default() -\u003e Self {\n        Self {\n            assets_folder: \"src/static\".to_string(),\n        }\n    }\n}\n\nimpl Default for SessionSettings {\n    fn default() -\u003e Self {\n        Self {\n            session_duration_hours: 24,\n            session_secret: String::new(), // Will be generated if empty\n        }\n    }\n}\n\nimpl Default for CookieSettings {\n    fn default() -\u003e Self {\n        Self {\n            secure: true, // Default to secure cookies\n        }\n    }\n}\n\nimpl Default for LoggingSettings {\n    fn default() -\u003e Self {\n        Self {\n            level: \"info\".to_string(),\n        }\n    }\n}\n\nimpl Default for ProviderSettings {\n    fn default() -\u003e Self {\n        Self {\n            name: String::new(),\n            display_name: None,\n            discovery_url: None,\n            authorization_endpoint: None,\n            token_endpoint: None,\n            userinfo_endpoint: None,\n            jwks_uri: None,\n            signout_url: None,\n            scopes: vec![\"openid\".to_string(), \"email\".to_string()],\n            client_id: None,\n            client_secret: None,\n            client_id_env: None,\n            client_secret_env: None,\n            enabled: true,\n            extra_auth_params: HashMap::new(),\n            jwt_signing: None,\n        }\n    }\n}\n\nimpl VouchrsSettings {\n    /// Load settings from configuration files and environment variables\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Environment initialization fails\n    /// - Settings file cannot be read or parsed\n    /// - TOML parsing fails\n    pub fn load() -\u003e Result\u003cSelf, Box\u003cdyn std::error::Error\u003e\u003e {\n        // Initialize environment and logging\n        Self::initialize_environment()?;\n\n        // Load base settings from TOML or defaults\n        let mut settings = Self::load_base_settings()?;\n\n        // Apply environment variable overrides\n        Self::apply_env_overrides(\u0026mut settings);\n\n        Ok(settings)\n    }\n\n    /// Initialize environment variables and logging\n    /// \n    /// # Errors\n    /// \n    /// Initialize environment and logging\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if logger initialization fails\n    fn initialize_environment() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n        Self::load_env_file();\n        env_logger::try_init()?;\n        Ok(())\n    }\n\n    /// Load base settings from TOML file(s) or use defaults\n    /// Settings are loaded with the following priority (highest to lowest):\n    /// 1. Environment variables (applied separately after loading base settings)\n    /// 2. Settings.toml in `VOUCHRS_SECRETS_DIR` (if specified and exists)\n    /// 3. Settings.toml in current directory (if exists)\n    /// 4. Default settings\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if:\n    /// - Settings file cannot be read\n    /// - TOML parsing fails\n    fn load_base_settings() -\u003e Result\u003cSelf, Box\u003cdyn std::error::Error\u003e\u003e {\n        // 1. Start with default settings\n        let mut settings = Self::default();\n\n        // 2. Try to load from Settings.toml in current directory (lower priority)\n        let default_config_path = std::path::PathBuf::from(\"Settings.toml\");\n        if default_config_path.exists() {\n            let toml_content = fs::read_to_string(\u0026default_config_path)?;\n            settings = basic_toml::from_str(\u0026toml_content)?;\n            println!(\n                \"âœ“ Loaded base settings from {}\",\n                default_config_path.display()\n            );\n        }\n\n        // 3. If VOUCHRS_SECRETS_DIR is set and contains Settings.toml, override with those settings (higher priority)\n        if let Ok(secrets_dir) = std::env::var(\"VOUCHRS_SECRETS_DIR\") {\n            let secrets_path = std::path::Path::new(\u0026secrets_dir).join(\"Settings.toml\");\n            if secrets_path.exists() {\n                let secrets_toml_content = fs::read_to_string(\u0026secrets_path)?;\n                let secrets_settings: Self =\n                    basic_toml::from_str(\u0026secrets_toml_content)?;\n\n                println!(\"âœ“ Overriding settings from {}\", secrets_path.display());\n\n                // Replace settings with those from secrets directory\n                settings = secrets_settings;\n            } else {\n                println!(\n                    \"â„¹ VOUCHRS_SECRETS_DIR set but no Settings.toml found at: {}\",\n                    secrets_path.display()\n                );\n            }\n        }\n\n        // Environment variables will be applied next, after this function returns\n\n        Ok(settings)\n    }\n\n    /// Apply environment variable overrides to settings\n    fn apply_env_overrides(settings: \u0026mut Self) {\n        Self::apply_application_env_overrides(\u0026mut settings.application);\n        Self::apply_proxy_env_overrides(\u0026mut settings.proxy);\n        Self::apply_static_files_env_overrides(\u0026mut settings.static_files);\n        Self::apply_session_env_overrides(\u0026mut settings.session);\n        Self::apply_cookie_env_overrides(\u0026mut settings.cookies);\n        Self::apply_logging_env_overrides(\u0026mut settings.logging);\n    }\n\n    /// Apply environment overrides for application settings\n    fn apply_application_env_overrides(app_settings: \u0026mut ApplicationSettings) {\n        if let Ok(host) = std::env::var(\"HOST\") {\n            app_settings.host = host;\n        }\n        if let Ok(port_str) = std::env::var(\"PORT\") {\n            if let Ok(port) = port_str.parse::\u003cu16\u003e() {\n                app_settings.port = port;\n            }\n        }\n        if let Ok(redirect_base_url) = std::env::var(\"REDIRECT_BASE_URL\") {\n            app_settings.redirect_base_url = redirect_base_url;\n        }\n        if let Ok(cors_origins) = std::env::var(\"CORS_ORIGINS\") {\n            app_settings.cors_origins = cors_origins;\n        }\n    }\n\n    /// Apply environment overrides for proxy settings\n    fn apply_proxy_env_overrides(proxy_settings: \u0026mut ProxySettings) {\n        if let Ok(upstream_url) = std::env::var(\"UPSTREAM_URL\") {\n            proxy_settings.upstream_url = upstream_url;\n        }\n    }\n\n    /// Apply environment overrides for static files settings\n    fn apply_static_files_env_overrides(static_settings: \u0026mut StaticFilesSettings) {\n        if let Ok(assets_folder) = std::env::var(\"STATIC_FOLDER_PATH\") {\n            static_settings.assets_folder = assets_folder;\n        }\n    }\n\n    /// Apply environment overrides for session settings\n    pub fn apply_session_env_overrides(session_settings: \u0026mut SessionSettings) {\n        if let Ok(session_duration_str) = std::env::var(\"SESSION_DURATION_HOURS\") {\n            if let Ok(session_duration) = session_duration_str.parse::\u003cu64\u003e() {\n                session_settings.session_duration_hours = session_duration;\n            }\n        }\n        \n        // Check if SESSION_SECRET environment variable is set\n        let env_secret_set = if let Ok(session_secret) = std::env::var(\"SESSION_SECRET\") {\n            if session_secret.is_empty() {\n                false\n            } else {\n                session_settings.session_secret = session_secret;\n                true\n            }\n        } else {\n            false\n        };\n        \n        // Generate random session secret if no environment variable was set and current value is empty\n        if !env_secret_set \u0026\u0026 session_settings.session_secret.is_empty() {\n            session_settings.session_secret = Self::generate_random_session_secret();\n            Self::warn_about_generated_secret(\u0026session_settings.session_secret);\n        }\n    }\n    \n    /// Generate a cryptographically secure random session secret\n    /// \n    /// Uses the same secure random source as our crypto utilities\n    /// Generates 32 bytes (256 bits) of entropy for AES-256 compatibility\n    fn generate_random_session_secret() -\u003e String {\n        use rand::RngCore;\n        let mut secret = [0u8; 32]; // 256 bits for AES-256\n        rand::thread_rng().fill_bytes(\u0026mut secret);\n        general_purpose::STANDARD.encode(secret)\n    }\n    \n    /// Display warnings about using a generated session secret\n    fn warn_about_generated_secret(secret: \u0026str) {\n        eprintln!(\"âš ï¸  WARNING: Using auto-generated session secret\");\n        eprintln!(\"ðŸ“ Generated secret: {secret}\");\n        eprintln!(\"ðŸ”’ For production use, set the SESSION_SECRET environment variable\");\n        eprintln!(\"   or configure session_secret in Settings.toml\");\n        eprintln!(\"ðŸ’¡ This secret will change on each restart unless explicitly configured\");\n    }\n\n    /// Apply environment overrides for cookie settings\n    fn apply_cookie_env_overrides(cookie_settings: \u0026mut CookieSettings) {\n        if let Ok(cookie_secure_str) = std::env::var(\"COOKIE_SECURE\") {\n            if let Ok(cookie_secure) = cookie_secure_str.parse::\u003cbool\u003e() {\n                cookie_settings.secure = cookie_secure;\n            }\n        }\n    }\n\n    /// Apply environment overrides for logging settings\n    fn apply_logging_env_overrides(logging_settings: \u0026mut LoggingSettings) {\n        if let Ok(log_level) = std::env::var(\"RUST_LOG\") {\n            logging_settings.level = log_level;\n        }\n    }\n\n    /// Load environment variables from .env file\n    fn load_env_file() {\n        if let Ok(contents) = std::fs::read_to_string(\".env\") {\n            for line in contents.lines() {\n                if let Some((key, value)) = line.split_once('=') {\n                    std::env::set_var(key.trim(), value.trim());\n                }\n            }\n        }\n    }\n\n    /// Get the bind address for the server\n    #[must_use]\n    pub fn get_bind_address(\u0026self) -\u003e String {\n        format!(\"{}:{}\", self.application.host, self.application.port)\n    }\n\n    /// Get CORS origins as a vector of strings\n    #[must_use]\n    pub fn get_cors_origins(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.application\n            .cors_origins\n            .split(',')\n            .map(|s| s.trim().to_string())\n            .collect()\n    }\n\n    /// Get enabled providers\n    #[must_use]\n    pub fn get_enabled_providers(\u0026self) -\u003e Vec\u003c\u0026ProviderSettings\u003e {\n        self.providers.iter().filter(|p| p.enabled).collect()\n    }\n\n    /// Get provider by name\n    #[must_use]\n    pub fn get_provider(\u0026self, name: \u0026str) -\u003e Option\u003c\u0026ProviderSettings\u003e {\n        self.providers.iter().find(|p| p.name == name)\n    }\n}\n\nimpl ProviderSettings {\n    /// Get the client ID, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_client_id(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.client_id_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.client_id.clone()\n    }\n\n    /// Get the client secret, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_client_secret(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.client_secret_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.client_secret.clone()\n    }\n}\n\nimpl JwtSigningConfig {\n    /// Get the team ID, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_team_id(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.team_id_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.team_id.clone()\n    }\n\n    /// Get the key ID, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_key_id(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.key_id_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.key_id.clone()\n    }\n\n    /// Get the private key path, checking environment variable first, then falling back to direct value\n    #[must_use]\n    pub fn get_private_key_path(\u0026self) -\u003e Option\u003cString\u003e {\n        if let Some(env_var) = \u0026self.private_key_path_env {\n            if let Ok(value) = std::env::var(env_var) {\n                return Some(value);\n            }\n        }\n        self.private_key_path.clone()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serial_test::serial;\n\n    // Helper function to clean all relevant environment variables for tests\n    fn clean_env_vars() {\n        std::env::remove_var(\"SESSION_SECRET\");\n        std::env::remove_var(\"SESSION_DURATION_HOURS\");\n        std::env::remove_var(\"VOUCHRS_SECRETS_DIR\");\n    }\n\n    #[test]\n    fn test_session_secret_configuration() {\n        // Test default value - should be empty and will be generated when processed\n        let default_session_settings = SessionSettings::default();\n        assert_eq!(default_session_settings.session_secret, \"\");\n        assert_eq!(default_session_settings.session_duration_hours, 24);\n    }\n\n    #[test]\n    #[serial]\n    fn test_session_secret_env_override() {\n        // Make sure the environment is clean\n        clean_env_vars();\n\n        let mut session_settings = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: \"default-secret\".to_string(),\n        };\n\n        // Set environment variable\n        std::env::set_var(\"SESSION_SECRET\", \"env-override-secret\");\n\n        // Apply environment overrides\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings);\n\n        assert_eq!(session_settings.session_secret, \"env-override-secret\");\n\n        // Clean up\n        std::env::remove_var(\"SESSION_SECRET\");\n    }\n\n    #[test]\n    #[serial]\n    fn test_session_duration_env_override() {\n        // Make sure the environment is clean\n        clean_env_vars();\n\n        let mut session_settings = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: \"test-secret\".to_string(),\n        };\n\n        // Set environment variable\n        std::env::set_var(\"SESSION_DURATION_HOURS\", \"48\");\n\n        // Apply environment overrides\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings);\n\n        assert_eq!(session_settings.session_duration_hours, 48);\n        assert_eq!(session_settings.session_secret, \"test-secret\"); // Should remain unchanged\n\n        // Clean up\n        clean_env_vars();\n    }\n\n    #[test]\n    #[serial]\n    fn test_session_env_override() {\n        // Make sure the environment is clean\n        clean_env_vars();\n\n        let mut session_settings = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: \"test-secret\".to_string(),\n        };\n\n        // Apply environment overrides\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings);\n\n        assert_eq!(session_settings.session_secret, \"test-secret\"); // Should remain unchanged\n        \n        clean_env_vars();\n    }\n\n    #[test]\n    #[serial]\n    fn test_settings_dir_precedence() {\n        clean_env_vars();\n        \n        // Setup temp dirs for testing\n        let temp_dir = tempfile::tempdir().unwrap();\n        let temp_path = temp_dir.path();\n\n        // Create a Settings.toml in the root with specific values\n        let root_settings_content = r#\"\n[session]\nsession_secret = \"root-secret-key\"\n\"#;\n\n        // Create a Settings.toml in the \"secrets\" dir with different values\n        let secrets_dir = temp_path.join(\"secrets\");\n        std::fs::create_dir_all(\u0026secrets_dir).unwrap();\n\n        let secrets_settings_content = r#\"\n[session]\nsession_secret = \"secrets-secret-key\"\n\"#;\n\n        // Write the files\n        std::fs::write(temp_path.join(\"Settings.toml\"), root_settings_content).unwrap();\n        std::fs::write(secrets_dir.join(\"Settings.toml\"), secrets_settings_content).unwrap();\n\n        // First test: No VOUCHR_SECRETS_DIR set, should use root Settings.toml\n        std::env::remove_var(\"VOUCHR_SECRETS_DIR\");\n\n        // Mock the load_base_settings to use our temp paths\n        let actual_settings = VouchrsSettings::load_base_settings().unwrap();\n\n        // Validate default values were not overridden in this mock test\n        // This is a limitation of the test due to searching in current directory\n        assert_eq!(\n            actual_settings.session.session_secret,\n            \"\"  // Default is now empty string\n        );\n\n        // Add a proper integration test that would validate this behavior in a controlled environment\n        // For now, we'll just document how it should work\n        println!(\"Note: Full precedence testing requires integration tests with file path control\");\n        \n        clean_env_vars();\n    }\n\n    #[test]\n    #[serial]\n    fn test_vouchrs_secrets_dir_precedence() {\n        clean_env_vars();\n        \n        // This is a conceptual test illustrating the expected behavior\n        // of the settings precedence. A full integration test would require\n        // more control over the file system.\n\n        // Mock settings from root Settings.toml\n        let mut mock_root_settings = VouchrsSettings::default();\n        mock_root_settings.session.session_secret = \"root-secret-key\".to_string();\n\n\n        // Mock settings from VOUCHRS_SECRETS_DIR Settings.toml\n        let mut mock_secrets_settings = VouchrsSettings::default();\n        mock_secrets_settings.session.session_secret = \"secrets-secret-key\".to_string();\n\n        // Scenario 1: No VOUCHRS_SECRETS_DIR, use root settings\n        assert_eq!(mock_root_settings.session.session_secret, \"root-secret-key\");\n\n        // Scenario 2: With VOUCHRS_SECRETS_DIR, prefer settings from secrets dir\n        assert_eq!(\n            mock_secrets_settings.session.session_secret,\n            \"secrets-secret-key\"\n        );\n\n        // Scenario 3: Environment variables override both\n        let mut settings_with_env = mock_secrets_settings.clone();\n        std::env::set_var(\"SESSION_SECRET\", \"env-secret-key\");\n\n        VouchrsSettings::apply_session_env_overrides(\u0026mut settings_with_env.session);\n\n        assert_eq!(settings_with_env.session.session_secret, \"env-secret-key\");\n\n        // Clean up\n        clean_env_vars();\n    }\n\n    #[test]\n    #[serial]\n    fn test_session_secret_auto_generation() {\n        // Make sure the environment is clean\n        clean_env_vars();\n        \n        let mut session_settings = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: String::new(), // Empty, should trigger auto-generation\n        };\n\n        // Apply environment overrides (which includes auto-generation)\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings);\n\n        // Should have generated a non-empty secret\n        assert!(!session_settings.session_secret.is_empty());\n        assert!(session_settings.session_secret.len() \u003e 40); // Base64 encoded 32 bytes should be ~44 chars\n        \n        // Generate another one to ensure they're different\n        let mut session_settings2 = SessionSettings {\n            session_duration_hours: 24,\n            session_secret: String::new(),\n        };\n        VouchrsSettings::apply_session_env_overrides(\u0026mut session_settings2);\n        \n        // Should be different each time\n        assert_ne!(session_settings.session_secret, session_settings2.session_secret);\n        \n        clean_env_vars();\n    }\n}\n","traces":[{"line":92,"address":[2855739,2855745,2855472],"length":1,"stats":{"Line":3}},{"line":94,"address":[2591294],"length":1,"stats":{"Line":3}},{"line":96,"address":[2591330],"length":1,"stats":{"Line":3}},{"line":97,"address":[2855578],"length":1,"stats":{"Line":4}},{"line":103,"address":[3695520],"length":1,"stats":{"Line":4}},{"line":105,"address":[2855773],"length":1,"stats":{"Line":4}},{"line":111,"address":[2591648],"length":1,"stats":{"Line":4}},{"line":113,"address":[3532413],"length":1,"stats":{"Line":4}},{"line":119,"address":[2855920],"length":1,"stats":{"Line":4}},{"line":122,"address":[2855933],"length":1,"stats":{"Line":4}},{"line":136,"address":[3532576],"length":1,"stats":{"Line":4}},{"line":138,"address":[3532589],"length":1,"stats":{"Line":4}},{"line":144,"address":[2857277,2857488,2856096],"length":1,"stats":{"Line":0}},{"line":146,"address":[3695878],"length":1,"stats":{"Line":0}},{"line":154,"address":[2591998,2592059,2593158],"length":1,"stats":{"Line":0}},{"line":160,"address":[3696373],"length":1,"stats":{"Line":0}},{"line":175,"address":[2857933,2857939,2857504],"length":1,"stats":{"Line":0}},{"line":177,"address":[3697281],"length":1,"stats":{"Line":0}},{"line":180,"address":[3697385],"length":1,"stats":{"Line":0}},{"line":183,"address":[2593633],"length":1,"stats":{"Line":0}},{"line":185,"address":[2857874],"length":1,"stats":{"Line":0}},{"line":197,"address":[2857952],"length":1,"stats":{"Line":0}},{"line":198,"address":[3697716],"length":1,"stats":{"Line":0}},{"line":199,"address":[3697721],"length":1,"stats":{"Line":0}},{"line":200,"address":[3697779],"length":1,"stats":{"Line":0}},{"line":215,"address":[3697808,3700387,3700771],"length":1,"stats":{"Line":1}},{"line":217,"address":[2593879],"length":1,"stats":{"Line":1}},{"line":220,"address":[2858116],"length":1,"stats":{"Line":1}},{"line":221,"address":[2594000,2594080],"length":1,"stats":{"Line":2}},{"line":222,"address":[3534897,3537542],"length":1,"stats":{"Line":1}},{"line":223,"address":[2858545,2858628,2858805],"length":1,"stats":{"Line":2}},{"line":224,"address":[2858912],"length":1,"stats":{"Line":1}},{"line":231,"address":[3698929,3698884,3698063],"length":1,"stats":{"Line":2}},{"line":232,"address":[3698969,3699064],"length":1,"stats":{"Line":0}},{"line":233,"address":[2859344,2859427],"length":1,"stats":{"Line":0}},{"line":234,"address":[3536242,3536039,3537239],"length":1,"stats":{"Line":0}},{"line":235,"address":[3699694,3699623],"length":1,"stats":{"Line":0}},{"line":238,"address":[2860216,2860148],"length":1,"stats":{"Line":0}},{"line":241,"address":[2860355,2860412],"length":1,"stats":{"Line":0}},{"line":243,"address":[3536079,3536022],"length":1,"stats":{"Line":0}},{"line":252,"address":[2860822],"length":1,"stats":{"Line":1}},{"line":256,"address":[3537616],"length":1,"stats":{"Line":0}},{"line":257,"address":[3537630],"length":1,"stats":{"Line":0}},{"line":258,"address":[3537640],"length":1,"stats":{"Line":0}},{"line":259,"address":[2596822],"length":1,"stats":{"Line":0}},{"line":260,"address":[2596836],"length":1,"stats":{"Line":0}},{"line":261,"address":[2861126],"length":1,"stats":{"Line":0}},{"line":262,"address":[2596870],"length":1,"stats":{"Line":0}},{"line":266,"address":[2861454,2861168,2861425],"length":1,"stats":{"Line":0}},{"line":267,"address":[2597015,2596916,2597148],"length":1,"stats":{"Line":0}},{"line":268,"address":[2861331,2861394,2861315],"length":1,"stats":{"Line":0}},{"line":270,"address":[3701332,3701251],"length":1,"stats":{"Line":0}},{"line":271,"address":[2597520,2597500,2597413,2597342],"length":1,"stats":{"Line":0}},{"line":272,"address":[3701548],"length":1,"stats":{"Line":0}},{"line":275,"address":[3701911,3701735,3701640],"length":1,"stats":{"Line":0}},{"line":276,"address":[2862115,2862015,2862035],"length":1,"stats":{"Line":0}},{"line":278,"address":[2598038,2598214,2597940],"length":1,"stats":{"Line":0}},{"line":279,"address":[2862370,2862450,2862350],"length":1,"stats":{"Line":0}},{"line":284,"address":[2598516,2598304,2598542],"length":1,"stats":{"Line":0}},{"line":285,"address":[2598387,2598511,2598318],"length":1,"stats":{"Line":0}},{"line":286,"address":[2598485,2598412,2598428],"length":1,"stats":{"Line":0}},{"line":291,"address":[3702852,3702640,3702878],"length":1,"stats":{"Line":0}},{"line":292,"address":[2862894,2862963,2863087],"length":1,"stats":{"Line":0}},{"line":293,"address":[2598716,2598789,2598732],"length":1,"stats":{"Line":0}},{"line":298,"address":[2863496,2863184,2863502],"length":1,"stats":{"Line":1}},{"line":299,"address":[3703050,3702964],"length":1,"stats":{"Line":2}},{"line":300,"address":[2599190,2599173,2599116,2599051],"length":1,"stats":{"Line":4}},{"line":301,"address":[2863458],"length":1,"stats":{"Line":1}},{"line":306,"address":[2863941,2863562,2863628],"length":1,"stats":{"Line":3}},{"line":307,"address":[2863809,2863686,2863742],"length":1,"stats":{"Line":2}},{"line":308,"address":[3703564],"length":1,"stats":{"Line":0}},{"line":310,"address":[3540313,3540376],"length":1,"stats":{"Line":1}},{"line":311,"address":[3703678],"length":1,"stats":{"Line":1}},{"line":314,"address":[2599351],"length":1,"stats":{"Line":1}},{"line":318,"address":[2864080,2864111],"length":1,"stats":{"Line":2}},{"line":319,"address":[3540722,3540696],"length":1,"stats":{"Line":1}},{"line":320,"address":[2864264],"length":1,"stats":{"Line":1}},{"line":328,"address":[3540848,3541029,3541035],"length":1,"stats":{"Line":1}},{"line":330,"address":[2600029],"length":1,"stats":{"Line":1}},{"line":331,"address":[2864314],"length":1,"stats":{"Line":1}},{"line":332,"address":[2864401],"length":1,"stats":{"Line":1}},{"line":336,"address":[2600224],"length":1,"stats":{"Line":1}},{"line":337,"address":[3704273],"length":1,"stats":{"Line":1}},{"line":338,"address":[3541102],"length":1,"stats":{"Line":1}},{"line":339,"address":[3704384],"length":1,"stats":{"Line":1}},{"line":340,"address":[2864659],"length":1,"stats":{"Line":1}},{"line":341,"address":[2600422],"length":1,"stats":{"Line":1}},{"line":345,"address":[2600480,2600766,2600772],"length":1,"stats":{"Line":0}},{"line":346,"address":[2600561,2600497],"length":1,"stats":{"Line":0}},{"line":347,"address":[3704753,3704623,3704682,3704774],"length":1,"stats":{"Line":0}},{"line":348,"address":[3541569],"length":1,"stats":{"Line":0}},{"line":354,"address":[3541696,3541908,3541934],"length":1,"stats":{"Line":0}},{"line":355,"address":[2601055,2600862,2600931],"length":1,"stats":{"Line":0}},{"line":356,"address":[2865244,2865260,2865317],"length":1,"stats":{"Line":0}},{"line":361,"address":[3705200,3705942,3705936],"length":1,"stats":{"Line":0}},{"line":362,"address":[2865447,2865563],"length":1,"stats":{"Line":0}},{"line":363,"address":[3542244,3542165],"length":1,"stats":{"Line":0}},{"line":364,"address":[2865967,2865858],"length":1,"stats":{"Line":0}},{"line":365,"address":[3542636],"length":1,"stats":{"Line":0}},{"line":373,"address":[2601968],"length":1,"stats":{"Line":0}},{"line":374,"address":[3706061],"length":1,"stats":{"Line":0}},{"line":379,"address":[2602160],"length":1,"stats":{"Line":0}},{"line":380,"address":[2866502],"length":1,"stats":{"Line":0}},{"line":383,"address":[3010144,3010197],"length":1,"stats":{"Line":0}},{"line":389,"address":[2866576],"length":1,"stats":{"Line":0}},{"line":390,"address":[2866608],"length":1,"stats":{"Line":0}},{"line":395,"address":[3543232],"length":1,"stats":{"Line":0}},{"line":396,"address":[3010289,3010272],"length":1,"stats":{"Line":0}},{"line":403,"address":[2866752],"length":1,"stats":{"Line":0}},{"line":404,"address":[3706535],"length":1,"stats":{"Line":0}},{"line":405,"address":[2602597,2602531],"length":1,"stats":{"Line":0}},{"line":406,"address":[2866931],"length":1,"stats":{"Line":0}},{"line":409,"address":[2866868],"length":1,"stats":{"Line":0}},{"line":414,"address":[3706752],"length":1,"stats":{"Line":0}},{"line":415,"address":[2602711],"length":1,"stats":{"Line":0}},{"line":416,"address":[3706835,3706901],"length":1,"stats":{"Line":0}},{"line":417,"address":[2602867],"length":1,"stats":{"Line":0}},{"line":420,"address":[3543668],"length":1,"stats":{"Line":0}},{"line":427,"address":[2602928],"length":1,"stats":{"Line":4}},{"line":428,"address":[3543815],"length":1,"stats":{"Line":4}},{"line":429,"address":[3707129,3707070],"length":1,"stats":{"Line":0}},{"line":430,"address":[2867399],"length":1,"stats":{"Line":0}},{"line":433,"address":[2603039],"length":1,"stats":{"Line":4}},{"line":438,"address":[3707232],"length":1,"stats":{"Line":3}},{"line":439,"address":[2867495],"length":1,"stats":{"Line":3}},{"line":440,"address":[3544173,3544110],"length":1,"stats":{"Line":0}},{"line":441,"address":[3544203],"length":1,"stats":{"Line":0}},{"line":444,"address":[3707343],"length":1,"stats":{"Line":3}},{"line":449,"address":[2603408],"length":1,"stats":{"Line":3}},{"line":450,"address":[2867735],"length":1,"stats":{"Line":3}},{"line":451,"address":[3707613,3707550],"length":1,"stats":{"Line":0}},{"line":452,"address":[3707643],"length":1,"stats":{"Line":0}},{"line":455,"address":[3707583],"length":1,"stats":{"Line":3}}],"covered":52,"coverable":133},{"path":["/","workspaces","vouchrs","src","utils","apple.rs"],"content":"// Apple-specific utility functions\nuse crate::oauth::OAuthCallback;\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\n\n/// Parse and process Apple user information from various sources\n///\n/// This function can:\n/// 1. Parse a raw JSON Value into `AppleUserInfo` (when called with just the value)\n/// 2. Process OAuth callback data and existing user info (when called with callback and existing info)\n///\n/// Apple Sign In can provide user information in two ways:\n/// - In the initial token response (handled by the OAuth provider)\n/// - In the callback data's 'user' parameter (handled here)\n///\n/// When both sources are provided, the callback data is prioritized\n\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct AppleUserName {\n    #[serde(rename = \"firstName\")]\n    pub first_name: Option\u003cString\u003e,\n    #[serde(rename = \"lastName\")]\n    pub last_name: Option\u003cString\u003e,\n}\n\nimpl AppleUserName {\n    /// Get the full name by concatenating first and last name with a space\n    #[must_use]\n    pub fn full_name(\u0026self) -\u003e String {\n        format!(\n            \"{} {}\",\n            self.first_name.as_deref().unwrap_or(\"\"),\n            self.last_name.as_deref().unwrap_or(\"\")\n        )\n    }\n}\n\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct AppleUserInfo {\n    pub name: AppleUserName,\n    pub email: Option\u003cString\u003e,\n}\n\n/// Process Apple user information from a JSON value\n/// \n/// # Arguments\n/// \n/// * `source` - The JSON value containing Apple user information\n/// * `fallback_info` - Optional fallback information to use if parsing fails\n/// \n/// # Returns\n/// \n/// Returns `Some(AppleUserInfo)` if parsing succeeds or fallback is available, `None` otherwise\n#[must_use]\npub fn process_apple_user_info(\n    user_value: \u0026Value,\n    existing_user_info: Option\u003cAppleUserInfo\u003e,\n) -\u003e Option\u003cAppleUserInfo\u003e {\n    // If we already have user info, return it\n    if existing_user_info.is_some() {\n        return existing_user_info;\n    }\n\n    // Try to parse from JSON value\n    if let Ok(user_info) = serde_json::from_value::\u003cAppleUserInfo\u003e(user_value.clone()) {\n        return Some(user_info);\n    }\n\n    // If it's a JSON string, try to parse the string\n    if let Value::String(json_str) = user_value {\n        if let Ok(user_info) = serde_json::from_str::\u003cAppleUserInfo\u003e(json_str) {\n            return Some(user_info);\n        }\n    }\n\n    None\n}\n\n/// Process Apple user info from OAuth callback data\n///\n/// This is a convenience wrapper around `process_apple_user_info` that handles\n/// extracting the user JSON from the callback data\n#[must_use]\npub fn process_apple_callback(\n    callback_data: \u0026OAuthCallback,\n    fallback_info: Option\u003cAppleUserInfo\u003e,\n) -\u003e Option\u003cAppleUserInfo\u003e {\n    callback_data\n        .user\n        .as_ref()\n        .and_then(|user_json| process_apple_user_info(user_json, None))\n        .or(fallback_info)\n}\n\n/// Generate Apple client secret JWT\n/// This function creates a properly signed JWT that can be used as a client secret\n/// with Apple's OAuth endpoints.\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Team ID is not configured\n/// - Key ID is not configured\n/// - Private key path is not configured\n/// - Private key file cannot be read\n/// - Private key cannot be parsed\n/// - JWT serialization fails\npub fn generate_jwt_client_secret(\n    jwt_config: \u0026crate::settings::JwtSigningConfig,\n    client_id: \u0026str,\n) -\u003e Result\u003cString, String\u003e {\n    use crate::utils::crypto::{create_jwt, create_jwt_header, JwtAlgorithm};\n    use chrono::{Duration, Utc};\n\n    // Get required values using the getter methods\n    let team_id = jwt_config\n        .get_team_id()\n        .ok_or_else(|| \"Team ID not configured for Apple provider\".to_string())?;\n    let key_id = jwt_config\n        .get_key_id()\n        .ok_or_else(|| \"Key ID not configured for Apple provider\".to_string())?;\n    let private_key_path = jwt_config\n        .get_private_key_path()\n        .ok_or_else(|| \"Private key path not configured for Apple provider\".to_string())?;\n\n    // Read the private key file\n    let private_key_pem = std::fs::read_to_string(\u0026private_key_path)\n        .map_err(|_| \"Failed to read Apple private key file\".to_string())?;\n\n    // Create JWT header with Apple-specific key ID\n    let header = create_jwt_header(\u0026JwtAlgorithm::ES256, Some(\u0026key_id));\n\n    // Create JWT payload with Apple-specific claims\n    let now = Utc::now();\n    let exp = now + Duration::minutes(5);\n\n    let payload = serde_json::json!({\n        \"iss\": team_id,\n        \"iat\": now.timestamp(),\n        \"exp\": exp.timestamp(),\n        \"aud\": \"https://appleid.apple.com\",\n        \"sub\": client_id\n    });\n\n    // Use the generic JWT creation function\n    let jwt = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::ES256, private_key_pem.as_bytes())\n        .map_err(|e| format!(\"Failed to create Apple JWT: {e}\"))?;\n\n    log::debug!(\"Generated Apple client secret JWT\");\n    Ok(jwt)\n}\n\n\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_process_apple_user_info_from_object() {\n        let apple_user_info = AppleUserInfo {\n            name: AppleUserName {\n                first_name: Some(\"John\".to_string()),\n                last_name: Some(\"Doe\".to_string()),\n            },\n            email: Some(\"john.doe@apple.com\".to_string()),\n        };\n\n        let value = serde_json::to_value(\u0026apple_user_info).unwrap();\n        let parsed = process_apple_user_info(\u0026value, None).unwrap();\n\n        assert_eq!(parsed.email, Some(\"john.doe@apple.com\".to_string()));\n        assert_eq!(parsed.name.first_name, Some(\"John\".to_string()));\n        assert_eq!(parsed.name.last_name, Some(\"Doe\".to_string()));\n    }\n\n    #[test]\n    fn test_process_apple_user_info_from_string() {\n        let apple_user_info = AppleUserInfo {\n            name: AppleUserName {\n                first_name: Some(\"Jane\".to_string()),\n                last_name: Some(\"Smith\".to_string()),\n            },\n            email: Some(\"jane.smith@apple.com\".to_string()),\n        };\n\n        let json_string = serde_json::to_string(\u0026apple_user_info).unwrap();\n        let value = Value::String(json_string);\n        let parsed = process_apple_user_info(\u0026value, None).unwrap();\n\n        assert_eq!(parsed.email, Some(\"jane.smith@apple.com\".to_string()));\n        assert_eq!(parsed.name.first_name, Some(\"Jane\".to_string()));\n        assert_eq!(parsed.name.last_name, Some(\"Smith\".to_string()));\n    }\n\n    #[test]\n    fn test_process_apple_user_info_with_fallback() {\n        // Test with invalid value but valid fallback\n        let fallback = AppleUserInfo {\n            name: AppleUserName {\n                first_name: Some(\"Fallback\".to_string()),\n                last_name: Some(\"User\".to_string()),\n            },\n            email: Some(\"fallback@example.com\".to_string()),\n        };\n\n        let value = Value::Number(serde_json::Number::from(42));\n        let result = process_apple_user_info(\u0026value, Some(fallback.clone()));\n\n        assert!(result.is_some());\n        let user = result.unwrap();\n        assert_eq!(user.email, Some(\"fallback@example.com\".to_string()));\n    }\n}\n","traces":[{"line":29,"address":[3683584],"length":1,"stats":{"Line":2}},{"line":30,"address":[2904911,2904984],"length":1,"stats":{"Line":4}},{"line":32,"address":[2904868],"length":1,"stats":{"Line":2}},{"line":33,"address":[2904937],"length":1,"stats":{"Line":2}},{"line":55,"address":[3683888,3684560],"length":1,"stats":{"Line":1}},{"line":60,"address":[3683931,3684007],"length":1,"stats":{"Line":5}},{"line":61,"address":[2984523],"length":1,"stats":{"Line":1}},{"line":65,"address":[3443410,3443463,3443516],"length":1,"stats":{"Line":5}},{"line":66,"address":[3443544],"length":1,"stats":{"Line":1}},{"line":70,"address":[3684260],"length":1,"stats":{"Line":1}},{"line":71,"address":[3684347,3684286,3684422],"length":1,"stats":{"Line":3}},{"line":72,"address":[2905701],"length":1,"stats":{"Line":1}},{"line":76,"address":[2905561],"length":1,"stats":{"Line":0}},{"line":84,"address":[2905840,2906087,2906115],"length":1,"stats":{"Line":0}},{"line":88,"address":[2985114,2985196,2985285],"length":1,"stats":{"Line":0}},{"line":91,"address":[3225280,3225297],"length":1,"stats":{"Line":0}},{"line":92,"address":[3444093],"length":1,"stats":{"Line":0}},{"line":108,"address":[2985360,2988895,2989134],"length":1,"stats":{"Line":4}},{"line":116,"address":[2906174,2906339],"length":1,"stats":{"Line":5}},{"line":118,"address":[3444384],"length":1,"stats":{"Line":3}},{"line":119,"address":[2985834,2989132,2985666,2985729],"length":1,"stats":{"Line":6}},{"line":121,"address":[2906570],"length":1,"stats":{"Line":0}},{"line":122,"address":[2906868,2906700,2906763,2909879],"length":1,"stats":{"Line":6}},{"line":124,"address":[2986068],"length":1,"stats":{"Line":0}},{"line":127,"address":[3445185,3447835,3445104,3445037],"length":1,"stats":{"Line":8}},{"line":128,"address":[3225504,3225488],"length":1,"stats":{"Line":3}},{"line":131,"address":[3445353,3445282],"length":1,"stats":{"Line":4}},{"line":134,"address":[2907367],"length":1,"stats":{"Line":2}},{"line":135,"address":[3686187],"length":1,"stats":{"Line":2}},{"line":137,"address":[2987356,2987617,2987410,2987151,2987097,2988977,2987839,2986757,2986881],"length":1,"stats":{"Line":6}},{"line":139,"address":[2907911,2907841],"length":1,"stats":{"Line":4}},{"line":140,"address":[2987332,2987402],"length":1,"stats":{"Line":4}},{"line":146,"address":[3446824,3447047,3446911],"length":1,"stats":{"Line":4}},{"line":147,"address":[2438848,2438879],"length":1,"stats":{"Line":0}},{"line":149,"address":[2909342,2909156,2909246],"length":1,"stats":{"Line":6}},{"line":150,"address":[2909257],"length":1,"stats":{"Line":2}}],"covered":28,"coverable":36},{"path":["/","workspaces","vouchrs","src","utils","cookie.rs"],"content":"use actix_web::{cookie::Cookie, HttpRequest};\nuse anyhow::{anyhow, Result};\nuse log;\n\n/// Common cookie names used across the application\npub const COOKIE_NAME: \u0026str = \"vouchrs_session\";\npub const USER_COOKIE_NAME: \u0026str = \"vouchrs_user\";\npub const OAUTH_STATE_COOKIE: \u0026str = \"vouchr_oauth_state\";\n\n/// Trait for converting objects to cookies\npub trait ToCookie\u003cT\u003e {\n    /// Convert self to a cookie with provided name using `SessionManager` for encryption\n    /// \n    /// # Errors\n    /// \n    /// Returns an error if the cookie creation fails (e.g., encryption failure)\n    fn to_cookie(\u0026self, manager: \u0026T) -\u003e Result\u003cCookie\u003c'static\u003e\u003e;\n}\n\n/// Options for cookie creation\npub struct CookieOptions {\n    pub http_only: bool,\n    pub secure: bool,\n    pub same_site: actix_web::cookie::SameSite,\n    pub path: String,\n    pub max_age: actix_web::cookie::time::Duration,\n}\n\nimpl Default for CookieOptions {\n    fn default() -\u003e Self {\n        Self {\n            http_only: true,\n            secure: true,\n            same_site: actix_web::cookie::SameSite::Strict,\n            path: \"/\".to_string(),\n            max_age: actix_web::cookie::time::Duration::hours(24),\n        }\n    }\n}\n\n/// Helper function to extract cookie value from `HttpRequest`\n/// \n/// # Errors\n/// \n/// Returns an error if the specified cookie is not found in the request\npub fn extract_cookie_value(req: \u0026HttpRequest, cookie_name: \u0026str) -\u003e Result\u003cString\u003e {\n    req.cookie(cookie_name)\n        .ok_or_else(|| anyhow!(\"Cookie not found: {cookie_name}\"))\n        .map(|cookie| cookie.value().to_string())\n}\n\n/// Create an expired cookie to clear a specific cookie\n#[must_use]\npub fn create_expired_cookie(name: \u0026str, secure: bool) -\u003e Cookie\u003c'static\u003e {\n    Cookie::build(name.to_owned(), \"\")\n        .http_only(true)\n        .secure(secure)\n        .same_site(actix_web::cookie::SameSite::Lax)\n        .path(\"/\")\n        .max_age(actix_web::cookie::time::Duration::seconds(-1))\n        .finish()\n}\n\n/// Helper function to extract and log cookies from a request\npub fn log_cookies(req: \u0026HttpRequest) {\n    if let Ok(cookies) = req.cookies() {\n        for cookie in cookies.iter() {\n            log::info!(\n                \"Found cookie: name='{}', secure={:?}\",\n                cookie.name(),\n                cookie.secure()\n            );\n        }\n    }\n}\n\n/// Filter cookies, removing `vouchrs_session` cookie\n#[must_use]\npub fn filter_vouchrs_cookies(cookie_str: \u0026str) -\u003e Option\u003cString\u003e {\n    let filtered_cookies: Vec\u003c\u0026str\u003e = cookie_str\n        .split(';')\n        .filter_map(|cookie| {\n            let trimmed = cookie.trim();\n            if trimmed.is_empty() || trimmed.starts_with(\u0026format!(\"{COOKIE_NAME}=\")) {\n                None\n            } else {\n                Some(trimmed)\n            }\n        })\n        .collect();\n\n    if filtered_cookies.is_empty() {\n        None\n    } else {\n        Some(filtered_cookies.join(\"; \"))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_filter_vouchrs_cookies() {\n        // Test with single vouchrs_session cookie\n        let cookies = \"vouchrs_session=abc123\";\n        assert_eq!(filter_vouchrs_cookies(cookies), None);\n\n        // Test with multiple cookies including vouchrs_session\n        let cookies = \"other_cookie=value; vouchrs_session=abc123; another_cookie=value2\";\n        assert_eq!(\n            filter_vouchrs_cookies(cookies),\n            Some(\"other_cookie=value; another_cookie=value2\".to_string())\n        );\n\n        // Test with no vouchrs_session cookie\n        let cookies = \"cookie1=value1; cookie2=value2\";\n        assert_eq!(\n            filter_vouchrs_cookies(cookies),\n            Some(\"cookie1=value1; cookie2=value2\".to_string())\n        );\n\n        // Test with empty string\n        assert_eq!(filter_vouchrs_cookies(\"\"), None);\n    }\n\n    #[test]\n    fn test_create_expired_cookie() {\n        let cookie = create_expired_cookie(\"test_cookie\", true);\n        assert_eq!(cookie.name(), \"test_cookie\");\n        assert_eq!(cookie.value(), \"\");\n        assert!(cookie.http_only().unwrap());\n        assert!(cookie.secure().unwrap());\n        assert_eq!(cookie.path().unwrap(), \"/\");\n        assert!(cookie.max_age().unwrap().whole_seconds() \u003c 0);\n    }\n}\n","traces":[{"line":30,"address":[3648252,3648258,3648080],"length":1,"stats":{"Line":4}},{"line":35,"address":[3755331],"length":1,"stats":{"Line":4}},{"line":36,"address":[3755357],"length":1,"stats":{"Line":4}},{"line":46,"address":[3787888],"length":1,"stats":{"Line":0}},{"line":47,"address":[3755538],"length":1,"stats":{"Line":0}},{"line":48,"address":[3799129,3799120],"length":1,"stats":{"Line":0}},{"line":49,"address":[2775483,2775456],"length":1,"stats":{"Line":0}},{"line":54,"address":[3129776,3130155,3130187],"length":1,"stats":{"Line":1}},{"line":55,"address":[3129823,3129960,3130084,3130132],"length":1,"stats":{"Line":4}},{"line":58,"address":[3129952],"length":1,"stats":{"Line":1}},{"line":60,"address":[3130168,3130124,3130024,3130050],"length":1,"stats":{"Line":2}},{"line":65,"address":[3756903,3756048,3756909],"length":1,"stats":{"Line":0}},{"line":66,"address":[3648901,3648834],"length":1,"stats":{"Line":0}},{"line":67,"address":[3649014,3648941],"length":1,"stats":{"Line":0}},{"line":68,"address":[3756592],"length":1,"stats":{"Line":0}},{"line":79,"address":[3131465,3131136,3131459],"length":1,"stats":{"Line":1}},{"line":80,"address":[3789393],"length":1,"stats":{"Line":1}},{"line":82,"address":[2775979,2775600,2775985],"length":1,"stats":{"Line":1}},{"line":83,"address":[3673033],"length":1,"stats":{"Line":2}},{"line":84,"address":[3673241,3673322,3673070],"length":1,"stats":{"Line":4}},{"line":85,"address":[3799612],"length":1,"stats":{"Line":2}},{"line":87,"address":[3799692],"length":1,"stats":{"Line":1}},{"line":92,"address":[3789533,3789473,3789583],"length":1,"stats":{"Line":3}},{"line":93,"address":[3757186],"length":1,"stats":{"Line":1}},{"line":95,"address":[3757155,3757211],"length":1,"stats":{"Line":3}}],"covered":17,"coverable":25},{"path":["/","workspaces","vouchrs","src","utils","crypto.rs"],"content":"// Cryptographic utilities for generating secure tokens and nonces\n\nuse aes_gcm::{\n    aead::{Aead, KeyInit},\n    Aes256Gcm, Key, Nonce,\n};\nuse anyhow::{anyhow, Context, Result};\nuse base64::{engine::general_purpose, Engine as _};\nuse rand::RngCore;\nuse serde::{de::DeserializeOwned, Serialize};\n\n/// Nonce size for AES-256-GCM encryption (96 bits)\npub const NONCE_SIZE: usize = 12;\n\n/// Encryption key size for AES-256 (256 bits)\npub const ENCRYPTION_KEY_SIZE: usize = 32;\n\n/// Generate a cryptographically secure CSRF token\n/// \n/// This generates a more compact token with higher entropy than UUID v4:\n/// - 24 bytes (192 bits) of entropy vs UUID's 122 bits\n/// - `Base64URL` encoding results in 32 characters vs UUID's 36 characters\n/// - Uses the same secure random source as our AES-GCM encryption\n/// \n/// Inspired by oauth2-proxy's approach but optimized for URL length\n/// \n/// # Returns\n/// \n/// A base64url-encoded string representing 24 bytes of cryptographically secure random data\n#[must_use]\npub fn generate_csrf_token() -\u003e String {\n    let mut nonce = [0u8; 24]; // 192 bits of entropy\n    rand::thread_rng().fill_bytes(\u0026mut nonce);\n    general_purpose::URL_SAFE_NO_PAD.encode(nonce)\n}\n\n/// Generate a cryptographically secure nonce of specified byte length\n/// \n/// This is a more general-purpose function for generating secure random data\n/// \n/// # Arguments\n/// \n/// * `length` - Number of bytes to generate (recommended: 16-32 for most use cases)\n/// \n/// # Returns\n/// \n/// A base64url-encoded string representing the specified bytes of random data\n#[must_use]\npub fn generate_nonce(length: usize) -\u003e String {\n    let mut nonce = vec![0u8; length];\n    rand::thread_rng().fill_bytes(\u0026mut nonce);\n    general_purpose::URL_SAFE_NO_PAD.encode(nonce)\n}\n\n/// Helper function to decode JWT token payload without verification\n/// This is used for debugging purposes only to inspect token claims\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - The JWT format is invalid (not 3 parts separated by dots)\n/// - Base64 decoding fails\n/// - UTF-8 decoding fails\n/// - JSON parsing fails\npub fn decode_jwt_payload(token: \u0026str) -\u003e Result\u003cserde_json::Value, String\u003e {\n    let parts: Vec\u003c\u0026str\u003e = token.split('.').collect();\n    if parts.len() != 3 {\n        return Err(\"Invalid JWT format\".to_string());\n    }\n\n    let payload_b64 = parts[1];\n    let payload_bytes = general_purpose::URL_SAFE_NO_PAD\n        .decode(payload_b64)\n        .or_else(|_| general_purpose::STANDARD.decode(payload_b64))\n        .map_err(|_| \"Base64 decode failed\")?;\n\n    let payload_str = String::from_utf8(payload_bytes).map_err(|_| \"UTF-8 decode failed\")?;\n\n    serde_json::from_str(\u0026payload_str).map_err(|_| \"JSON parse failed\".to_string())\n}\n\n/// Generic encryption function for any serializable data using AES-256-GCM\n/// \n/// # Arguments\n/// \n/// * `data` - The data to encrypt (must implement Serialize)\n/// * `key` - The encryption key (must be 32 bytes for AES-256)\n/// \n/// # Returns\n/// \n/// A Base64URL-encoded string containing the nonce + ciphertext\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Serialization fails\n/// - Key length is invalid\n/// - AES encryption fails\npub fn encrypt_data\u003cT: Serialize\u003e(data: \u0026T, key: \u0026[u8]) -\u003e Result\u003cString\u003e {\n    if key.len() != ENCRYPTION_KEY_SIZE {\n        return Err(anyhow!(\"Invalid key length: expected {} bytes, got {}\", ENCRYPTION_KEY_SIZE, key.len()));\n    }\n\n    // Serialize the data to JSON\n    let json_data = serde_json::to_string(data).context(\"Failed to serialize data\")?;\n\n    // Generate random nonce\n    let mut nonce_bytes = [0u8; NONCE_SIZE];\n    rand::thread_rng().fill_bytes(\u0026mut nonce_bytes);\n    let nonce = Nonce::from_slice(\u0026nonce_bytes);\n\n    // Encrypt the data\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(key));\n    let ciphertext = cipher\n        .encrypt(nonce, json_data.as_bytes())\n        .map_err(|e| anyhow!(\"AES encryption failed: {e}\"))?;\n\n    // Combine nonce + ciphertext and encode as base64\n    let mut combined = Vec::with_capacity(NONCE_SIZE + ciphertext.len());\n    combined.extend_from_slice(\u0026nonce_bytes);\n    combined.extend_from_slice(\u0026ciphertext);\n\n    Ok(general_purpose::URL_SAFE_NO_PAD.encode(\u0026combined))\n}\n\n/// Generic decryption function for any deserializable data using AES-256-GCM\n/// \n/// # Arguments\n/// \n/// * `encrypted_data` - Base64URL-encoded string containing nonce + ciphertext\n/// * `key` - The decryption key (must be 32 bytes for AES-256)\n/// \n/// # Returns\n/// \n/// The decrypted and deserialized data\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Key length is invalid\n/// - Base64 decoding fails\n/// - Data length is invalid\n/// - AES decryption fails\n/// - Deserialization fails\npub fn decrypt_data\u003cT: DeserializeOwned\u003e(encrypted_data: \u0026str, key: \u0026[u8]) -\u003e Result\u003cT\u003e {\n    if key.len() != ENCRYPTION_KEY_SIZE {\n        return Err(anyhow!(\"Invalid key length: expected {} bytes, got {}\", ENCRYPTION_KEY_SIZE, key.len()));\n    }\n\n    // Decode from base64\n    let combined = general_purpose::URL_SAFE_NO_PAD\n        .decode(encrypted_data)\n        .context(\"Failed to decode base64 data\")?;\n\n    if combined.len() \u003c NONCE_SIZE {\n        return Err(anyhow!(\"Invalid data length\"));\n    }\n\n    // Split nonce and ciphertext\n    let (nonce_bytes, ciphertext) = combined.split_at(NONCE_SIZE);\n    let nonce = Nonce::from_slice(nonce_bytes);\n\n    // Decrypt the data\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(key));\n    let plaintext = cipher\n        .decrypt(nonce, ciphertext)\n        .map_err(|e| anyhow!(\"AES decryption failed: {e}\"))?;\n\n    // Deserialize the data from JSON\n    let data: T = serde_json::from_slice(\u0026plaintext)\n        .context(\"Failed to deserialize data from decrypted JSON\")?;\n\n    Ok(data)\n}\n\n/// Derive a proper 32-byte encryption key from input key material\n/// \n/// This function ensures that any input key is properly extended or truncated\n/// to exactly 32 bytes for use with AES-256. For keys shorter than 32 bytes,\n/// it uses a simple hash-based extension method.\n/// \n/// # Arguments\n/// \n/// * `input_key` - The input key material (any length)\n/// \n/// # Returns\n/// \n/// A 32-byte encryption key suitable for AES-256\n/// \n/// # Note\n/// \n/// This is a simple key derivation method. For production use with weak keys,\n/// consider using proper key derivation functions like PBKDF2 or HKDF.\n#[must_use] pub fn derive_encryption_key(input_key: \u0026[u8]) -\u003e [u8; ENCRYPTION_KEY_SIZE] {\n    let mut encryption_key = [0u8; ENCRYPTION_KEY_SIZE];\n    let key_len = std::cmp::min(input_key.len(), ENCRYPTION_KEY_SIZE);\n    encryption_key[..key_len].copy_from_slice(\u0026input_key[..key_len]);\n\n    // If key is shorter than 32 bytes, derive the rest using a simple hash\n    if key_len \u003c ENCRYPTION_KEY_SIZE {\n        for i in key_len..ENCRYPTION_KEY_SIZE {\n            encryption_key[i] = encryption_key[i % key_len].wrapping_add(u8::try_from(i % 256).unwrap_or(0));\n        }\n    }\n\n    encryption_key\n}\n\n/// JWT signing algorithms supported by the generic JWT functions\n#[derive(Debug, Clone, Copy)]\npub enum JwtAlgorithm {\n    /// HMAC with SHA-256 (symmetric key)\n    HS256,\n    /// ECDSA with P-256 curve and SHA-256 (asymmetric key)\n    ES256,\n}\n\n/// Generic JWT creation function for different signing algorithms\n/// \n/// This function supports both HMAC-SHA256 (HS256) and ECDSA P-256 (ES256) signing.\n/// \n/// # Arguments\n/// \n/// * `header` - JWT header as a JSON value\n/// * `payload` - JWT payload/claims as a JSON value  \n/// * `algorithm` - The signing algorithm to use\n/// * `key_material` - Key material for signing:\n///   - For HS256: The shared secret as bytes\n///   - For ES256: PEM-encoded PKCS#8 private key as string\n/// \n/// # Returns\n/// \n/// A complete JWT string with header.payload.signature\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - JSON serialization fails\n/// - Key parsing fails (for ES256)\n/// - Signing operation fails\n/// - Base64 encoding fails\npub fn create_jwt(\n    header: \u0026serde_json::Value,\n    payload: \u0026serde_json::Value,\n    algorithm: JwtAlgorithm,\n    key_material: \u0026[u8],\n) -\u003e Result\u003cString\u003e {\n    // Serialize header and payload\n    let header_json = serde_json::to_string(header)\n        .context(\"Failed to serialize JWT header\")?;\n    let payload_json = serde_json::to_string(payload)\n        .context(\"Failed to serialize JWT payload\")?;\n    \n    // Base64URL encode header and payload\n    let header_b64 = general_purpose::URL_SAFE_NO_PAD.encode(header_json.as_bytes());\n    let payload_b64 = general_purpose::URL_SAFE_NO_PAD.encode(payload_json.as_bytes());\n    \n    let message = format!(\"{header_b64}.{payload_b64}\");\n    \n    // Sign the message based on algorithm\n    let signature_bytes = match algorithm {\n        JwtAlgorithm::HS256 =\u003e sign_jwt_hmac_sha256(message.as_bytes(), key_material)?,\n        JwtAlgorithm::ES256 =\u003e {\n            let key_pem = std::str::from_utf8(key_material)\n                .context(\"ES256 key material must be valid UTF-8 PEM\")?;\n            sign_jwt_es256(message.as_bytes(), key_pem)?\n        }\n    };\n    \n    let signature_b64 = general_purpose::URL_SAFE_NO_PAD.encode(\u0026signature_bytes);\n    \n    Ok(format!(\"{message}.{signature_b64}\"))\n}\n\n/// Sign a message using HMAC-SHA256\n/// \n/// # Arguments\n/// \n/// * `message` - The message to sign\n/// * `secret` - The shared secret key\n/// \n/// # Returns\n/// \n/// The HMAC-SHA256 signature as bytes\n/// \n/// # Errors\n/// \n/// Returns an error if HMAC computation fails\nfn sign_jwt_hmac_sha256(message: \u0026[u8], secret: \u0026[u8]) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n    use hmac::{Hmac, Mac};\n    use sha2::Sha256;\n    \n    type HmacSha256 = Hmac\u003cSha256\u003e;\n    \n    let mut mac = \u003cHmacSha256 as Mac\u003e::new_from_slice(secret)\n        .context(\"Invalid HMAC key length\")?;\n    mac.update(message);\n    \n    Ok(mac.finalize().into_bytes().to_vec())\n}\n\n/// Sign a message using ECDSA P-256 with SHA-256 (ES256)\n/// \n/// # Arguments\n/// \n/// * `message` - The message to sign\n/// * `private_key_pem` - PEM-encoded PKCS#8 private key\n/// \n/// # Returns\n/// \n/// The ES256 signature as bytes\n/// \n/// # Errors\n/// \n/// Returns an error if:\n/// - Private key parsing fails\n/// - Signing operation fails\nfn sign_jwt_es256(message: \u0026[u8], private_key_pem: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n    use p256::ecdsa::{signature::Signer, Signature, SigningKey};\n    use p256::pkcs8::DecodePrivateKey;\n    \n    let signing_key = SigningKey::from_pkcs8_pem(private_key_pem)\n        .map_err(|e| anyhow!(\"Failed to parse ECDSA private key: {e:?}\"))?;\n    \n    let signature: Signature = signing_key.sign(message);\n    Ok(signature.to_bytes().to_vec())\n}\n\n/// Helper function to create JWT header for common algorithms\n/// \n/// # Arguments\n/// \n/// * `algorithm` - The JWT algorithm\n/// * `key_id` - Optional key ID (for ES256 with key rotation)\n/// \n/// # Returns\n/// \n/// A JSON value representing the JWT header\n#[must_use]\npub fn create_jwt_header(algorithm: \u0026JwtAlgorithm, key_id: Option\u003c\u0026str\u003e) -\u003e serde_json::Value {\n    let alg_str = match algorithm {\n        JwtAlgorithm::HS256 =\u003e \"HS256\",\n        JwtAlgorithm::ES256 =\u003e \"ES256\",\n    };\n    \n    let mut header = serde_json::json!({\n        \"alg\": alg_str,\n        \"typ\": \"JWT\"\n    });\n    \n    if let Some(kid) = key_id {\n        header[\"kid\"] = serde_json::Value::String(kid.to_string());\n    }\n    \n    header\n}\n\n/// Helper function to create standard JWT payload with common claims\n/// \n/// # Arguments\n/// \n/// * `issuer` - The issuer (iss) claim\n/// * `subject` - The subject (sub) claim  \n/// * `audience` - The audience (aud) claim\n/// * `expiry_minutes` - Token expiry time in minutes from now\n/// * `additional_claims` - Additional custom claims to include\n/// \n/// # Returns\n/// \n/// A JSON value representing the JWT payload\n#[must_use]\npub fn create_jwt_payload(\n    issuer: \u0026str,\n    subject: \u0026str,\n    audience: \u0026str,\n    expiry_minutes: i64,\n    additional_claims: Option\u003c\u0026serde_json::Value\u003e,\n) -\u003e serde_json::Value {\n    use chrono::{Duration, Utc};\n    \n    let now = Utc::now();\n    let exp = now + Duration::minutes(expiry_minutes);\n    \n    let mut payload = serde_json::json!({\n        \"iss\": issuer,\n        \"sub\": subject,\n        \"aud\": audience,\n        \"iat\": now.timestamp(),\n        \"exp\": exp.timestamp()\n    });\n    \n    // Merge additional claims if provided\n    if let Some(serde_json::Value::Object(additional_map)) = additional_claims {\n        if let serde_json::Value::Object(ref mut payload_map) = payload {\n            for (key, value) in additional_map {\n                payload_map.insert(key.clone(), value.clone());\n            }\n        }\n    }\n    \n    payload\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n    \n    // Test secret key for HMAC operations - generated dynamically\n    fn get_test_secret() -\u003e Vec\u003cu8\u003e {\n        b\"test_secret_key_for_hmac_testing_32b\".to_vec()\n    }\n    \n    // Generate a test P-256 (NIST curve) private key for ES256 testing\n    // This avoids hardcoding a private key in the source code\n    fn generate_test_es256_key() -\u003e String {\n        // Only import these crates inside the test module\n        use p256::pkcs8::{EncodePrivateKey, LineEnding};\n        use p256::ecdsa::{SigningKey};\n        use rand::thread_rng;\n        \n        // Generate a new random key each time using thread_rng from rand crate\n        let signing_key = SigningKey::random(\u0026mut thread_rng());\n        \n        // Convert to PKCS#8 PEM format\n        signing_key.to_pkcs8_pem(LineEnding::LF)\n            .expect(\"Failed to generate test ES256 key\")\n            .to_string()\n    }\n\n    #[test]\n    fn test_create_jwt_header_hs256() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        \n        assert_eq!(header[\"alg\"], \"HS256\");\n        assert_eq!(header[\"typ\"], \"JWT\");\n        assert!(header.get(\"kid\").is_none());\n    }\n\n    #[test]\n    fn test_create_jwt_header_es256_with_kid() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::ES256, Some(\"test-key-id\"));\n        \n        assert_eq!(header[\"alg\"], \"ES256\");\n        assert_eq!(header[\"typ\"], \"JWT\");\n        assert_eq!(header[\"kid\"], \"test-key-id\");\n    }\n\n    #[test]\n    fn test_create_jwt_payload() {\n        let payload = create_jwt_payload(\n            \"test-issuer\",\n            \"test-subject\", \n            \"test-audience\",\n            60, // 1 hour\n            None,\n        );\n        \n        assert_eq!(payload[\"iss\"], \"test-issuer\");\n        assert_eq!(payload[\"sub\"], \"test-subject\");\n        assert_eq!(payload[\"aud\"], \"test-audience\");\n        assert!(payload[\"iat\"].is_number());\n        assert!(payload[\"exp\"].is_number());\n        \n        // Verify expiry is 1 hour from now\n        let iat = payload[\"iat\"].as_i64().unwrap();\n        let exp = payload[\"exp\"].as_i64().unwrap();\n        assert_eq!(exp - iat, 3600); // 60 minutes * 60 seconds\n    }\n\n    #[test]\n    fn test_create_jwt_payload_with_additional_claims() {\n        let additional_claims = json!({\n            \"custom_field\": \"custom_value\",\n            \"number_field\": 123\n        });\n        \n        let payload = create_jwt_payload(\n            \"test-issuer\",\n            \"test-subject\",\n            \"test-audience\", \n            5,\n            Some(\u0026additional_claims),\n        );\n        \n        assert_eq!(payload[\"iss\"], \"test-issuer\");\n        assert_eq!(payload[\"custom_field\"], \"custom_value\");\n        assert_eq!(payload[\"number_field\"], 123);\n    }\n\n    #[test]\n    fn test_hmac_sha256_signing() {\n        let test_secret = get_test_secret();\n        let message = b\"test.message\";\n        let result = sign_jwt_hmac_sha256(message, \u0026test_secret);\n        \n        assert!(result.is_ok());\n        let signature = result.unwrap();\n        assert!(!signature.is_empty());\n        assert_eq!(signature.len(), 32); // SHA-256 produces 32-byte hash\n    }\n\n    #[test]\n    fn test_hmac_sha256_deterministic() {\n        let message = b\"test.message\";\n        let test_secret = get_test_secret();\n        \n        let sig1 = sign_jwt_hmac_sha256(message, \u0026test_secret).unwrap();\n        let sig2 = sign_jwt_hmac_sha256(message, \u0026test_secret).unwrap();\n        \n        assert_eq!(sig1, sig2, \"HMAC signatures should be deterministic\");\n    }\n\n    #[test]\n    fn test_hmac_sha256_different_messages() {\n        let message1 = b\"test.message1\";\n        let message2 = b\"test.message2\";\n        let test_secret = get_test_secret();\n        \n        let sig1 = sign_jwt_hmac_sha256(message1, \u0026test_secret).unwrap();\n        let sig2 = sign_jwt_hmac_sha256(message2, \u0026test_secret).unwrap();\n        \n        assert_ne!(sig1, sig2, \"Different messages should produce different signatures\");\n    }\n\n    #[test]\n    fn test_create_jwt_hs256() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        let payload = json!({\n            \"sub\": \"test-user\",\n            \"iat\": 1_234_567_890,\n            \"exp\": 1_234_571_490\n        });\n        \n        let test_secret = get_test_secret();\n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::HS256, \u0026test_secret);\n        \n        assert!(result.is_ok());\n        let jwt = result.unwrap();\n        \n        // JWT should have 3 parts separated by dots\n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        assert_eq!(parts.len(), 3);\n        \n        // Decode and verify header\n        let header_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[0]).unwrap();\n        let decoded_header: serde_json::Value = serde_json::from_slice(\u0026header_bytes).unwrap();\n        assert_eq!(decoded_header[\"alg\"], \"HS256\");\n        assert_eq!(decoded_header[\"typ\"], \"JWT\");\n        \n        // Decode and verify payload\n        let payload_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[1]).unwrap();\n        let decoded_payload: serde_json::Value = serde_json::from_slice(\u0026payload_bytes).unwrap();\n        assert_eq!(decoded_payload[\"sub\"], \"test-user\");\n        assert_eq!(decoded_payload[\"iat\"], 1_234_567_890);\n        assert_eq!(decoded_payload[\"exp\"], 1_234_571_490);\n    }\n\n    #[test]\n    fn test_create_jwt_hs256_verification() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        let payload = json!({\n            \"sub\": \"test-user\",\n            \"iss\": \"test-issuer\"\n        });\n        \n        let test_secret = get_test_secret();\n        let jwt = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::HS256, \u0026test_secret).unwrap();\n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        \n        // Manually verify HMAC signature\n        let message = format!(\"{}.{}\", parts[0], parts[1]);\n        let expected_signature = sign_jwt_hmac_sha256(message.as_bytes(), \u0026test_secret).unwrap();\n        let expected_signature_b64 = general_purpose::URL_SAFE_NO_PAD.encode(\u0026expected_signature);\n        \n        assert_eq!(parts[2], expected_signature_b64);\n    }\n\n    #[test]\n    fn test_es256_signing_deterministic_within_same_key() {\n        // ES256 produces different signatures each time (due to random k value),\n        // but we should be able to sign successfully\n        let message = b\"test.message\";\n        \n        // Generate a test key for this test\n        let test_es256_key = generate_test_es256_key();\n        \n        let result1 = sign_jwt_es256(message, \u0026test_es256_key);\n        let result2 = sign_jwt_es256(message, \u0026test_es256_key);\n        \n        assert!(result1.is_ok());\n        assert!(result2.is_ok());\n        \n        let sig1 = result1.unwrap();\n        let sig2 = result2.unwrap();\n        \n        // ES256 signatures are not deterministic due to random k value\n        // But they should both be 64 bytes (32 bytes r + 32 bytes s)\n        assert_eq!(sig1.len(), 64);\n        assert_eq!(sig2.len(), 64);\n    }\n\n    #[test]\n    fn test_create_jwt_es256() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::ES256, Some(\"test-key\"));\n        let payload = json!({\n            \"sub\": \"test-user\",\n            \"iss\": \"test-issuer\",\n            \"aud\": \"https://api.example.com\"\n        });\n        \n        // Generate a key for this test\n        let test_es256_key = generate_test_es256_key();\n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::ES256, test_es256_key.as_bytes());\n        \n        assert!(result.is_ok());\n        let jwt = result.unwrap();\n        \n        // JWT should have 3 parts separated by dots\n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        assert_eq!(parts.len(), 3);\n        \n        // Decode and verify header\n        let header_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[0]).unwrap();\n        let decoded_header: serde_json::Value = serde_json::from_slice(\u0026header_bytes).unwrap();\n        assert_eq!(decoded_header[\"alg\"], \"ES256\");\n        assert_eq!(decoded_header[\"typ\"], \"JWT\");\n        assert_eq!(decoded_header[\"kid\"], \"test-key\");\n        \n        // Decode and verify payload\n        let payload_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[1]).unwrap();\n        let decoded_payload: serde_json::Value = serde_json::from_slice(\u0026payload_bytes).unwrap();\n        assert_eq!(decoded_payload[\"sub\"], \"test-user\");\n        assert_eq!(decoded_payload[\"iss\"], \"test-issuer\");\n        assert_eq!(decoded_payload[\"aud\"], \"https://api.example.com\");\n        \n        // Signature should be base64url encoded and non-empty\n        assert!(!parts[2].is_empty());\n        let signature_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[2]).unwrap();\n        assert_eq!(signature_bytes.len(), 64); // ES256 signature is 64 bytes\n    }\n\n    #[test]\n    fn test_create_jwt_invalid_es256_key() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::ES256, None);\n        let payload = json!({\"sub\": \"test\"});\n        let invalid_key = b\"not-a-valid-pem-key\";\n        \n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::ES256, invalid_key);\n        \n        assert!(result.is_err());\n        let error = result.unwrap_err();\n        assert!(error.to_string().contains(\"Failed to parse ECDSA private key\"));\n    }\n\n    #[test]\n    fn test_create_jwt_malformed_es256_key() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::ES256, None);\n        let payload = json!({\"sub\": \"test\"});\n        let malformed_key = \"-----BEGIN PRIVATE KEY-----\\ninvalid\\n-----END PRIVATE KEY-----\";\n        \n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::ES256, malformed_key.as_bytes());\n        \n        assert!(result.is_err());\n        let error = result.unwrap_err();\n        assert!(error.to_string().contains(\"Failed to parse ECDSA private key\"));\n    }\n\n    #[test]\n    fn test_hmac_invalid_key_length() {\n        // Test with zero-length key (should still work with HMAC)\n        let message = b\"test.message\";\n        let empty_key = b\"\";\n        \n        let result = sign_jwt_hmac_sha256(message, empty_key);\n        // HMAC should work with any key length, including empty\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_jwt_algorithm_debug() {\n        // Test that the enum implements Debug properly\n        let hs256 = JwtAlgorithm::HS256;\n        let es256 = JwtAlgorithm::ES256;\n        \n        assert!(format!(\"{hs256:?}\").contains(\"HS256\"));\n        assert!(format!(\"{es256:?}\").contains(\"ES256\"));\n    }\n\n    #[test]\n    fn test_jwt_algorithm_clone() {\n        // Test that the enum implements Clone properly\n        let original = JwtAlgorithm::HS256;\n        let cloned = original;\n        \n        // They should be equal (though we can't test equality directly without PartialEq)\n        assert!(format!(\"{original:?}\") == format!(\"{cloned:?}\"));\n    }\n\n    #[test]\n    fn test_empty_jwt_payload() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        let payload = json!({});\n        \n        let test_secret = get_test_secret();\n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::HS256, \u0026test_secret);\n        \n        assert!(result.is_ok());\n        let jwt = result.unwrap();\n        \n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        assert_eq!(parts.len(), 3);\n        \n        // Should be able to decode empty payload\n        let payload_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[1]).unwrap();\n        let decoded_payload: serde_json::Value = serde_json::from_slice(\u0026payload_bytes).unwrap();\n        assert!(decoded_payload.is_object());\n        assert!(decoded_payload.as_object().unwrap().is_empty());\n    }\n\n    #[test]\n    fn test_large_jwt_payload() {\n        let header = create_jwt_header(\u0026JwtAlgorithm::HS256, None);\n        let large_string = \"x\".repeat(1000);\n        let payload = json!({\n            \"large_field\": large_string,\n            \"sub\": \"test-user\"\n        });\n        \n        let test_secret = get_test_secret();\n        let result = create_jwt(\u0026header, \u0026payload, JwtAlgorithm::HS256, \u0026test_secret);\n        \n        assert!(result.is_ok());\n        let jwt = result.unwrap();\n        \n        let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n        assert_eq!(parts.len(), 3);\n        \n        // Should be able to decode large payload\n        let payload_bytes = general_purpose::URL_SAFE_NO_PAD.decode(parts[1]).unwrap();\n        let decoded_payload: serde_json::Value = serde_json::from_slice(\u0026payload_bytes).unwrap();\n        assert_eq!(decoded_payload[\"sub\"], \"test-user\");\n        assert_eq!(decoded_payload[\"large_field\"], large_string);\n    }\n}\n","traces":[{"line":31,"address":[3895941,3895760,3895935],"length":1,"stats":{"Line":0}},{"line":32,"address":[3191405],"length":1,"stats":{"Line":0}},{"line":33,"address":[3470878],"length":1,"stats":{"Line":0}},{"line":34,"address":[3470965],"length":1,"stats":{"Line":0}},{"line":49,"address":[3471040,3471335,3471329],"length":1,"stats":{"Line":0}},{"line":50,"address":[3895977],"length":1,"stats":{"Line":0}},{"line":51,"address":[3098106,3098162],"length":1,"stats":{"Line":0}},{"line":52,"address":[3471267],"length":1,"stats":{"Line":0}},{"line":65,"address":[3192965,3193066,3191920],"length":1,"stats":{"Line":5}},{"line":66,"address":[3191953],"length":1,"stats":{"Line":2}},{"line":67,"address":[3098478,3098540],"length":1,"stats":{"Line":10}},{"line":68,"address":[3192115,3193025],"length":1,"stats":{"Line":0}},{"line":71,"address":[3471610,3471538],"length":1,"stats":{"Line":7}},{"line":72,"address":[3192177,3192382,3193005],"length":1,"stats":{"Line":7}},{"line":74,"address":[2535472,2535489],"length":1,"stats":{"Line":2}},{"line":75,"address":[3192350],"length":1,"stats":{"Line":2}},{"line":77,"address":[2535552,2535553],"length":1,"stats":{"Line":8}},{"line":79,"address":[3245392,3245376],"length":1,"stats":{"Line":8}},{"line":99,"address":[3247088,3250265,3248688,3250224,3247024,3247065,3248665,3245488,3248624],"length":1,"stats":{"Line":6}},{"line":100,"address":[2538856,2535752,2537304],"length":1,"stats":{"Line":6}},{"line":101,"address":[2537428,2538980,2535876],"length":1,"stats":{"Line":0}},{"line":105,"address":[3949923,3953123,3953474,3950274,3951874,3951523],"length":1,"stats":{"Line":6}},{"line":108,"address":[3951972,3953572,3950372],"length":1,"stats":{"Line":5}},{"line":109,"address":[2537848,2536231,2537783,2536296,2539400,2539335],"length":1,"stats":{"Line":12}},{"line":110,"address":[2537961,2539513,2536409],"length":1,"stats":{"Line":6}},{"line":113,"address":[3247844,3246244,3249444],"length":1,"stats":{"Line":6}},{"line":114,"address":[3155856,3152795,3152656,3154256,3155995,3154395],"length":1,"stats":{"Line":6}},{"line":115,"address":[3154180,3152580,3155780],"length":1,"stats":{"Line":6}},{"line":116,"address":[3156580,3156676,3154379,3156768,3155979,3152779,3156772,3156672,3156576],"length":1,"stats":{"Line":0}},{"line":119,"address":[3248192,3249792,3246592,3248265,3249865,3246665],"length":1,"stats":{"Line":12}},{"line":120,"address":[3952698,3951098,3954298],"length":1,"stats":{"Line":6}},{"line":121,"address":[3153101,3154701,3156301],"length":1,"stats":{"Line":8}},{"line":123,"address":[3250078,3248478,3246878],"length":1,"stats":{"Line":8}},{"line":145,"address":[2543921,2544016,2545765,2540640,2542345,2542368,2545669,2542249,2544032],"length":1,"stats":{"Line":5}},{"line":146,"address":[3250648,3254244,3252424],"length":1,"stats":{"Line":5}},{"line":147,"address":[3956935,3955159,3958761],"length":1,"stats":{"Line":0}},{"line":151,"address":[3158732,3160558,3159112,3156956,3160938,3157336],"length":1,"stats":{"Line":6}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[3251130,3252906,3251203,3254732,3252979,3254805],"length":1,"stats":{"Line":12}},{"line":156,"address":[2541298,2542281,2545701,2544690,2543044,2543953],"length":1,"stats":{"Line":0}},{"line":160,"address":[3959247,3955645,3957353,3959179,3957421,3955577],"length":1,"stats":{"Line":12}},{"line":161,"address":[3159446,3161272,3157670],"length":1,"stats":{"Line":6}},{"line":164,"address":[3161314,3159485,3157709],"length":1,"stats":{"Line":7}},{"line":165,"address":[3253435,3251547,3252247,3251659,3255081,3251476,3253252,3255267,3255775,3254051,3255152,3253323],"length":1,"stats":{"Line":16}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[3255984,3256080,3251643,3253419,3255892,3255888,3255988,3255251,3256084],"length":1,"stats":{"Line":3}},{"line":170,"address":[2543736,2541867,2545168,2541776,2543619,2541990,2545382,2543528,2545259],"length":1,"stats":{"Line":12}},{"line":173,"address":[3253868,3255661,3252076],"length":1,"stats":{"Line":6}},{"line":194,"address":[3193088],"length":1,"stats":{"Line":9}},{"line":195,"address":[3897499],"length":1,"stats":{"Line":9}},{"line":196,"address":[3472577],"length":1,"stats":{"Line":9}},{"line":197,"address":[3897548],"length":1,"stats":{"Line":9}},{"line":200,"address":[3099744],"length":1,"stats":{"Line":9}},{"line":201,"address":[3473026,3472768],"length":1,"stats":{"Line":4}},{"line":202,"address":[3473036,3472859],"length":1,"stats":{"Line":2}},{"line":206,"address":[3897664],"length":1,"stats":{"Line":9}},{"line":242,"address":[3102457,3100096,3102366],"length":1,"stats":{"Line":3}},{"line":249,"address":[3898079,3898207],"length":1,"stats":{"Line":3}},{"line":251,"address":[3475355,3473405,3473521,3473354],"length":1,"stats":{"Line":11}},{"line":255,"address":[3473610,3473681],"length":1,"stats":{"Line":13}},{"line":256,"address":[3194311,3194379],"length":1,"stats":{"Line":14}},{"line":258,"address":[3100937,3100869],"length":1,"stats":{"Line":14}},{"line":261,"address":[3474016],"length":1,"stats":{"Line":7}},{"line":262,"address":[3195008,3194762,3194673],"length":1,"stats":{"Line":6}},{"line":264,"address":[3195032,3194643,3195913,3195150],"length":1,"stats":{"Line":10}},{"line":266,"address":[3474592,3475272],"length":1,"stats":{"Line":7}},{"line":270,"address":[3474359],"length":1,"stats":{"Line":6}},{"line":272,"address":[3195522,3195590],"length":1,"stats":{"Line":7}},{"line":289,"address":[3475376],"length":1,"stats":{"Line":3}},{"line":295,"address":[3102563,3102668],"length":1,"stats":{"Line":4}},{"line":297,"address":[3196285],"length":1,"stats":{"Line":4}},{"line":299,"address":[3196296],"length":1,"stats":{"Line":5}},{"line":318,"address":[3475808,3476427,3476421],"length":1,"stats":{"Line":3}},{"line":322,"address":[3475983,3475893],"length":1,"stats":{"Line":8}},{"line":323,"address":[3475967],"length":1,"stats":{"Line":6}},{"line":325,"address":[3103330],"length":1,"stats":{"Line":4}},{"line":326,"address":[3103395],"length":1,"stats":{"Line":4}},{"line":340,"address":[3901472,3902640,3902634],"length":1,"stats":{"Line":4}},{"line":341,"address":[3103603],"length":1,"stats":{"Line":4}},{"line":342,"address":[3901569],"length":1,"stats":{"Line":1}},{"line":343,"address":[3901546],"length":1,"stats":{"Line":4}},{"line":346,"address":[3476890,3476683,3476571,3477609],"length":1,"stats":{"Line":4}},{"line":351,"address":[3477103,3477563],"length":1,"stats":{"Line":9}},{"line":352,"address":[3197942,3197829,3198030,3198244,3198092],"length":1,"stats":{"Line":8}},{"line":355,"address":[3902226],"length":1,"stats":{"Line":3}},{"line":372,"address":[3104800,3106918,3106924],"length":1,"stats":{"Line":1}},{"line":381,"address":[3902783],"length":1,"stats":{"Line":1}},{"line":382,"address":[3477813],"length":1,"stats":{"Line":1}},{"line":384,"address":[3199651,3198684,3199338,3199597,3198565,3200473,3199119,3199392,3198900],"length":1,"stats":{"Line":6}},{"line":388,"address":[3105848,3105778],"length":1,"stats":{"Line":4}},{"line":389,"address":[3904011,3903941],"length":1,"stats":{"Line":4}},{"line":393,"address":[3479287,3479174],"length":1,"stats":{"Line":3}},{"line":394,"address":[3200028],"length":1,"stats":{"Line":1}},{"line":395,"address":[3479411,3479360],"length":1,"stats":{"Line":2}},{"line":396,"address":[3106785,3106739],"length":1,"stats":{"Line":1}},{"line":401,"address":[3106412],"length":1,"stats":{"Line":1}}],"covered":81,"coverable":96},{"path":["/","workspaces","vouchrs","src","utils","error_handler.rs"],"content":"use actix_web::HttpResponse;\nuse crate::session::SessionManager;\n\npub struct ErrorHandler;\n\nimpl ErrorHandler {\n    /// Create an OAuth error redirect with cookie clearing\n    #[must_use]\n    pub fn oauth_error_redirect(\n        session_manager: \u0026SessionManager,\n        error_type: \u0026str,\n        redirect_url: Option\u003c\u0026str\u003e\n    ) -\u003e HttpResponse {\n        let clear_cookie = session_manager.create_expired_cookie();\n        let location = redirect_url.unwrap_or(\"/oauth2/sign_in\");\n        \n        let final_url = if location.contains('?') {\n            format!(\"{location}\u0026error={error_type}\")\n        } else {\n            format!(\"{location}?error={error_type}\")\n        };\n        \n        HttpResponse::Found()\n            .cookie(clear_cookie)\n            .append_header((\"Location\", final_url))\n            .finish()\n    }\n}","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","utils","logging.rs"],"content":"// Centralized logging utilities to reduce verbose logging patterns\nuse crate::utils::apple::AppleUserInfo;\nuse log::{debug, info, warn};\n\npub struct LoggingHelper;\n\nimpl LoggingHelper {\n    /// Log OAuth token response in a standardized format\n    pub fn log_oauth_token_response(provider: \u0026str, apple_user_info: Option\u003c\u0026AppleUserInfo\u003e) {\n        info!(\"=== OAuth Token Exchange Success for {provider} ===\");\n        // Expires at, refresh token, and id token are now on VouchrSession or passed separately.\n        if provider == \"apple\" {\n            Self::log_apple_user_info(apple_user_info);\n        }\n        info!(\"=== End OAuth Token Analysis ===\");\n    }\n\n    /// Log Apple user info in a standardized format\n    fn log_apple_user_info(apple_user_info: Option\u003c\u0026AppleUserInfo\u003e) {\n        info!(\"=== Apple User Info Analysis ===\");\n        info!(\"Apple user info present: {}\", apple_user_info.is_some());\n\n        if let Some(user_info) = apple_user_info {\n            info!(\"Apple user info email: {:?}\", user_info.email);\n            info!(\"Apple user info name: {:?}\", user_info.name.full_name());\n            info!(\n                \"Apple user info first_name: {:?}\",\n                user_info.name.first_name\n            );\n            info!(\"Apple user info last_name: {:?}\", user_info.name.last_name);\n\n            // Log raw JSON serialization for complete debugging\n            if let Ok(user_info_json) = serde_json::to_string_pretty(user_info) {\n                info!(\"Apple user info JSON:\\n{user_info_json}\");\n            }\n        } else {\n            warn!(\"Apple OAuth completed but no user info was returned in the token response\");\n            warn!(\"This may happen on subsequent logins or if user info was not requested\");\n        }\n    }\n\n    /// Log provider initialization status\n    pub fn log_provider_init(provider_name: \u0026str, display_name: Option\u003c\u0026str\u003e, configured: bool) {\n        let name = display_name.unwrap_or(provider_name);\n        if configured {\n            info!(\"âœ… {name} OAuth2 configured ({provider_name})\");\n        } else {\n            info!(\n                \"âŒ {name} OAuth2 not configured - missing environment variables\"\n            );\n        }\n    }\n\n    /// Log OAuth provider initialization start\n    pub fn log_oauth_provider_initialization() {\n        info!(\"ðŸ”§ Initializing OAuth providers from configuration...\");\n    }\n\n    /// Log that a provider is disabled\n    pub fn log_oauth_provider_disabled(provider_name: \u0026str) {\n        info!(\"â­ï¸  Provider {provider_name} is disabled, skipping\");\n    }\n\n    /// Log that a provider is configured\n    pub fn log_oauth_provider_configured(display_name: \u0026str, provider_name: \u0026str) {\n        info!(\"âœ… {display_name} OAuth2 configured ({provider_name})\");\n    }\n\n    /// Log that a provider is not configured\n    pub fn log_oauth_provider_not_configured(display_name: \u0026str) {\n        info!(\n            \"âŒ {display_name} OAuth2 not configured - missing environment variables\"\n        );\n    }\n\n    /// Log summary of configured OAuth providers\n    pub fn log_oauth_providers_summary(provider_names: \u0026[\u0026String]) {\n        info!(\"ðŸŽ¯ Configured OAuth providers: {provider_names:?}\");\n    }\n\n    /// Log OAuth URL building\n    pub fn log_oauth_url_built(\n        provider: \u0026str,\n        scopes: \u0026str,\n        extra_params: \u0026std::collections::HashMap\u003cString, String\u003e,\n    ) {\n        info!(\n            \"ðŸ” Built {provider} OAuth URL with scopes: {scopes} and extra params: {extra_params:?}\"\n        );\n    }\n\n    /// Log token exchange start\n    pub fn log_token_exchange_start(provider: \u0026str) {\n        info!(\n            \"ðŸ”„ Exchanging authorization code for tokens with {provider}\"\n        );\n    }\n\n    /// Log raw Apple token response for debugging\n    pub fn log_apple_token_response_raw(response_text: \u0026str) {\n        info!(\"=== Raw Apple Token Response ===\");\n        info!(\"Response text: {response_text}\");\n        info!(\"=== End Raw Apple Token Response ===\");\n    }\n\n    /// Log raw token response for other providers\n    pub fn log_token_response_raw(provider: \u0026str, response_text: \u0026str) {\n        debug!(\"Raw {provider} token response: {response_text}\");\n    }\n\n    /// Log token exchange summary\n    pub fn log_token_exchange_summary(\n        provider: \u0026str,\n        refresh_token: Option\u003c\u0026String\u003e,\n        id_token: Option\u003c\u0026String\u003e,\n        token_type: \u0026str,\n        expires_in: Option\u003ci64\u003e,\n    ) {\n        let refresh_status = refresh_token.map_or(\"No\", |_| \"Yes\");\n        let id_status = id_token.map_or(\"No\", |_| \"Yes\");\n        \n        info!(\"ðŸ” Token exchange summary for {provider}: refresh_token={refresh_status}, id_token={id_status}, token_type={token_type}, expires_in={expires_in:?}\");\n    }\n\n    /// Log session creation success\n    pub fn log_session_created(user_email: \u0026str, provider: \u0026str) {\n        info!(\n            \"Successfully built session for user: {user_email} (provider: {provider})\"\n        );\n    }\n\n    /// Log OAuth callback details in development mode\n    pub fn log_callback_debug(\n        req: \u0026actix_web::HttpRequest,\n        callback_data: \u0026crate::oauth::OAuthCallback,\n    ) {\n        debug!(\n            \"OAuth callback received via {}: {callback_data:?}\",\n            req.method()\n        );\n        debug!(\"Callback request headers: {:?}\", req.headers());\n        debug!(\n            \"Callback request connection info: {:?}\",\n            req.connection_info()\n        );\n    }\n}\n","traces":[{"line":9,"address":[3744064],"length":1,"stats":{"Line":0}},{"line":10,"address":[3565212,3565150],"length":1,"stats":{"Line":0}},{"line":12,"address":[2880173],"length":1,"stats":{"Line":0}},{"line":13,"address":[3734779],"length":1,"stats":{"Line":0}},{"line":15,"address":[3744351,3744410],"length":1,"stats":{"Line":0}},{"line":19,"address":[2880640,2883053,2883047],"length":1,"stats":{"Line":0}},{"line":20,"address":[3744604,3744689],"length":1,"stats":{"Line":0}},{"line":21,"address":[3565699,3565936],"length":1,"stats":{"Line":0}},{"line":23,"address":[3568127,3566190,3565899],"length":1,"stats":{"Line":0}},{"line":24,"address":[3745282,3745151],"length":1,"stats":{"Line":0}},{"line":25,"address":[3735621,3735948],"length":1,"stats":{"Line":0}},{"line":26,"address":[3745516,3745927],"length":1,"stats":{"Line":0}},{"line":30,"address":[3745881,3746229],"length":1,"stats":{"Line":0}},{"line":33,"address":[3736902,3736553],"length":1,"stats":{"Line":0}},{"line":34,"address":[3746549,3746667,3746639],"length":1,"stats":{"Line":0}},{"line":37,"address":[3737524,3735575],"length":1,"stats":{"Line":0}},{"line":38,"address":[2883360,2883145],"length":1,"stats":{"Line":0}},{"line":43,"address":[3747488],"length":1,"stats":{"Line":0}},{"line":44,"address":[3737947],"length":1,"stats":{"Line":0}},{"line":45,"address":[3747596],"length":1,"stats":{"Line":0}},{"line":46,"address":[2883687,2883961],"length":1,"stats":{"Line":0}},{"line":48,"address":[3568738,3568656],"length":1,"stats":{"Line":0}},{"line":55,"address":[3748192],"length":1,"stats":{"Line":0}},{"line":56,"address":[3748196,3748229],"length":1,"stats":{"Line":0}},{"line":60,"address":[3748368],"length":1,"stats":{"Line":0}},{"line":61,"address":[3738768,3738807],"length":1,"stats":{"Line":0}},{"line":65,"address":[3569664],"length":1,"stats":{"Line":0}},{"line":66,"address":[2884721,2884682],"length":1,"stats":{"Line":0}},{"line":70,"address":[2884976],"length":1,"stats":{"Line":0}},{"line":71,"address":[3739328,3739367],"length":1,"stats":{"Line":0}},{"line":77,"address":[3749168],"length":1,"stats":{"Line":0}},{"line":78,"address":[3749184,3749223],"length":1,"stats":{"Line":0}},{"line":82,"address":[2885456],"length":1,"stats":{"Line":0}},{"line":87,"address":[3749479,3749440],"length":1,"stats":{"Line":0}},{"line":93,"address":[3749792],"length":1,"stats":{"Line":0}},{"line":94,"address":[3749847,3749808],"length":1,"stats":{"Line":0}},{"line":100,"address":[2886080],"length":1,"stats":{"Line":0}},{"line":101,"address":[3571104,3571175],"length":1,"stats":{"Line":0}},{"line":102,"address":[3740685,3740463],"length":1,"stats":{"Line":0}},{"line":103,"address":[2886580,2886303],"length":1,"stats":{"Line":0}},{"line":107,"address":[3750704],"length":1,"stats":{"Line":0}},{"line":108,"address":[2886778,2886817],"length":1,"stats":{"Line":0}},{"line":112,"address":[3572080],"length":1,"stats":{"Line":0}},{"line":119,"address":[3506021,3506016],"length":1,"stats":{"Line":0}},{"line":120,"address":[3572198],"length":1,"stats":{"Line":0}},{"line":122,"address":[3572226,3572265],"length":1,"stats":{"Line":0}},{"line":126,"address":[3742016],"length":1,"stats":{"Line":0}},{"line":127,"address":[2887706,2887745],"length":1,"stats":{"Line":0}},{"line":133,"address":[3751952,3752955,3752949],"length":1,"stats":{"Line":0}},{"line":137,"address":[2888139],"length":1,"stats":{"Line":0}},{"line":141,"address":[3742392,3742754],"length":1,"stats":{"Line":0}},{"line":142,"address":[3743060],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":52},{"path":["/","workspaces","vouchrs","src","utils","mod.rs"],"content":"pub mod apple;\npub mod cookie;\npub mod crypto;\npub mod logging;\npub mod redirect_validator;\npub mod response_builder;\npub mod user_agent;\n\n// Make test utilities available for both unit tests and integration tests\npub mod test_helpers;\npub mod test_request_builder;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","src","utils","redirect_validator.rs"],"content":"use actix_web::HttpResponse;\nuse log::{debug, warn};\n\n/// Validate post-authentication redirect URLs to prevent open redirect attacks\n/// Balanced approach between security and simplicity\n/// \n/// # Errors\n/// \n/// Returns an `HttpResponse` error in the following cases:\n/// - Empty redirect URL\n/// - URL exceeds 2048 characters\n/// - URL doesn't start with a single forward slash\n/// - URL contains dangerous characters (control chars, Unicode tricks)\n/// - URL contains path traversal patterns\n/// - URL contains encoded double slashes\n/// - URL contains protocol injection attempts\n/// - URL contains suspicious redirect parameters in query string\npub fn validate_post_auth_redirect(redirect_url: \u0026str) -\u003e Result\u003cString, HttpResponse\u003e {\n    debug!(\"Validating post-authentication redirect URL: {redirect_url}\");\n    \n    // Empty redirects are invalid\n    if redirect_url.is_empty() {\n        return Err(invalid_redirect_error());\n    }\n    \n    // Length limit to prevent DoS\n    if redirect_url.len() \u003e 2048 {\n        warn!(\"Redirect URL too long: {} characters\", redirect_url.len());\n        return Err(invalid_redirect_error());\n    }\n    \n    // Must start with a single slash (relative URL only)\n    if !redirect_url.starts_with('/') || redirect_url.starts_with(\"//\") {\n        warn!(\"Invalid redirect URL format: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Check for control characters and other dangerous characters\n    if contains_dangerous_characters(redirect_url) {\n        warn!(\"Dangerous characters in redirect URL: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Simple path traversal check (including encoded variants)\n    if contains_path_traversal(redirect_url) {\n        warn!(\"Path traversal attempt in redirect: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Check for encoded slashes that could create // \n    if contains_encoded_double_slash(redirect_url) {\n        warn!(\"Encoded double slash in redirect: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Basic protocol injection check (including mixed case)\n    if contains_protocol_injection(redirect_url) {\n        warn!(\"Protocol injection attempt in redirect: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    // Check for suspicious query parameters that could be open redirects\n    if contains_redirect_in_query(redirect_url) {\n        warn!(\"Redirect parameter in query string: {redirect_url}\");\n        return Err(invalid_redirect_error());\n    }\n    \n    Ok(redirect_url.to_string())\n}\n\n/// Check for dangerous characters including control chars and Unicode tricks\nfn contains_dangerous_characters(url: \u0026str) -\u003e bool {\n    // Check for null bytes\n    if url.contains('\\0') || url.contains(\"%00\") {\n        return true;\n    }\n    \n    // Check for control characters (both raw and encoded)\n    let control_patterns = [\n        \"\\n\", \"\\r\", \"\\t\", // Raw control chars\n        \"%0a\", \"%0A\", \"%0d\", \"%0D\", \"%09\", // Encoded newline, carriage return, tab\n        \"%01\", \"%02\", \"%03\", \"%04\", \"%05\", \"%06\", \"%07\", \"%08\", // Other control chars\n        \"%0b\", \"%0B\", \"%0c\", \"%0C\", \"%0e\", \"%0E\", \"%0f\", \"%0F\",\n    ];\n    \n    let url_lower = url.to_lowercase();\n    for pattern in \u0026control_patterns {\n        if url.contains(pattern) || url_lower.contains(pattern) {\n            return true;\n        }\n    }\n    \n    // Check for Unicode direction override characters and various spaces\n    if url.chars().any(|c| matches!(c, \n        '\\u{202A}'..='\\u{202E}' | // LTR/RTL override\n        '\\u{2060}'..='\\u{2069}' | // Word joiner and invisible separators\n        '\\u{200B}'..='\\u{200F}' | // Zero-width space and marks\n        '\\u{FEFF}' |              // Zero-width no-break space\n        '\\u{2000}'..='\\u{200A}' | // Various Unicode spaces (en space, em space, etc.)\n        '\\u{00A0}' |              // Non-breaking space\n        '\\u{1680}' |              // Ogham space mark\n        '\\u{180E}' |              // Mongolian vowel separator\n        '\\u{2028}' |              // Line separator\n        '\\u{2029}' |              // Paragraph separator\n        '\\u{205F}' |              // Medium mathematical space\n        '\\u{3000}'                // Ideographic space\n    )) {\n        return true;\n    }\n    \n    false\n}\n\n/// Check for path traversal patterns including encoded variants\nfn contains_path_traversal(url: \u0026str) -\u003e bool {\n    // Direct check\n    if url.contains(\"..\") || url.contains('\\\\') {\n        return true;\n    }\n    \n    // Check URL-encoded variants\n    let encoded_patterns = [\n        \"%2e%2e\", \"%2E%2E\", // ..\n        \"%2e%2e%2f\", \"%2E%2E%2F\", // ../\n        \"%2e%2e%5c\", \"%2E%2E%5C\", // ..\\\n        \"%252e%252e\", \"%252E%252E\", // Double-encoded ..\n        \"%c0%ae\", \"%c1%9c\", // Unicode encoding tricks\n        \"%5c\", \"%5C\", // \\\n        \"%252f\", \"%252F\", // Double-encoded /\n        \"%255c\", \"%255C\", // Double-encoded \\\n    ];\n    \n    let url_lower = url.to_lowercase();\n    for pattern in \u0026encoded_patterns {\n        if url_lower.contains(pattern) {\n            return true;\n        }\n    }\n    \n    false\n}\n\n/// Check for encoded slashes that could create //\nfn contains_encoded_double_slash(url: \u0026str) -\u003e bool {\n    let patterns = [\n        \"%2f%2f\", \"%2F%2F\", // //\n        \"%252f%252f\", \"%252F%252F\", // Double-encoded //\n        \"%2f%252f\", \"%252f%2f\", // Mixed encoding\n        \"/%2f\", \"/%2F\", // Leading to //\n        \"%5c%5c\", \"%5C%5C\", // \\\\\n    ];\n    \n    let url_lower = url.to_lowercase();\n    for pattern in \u0026patterns {\n        if url_lower.contains(pattern) {\n            return true;\n        }\n    }\n    \n    // Check for patterns that would result in // after decoding\n    if url.contains(\"/%2f\") || url.contains(\"/%2F\") ||\n       url.contains(\"/%252f\") || url.contains(\"/%252F\") {\n        return true;\n    }\n    \n    false\n}\n\n/// Check for protocol injection attempts\nfn contains_protocol_injection(url: \u0026str) -\u003e bool {\n    let protocols = [\n        \"javascript:\", \"data:\", \"vbscript:\", \"file:\", \"about:\",\n        \"chrome:\", \"chrome-extension:\", \"ms-browser-extension:\",\n        \"opera:\", \"brave:\", \"edge:\",\n    ];\n    \n    let url_lower = url.to_lowercase();\n    \n    // Direct protocol check\n    for protocol in \u0026protocols {\n        if url_lower.contains(protocol) {\n            return true;\n        }\n    }\n    \n    // Check for encoded protocols\n    let encoded_protocols = [\n        \"%6a%61%76%61%73%63%72%69%70%74%3a\", // javascript:\n        \"%64%61%74%61%3a\", // data:\n        \"\u0026#106;\u0026#97;\u0026#118;\u0026#97;\u0026#115;\u0026#99;\u0026#114;\u0026#105;\u0026#112;\u0026#116;\u0026#58;\", // HTML entity encoded javascript:\n        \"\\\\x6A\\\\x61\\\\x76\\\\x61\\\\x73\\\\x63\\\\x72\\\\x69\\\\x70\\\\x74\\\\x3A\", // Hex escaped javascript:\n    ];\n    \n    for encoded_protocol in \u0026encoded_protocols {\n        if url_lower.contains(encoded_protocol) {\n            return true;\n        }\n    }\n    \n    false\n}\n\n/// Check for redirect parameters in query string\nfn contains_redirect_in_query(url: \u0026str) -\u003e bool {\n    // Common redirect parameter names\n    let redirect_params = [\n        \"redirect\", \"redirect_uri\", \"redirect_url\", \"return\", \"returnurl\",\n        \"return_url\", \"returnto\", \"return_to\", \"next\", \"goto\", \"target\",\n        \"destination\", \"dest\", \"continue\", \"url\", \"link\", \"ref\",\n        \"callback\", \"callback_url\", \"success_url\", \"failure_url\",\n    ];\n    \n    let url_lower = url.to_lowercase();\n    \n    // Check if URL has query string\n    if let Some(query_start) = url_lower.find('?') {\n        let query_part = \u0026url_lower[query_start + 1..];\n        \n        for param in \u0026redirect_params {\n            // Check for parameter=value pattern\n            let patterns = [\n                format!(\"{param}=\"),\n                format!(\"{param}\u0026\"),\n                format!(\"{param}%3d\"), // URL encoded =\n                format!(\"{param}%3D\"),\n            ];\n            \n            for pattern in \u0026patterns {\n                if query_part.contains(pattern) {\n                    return true;\n                }\n            }\n        }\n    }\n    \n    false\n}\n\n/// Create a generic invalid redirect error response\nfn invalid_redirect_error() -\u003e HttpResponse {\n    HttpResponse::BadRequest().json(serde_json::json!({\n        \"error\": \"invalid_redirect\",\n        \"error_description\": \"The redirect URL is invalid or potentially unsafe\"\n    }))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_valid_redirects() {\n        // Valid paths should pass\n        assert!(validate_post_auth_redirect(\"/home\").is_ok());\n        assert!(validate_post_auth_redirect(\"/app/dashboard\").is_ok());\n        assert!(validate_post_auth_redirect(\"/\").is_ok());\n        assert!(validate_post_auth_redirect(\"/page?param=value\").is_ok());\n        assert!(validate_post_auth_redirect(\"/path#anchor\").is_ok());\n    }\n\n    #[test]\n    fn test_empty_redirect() {\n        assert!(validate_post_auth_redirect(\"\").is_err());\n    }\n\n    #[test]\n    fn test_protocol_injection() {\n        // Direct protocol injection\n        assert!(validate_post_auth_redirect(\"/javascript:alert(1)\").is_err());\n        assert!(validate_post_auth_redirect(\"/data:text/html,\u003cscript\u003ealert(1)\u003c/script\u003e\").is_err());\n        \n        // Case variations\n        assert!(validate_post_auth_redirect(\"/JavaScript:alert(1)\").is_err());\n        assert!(validate_post_auth_redirect(\"/JAVASCRIPT:alert(1)\").is_err());\n        \n        // URL encoded\n        assert!(validate_post_auth_redirect(\"/%6a%61%76%61%73%63%72%69%70%74%3aalert(1)\").is_err());\n    }\n\n    #[test]\n    fn test_double_slash() {\n        // Direct double slash\n        assert!(validate_post_auth_redirect(\"//evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"//evil.com/path\").is_err());\n        \n        // Encoded slashes\n        assert!(validate_post_auth_redirect(\"/%2f%2fevil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/%2F%2Fevil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/%252f%252fevil.com\").is_err());\n    }\n\n    #[test]\n    fn test_path_traversal() {\n        // Direct traversal\n        assert!(validate_post_auth_redirect(\"/../etc/passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"/../../etc/passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"/path/../../../etc/passwd\").is_err());\n        \n        // Backslashes\n        assert!(validate_post_auth_redirect(\"/..\\\\etc\\\\passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"\\\\..\\\\etc\\\\passwd\").is_err());\n        \n        // URL encoded\n        assert!(validate_post_auth_redirect(\"/%2e%2e/etc/passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"/%2e%2e%2f%2e%2e%2fetc/passwd\").is_err());\n        assert!(validate_post_auth_redirect(\"/%252e%252e/etc/passwd\").is_err());\n    }\n\n    #[test]\n    fn test_control_characters() {\n        // Raw control characters\n        assert!(validate_post_auth_redirect(\"/path\\nHeader: Value\").is_err());\n        assert!(validate_post_auth_redirect(\"/path\\rHeader: Value\").is_err());\n        assert!(validate_post_auth_redirect(\"/path\\0null\").is_err());\n        \n        // URL encoded control characters\n        assert!(validate_post_auth_redirect(\"/path%0aHeader:%20Value\").is_err());\n        assert!(validate_post_auth_redirect(\"/path%0dHeader:%20Value\").is_err());\n        assert!(validate_post_auth_redirect(\"/path%00null\").is_err());\n    }\n\n    #[test]\n    fn test_unicode_tricks() {\n        // Unicode direction override\n        assert!(validate_post_auth_redirect(\"/path\\u{202E}reversed\").is_err());\n        \n        // Zero-width characters\n        assert!(validate_post_auth_redirect(\"/path\\u{200B}invisible\").is_err());\n        assert!(validate_post_auth_redirect(\"/path\\u{FEFF}bom\").is_err());\n        \n        // Various Unicode spaces\n        assert!(validate_post_auth_redirect(\"/path\\u{2000}space\").is_err());\n        assert!(validate_post_auth_redirect(\"/path\\u{3000}ideographic\").is_err());\n    }\n\n    #[test]\n    fn test_query_string_redirects() {\n        // Common redirect parameters\n        assert!(validate_post_auth_redirect(\"/page?redirect=http://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?redirect_uri=http://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?return_url=http://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?next=http://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?goto=http://evil.com\").is_err());\n        \n        // Multiple parameters\n        assert!(validate_post_auth_redirect(\"/page?safe=true\u0026redirect=http://evil.com\").is_err());\n        \n        // URL encoded equals\n        assert!(validate_post_auth_redirect(\"/page?redirect%3dhttp://evil.com\").is_err());\n        assert!(validate_post_auth_redirect(\"/page?redirect%3Dhttp://evil.com\").is_err());\n    }\n\n    #[test]\n    fn test_length_limit() {\n        let long_path = \"/\".to_string() + \u0026\"a\".repeat(2048);\n        assert!(validate_post_auth_redirect(\u0026long_path).is_err());\n        \n        let max_path = \"/\".to_string() + \u0026\"a\".repeat(2047);\n        assert!(validate_post_auth_redirect(\u0026max_path).is_ok());\n    }\n\n    #[test]\n    fn test_complex_valid_paths() {\n        // Valid complex paths that should pass\n        assert!(validate_post_auth_redirect(\"/app/user/profile/123\").is_ok());\n        assert!(validate_post_auth_redirect(\"/search?q=rust+programming\u0026page=2\").is_ok());\n        assert!(validate_post_auth_redirect(\"/docs/api/v2#authentication\").is_ok());\n        assert!(validate_post_auth_redirect(\"/files/document.pdf\").is_ok());\n        assert!(validate_post_auth_redirect(\"/user@example/profile\").is_ok());\n    }\n\n    #[test]\n    fn test_edge_cases() {\n        // Must start with /\n        assert!(validate_post_auth_redirect(\"home\").is_err());\n        assert!(validate_post_auth_redirect(\"./home\").is_err());\n        assert!(validate_post_auth_redirect(\"~/home\").is_err());\n        \n        // Various invalid patterns\n        assert!(validate_post_auth_redirect(\"/\\0\").is_err());\n        assert!(validate_post_auth_redirect(\"/\\n\").is_err());\n        assert!(validate_post_auth_redirect(\"/\\r\").is_err());\n        \n        // Just a slash is valid\n        assert!(validate_post_auth_redirect(\"/\").is_ok());\n    }\n}\n","traces":[{"line":18,"address":[3889488],"length":1,"stats":{"Line":2}},{"line":19,"address":[4065995,4066054],"length":1,"stats":{"Line":6}},{"line":22,"address":[3856650],"length":1,"stats":{"Line":4}},{"line":23,"address":[3693829],"length":1,"stats":{"Line":1}},{"line":27,"address":[3693804],"length":1,"stats":{"Line":4}},{"line":28,"address":[3693897,3696104],"length":1,"stats":{"Line":2}},{"line":29,"address":[3696063],"length":1,"stats":{"Line":1}},{"line":33,"address":[4066437,4066318],"length":1,"stats":{"Line":8}},{"line":34,"address":[3693943,3695832],"length":1,"stats":{"Line":3}},{"line":35,"address":[3858863],"length":1,"stats":{"Line":2}},{"line":39,"address":[3694021],"length":1,"stats":{"Line":3}},{"line":40,"address":[3694061,3695560],"length":1,"stats":{"Line":2}},{"line":41,"address":[4067967],"length":1,"stats":{"Line":1}},{"line":45,"address":[4066488],"length":1,"stats":{"Line":8}},{"line":46,"address":[3695288,3694128],"length":1,"stats":{"Line":2}},{"line":47,"address":[3891215],"length":1,"stats":{"Line":1}},{"line":51,"address":[4066555],"length":1,"stats":{"Line":7}},{"line":52,"address":[4066643,4067464],"length":1,"stats":{"Line":2}},{"line":53,"address":[3858047],"length":1,"stats":{"Line":1}},{"line":57,"address":[3890142],"length":1,"stats":{"Line":6}},{"line":58,"address":[3857334,3857816],"length":1,"stats":{"Line":2}},{"line":59,"address":[4067151],"length":1,"stats":{"Line":1}},{"line":63,"address":[3694241],"length":1,"stats":{"Line":5}},{"line":64,"address":[4066920,4066830],"length":1,"stats":{"Line":2}},{"line":65,"address":[3694434],"length":1,"stats":{"Line":1}},{"line":68,"address":[3694308],"length":1,"stats":{"Line":4}},{"line":72,"address":[3859440,3860640,3860646],"length":1,"stats":{"Line":4}},{"line":74,"address":[3892369],"length":1,"stats":{"Line":2}},{"line":75,"address":[3859519],"length":1,"stats":{"Line":1}},{"line":79,"address":[3859539],"length":1,"stats":{"Line":5}},{"line":86,"address":[3893077],"length":1,"stats":{"Line":6}},{"line":87,"address":[3893174,3893094],"length":1,"stats":{"Line":15}},{"line":88,"address":[3860559,3860612,3860393],"length":1,"stats":{"Line":28}},{"line":89,"address":[3860590],"length":1,"stats":{"Line":2}},{"line":94,"address":[2612640,2612854,2612688,2612730],"length":1,"stats":{"Line":36}},{"line":95,"address":[2612681,2612653],"length":1,"stats":{"Line":10}},{"line":96,"address":[3842378,3842429],"length":1,"stats":{"Line":10}},{"line":97,"address":[3842540,3842414],"length":1,"stats":{"Line":10}},{"line":99,"address":[3842577,3842557],"length":1,"stats":{"Line":10}},{"line":108,"address":[3893414],"length":1,"stats":{"Line":1}},{"line":111,"address":[3893393],"length":1,"stats":{"Line":8}},{"line":115,"address":[3697584,3698422,3698416],"length":1,"stats":{"Line":8}},{"line":117,"address":[3697617],"length":1,"stats":{"Line":8}},{"line":118,"address":[4070130],"length":1,"stats":{"Line":1}},{"line":122,"address":[3860774],"length":1,"stats":{"Line":7}},{"line":133,"address":[3894084],"length":1,"stats":{"Line":7}},{"line":134,"address":[4070581,4070661],"length":1,"stats":{"Line":8}},{"line":135,"address":[3894294,3894359],"length":1,"stats":{"Line":15}},{"line":136,"address":[4070867],"length":1,"stats":{"Line":1}},{"line":140,"address":[3894311],"length":1,"stats":{"Line":7}},{"line":144,"address":[3895250,3895256,3894432],"length":1,"stats":{"Line":3}},{"line":145,"address":[4070951],"length":1,"stats":{"Line":7}},{"line":153,"address":[3698739],"length":1,"stats":{"Line":7}},{"line":154,"address":[3698761,3698832],"length":1,"stats":{"Line":14}},{"line":155,"address":[3894933,3895215],"length":1,"stats":{"Line":14}},{"line":156,"address":[3862347],"length":1,"stats":{"Line":1}},{"line":161,"address":[4071531,4071443],"length":1,"stats":{"Line":12}},{"line":162,"address":[4071547],"length":1,"stats":{"Line":6}},{"line":163,"address":[3895037],"length":1,"stats":{"Line":0}},{"line":166,"address":[3699163],"length":1,"stats":{"Line":6}},{"line":170,"address":[3896260,3895280,3896254],"length":1,"stats":{"Line":5}},{"line":171,"address":[3862413],"length":1,"stats":{"Line":6}},{"line":177,"address":[3895600],"length":1,"stats":{"Line":6}},{"line":180,"address":[3895617,3895697],"length":1,"stats":{"Line":12}},{"line":181,"address":[3863323,3862914],"length":1,"stats":{"Line":12}},{"line":182,"address":[3863351],"length":1,"stats":{"Line":1}},{"line":187,"address":[4072310],"length":1,"stats":{"Line":5}},{"line":194,"address":[4072418],"length":1,"stats":{"Line":5}},{"line":195,"address":[3896155,3896090],"length":1,"stats":{"Line":10}},{"line":196,"address":[3863287],"length":1,"stats":{"Line":1}},{"line":200,"address":[3700103],"length":1,"stats":{"Line":5}},{"line":204,"address":[3863392,3865538,3865544],"length":1,"stats":{"Line":2}},{"line":206,"address":[3896317],"length":1,"stats":{"Line":5}},{"line":213,"address":[4073364],"length":1,"stats":{"Line":5}},{"line":216,"address":[3700895,3700978],"length":1,"stats":{"Line":10}},{"line":217,"address":[3864228,3864180],"length":1,"stats":{"Line":2}},{"line":219,"address":[3864326],"length":1,"stats":{"Line":3}},{"line":221,"address":[3701985],"length":1,"stats":{"Line":3}},{"line":222,"address":[3701345],"length":1,"stats":{"Line":2}},{"line":223,"address":[4073972,4074043],"length":1,"stats":{"Line":5}},{"line":224,"address":[3864767,3864838],"length":1,"stats":{"Line":6}},{"line":225,"address":[3864938,3865009],"length":1,"stats":{"Line":6}},{"line":228,"address":[3702121,3702188],"length":1,"stats":{"Line":6}},{"line":229,"address":[3702335,3702298],"length":1,"stats":{"Line":6}},{"line":230,"address":[3702344],"length":1,"stats":{"Line":1}},{"line":236,"address":[3897092],"length":1,"stats":{"Line":4}},{"line":240,"address":[3898464,3899183,3899211],"length":1,"stats":{"Line":1}},{"line":241,"address":[3898679,3898566,3898897,3899161,3898480,3899189],"length":1,"stats":{"Line":2}}],"covered":87,"coverable":88},{"path":["/","workspaces","vouchrs","src","utils","response_builder.rs"],"content":"// filepath: /workspaces/vouchrs/src/utils/response_builder.rs\nuse actix_web::{cookie::Cookie, web, HttpRequest, HttpResponse};\nuse reqwest;\nuse std::collections::HashMap;\nuse url;\nuse log::{debug, warn};\n\nuse crate::utils::cookie::filter_vouchrs_cookies;\n\npub struct ResponseBuilder;\n\n// Helper function to check for hop-by-hop headers\n#[must_use]\npub fn is_hop_by_hop_header(name: \u0026str) -\u003e bool {\n    matches!(\n        name,\n        \"connection\"\n            | \"keep-alive\"\n            | \"proxy-authenticate\"\n            | \"proxy-authorization\"\n            | \"te\"\n            | \"trailers\"\n            | \"transfer-encoding\"\n            | \"upgrade\"\n    )\n}\n\nimpl ResponseBuilder {\n    /// Create a redirect response with optional cookies\n    #[must_use]\n    pub fn redirect(location: \u0026str, cookies: Option\u003cVec\u003cCookie\u003e\u003e) -\u003e HttpResponse {\n        let mut builder = HttpResponse::Found();\n\n        if let Some(cookies_vec) = cookies {\n            for cookie in cookies_vec {\n                builder.cookie(cookie);\n            }\n        }\n\n        builder.append_header((\"Location\", location)).finish()\n    }\n\n    /// Create a redirect response with a single cookie\n    #[must_use]\n    pub fn redirect_with_cookie(location: \u0026str, cookie: Option\u003cCookie\u003e) -\u003e HttpResponse {\n        let cookies = cookie.map(|c| vec![c]);\n        Self::redirect(location, cookies)\n    }\n\n    /// Create an error redirect response\n    #[must_use]\n    pub fn error_redirect(location: \u0026str, error_param: \u0026str) -\u003e HttpResponse {\n        let redirect_url = if location.contains('?') {\n            format!(\"{location}\u0026error={error_param}\")\n        } else {\n            format!(\"{location}?error={error_param}\")\n        };\n\n        Self::redirect(\u0026redirect_url, None)\n    }\n\n    /// Create a success redirect response with cookie\n    #[must_use]\n    pub fn success_redirect_with_cookie(location: \u0026str, cookie: Cookie) -\u003e HttpResponse {\n        Self::redirect(location, Some(vec![cookie]))\n    }\n\n    /// Create a success redirect response with multiple cookies\n    #[must_use]\n    pub fn success_redirect_with_cookies(location: \u0026str, cookies: Vec\u003cCookie\u003e) -\u003e HttpResponse {\n        Self::redirect(location, Some(cookies))\n    }\n\n    /// Convert Actix HTTP method to reqwest method\n    /// \n    /// # Errors\n    /// \n    /// Returns an `HttpResponse` error if the HTTP method is not supported\n    pub fn convert_http_method(\n        method: \u0026actix_web::http::Method,\n    ) -\u003e Result\u003creqwest::Method, HttpResponse\u003e {\n        match method.as_str() {\n            \"GET\" =\u003e Ok(reqwest::Method::GET),\n            \"POST\" =\u003e Ok(reqwest::Method::POST),\n            \"PUT\" =\u003e Ok(reqwest::Method::PUT),\n            \"DELETE\" =\u003e Ok(reqwest::Method::DELETE),\n            \"PATCH\" =\u003e Ok(reqwest::Method::PATCH),\n            \"HEAD\" =\u003e Ok(reqwest::Method::HEAD),\n            \"OPTIONS\" =\u003e Ok(reqwest::Method::OPTIONS),\n            method_str =\u003e Err(HttpResponse::BadRequest().json(serde_json::json!({\n                \"error\": \"bad_request\",\n                \"message\": format!(\"HTTP method '{method_str}' is not supported\")\n            }))),\n        }\n    }\n\n    /// Forward request headers (excluding Authorization, Cookie with `vouchrs_session`, and hop-by-hop headers)\n    pub fn forward_request_headers(\n        mut request_builder: reqwest::RequestBuilder,\n        req: \u0026HttpRequest,\n    ) -\u003e reqwest::RequestBuilder {\n        for (name, value) in req.headers() {\n            let name_str = name.as_str().to_lowercase();\n\n            // Skip authorization and hop-by-hop headers\n            if name_str == \"authorization\" || is_hop_by_hop_header(\u0026name_str) {\n                continue;\n            }\n\n            // Special handling for cookies\n            if name_str == \"cookie\" {\n                if let Ok(cookie_str) = value.to_str() {\n                    if let Some(filtered_cookie) = filter_vouchrs_cookies(cookie_str) {\n                        request_builder = request_builder.header(name.as_str(), filtered_cookie);\n                    }\n                }\n                continue;\n            }\n\n            // Add other headers\n            if let Ok(value_str) = value.to_str() {\n                request_builder = request_builder.header(name.as_str(), value_str);\n            }\n        }\n        request_builder\n    }\n\n    /// Forward query parameters\n    pub fn forward_query_parameters(\n        mut request_builder: reqwest::RequestBuilder,\n        query_params: \u0026web::Query\u003cHashMap\u003cString, String\u003e\u003e,\n    ) -\u003e reqwest::RequestBuilder {\n        if !query_params.is_empty() {\n            for (key, value) in query_params.iter() {\n                request_builder = request_builder.query(\u0026[(key, value)]);\n            }\n        }\n        request_builder\n    }\n\n    /// Forward request body if present\n    pub fn forward_request_body(\n        mut request_builder: reqwest::RequestBuilder,\n        body: \u0026web::Bytes,\n    ) -\u003e reqwest::RequestBuilder {\n        if !body.is_empty() {\n            request_builder = request_builder.body(body.to_vec());\n        }\n        request_builder\n    }\n\n    /// Build the upstream URL by combining base URL with request path\n    /// Simple URL construction for admin-controlled upstream URLs\n    /// No redirect protection needed since upstream URLs are controlled by admins\n    /// \n    /// # Errors\n    /// \n    /// Returns an `HttpResponse` error if:\n    /// - The base URL cannot be parsed\n    /// - The path cannot be joined with the base URL\n    pub fn build_upstream_url(base_url: \u0026str, request_path: \u0026str) -\u003e Result\u003cString, HttpResponse\u003e {\n        debug!(\"Building upstream URL - base: {base_url}, path: {request_path}\");\n        \n        // Parse base URL\n        let base = url::Url::parse(base_url)\n            .map_err(|e| {\n                warn!(\"Failed to parse base URL '{base_url}': {e}\");\n                HttpResponse::BadRequest().json(serde_json::json!({\n                    \"error\": \"bad_request\",\n                    \"message\": \"Invalid upstream URL configuration\"\n                }))\n            })?;\n\n        // Normalize the request path by removing leading slashes\n        let clean_path = request_path.trim_start_matches('/');\n        \n        // Join the path with the base URL\n        let final_url = base.join(clean_path)\n            .map_err(|e| {\n                warn!(\"Failed to join URL '{base_url}' + '{clean_path}': {e}\");\n                HttpResponse::BadRequest().json(serde_json::json!({\n                    \"error\": \"bad_request\", \n                    \"message\": \"Invalid request path\"\n                }))\n            })?;\n            \n        debug!(\"Successfully built upstream URL: {final_url}\");\n        Ok(final_url.to_string())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::ResponseBuilder;\n\n    /// Test that legitimate upstream URLs still work with simplified `build_upstream_url`\n    #[test]\n    fn test_upstream_url_building() {\n        let base_url = \"https://api.example.com\";\n        \n        let legitimate_paths = vec![\n            \"/api/v1/users\",\n            \"/users/123\",\n            \"/api/data.json\",\n            \"/path/to/resource\",\n            \"/search?q=test\",\n            \"/uploads/file.pdf\",\n        ];\n\n        for path in legitimate_paths {\n            let result = ResponseBuilder::build_upstream_url(base_url, path);\n            assert!(result.is_ok(), \"Legitimate upstream path should work: {path}\");\n            let url = result.unwrap();\n            assert!(url.starts_with(base_url), \"URL should start with base URL: {url}\");\n        }\n    }\n}\n\n\n","traces":[{"line":14,"address":[3444144],"length":1,"stats":{"Line":1}},{"line":15,"address":[3673932],"length":1,"stats":{"Line":1}},{"line":31,"address":[3674893,3674771,3674144],"length":1,"stats":{"Line":0}},{"line":32,"address":[3749120],"length":1,"stats":{"Line":0}},{"line":34,"address":[3674295],"length":1,"stats":{"Line":0}},{"line":35,"address":[3444804,3444651,3444939],"length":1,"stats":{"Line":0}},{"line":36,"address":[3233114,3233080],"length":1,"stats":{"Line":0}},{"line":40,"address":[3749715,3749328],"length":1,"stats":{"Line":0}},{"line":45,"address":[3233280],"length":1,"stats":{"Line":0}},{"line":46,"address":[3445263],"length":1,"stats":{"Line":0}},{"line":47,"address":[3749929],"length":1,"stats":{"Line":0}},{"line":52,"address":[3675561,3675024,3675567],"length":1,"stats":{"Line":0}},{"line":53,"address":[3675061],"length":1,"stats":{"Line":0}},{"line":54,"address":[3233618],"length":1,"stats":{"Line":0}},{"line":56,"address":[3233442],"length":1,"stats":{"Line":0}},{"line":59,"address":[3233782,3233862],"length":1,"stats":{"Line":0}},{"line":64,"address":[3675584,3675952,3675924],"length":1,"stats":{"Line":0}},{"line":65,"address":[3675631,3675714],"length":1,"stats":{"Line":0}},{"line":70,"address":[3675968],"length":1,"stats":{"Line":0}},{"line":71,"address":[3446278],"length":1,"stats":{"Line":0}},{"line":79,"address":[3234384,3236012,3235984],"length":1,"stats":{"Line":0}},{"line":82,"address":[3234420],"length":1,"stats":{"Line":0}},{"line":83,"address":[3234457,3234516],"length":1,"stats":{"Line":0}},{"line":84,"address":[3234488,3234599],"length":1,"stats":{"Line":0}},{"line":85,"address":[3751274,3751163],"length":1,"stats":{"Line":0}},{"line":86,"address":[3446717,3446606],"length":1,"stats":{"Line":0}},{"line":87,"address":[3676512,3676401],"length":1,"stats":{"Line":0}},{"line":88,"address":[3751412,3751523],"length":1,"stats":{"Line":0}},{"line":89,"address":[3676567,3676697],"length":1,"stats":{"Line":0}},{"line":90,"address":[3752214,3752187,3751578,3751714,3752043,3752605,3752577,3751827],"length":1,"stats":{"Line":0}},{"line":92,"address":[3235487,3235419],"length":1,"stats":{"Line":0}},{"line":98,"address":[3677712,3679399,3678787],"length":1,"stats":{"Line":1}},{"line":102,"address":[3677770,3677890],"length":1,"stats":{"Line":2}},{"line":103,"address":[3236475,3236386],"length":1,"stats":{"Line":2}},{"line":106,"address":[3236631,3236568,3236494],"length":1,"stats":{"Line":3}},{"line":111,"address":[3678336],"length":1,"stats":{"Line":1}},{"line":112,"address":[3753731,3753337,3754303],"length":1,"stats":{"Line":3}},{"line":113,"address":[3449584,3449174],"length":1,"stats":{"Line":2}},{"line":114,"address":[3237416,3237616,3237310],"length":1,"stats":{"Line":1}},{"line":121,"address":[3236836,3236696,3236759,3237068],"length":1,"stats":{"Line":0}},{"line":122,"address":[3237073,3236878],"length":1,"stats":{"Line":0}},{"line":125,"address":[3753033],"length":1,"stats":{"Line":1}},{"line":129,"address":[3679440,3680012,3679983],"length":1,"stats":{"Line":0}},{"line":133,"address":[3679483,3679561],"length":1,"stats":{"Line":0}},{"line":134,"address":[3754581,3754519,3754906],"length":1,"stats":{"Line":0}},{"line":135,"address":[3679855],"length":1,"stats":{"Line":0}},{"line":138,"address":[3754545],"length":1,"stats":{"Line":0}},{"line":142,"address":[3450320,3450728],"length":1,"stats":{"Line":0}},{"line":146,"address":[3755341,3755003,3755083],"length":1,"stats":{"Line":0}},{"line":147,"address":[3755094,3755195,3755346],"length":1,"stats":{"Line":0}},{"line":149,"address":[3755164],"length":1,"stats":{"Line":0}},{"line":161,"address":[3755408,3757179,3757157],"length":1,"stats":{"Line":1}},{"line":162,"address":[3680517,3680657],"length":1,"stats":{"Line":2}},{"line":165,"address":[3755476,3755883],"length":1,"stats":{"Line":1}},{"line":166,"address":[3725579,3724512,3725551],"length":1,"stats":{"Line":0}},{"line":167,"address":[3724622,3724540],"length":1,"stats":{"Line":0}},{"line":168,"address":[3555961,3555019,3555463,3555681,3555350,3555989],"length":1,"stats":{"Line":0}},{"line":175,"address":[3681173,3681263],"length":1,"stats":{"Line":2}},{"line":178,"address":[3681279,3681534],"length":1,"stats":{"Line":1}},{"line":179,"address":[2511692,2510592,2511664],"length":1,"stats":{"Line":0}},{"line":180,"address":[2878850,2878768],"length":1,"stats":{"Line":0}},{"line":181,"address":[3726392,3726061,3726174,3726671,3726699,3725679],"length":1,"stats":{"Line":0}},{"line":187,"address":[3681881,3681845,3681755],"length":1,"stats":{"Line":3}},{"line":188,"address":[3681851,3682152],"length":1,"stats":{"Line":2}}],"covered":18,"coverable":64},{"path":["/","workspaces","vouchrs","src","utils","test_helpers.rs"],"content":"// Test utilities shared across modules\nuse crate::models::VouchrsSession;\nuse crate::settings::{ApplicationSettings, SessionSettings, ProxySettings, VouchrsSettings};\nuse chrono::{Duration, Utc};\n\n/// Create a test session for use in unit tests\n#[must_use]\npub fn create_test_session() -\u003e VouchrsSession {\n    VouchrsSession {\n        id_token: Some(\"test_id_token\".to_string()),\n        refresh_token: Some(\"test_refresh_token\".to_string()),\n        provider: \"google\".to_string(),\n        expires_at: Utc::now() + Duration::hours(1),\n    }\n}\n\n/// Create test settings for use in unit tests\n#[must_use]\npub fn create_test_settings() -\u003e VouchrsSettings {\n    VouchrsSettings {\n        application: ApplicationSettings {\n            host: \"0.0.0.0\".to_string(),\n            port: 8080,\n            redirect_base_url: \"http://localhost:8080\".to_string(),\n            cors_origins: \"http://localhost:3000\".to_string(),\n        },\n        proxy: ProxySettings {\n            upstream_url: \"http://localhost:3000\".to_string(),\n        },\n        session: SessionSettings {\n            session_duration_hours: 24,\n            session_secret: \"test-secret-key\".to_string(),\n        },\n        ..Default::default()\n    }\n}\n","traces":[{"line":8,"address":[3357792,3358271,3358277],"length":1,"stats":{"Line":7}},{"line":10,"address":[3357809],"length":1,"stats":{"Line":7}},{"line":11,"address":[3357865,3357930],"length":1,"stats":{"Line":14}},{"line":12,"address":[3357956],"length":1,"stats":{"Line":7}},{"line":13,"address":[3358090,3358025],"length":1,"stats":{"Line":14}},{"line":19,"address":[3358304,3359206,3359212],"length":1,"stats":{"Line":3}},{"line":21,"address":[3358494],"length":1,"stats":{"Line":3}},{"line":27,"address":[3358648],"length":1,"stats":{"Line":3}},{"line":30,"address":[3358752],"length":1,"stats":{"Line":3}}],"covered":9,"coverable":9},{"path":["/","workspaces","vouchrs","src","utils","test_request_builder.rs"],"content":"// Test request builders for common test patterns\nuse actix_web::http::header;\nuse actix_web::{test, HttpRequest};\n\npub struct TestRequestBuilder;\n\nimpl TestRequestBuilder {\n    /// Create a browser request with typical browser headers\n    #[must_use]\n    pub fn browser_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((\n                header::ACCEPT,\n                \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n            ))\n            .insert_header((\n                header::USER_AGENT,\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n            ))\n            .to_http_request()\n    }\n\n    /// Create an API request with typical API client headers\n    #[must_use]\n    pub fn api_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((header::ACCEPT, \"application/json\"))\n            .insert_header((header::USER_AGENT, \"MyApp/1.0\"))\n            .to_http_request()\n    }\n\n    /// Create a request with client hints headers\n    #[must_use]\n    pub fn client_hints_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((\n                \"sec-ch-ua\",\n                \"\\\"Google Chrome\\\";v=\\\"91\\\", \\\"Chromium\\\";v=\\\"91\\\"\",\n            ))\n            .insert_header((\"sec-ch-ua-platform\", \"\\\"Windows\\\"\"))\n            .insert_header((\"sec-ch-ua-mobile\", \"?0\"))\n            .insert_header((\"accept-language\", \"en-US,en;q=0.9,es;q=0.8\"))\n            .to_http_request()\n    }\n\n    /// Create a mobile browser request\n    #[must_use]\n    pub fn mobile_browser_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((\n                header::ACCEPT,\n                \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n            ))\n            .insert_header((\n                header::USER_AGENT,\n                \"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15\",\n            ))\n            .insert_header((\"sec-ch-ua-mobile\", \"?1\"))\n            .to_http_request()\n    }\n\n    /// Create a request with specific User-Agent for platform testing\n    #[must_use]\n    pub fn user_agent_request(user_agent: \u0026str) -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((header::USER_AGENT, user_agent))\n            .to_http_request()\n    }\n\n    /// Create an empty request with no headers\n    #[must_use]\n    pub fn empty_request() -\u003e HttpRequest {\n        test::TestRequest::default().to_http_request()\n    }\n\n    /// Create a request with macOS User-Agent and French language\n    #[must_use]\n    pub fn macos_french_request() -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((\n                header::USER_AGENT,\n                \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\",\n            ))\n            .insert_header((\"accept-language\", \"fr-FR,fr;q=0.9\"))\n            .to_http_request()\n    }\n\n    /// Create a request with specific cookie header\n    #[must_use]\n    pub fn with_cookies(cookies: \u0026str) -\u003e HttpRequest {\n        test::TestRequest::default()\n            .insert_header((header::COOKIE, cookies))\n            .to_http_request()\n    }\n}\n","traces":[{"line":10,"address":[3127520],"length":1,"stats":{"Line":2}},{"line":11,"address":[3127744,3127527,3127628],"length":1,"stats":{"Line":6}},{"line":12,"address":[3127541],"length":1,"stats":{"Line":2}},{"line":16,"address":[3127657],"length":1,"stats":{"Line":2}},{"line":25,"address":[3127792],"length":1,"stats":{"Line":1}},{"line":26,"address":[3127799,3127900,3128016],"length":1,"stats":{"Line":5}},{"line":27,"address":[3127813],"length":1,"stats":{"Line":1}},{"line":28,"address":[3127929],"length":1,"stats":{"Line":2}},{"line":34,"address":[3128064],"length":1,"stats":{"Line":1}},{"line":35,"address":[3128083,3128400,3128234,3128317,3128151],"length":1,"stats":{"Line":5}},{"line":36,"address":[3128097],"length":1,"stats":{"Line":1}},{"line":40,"address":[3128180],"length":1,"stats":{"Line":1}},{"line":41,"address":[3128263],"length":1,"stats":{"Line":1}},{"line":42,"address":[3128346],"length":1,"stats":{"Line":1}},{"line":48,"address":[3128448],"length":1,"stats":{"Line":0}},{"line":49,"address":[3128455,3128755,3128556,3128672],"length":1,"stats":{"Line":0}},{"line":50,"address":[3128469],"length":1,"stats":{"Line":0}},{"line":54,"address":[3128585],"length":1,"stats":{"Line":0}},{"line":58,"address":[3128701],"length":1,"stats":{"Line":0}},{"line":64,"address":[3128800],"length":1,"stats":{"Line":1}},{"line":65,"address":[3128933,3128833],"length":1,"stats":{"Line":2}},{"line":66,"address":[3128857],"length":1,"stats":{"Line":1}},{"line":72,"address":[3128992],"length":1,"stats":{"Line":2}},{"line":73,"address":[3128999],"length":1,"stats":{"Line":1}},{"line":78,"address":[3129040],"length":1,"stats":{"Line":1}},{"line":79,"address":[3129231,3129047,3129148],"length":1,"stats":{"Line":4}},{"line":80,"address":[3129061],"length":1,"stats":{"Line":2}},{"line":84,"address":[3129177],"length":1,"stats":{"Line":2}},{"line":90,"address":[3129280],"length":1,"stats":{"Line":1}},{"line":91,"address":[3129313,3129413],"length":1,"stats":{"Line":2}},{"line":92,"address":[3129337],"length":1,"stats":{"Line":1}}],"covered":26,"coverable":31},{"path":["/","workspaces","vouchrs","src","utils","user_agent.rs"],"content":"// User agent extraction and platform detection utilities\nuse actix_web::HttpRequest;\n\n/// User agent information extracted from HTTP headers\n#[derive(Debug, Clone)]\npub struct UserAgentInfo {\n    pub user_agent: Option\u003cString\u003e,\n    pub platform: Option\u003cString\u003e,\n    pub lang: Option\u003cString\u003e,\n    pub mobile: u8, // 0 or 1\n}\n\n/// Extract user agent information from HTTP request headers\n/// Uses modern client hints headers first, with fallback to traditional User-Agent header\n#[must_use]\npub fn extract_user_agent_info(req: \u0026HttpRequest) -\u003e UserAgentInfo {\n    let headers = req.headers();\n\n    // Try to get user agent from modern client hints or fallback to User-Agent header\n    let user_agent = headers\n        .get(\"sec-ch-ua\")\n        .and_then(|h| h.to_str().ok())\n        .map(ToString::to_string)\n        .or_else(|| {\n            headers\n                .get(\"user-agent\")\n                .and_then(|h| h.to_str().ok())\n                .map(ToString::to_string)\n        });\n\n    // Try to get platform from client hints or derive from User-Agent\n    let platform = headers\n        .get(\"sec-ch-ua-platform\")\n        .and_then(|h| h.to_str().ok())\n        .map(|s| s.trim_matches('\"').to_string())\n        .or_else(|| {\n            user_agent.as_ref().map_or_else(|| Some(\"Unknown\".to_string()), |ua| Some(derive_platform_from_user_agent(ua)))\n        });\n\n    // Extract language preference from Accept-Language header\n    let lang = headers\n        .get(\"accept-language\")\n        .and_then(|h| h.to_str().ok())\n        .map(|s| s.split(',').next().unwrap_or(\"\").trim().to_string())\n        .filter(|s| !s.is_empty());\n\n    // Detect mobile from client hints\n    let mobile = headers\n        .get(\"sec-ch-ua-mobile\")\n        .and_then(|h| h.to_str().ok())\n        .map_or(0, |s| u8::from(s.contains('1')));\n\n    UserAgentInfo {\n        user_agent,\n        platform,\n        lang,\n        mobile,\n    }\n}\n\n/// Derive platform from User-Agent string\n/// Detects common platforms like Windows, macOS, Linux, Android, iOS, Chrome OS\n#[must_use]\npub fn derive_platform_from_user_agent(user_agent: \u0026str) -\u003e String {\n    let ua_lower = user_agent.to_lowercase();\n\n    if ua_lower.contains(\"android\") {\n        \"Android\".to_string()\n    } else if ua_lower.contains(\"iphone\") || ua_lower.contains(\"ipad\") || ua_lower.contains(\"ios\") {\n        \"iOS\".to_string()\n    } else if ua_lower.contains(\"chrome os\") || ua_lower.contains(\"cros\") {\n        \"Chrome OS\".to_string()\n    } else if ua_lower.contains(\"windows\") {\n        \"Windows\".to_string()\n    } else if ua_lower.contains(\"macintosh\") || ua_lower.contains(\"mac os\") {\n        \"macOS\".to_string()\n    } else if ua_lower.contains(\"linux\") {\n        \"Linux\".to_string()\n    } else {\n        \"Unknown\".to_string()\n    }\n}\n\n/// Determine if a request came from a browser vs an API client\n/// Browsers typically send Accept headers that include text/html\n#[must_use]\npub fn is_browser_request(req: \u0026HttpRequest) -\u003e bool {\n    if let Some(accept_header) = req.headers().get(\"accept\") {\n        if let Ok(accept_str) = accept_header.to_str() {\n            // Browser requests typically accept text/html\n            return accept_str.contains(\"text/html\")\n                || accept_str.contains(\"application/xhtml+xml\");\n        }\n    }\n\n    // Fallback: check User-Agent for common browser patterns\n    if let Some(user_agent) = req.headers().get(\"user-agent\") {\n        if let Ok(ua_str) = user_agent.to_str() {\n            let ua_lower = ua_str.to_lowercase();\n            return ua_lower.contains(\"mozilla\")\n                || ua_lower.contains(\"chrome\")\n                || ua_lower.contains(\"safari\")\n                || ua_lower.contains(\"firefox\")\n                || ua_lower.contains(\"edge\");\n        }\n    }\n\n    false\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::test_request_builder::TestRequestBuilder;\n\n    #[test]\n    fn test_user_agent_extraction() {\n        // Test with modern client hints headers\n        let req = TestRequestBuilder::client_hints_request();\n\n        let user_agent_info = extract_user_agent_info(\u0026req);\n\n        assert_eq!(\n            user_agent_info.user_agent,\n            Some(\"\\\"Google Chrome\\\";v=\\\"91\\\", \\\"Chromium\\\";v=\\\"91\\\"\".to_string())\n        );\n        assert_eq!(user_agent_info.platform, Some(\"Windows\".to_string()));\n        assert_eq!(user_agent_info.lang, Some(\"en-US\".to_string()));\n        assert_eq!(user_agent_info.mobile, 0);\n\n        // Test with fallback to User-Agent header\n        let req = TestRequestBuilder::macos_french_request();\n\n        let user_agent_info = extract_user_agent_info(\u0026req);\n\n        assert_eq!(\n            user_agent_info.user_agent,\n            Some(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\".to_string())\n        );\n        assert_eq!(user_agent_info.platform, Some(\"macOS\".to_string())); // Derived from User-Agent\n        assert_eq!(user_agent_info.lang, Some(\"fr-FR\".to_string()));\n        assert_eq!(user_agent_info.mobile, 0); // Default when not specified\n    }\n\n    #[test]\n    fn test_platform_derivation_from_user_agent() {\n        // Test Windows detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Windows NT 10.0; Win64; x64)\"),\n            \"Windows\"\n        );\n\n        // Test macOS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)\"),\n            \"macOS\"\n        );\n\n        // Test Linux detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (X11; Linux x86_64)\"),\n            \"Linux\"\n        );\n\n        // Test Android detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Linux; Android 11; SM-G991B)\"),\n            \"Android\"\n        );\n\n        // Test iOS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\n                \"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)\"\n            ),\n            \"iOS\"\n        );\n\n        // Test Chrome OS detection\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (X11; CrOS x86_64 14541.0.0)\"),\n            \"Chrome OS\"\n        );\n\n        // Test unknown platform - now returns \"Unknown\" instead of None\n        assert_eq!(\n            derive_platform_from_user_agent(\"Mozilla/5.0 (Unknown Platform)\"),\n            \"Unknown\"\n        );\n    }\n\n    #[test]\n    fn test_is_browser_request() {\n        // Test browser detection with Accept: text/html\n        let browser_req = TestRequestBuilder::browser_request();\n        assert!(is_browser_request(\u0026browser_req));\n\n        // Test API client detection with Accept: application/json\n        let api_req = TestRequestBuilder::api_request();\n        assert!(!is_browser_request(\u0026api_req));\n\n        // Test with a user agent only request\n        let browser_ua_req = TestRequestBuilder::user_agent_request(\n            \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n        );\n        assert!(is_browser_request(\u0026browser_ua_req));\n\n        // Test API client via User-Agent\n        let api_ua_req = TestRequestBuilder::user_agent_request(\"curl/7.68.0\");\n        assert!(!is_browser_request(\u0026api_ua_req));\n\n        // Test unknown client (no Accept or User-Agent)\n        let unknown_req = TestRequestBuilder::empty_request();\n        assert!(!is_browser_request(\u0026unknown_req));\n    }\n}\n","traces":[{"line":16,"address":[3313963,3313957,3313120],"length":1,"stats":{"Line":1}},{"line":17,"address":[3788678],"length":1,"stats":{"Line":1}},{"line":20,"address":[3788707],"length":1,"stats":{"Line":1}},{"line":22,"address":[3362281,3362272],"length":1,"stats":{"Line":2}},{"line":24,"address":[3362320],"length":1,"stats":{"Line":2}},{"line":25,"address":[3362338],"length":1,"stats":{"Line":1}},{"line":27,"address":[3362400,3362409],"length":1,"stats":{"Line":4}},{"line":32,"address":[3819303,3819379],"length":1,"stats":{"Line":2}},{"line":34,"address":[3362448,3362457],"length":1,"stats":{"Line":2}},{"line":35,"address":[3843424,3843472],"length":1,"stats":{"Line":2}},{"line":36,"address":[3843520],"length":1,"stats":{"Line":1}},{"line":37,"address":[4082014,4082080,4082000,4081954,4082112],"length":1,"stats":{"Line":6}},{"line":41,"address":[3788973,3789050],"length":1,"stats":{"Line":2}},{"line":43,"address":[3362832,3362841],"length":1,"stats":{"Line":2}},{"line":44,"address":[3105928,3105904],"length":1,"stats":{"Line":2}},{"line":45,"address":[3106025,3106016],"length":1,"stats":{"Line":2}},{"line":48,"address":[3819628,3819705],"length":1,"stats":{"Line":2}},{"line":50,"address":[3363033,3363024],"length":1,"stats":{"Line":2}},{"line":51,"address":[3363072,3363086],"length":1,"stats":{"Line":2}},{"line":64,"address":[3313984,3315182,3315188],"length":1,"stats":{"Line":1}},{"line":65,"address":[3820103],"length":1,"stats":{"Line":1}},{"line":67,"address":[3789640,3789723],"length":1,"stats":{"Line":2}},{"line":68,"address":[3820301,3821260],"length":1,"stats":{"Line":2}},{"line":69,"address":[3314263,3314190,3314387],"length":1,"stats":{"Line":3}},{"line":70,"address":[3821258,3820425],"length":1,"stats":{"Line":2}},{"line":71,"address":[3843067,3842916],"length":1,"stats":{"Line":2}},{"line":72,"address":[3820727,3821256],"length":1,"stats":{"Line":2}},{"line":73,"address":[3314728],"length":1,"stats":{"Line":1}},{"line":74,"address":[3790758,3790409],"length":1,"stats":{"Line":2}},{"line":75,"address":[3790384,3790445,3790551],"length":1,"stats":{"Line":3}},{"line":76,"address":[3821252,3821011],"length":1,"stats":{"Line":2}},{"line":77,"address":[3821092],"length":1,"stats":{"Line":1}},{"line":78,"address":[3843554,3843499],"length":1,"stats":{"Line":2}},{"line":80,"address":[3315138,3315084],"length":1,"stats":{"Line":2}},{"line":87,"address":[3790800,3791768,3791762],"length":1,"stats":{"Line":1}},{"line":88,"address":[3790823],"length":1,"stats":{"Line":1}},{"line":89,"address":[3315453,3315319],"length":1,"stats":{"Line":2}},{"line":91,"address":[3821650,3821583],"length":1,"stats":{"Line":2}},{"line":92,"address":[3315539],"length":1,"stats":{"Line":2}},{"line":97,"address":[3791179,3790965],"length":1,"stats":{"Line":2}},{"line":98,"address":[3791195,3791258],"length":1,"stats":{"Line":2}},{"line":99,"address":[3791290],"length":1,"stats":{"Line":1}},{"line":100,"address":[3844194,3844256,3844117],"length":1,"stats":{"Line":3}},{"line":101,"address":[3821975,3821935],"length":1,"stats":{"Line":2}},{"line":102,"address":[3791524],"length":1,"stats":{"Line":2}},{"line":103,"address":[3791600],"length":1,"stats":{"Line":2}},{"line":104,"address":[3791676],"length":1,"stats":{"Line":2}},{"line":108,"address":[3791248],"length":1,"stats":{"Line":2}}],"covered":48,"coverable":48},{"path":["/","workspaces","vouchrs","tests","apple_jwt_integration_test.rs"],"content":"// Integration test for Apple JWT functions using the refactored crypto module\nuse std::fs;\nuse std::path::Path;\nuse vouchrs::settings::JwtSigningConfig;\nuse vouchrs::utils::apple::generate_jwt_client_secret;\nuse vouchrs::utils::crypto::decode_jwt_payload;\n\n// Helper function to create a test JWT signing config\nfn create_test_jwt_config() -\u003e JwtSigningConfig {\n    create_test_jwt_config_with_path(\"/tmp/test_apple_key.p8\")\n}\n\n// Helper function to create a test JWT signing config with custom path\nfn create_test_jwt_config_with_path(path: \u0026str) -\u003e JwtSigningConfig {\n    // Create a temporary test key file\n    let test_key = r\"-----BEGIN PRIVATE KEY-----\nMIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgpQUGzV2mpXNdjHnV\n9QFCar9R+eojTjLOXCisVV9xfvehRANCAATyHpTDz7xyWXHaC0FXYlwK5r4IpeHx\n1X4WXDZiAKUxHblBs1Kn15IR334KNiNP7gEWM+9BFuWh9uJwHGOBJXc/\n-----END PRIVATE KEY-----\";\n\n    fs::write(path, test_key).expect(\"Failed to write test key file\");\n\n    JwtSigningConfig {\n        team_id: Some(\"TEST123456\".to_string()),\n        key_id: Some(\"TEST789XYZ\".to_string()),\n        private_key_path: Some(path.to_string()),\n        team_id_env: None,\n        key_id_env: None,\n        private_key_path_env: None,\n    }\n}\n\n#[test]\nfn test_apple_jwt_creation_with_crypto_module() {\n    let jwt_config = create_test_jwt_config();\n    let client_id = \"com.example.testapp\";\n\n    // Generate Apple JWT using the refactored function\n    let result = generate_jwt_client_secret(\u0026jwt_config, client_id);\n    \n    match \u0026result {\n        Ok(_) =\u003e println!(\"âœ… Apple JWT generation succeeded\"),\n        Err(e) =\u003e println!(\"âŒ Apple JWT generation failed: {e}\"),\n    }\n    \n    assert!(result.is_ok(), \"Apple JWT generation should succeed: {:?}\", result.as_ref().err());\n    let jwt = result.unwrap();\n    \n    // Verify JWT format (should have 3 parts separated by dots)\n    let parts: Vec\u003c\u0026str\u003e = jwt.split('.').collect();\n    assert_eq!(parts.len(), 3, \"JWT should have header.payload.signature format\");\n    \n    // Decode and verify header\n    let header_result = decode_jwt_payload(\u0026format!(\"{}.{}.dummy\", parts[0], parts[1]));\n    assert!(header_result.is_ok(), \"Should be able to decode JWT payload\");\n    \n    let payload = header_result.unwrap();\n    \n    // Verify Apple-specific claims\n    assert_eq!(payload[\"iss\"], \"TEST123456\", \"Issuer should be team ID\");\n    assert_eq!(payload[\"sub\"], client_id, \"Subject should be client ID\");\n    assert_eq!(payload[\"aud\"], \"https://appleid.apple.com\", \"Audience should be Apple ID\");\n    \n    // Verify timestamps are present and reasonable\n    assert!(payload[\"iat\"].is_number(), \"Issued at timestamp should be present\");\n    assert!(payload[\"exp\"].is_number(), \"Expiration timestamp should be present\");\n    \n    let iat = payload[\"iat\"].as_i64().unwrap();\n    let exp = payload[\"exp\"].as_i64().unwrap();\n    \n    // Token should expire 5 minutes (300 seconds) from issue time\n    assert_eq!(exp - iat, 300, \"Token should expire in 5 minutes\");\n    \n    // Verify signature is present and not empty\n    assert!(!parts[2].is_empty(), \"Signature should not be empty\");\n    \n    // Clean up test file\n    if Path::new(\"/tmp/test_apple_key.p8\").exists() {\n        fs::remove_file(\"/tmp/test_apple_key.p8\").unwrap();\n    }\n    \n    println!(\"âœ… Apple JWT integration test passed\");\n    println!(\"Generated JWT: {jwt}\");\n}\n\n#[test]\nfn test_apple_jwt_missing_config() {\n    let incomplete_config = JwtSigningConfig {\n        team_id: None, // Missing team ID\n        key_id: Some(\"TEST789XYZ\".to_string()),\n        private_key_path: Some(\"/tmp/nonexistent.p8\".to_string()),\n        team_id_env: None,\n        key_id_env: None,\n        private_key_path_env: None,\n    };\n    \n    let result = generate_jwt_client_secret(\u0026incomplete_config, \"com.example.test\");\n    \n    assert!(result.is_err(), \"Should fail with missing team ID\");\n    assert!(result.unwrap_err().contains(\"Team ID not configured\"));\n}\n\n#[test]\nfn test_apple_jwt_invalid_key_file() {\n    let invalid_config = JwtSigningConfig {\n        team_id: Some(\"TEST123456\".to_string()),\n        key_id: Some(\"TEST789XYZ\".to_string()),\n        private_key_path: Some(\"/tmp/nonexistent_key.p8\".to_string()),\n        team_id_env: None,\n        key_id_env: None,\n        private_key_path_env: None,\n    };\n    \n    let result = generate_jwt_client_secret(\u0026invalid_config, \"com.example.test\");\n    \n    assert!(result.is_err(), \"Should fail with missing key file\");\n    assert!(result.unwrap_err().contains(\"Failed to read Apple private key file\"));\n}\n\n#[test]\nfn test_apple_jwt_deterministic_with_same_input() {\n    let test_key_path = \"/tmp/test_apple_key_deterministic.p8\";\n    let jwt_config = create_test_jwt_config_with_path(test_key_path);\n    let client_id = \"com.example.testapp\";\n\n    // Generate two JWTs with the same parameters\n    let jwt1 = generate_jwt_client_secret(\u0026jwt_config, client_id).unwrap();\n    \n    // Wait a moment to ensure different timestamps\n    std::thread::sleep(std::time::Duration::from_millis(1001));\n    \n    let jwt2 = generate_jwt_client_secret(\u0026jwt_config, client_id).unwrap();\n    \n    // JWTs should be different due to different timestamps\n    assert_ne!(jwt1, jwt2, \"JWTs should differ due to different timestamps\");\n    \n    // But they should have the same structure\n    let parts1: Vec\u003c\u0026str\u003e = jwt1.split('.').collect();\n    let parts2: Vec\u003c\u0026str\u003e = jwt2.split('.').collect();\n    \n    // Headers should be identical (same algorithm and key ID)\n    assert_eq!(parts1[0], parts2[0], \"Headers should be identical\");\n    \n    // Payloads should differ only in timestamps\n    let payload1 = decode_jwt_payload(\u0026format!(\"{}.{}.dummy\", parts1[0], parts1[1])).unwrap();\n    let payload2 = decode_jwt_payload(\u0026format!(\"{}.{}.dummy\", parts2[0], parts2[1])).unwrap();\n    \n    assert_eq!(payload1[\"iss\"], payload2[\"iss\"], \"Issuers should match\");\n    assert_eq!(payload1[\"sub\"], payload2[\"sub\"], \"Subjects should match\");\n    assert_eq!(payload1[\"aud\"], payload2[\"aud\"], \"Audiences should match\");\n    \n    // Timestamps should be different\n    assert_ne!(payload1[\"iat\"], payload2[\"iat\"], \"Issue times should differ\");\n    assert_ne!(payload1[\"exp\"], payload2[\"exp\"], \"Expiry times should differ\");\n    \n    // Clean up test file\n    if Path::new(test_key_path).exists() {\n        fs::remove_file(test_key_path).unwrap();\n    }\n    \n    println!(\"âœ… Apple JWT deterministic test passed\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","vouchrs","tests","integration_test.rs"],"content":"// Integration test for JWT settings and user cookie functionality\nuse vouchrs::models::VouchrsUserData;\nuse vouchrs::session::SessionManager;\nuse vouchrs::utils::test_helpers::{create_test_session, create_test_settings};\nuse vouchrs::utils::user_agent::UserAgentInfo;\n\n/// Helper function to create test user data with optional context\nfn create_test_user_data(\n    email: \u0026str,\n    name: Option\u003cString\u003e,\n    provider: \u0026str,\n    provider_id: \u0026str,\n    client_ip: Option\u003c\u0026str\u003e,\n    user_agent_info: Option\u003c\u0026UserAgentInfo\u003e,\n) -\u003e VouchrsUserData {\n    VouchrsUserData {\n        email: email.to_string(),\n        name,\n        provider: provider.to_string(),\n        provider_id: provider_id.to_string(),\n        client_ip: client_ip.map(std::string::ToString::to_string),\n        user_agent: user_agent_info.and_then(|ua| ua.user_agent.clone()),\n        platform: user_agent_info.and_then(|ua| ua.platform.clone()),\n        lang: user_agent_info.and_then(|ua| ua.lang.clone()),\n        mobile: user_agent_info.map_or(0, |ua| i32::from(ua.mobile)),\n        session_start: Some(chrono::Utc::now().timestamp()), // Adding session_start as Unix timestamp for test\n    }\n}\n\n#[test]\nfn test_user_cookie_contains_required_fields() {\n    // Create a session with proper provider_id set\n    let session = create_test_session();\n\n    let settings = create_test_settings();\n\n    // Create user agent info with platform\n    let user_agent_info = UserAgentInfo {\n        user_agent: Some(\n            \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\".to_string(),\n        ),\n        platform: Some(\"macOS\".to_string()),\n        lang: Some(\"en-US\".to_string()),\n        mobile: 0,\n    };\n\n    // Create user data manually since we now have separate token and user data\n    let user_data = create_test_user_data(\n        \"test@example.com\",\n        Some(\"Test User\".to_string()),\n        \u0026session.provider,\n        \"123456789\",\n        Some(\"192.168.1.1\"),\n        Some(\u0026user_agent_info),\n    );\n\n    // Verify user data contains all required fields\n    assert_eq!(\n        user_data.provider, session.provider,\n        \"Provider should match session\"\n    );\n    assert_eq!(\n        user_data.client_ip,\n        Some(\"192.168.1.1\".to_string()),\n        \"Client IP should be set\"\n    );\n    assert_eq!(\n        user_data.platform,\n        Some(\"macOS\".to_string()),\n        \"Platform should be extracted from user agent\"\n    );\n    assert_eq!(\n        user_data.lang,\n        Some(\"en-US\".to_string()),\n        \"Language should be set\"\n    );\n    assert_eq!(user_data.mobile, 0, \"Mobile flag should be set\");\n\n    // Test user cookie encryption/decryption\n    let session_manager = SessionManager::new(settings.session.session_secret.as_bytes(), false, settings.session.session_duration_hours);\n    let user_cookie = session_manager\n        .create_user_cookie(\u0026user_data)\n        .expect(\"Should create user cookie\");\n\n    // Verify cookie has correct properties\n    assert_eq!(user_cookie.name(), \"vouchrs_user\");\n    assert_eq!(\n        user_cookie.http_only(),\n        Some(true),\n        \"User cookie should be HTTP-only\"\n    );\n    assert_eq!(user_cookie.path(), Some(\"/\"));\n\n    // Test that we can decrypt the user data back using a mock request\n    let test_req = actix_web::test::TestRequest::default()\n        .cookie(user_cookie.clone())\n        .to_http_request();\n\n    let decrypted_data = session_manager\n        .get_user_data_from_request(\u0026test_req)\n        .expect(\"Should get user data from request\")\n        .expect(\"Should have user data\");\n\n    assert_eq!(decrypted_data.email, user_data.email);\n    assert_eq!(decrypted_data.provider, user_data.provider);\n    assert_eq!(decrypted_data.platform, user_data.platform);\n\n    println!(\"âœ… All user cookie functionality verified successfully\");\n}\n\n#[test]\nfn test_minimal_user_data() {\n    // Test creating user data with minimal information\n    let session = create_test_session();\n\n    let settings = create_test_settings();\n\n    // Create user data without user agent info or client IP\n    let user_data = create_test_user_data(\n        \"test@example.com\",\n        Some(\"Test User\".to_string()),\n        \u0026session.provider,\n        \"123456789\",\n        None,\n        None,\n    );\n\n    // Verify required fields are present\n    assert_eq!(user_data.provider, session.provider);\n    assert_eq!(\n        user_data.client_ip, None,\n        \"Client IP should be None when not provided\"\n    );\n    assert_eq!(\n        user_data.platform, None,\n        \"Platform should be None when not provided\"\n    );\n    assert_eq!(user_data.mobile, 0, \"Mobile should default to 0\");\n\n    // Test encryption/decryption with minimal data\n    let session_manager = SessionManager::new(settings.session.session_secret.as_bytes(), false, settings.session.session_duration_hours);\n    let user_cookie = session_manager\n        .create_user_cookie(\u0026user_data)\n        .expect(\"Should create user cookie\");\n\n    // Test that we can decrypt the user data back using a mock request\n    let test_req = actix_web::test::TestRequest::default()\n        .cookie(user_cookie.clone())\n        .to_http_request();\n\n    let decrypted_data = session_manager\n        .get_user_data_from_request(\u0026test_req)\n        .expect(\"Should get user data from request\")\n        .expect(\"Should have user data\");\n\n    assert_eq!(decrypted_data.email, user_data.email);\n    assert_eq!(decrypted_data.client_ip, None);\n\n    println!(\"âœ… Minimal user data test passed\");\n}\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>